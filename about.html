<!DOCTYPE html>
<html lang="en" class="h-full bg-white">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>About â€¢ Agrovoltaicos sin Fronteras</title>
  <meta name="description" content="Learn about the Agrovoltaicos sin Fronteras seminar series.">

  <script>
    (function() {
      try {
        const cached = localStorage.getItem('asf_auth_cache');
        if (!cached) {
          document.documentElement.setAttribute('data-auth-ready', 'logged-out');
          return;
        }
        
        const parsed = JSON.parse(cached);
        if (Date.now() > parsed.expiry) {
          localStorage.removeItem('asf_auth_cache');
          document.documentElement.setAttribute('data-auth-ready', 'logged-out');
          return;
        }
        
        const isLoggedIn = !!(parsed.data?.session && parsed.data?.profile);
        
        const style = document.createElement('style');
        style.id = 'auth-preload-style';
        style.textContent = isLoggedIn 
          ? '#btnSignIn { display: none !important; } #btnProfile, #btnSignOut { display: inline-flex !important; } #btnProfile { display: grid !important; } #userName { display: inline !important; }' 
          : '#btnSignIn { display: inline-flex !important; } #btnProfile, #userName, #btnSignOut { display: none !important; }';
        document.head.appendChild(style);
        
        const fingerprint = JSON.stringify({
          hasSession: !!parsed.data?.session,
          userId: parsed.data?.session?.user?.id || null,
          profileId: parsed.data?.profile?.id || null,
          fullName: parsed.data?.profile?.full_name || null,
          username: parsed.data?.profile?.username || null,
          avatarUrl: parsed.data?.profile?.avatar_url || null,
          role: parsed.data?.profile?.role || null,
          language: localStorage.getItem("lang") || "en"
        });
        
        document.documentElement.setAttribute('data-auth-ready', isLoggedIn ? 'logged-in' : 'logged-out');
        document.documentElement.setAttribute('data-auth-fingerprint', fingerprint);
        
      } catch(e) {
        document.documentElement.setAttribute('data-auth-ready', 'error');
      }
    })();
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700;800&family=Lato:wght@400;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            display: ['Poppins', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#f0f7f5',
              100: '#e1efeb',
              200: '#c3e0d8',
              300: '#a5d0c4',
              400: '#6aae9d',
              500: '#4A8C82',
              600: '#3b7d71',
              700: '#186D50',
              800: '#145942',
              900: '#114a37'
            },
            accent: {
              yellow: '#FDEB71'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out',
            'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } }
          }
        }
      }
    }
  </script>

  <!-- Custom CSS -->
  <style>
    :root { --color-brand: #16a34a; --color-brand-dark: #15803d; --color-brand-light: #dcfce7; --color-accent: #f97316; --color-danger: #ef4444; --bg-main: #f8fafc; --bg-panel: #ffffff; --bg-input: #f1f5f9; --text-primary: #0f172a; --text-secondary: #64748b; --text-tertiary: #94a3b8; --text-light: #ffffff; --border: #e2e8f0; --radius-md: 12px; --radius-lg: 24px; --header-h: 64px; --footer-h: 64px; --shadow-panel: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    .site-header { background-color: var(--bg-panel); border-bottom: 1px solid var(--border); padding: 0 16px; position: sticky; top: 0; z-index: 50; }
    @media (min-width: 768px) { .site-header { padding: 0 24px; } }
    .site-header .container.header-grid { height: 72px; max-width: 1800px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand .logo-image { width: 40px; height: 40px; }
    .brand-text .title { font-family: 'Poppins', sans-serif; font-weight: 800; font-size: 1.1rem; color: var(--text-primary); }
    .brand-text .subtitle { display: none; }
    @media (min-width: 768px) { .brand-text .subtitle { display: block; font-family: 'Lato', sans-serif; font-size: 0.8rem; color: var(--text-secondary); max-width: 350px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } }
    .nav { display: none; }
    @media (min-width: 960px) { .nav { display: flex; align-items: center; gap: 24px; } }
    .nav .link { font-weight: 700; font-size: 0.9rem; font-family: 'Lato', sans-serif; color: var(--text-secondary); transition: color 0.2s; }
    .nav .link:hover, .nav .link.active { color: var(--color-brand); }
    .nav .divider { width: 1px; height: 20px; background-color: var(--border); }
    .lang-switch-slider { display: flex; cursor: pointer; background: var(--bg-input); border-radius: 99px; padding: 4px; position: relative; font-size: 12px; font-weight: 700; }
    .lang-switch-slider span { padding: 4px 12px; z-index: 1; transition: color 0.2s; user-select: none; }
    .lang-switch-slider::before { content: ''; position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: calc(100% - 8px); background: white; border-radius: 99px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
    .lang-switch-slider[data-lang="es"]::before { transform: translateX(100%); }
    .lang-switch-slider[data-lang="en"] span:first-child, .lang-switch-slider[data-lang="es"] span:last-child { color: var(--color-brand-dark); }
    .auth-area { display: flex; align-items: center; gap: 16px; }
    .profile-button { width: 36px; height: 36px; border-radius: 50%; background-color: var(--color-brand-light); color: var(--color-brand-dark); font-weight: 700; font-family: 'Poppins', sans-serif; display: grid; place-content: center; overflow: hidden; border: 2px solid var(--border); }
    #userName { font-weight: 700; font-size: 0.9rem; font-family: 'Lato', sans-serif; }
    .mobile-menu-btn { display: block; color: var(--text-secondary); }
    @media (min-width: 960px) { .mobile-menu-btn { display: none; } }
    .mobile-nav-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); z-index: 998; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .mobile-nav-overlay.is-open { opacity: 1; visibility: visible; }
    .mobile-nav-content { position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 320px; background: var(--bg-panel); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 1, 0.3, 1); display: flex; flex-direction: column; z-index: 999; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1); padding: 24px; }
    .is-open .mobile-nav-content { transform: translateX(0); }
    .mobile-nav-close-btn { position: absolute; top: 16px; right: 16px; color: var(--text-secondary); z-index: 10; }
    .mobile-nav-content > nav { display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%; padding-top: 48px; }
    .mobile-nav-content .link { font-size: 1.75rem; font-weight: 700; font-family: 'Poppins', sans-serif; color: var(--text-primary); width: 100%; padding: 12px 0; }
    .mobile-nav-content .link.active { color: var(--color-brand); }
    .mobile-nav-content .divider { display: none; }
    .mobile-nav-content .lang-switch-slider { order: -1; transform: scale(1.15); margin-bottom: 48px; }
    .mobile-nav-content .auth-area { margin-top: auto; width: 100%; padding-top: 24px; border-top: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .mobile-nav-content .auth-area .profile-button { width: 64px; height: 64px; font-size: 2rem; }
    .mobile-nav-content .auth-area #userNameMobile { font-weight: 600; font-size: 1.1rem; color: var(--text-primary); }
    .mobile-nav-content .auth-area #btnSignOutMobile, .mobile-nav-content .auth-area #btnSignInMobile { width: 100%; justify-content: center; padding: 12px 24px; font-size: 1rem; border-radius: var(--radius-md); }
    .btn { border: none; padding: 14px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--color-brand-dark); color: white; box-shadow: 0 4px 12px -2px rgba(22, 163, 74, 0.3); }
    .btn-primary:hover { background: #14532d; }
    .btn-secondary { background: white; border: 2px solid var(--border); color: var(--text-primary); }
    .btn-secondary:hover { border-color: var(--text-tertiary); background: var(--bg-input); }
    .btn-ghost { background: transparent; color: var(--text-secondary); font-size: 0.9rem; font-weight: 700; padding: 8px 12px; border-radius: 8px; }
    .btn-ghost:hover { background: var(--bg-input); color: var(--text-primary); }
    #btnSignIn { padding: 8px 16px; font-size: 0.9rem; border-radius: 8px; background: var(--color-brand); color: white;}
    #btnSignIn:hover { background: var(--color-brand-dark); }
    .site-footer { background-color: var(--bg-panel); border-top: 1px solid var(--border); padding: 24px; }
    .site-footer .container { max-width: 1800px; margin: 0 auto; }
    .site-footer small { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; font-size: 12px; color: var(--text-secondary); }
    .site-footer .footer-text { display: flex; align-items: center; flex-wrap: wrap; }
    .site-footer .footer-logos { display: flex; align-items: center; gap: 8px; }
    .site-footer .footer-logos img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    @media (max-width: 767px) { .site-footer small { flex-direction: column; text-align: center; } }
  </style>

  <style type="text/tailwindcss">
    @layer utilities {
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #a8b2c1; }
    }
    #flash {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(-150%);
      background-color: #0f172a;
      color: white;
      padding: 12px 24px;
      border-radius: 9999px;
      font-weight: 600;
      z-index: 1000;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    #flash.visible {
      transform: translateX(-50%) translateY(0);
    }
  </style>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="text-slate-800 flex flex-col h-full overflow-hidden selection:bg-brand-200 selection:text-brand-900">

  <!-- ================= HEADER ================= -->
  <header class="site-header">
    <div class="container header-grid">
      <a href="index.html" class="brand">
        <img src="static/icon.png" alt="Agrovoltaicos sin Fronteras logo" class="logo-image">
        <div class="brand-text">
          <div class="title">Agrovoltaicos sin Fronteras</div>
          <div class="subtitle" data-i18n="tagline">A seminar series to share advances in agrivoltaics in the Americas</div>
        </div>
      </a>
      <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>
      <!-- Desktop Nav -->
      <nav class="nav">
        <a href="index.html" class="link" data-i18n="nav.schedule">Schedule</a>
        <a href="archive.html" class="link" data-i18n="nav.archive">Archive</a>
        <a href="about.html" class="link active" data-i18n="nav.about">About</a>
        <a href="network.html" class="link" data-i18n="nav.network">Network</a>
        <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
        <div class="divider"></div>
        <div id="langSwitchDesktop" class="lang-switch-slider" data-lang="en">
          <span>EN</span>
          <span>ES</span>
        </div>
        <div class="auth-area">
          <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile" onclick="window.location.href='profile.html'">
            <span id="userInitial"></span>
            <img id="userAvatar" style="display: none; width: 100%; height: 100%; object-fit: cover;" alt="User Avatar" />
          </button>
          <span id="userName" style="display: none;"></span>
          <a href="signin.html" id="btnSignIn" data-i18n="auth.signin">Sign in</a>
          <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
            Sign out
          </button>
        </div>
      </nav>
    </div>
  </header>

  <!-- ================= MOBILE MENU OVERLAY ================= -->
  <div id="mobileNavOverlay" class="mobile-nav-overlay">
    <div class="mobile-nav-content"><!-- Injected by JS --></div>
  </div>

  <!-- ================= MAIN CONTENT ================= -->
  <main class="flex-1 relative overflow-hidden bg-gray-50">
    <div class="absolute inset-0 overflow-y-auto custom-scrollbar">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 py-8">
        <div class="bg-white rounded-3xl shadow-sm border border-gray-200 overflow-hidden">
          <img src="static/agrivUA.jpg" 
               alt="Agrivoltaic solar panels over a field of crops at the University of Arizona"
               class="w-full h-64 md:h-96 object-cover">
          <div class="p-8 md:p-12">
            <!-- English Content -->
            <div class="prose prose-lg max-w-none" data-lang-content="en">
              <h2 class="text-3xl font-bold font-display text-brand-700 mb-4">What is Agrivoltaics?</h2>
              <p class="text-gray-600 leading-relaxed">
                Agrivoltaics is the integration of solar photovoltaics with agricultural production in the same space. 
                Agrivoltaics is a highly diverse field that can include energy production from household to utility scale, 
                and agricultural production from horticulture to field crops to livestock and more. Topics covered in this 
                seminar series will include agrivoltaic system design, crop yield and responses, business models, community 
                engagement, governance and legal frameworks, and much more.
              </p>

              <h2 class="text-3xl font-bold font-display text-brand-700 mb-4 mt-8">Attend the seminars:</h2>
              <p class="text-gray-600 leading-relaxed">
                To attend the seminars, simply 
                <a href="https://arizona.zoom.us/meeting/register/rFJXhrYpQL2Vcw30vlxwyA" 
                   target="_blank" rel="noopener noreferrer" 
                   class="text-brand-600 hover:text-brand-700 font-semibold underline">register here</a> 
                and you will receive the zoom meeting link to your email. This link will work for all future seminars, 
                so you only need to register once.
              </p>

              <h2 class="text-3xl font-bold font-display text-brand-700 mb-4 mt-8">Contact Us:</h2>
              <p class="text-gray-600 leading-relaxed">
                Agrovoltaicos sin Fronteras is jointly hosted by UNAM and the University of Arizona. 
                For more information, please contact Christine Lamanna 
                <a href="mailto:clamanna@arizona.edu" class="text-brand-600 hover:text-brand-700 font-semibold underline">clamanna@arizona.edu</a>.
              </p>
            </div>

            <!-- Spanish Content -->
            <div class="prose prose-lg max-w-none hidden" data-lang-content="es">
              <h2 class="text-3xl font-bold font-display text-brand-700 mb-4">Â¿QuÃ© son los Agrovoltaicos?</h2>
              <p class="text-gray-600 leading-relaxed">
                Los Agrovoltaicos son la integraciÃ³n de la energÃ­a solar fotovoltaica con la producciÃ³n agrÃ­cola en un mismo espacio. 
                Es un campo muy diverso que abarca la producciÃ³n de energÃ­a desde el hogar hasta la escala de servicios pÃºblicos, 
                y la producciÃ³n agrÃ­cola desde la horticultura hasta los cultivos extensivos, la ganaderÃ­a y mÃ¡s. 
                Los temas que se abordarÃ¡n en esta serie de seminarios incluirÃ¡n el diseÃ±o de sistemas agrovoltaicos, 
                el rendimiento y las respuestas de los cultivos, los modelos de negocio, la participaciÃ³n comunitaria, 
                la gobernanza y los marcos legales, y mucho mÃ¡s.
              </p>

              <h2 class="text-3xl font-bold font-display text-brand-700 mb-4 mt-8">Asista a los seminarios:</h2>
              <p class="text-gray-600 leading-relaxed">
                Para asistir a los seminarios, simplemente 
                <a href="https://arizona.zoom.us/meeting/register/rFJXhrYpQL2Vcw30vlxwyA" 
                   target="_blank" rel="noopener noreferrer"
                   class="text-brand-600 hover:text-brand-700 font-semibold underline">regÃ­strese aquÃ­</a> 
                y recibirÃ¡ el enlace de la reuniÃ³n de Zoom en su correo electrÃ³nico. 
                Este enlace funcionarÃ¡ para todos los seminarios futuros, por lo que solo necesita registrarse una vez.
              </p>

              <h2 class="text-3xl font-bold font-display text-brand-700 mb-4 mt-8">ContÃ¡ctenos:</h2>
              <p class="text-gray-600 leading-relaxed">
                Agrovoltaicos sin Fronteras es un evento conjunto de la UNAM y la Universidad de Arizona. 
                Para obtener mÃ¡s informaciÃ³n, comunÃ­quese con Christine Lamanna 
                <a href="mailto:clamanna@arizona.edu" class="text-brand-600 hover:text-brand-700 font-semibold underline">clamanna@arizona.edu</a>.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ================= FOOTER ================= -->
  <footer class="site-footer">
    <div class="container">
      <small>
        <div class="footer-text">
          Â© <span id="year"></span> Agrovoltaicos sin Fronteras â€¢&nbsp;
          <span data-i18n="footer.note">Bilingual, community-driven seminar on agrivoltaics in Latin America.</span>
        </div>
        <div class="footer-logos">
          <a href="https://biosphere2.org/research/research-initiatives/agrivoltaics" target="_blank" rel="noopener noreferrer">
            <img src="static/b2ua.jpg" alt="Biosphere 2 Agrivoltaics">
          </a>
          <a href="https://www.ier.unam.mx/ParcelaAgrovoltaica.html" target="_blank" rel="noopener noreferrer">
            <img src="static/unam.png" alt="UNAM">
          </a>
          <a href="https://centroenergia.cl/2o-simposium-nacional-agrovoltaico-aal-alianza-agrovoltaica-latinoamericana" target="_blank" rel="noopener noreferrer">
            <img src="static/aal.png" alt="AAL - Alianza Agrovoltaica Latinoamericana" style="background-color: white;">
          </a>
          <a href="https://redagvmx.com" target="_blank" rel="noopener noreferrer">
            <img src="static/rame.png" alt="Rame - Red Agrivoltaica de MÃ©xico" style="background-color: white;">
          </a>
        </div>
      </small>
    </div>
  </footer>

  <!-- ================= JAVASCRIPT LOGIC ================= -->
  <script type="module">
    import { supabase, authState, initAuth, signOut } from './auth.js';
    
    let headerState = { lastRenderedFingerprint: null };
    const state = { language: localStorage.getItem("lang") || "en" };
    
    const t = {
      en: {
        tagline: "Seminar series on agrivoltaics in the Americas",
        nav: { schedule: "Schedule", archive: "Archive", about: "About", network: "Network", admin: "Admin" },
        auth: { signin: "Sign in", signout: "Sign out" },
        footer: { note: "Bilingual, community-driven seminar on agrivoltaics in Latin America." }
      },
      es: {
        tagline: "Serie de seminarios sobre agrovoltaicos en las AmÃ©ricas",
        nav: { schedule: "Calendario", archive: "Archivo", about: "Acerca de", network: "Red", admin: "Admin" },
        auth: { signin: "Iniciar sesiÃ³n", signout: "Cerrar sesiÃ³n" },
        footer: { note: "Seminario bilingÃ¼e y comunitario sobre agrofotovoltaica en AmÃ©rica Latina." }
      }
    };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const show = (el) => el?.classList.remove('hidden');
    const hide = (el) => el?.classList.add('hidden');
    function tr(key, fallback = "") { const lang = state.language; const parts = key.split("."); let obj = t[lang]; for (const p of parts) obj = obj?.[p]; return obj ?? fallback; }
    function setFlash(msg, timeout = 3000) { const el = $("#flash"); if (!el) return; el.textContent = msg; el.classList.add("visible"); clearTimeout(setFlash._t); if (timeout > 0) { setFlash._t = setTimeout(() => el.classList.remove("visible"), timeout); } }
    function escapeHtml(s = "") { return String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])); }
    async function getAvatarUrl(path) { if (!path) return null; if (path.startsWith('http')) return path; const SUPABASE_URL = "https://iuzgfldgvueuehybgntm.supabase.co"; return `${SUPABASE_URL}/storage/v1/object/public/avatars/${path}`; }
    
    function applyI18n() {
      $$("[data-i18n]").forEach((el) => { el.textContent = tr(el.dataset.i18n, el.textContent); });
      $$("[data-i18n-placeholder]").forEach((el) => { el.placeholder = tr(el.dataset.i18nPlaceholder, el.placeholder); });
      $$(".lang-switch-slider").forEach(el => el.dataset.lang = state.language);
      // Show/hide language content
      $$("[data-lang-content]").forEach(el => {
        if (el.dataset.langContent === state.language) {
          show(el);
        } else {
          hide(el);
        }
      });
    }
    
    function updateActiveNav() {
      const currentPage = window.location.pathname.split('/').pop() || 'index.html';
      $$('.nav .link, .mobile-nav-content .link').forEach(link => {
        const linkPage = link.getAttribute('href');
        if (linkPage === currentPage) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    function toggleMobileMenu(forceState) {
      const overlay = $('#mobileNavOverlay');
      const showMenu = forceState !== undefined ? forceState : !overlay.classList.contains('is-open');
      overlay.classList.toggle('is-open', showMenu);
    }

    async function renderHeader() {
      const fingerprint = JSON.stringify({
        hasSession: !!authState.session,
        userId: authState.session?.user?.id || null,
        profileId: authState.profile?.id || null,
        fullName: authState.profile?.full_name || null,
        avatarUrl: authState.profile?.avatar_url || null,
        role: authState.profile?.role || null,
        language: state.language
      });

      const preloadFingerprint = document.documentElement.getAttribute('data-auth-fingerprint');
      if (preloadFingerprint === fingerprint && headerState.lastRenderedFingerprint === null) {
        headerState.lastRenderedFingerprint = fingerprint;
        document.getElementById('auth-preload-style')?.remove();
        document.documentElement.removeAttribute('data-auth-fingerprint');
        applyI18n();
        updateActiveNav();
        return;
      }
      if (headerState.lastRenderedFingerprint === fingerprint) return;
      headerState.lastRenderedFingerprint = fingerprint;

      const btnProfile = $('#btnProfile'), userInitial = $('#userInitial'), userAvatar = $('#userAvatar'), userName = $('#userName'), btnSignIn = $('#btnSignIn'), btnSignOut = $('#btnSignOut'), btnAdmin = $('#btnAdmin');
      const mobileNavContent = $('.mobile-nav-content');
      const isOrganizer = ["organizer", "admin"].includes(authState.profile?.role);
      
      if (authState.session && authState.profile) {
        show(btnProfile); show(btnSignOut); show(userName); hide(btnSignIn);
        userName.textContent = authState.profile.full_name || authState.profile.username || '';
        const avatarPath = authState.profile.avatar_url;
        const avatarUrl = avatarPath ? await getAvatarUrl(avatarPath) : null;
        if (avatarUrl) {
          userAvatar.src = avatarUrl; show(userAvatar); hide(userInitial);
        } else {
          userInitial.textContent = (authState.profile.full_name || "U").charAt(0).toUpperCase();
          hide(userAvatar); show(userInitial);
        }
        if (isOrganizer) show(btnAdmin); else hide(btnAdmin);
      } else {
        hide(btnProfile); hide(btnSignOut); hide(userName); show(btnSignIn);
        hide(btnAdmin);
      }
      
      if (mobileNavContent) {
        const avatarPath = authState.profile?.avatar_url;
        const avatarUrl = avatarPath ? await getAvatarUrl(avatarPath) : null;
        const initial = (authState.profile?.full_name || "U").charAt(0).toUpperCase();

        mobileNavContent.innerHTML = `
          <button id="mobileNavCloseBtn" class="mobile-nav-close-btn" aria-label="Close menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
          <nav>
            <div id="langSwitchMobile" class="lang-switch-slider" data-lang="${state.language}"><span>EN</span><span>ES</span></div>
            <a href="index.html" class="link" data-i18n="nav.schedule"></a>
            <a href="archive.html" class="link" data-i18n="nav.archive"></a>
            <a href="about.html" class="link active" data-i18n="nav.about"></a>
            <a href="network.html" class="link" data-i18n="nav.network"></a>
            ${isOrganizer ? `<a href="admin.html" class="link" data-i18n="nav.admin"></a>` : ''}
            <div class="auth-area">
              ${authState.session && authState.profile ? `
                <button class="profile-button" onclick="window.location.href='profile.html'">
                  ${avatarUrl ? `<img src="${avatarUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="User Avatar" />` : `<span>${initial}</span>`}
                </button>
                <span id="userNameMobile">${escapeHtml(authState.profile.full_name || "")}</span>
                <button id="btnSignOutMobile" class="btn btn-secondary"><span data-i18n="auth.signout"></span></button>
              ` : `
                <a href="signin.html" id="btnSignInMobile" class="btn btn-primary"><span data-i18n="auth.signin"></span></a>
              `}
            </div>
          </nav>
        `;
      }
      
      document.getElementById('auth-preload-style')?.remove();
      applyI18n();
      updateActiveNav();
    }
    
    function handleLangSwitch() { 
      state.language = state.language === 'en' ? 'es' : 'en'; 
      localStorage.setItem("lang", state.language); 
      applyI18n(); 
    }

    function wireUI() {
      $('#mobileMenuBtn').addEventListener('click', () => toggleMobileMenu(true));
      document.body.addEventListener('click', e => {
        if (e.target.closest('#btnSignOut') || e.target.closest('#btnSignOutMobile')) signOut();
        if (e.target.closest('#langSwitchDesktop') || e.target.closest('#langSwitchMobile')) handleLangSwitch();
        if (e.target.id === 'mobileNavOverlay' || e.target.closest('#mobileNavCloseBtn')) toggleMobileMenu(false);
      });
      $("#year").textContent = new Date().getFullYear();
    }

    (async function main() {
      wireUI();
      await initAuth({ onAuthReady: renderHeader, onAuthChange: renderHeader });
      lucide.createIcons();
    })();
  </script>

</body>
</html>
