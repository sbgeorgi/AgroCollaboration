<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50 antialiased">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Network Map • Agrovoltaicos sin Fronteras</title>
  <meta name="description" content="A map of agrivoltaics projects and collaborators in the Americas.">

  <!-- Critical pre-render script -->
  <script src="auth-preloader.js"></script>

  <!-- Leaflet Map Library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&family=Poppins:wght@600;700;800&display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Global Styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Quill.js (Rich Text Editor) v2.0 -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

  <!-- External Tailwind Config -->
  <script src="theme.js"></script>

  <!-- Custom CSS & Theme Overrides (Synced with Admin) -->
  <style type="text/tailwindcss">
    @layer utilities {
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
      .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; border: 2px solid transparent; background-clip: content-box; }
    }

    html, body { height: 100%; overflow: hidden; }

    /* Input Field matching styles.css/admin.html via Tailwind layer */
    .input-field {
        @apply w-full px-4 py-2.5 bg-[var(--bg-input)] border border-transparent rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--color-brand-light)] focus:border-[var(--color-brand)] transition-all text-sm text-slate-800 placeholder:text-slate-400 shadow-inner;
    }
    .input-field:hover {
        @apply bg-white shadow-sm;
    }
    .label-text {
        @apply block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5;
    }

    /* Quill Editor Customization to match Admin */
    .editor-wrapper {
      @apply w-full bg-[var(--bg-input)] border border-transparent rounded-xl transition-all shadow-inner overflow-hidden;
    }
    .editor-wrapper:hover {
      @apply bg-white shadow-sm;
    }
    .editor-wrapper:focus-within {
      @apply ring-2 ring-[var(--color-brand-light)] border-[var(--color-brand)] bg-white;
    }
    
    .ql-toolbar.ql-snow {
      border: none !important;
      border-bottom: 1px solid rgba(0,0,0,0.05) !important;
      background: rgba(255,255,255,0.5);
      padding: 6px 8px !important;
    }
    .ql-container.ql-snow {
      border: none !important;
      font-family: 'Inter', sans-serif !important;
      font-size: 0.875rem !important;
    }
    .ql-editor {
      min-height: 100px;
      padding: 12px 16px !important;
      color: #1e293b;
    }
    .ql-editor.ql-blank::before {
      color: #94a3b8 !important;
      font-style: normal !important;
    }
    /* Toolbar button adjustments */
    .ql-snow .ql-stroke { stroke: #64748b !important; }
    .ql-snow .ql-fill { fill: #64748b !important; }
    .ql-snow .ql-picker { color: #64748b !important; }
  </style>

  <!-- Map Specific Styles -->
  <style>
    .leaflet-container {
      width: 100% !important;
      height: 100% !important;
      font-family: 'Inter', sans-serif !important;
      z-index: 0;
      background: #f8fafc;
    }

    #view-panel,
    #edit-panel {
      transition-timing-function: cubic-bezier(0.32, 0.72, 0, 1);
    }

    /* Carousel & Other Components */
    .carousel-container { position: relative; width: 100%; height: 220px; background: #f1f5f9; border-radius: 12px; overflow: hidden; }
    .carousel-track { display: flex; height: 100%; transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); }
    .carousel-slide { width: 100%; height: 100%; flex-shrink: 0; }
    .carousel-slide img, .carousel-slide video { width: 100%; height: 100%; object-fit: cover; }
    .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0, 0, 0, 0.4); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: all 0.3s; z-index: 2; backdrop-filter: blur(4px); }
    .carousel-container:hover .carousel-btn { opacity: 1; }
    .carousel-btn:hover { background: rgba(0, 0, 0, 0.7); }
    .carousel-btn.prev { left: 12px; }
    .carousel-btn.next { right: 12px; }
    .carousel-indicators { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 2; }
    .carousel-dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(255, 255, 255, 0.5); transition: all 0.3s; cursor: pointer; }
    .carousel-dot.active { width: 16px; border-radius: 4px; background: white; }

    /* Upload Area */
    .media-upload-area { background: var(--bg-input); border: 2px dashed #cbd5e1; border-radius: 12px; padding: 24px; text-align: center; transition: all 0.3s; position: relative; cursor: pointer; }
    .media-upload-area:hover { border-color: var(--color-brand); background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .media-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; margin-top: 16px; }
    .media-preview-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; background: #e2e8f0; border: 1px solid var(--border); }
    .media-preview-item img, .media-preview-item video { width: 100%; height: 100%; object-fit: cover; }
    .media-preview-remove { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background: rgba(220, 38, 38, 0.9); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }

    /* User Search & Table */
    .user-search-wrapper { position: relative; }
    #userSearchResults { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 12px; margin-top: 4px; z-index: 100; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); display: none; }
    .user-search-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; cursor: pointer; transition: background-color 0.2s; font-size: 14px; }
    .user-search-item:hover { background-color: var(--color-brand-light); }
    .user-search-item img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
    #selectedUsers { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .selected-user-pill { display: flex; align-items: center; gap: 6px; background: var(--color-brand-light); padding: 4px 8px 4px 4px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: var(--color-brand-dark); border: 1px solid var(--border); }
    .selected-user-pill img { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; }
    .selected-user-pill button { margin-left: 4px; color: var(--color-brand-dark); opacity: 0.6; }
    .selected-user-pill button:hover { opacity: 1; }
    #projects-table th { cursor: pointer; user-select: none; font-family: 'Poppins', sans-serif; }
    #projects-table th:hover { background-color: #f8fafc; }
    #projects-table th .sort-icon { opacity: 0.3; transition: opacity 0.2s; display: inline-block; vertical-align: middle; margin-left: 4px; width: 14px; height: 14px; }
    #projects-table th.sort-asc .sort-icon, #projects-table th.sort-desc .sort-icon { opacity: 1; color: var(--color-brand); }
    #projects-table tbody tr.selected { background-color: var(--color-brand-light); }
    #projects-table tbody tr.selected td:first-child { color: var(--color-brand-dark); font-weight: 700; position: relative; }
    #projects-table tbody tr.selected td:first-child::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--color-brand); }
  </style>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="text-slate-800 flex flex-col h-full overflow-hidden selection:bg-brand-100 selection:text-brand-900 font-sans">

  <!-- ================= FLASH MESSAGES ================= -->
  <div id="flash" class="flash"></div>

  <!-- ================= MAIN CONTENT ================= -->
  <main class="flex-1 relative overflow-hidden bg-gray-50 flex flex-col items-center">

    <!-- Inner Container -->
    <div class="w-full h-full max-w-[1800px] px-4 sm:px-6 py-6 flex flex-col lg:flex-row gap-6 relative">

      <!-- MAP PANEL -->
      <div class="flex-1 lg:flex-[1.4] relative rounded-[1.5rem] overflow-hidden border border-gray-200 shadow-sm bg-white z-0 flex flex-col">
        <div id="map" class="flex-1 w-full h-full z-10"></div>
        <button id="addPointBtn" class="hidden absolute top-4 right-4 z-20 bg-brand-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-brand-700 transition-colors active:scale-95 items-center gap-2 border border-white/20 backdrop-blur-sm">
          <i data-lucide="plus-circle" class="w-5 h-5"></i>
          <span data-i18n="map.add">Add Point</span>
        </button>

        <!-- View Panel -->
        <div id="view-panel" class="absolute top-0 left-0 h-full w-full md:max-w-md bg-white/95 backdrop-blur-md shadow-2xl z-30 transform -translate-x-full border-r border-gray-200 flex flex-col">
          <button id="closeViewPanelBtn" class="absolute top-3 right-3 z-50 p-2 bg-white text-slate-500 hover:text-brand-600 hover:bg-brand-50 rounded-full shadow-sm border border-gray-200 transition-all">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
          <div id="view-panel-content" class="flex-1 overflow-y-auto custom-scrollbar p-6"></div>
        </div>

        <!-- Edit Panel -->
        <div id="edit-panel" class="absolute top-0 right-0 h-full w-full md:max-w-2xl bg-white shadow-2xl z-30 transform translate-x-full flex flex-col border-l border-gray-200">
          <div class="p-5 border-b border-gray-100 flex justify-between items-center flex-shrink-0 bg-white z-10">
            <h2 id="panel-title" class="font-display font-bold text-xl text-slate-800" data-i18n="map.add_panel_title">Add New Point</h2>
            <button id="closePanelBtn" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors">
              <i data-lucide="x" class="w-6 h-6"></i>
            </button>
          </div>

          <form id="point-form" class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-gray-50/50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input type="hidden" id="pointId">

              <!-- Media Upload -->
              <div class="md:col-span-2">
                <label class="label-text" for="mediaUpload" data-i18n="form.media">Media</label>
                <div id="mediaDropZone" class="media-upload-area group">
                  <i data-lucide="upload-cloud" class="w-10 h-10 text-brand-300 mx-auto mb-2 group-hover:text-brand-500 transition-colors"></i>
                  <div class="text-sm font-medium text-slate-600">Drop videos or images here</div>
                  <div class="text-xs text-slate-400 mt-1">Videos first. PNG, JPG, MP4 up to 10MB.</div>
                  <input type="file" id="mediaUpload" accept="image/*,video/*" multiple style="display: none;">
                </div>
                <div id="mediaPreviewGrid" class="media-preview-grid"></div>
              </div>

              <!-- Collaborators -->
              <div class="md:col-span-2">
                <label class="label-text" for="userSearch" data-i18n="form.collaborators">Collaborators</label>
                <div id="selectedUsers"></div>
                <div class="user-search-wrapper">
                  <input type="text" id="userSearch" class="input-field" placeholder="Search for users..." autocomplete="off">
                  <div id="userSearchResults" class="custom-scrollbar"></div>
                </div>
              </div>

              <!-- Basic Info -->
              <div>
                <label class="label-text" for="name" data-i18n="form.institution">Institution (Required)</label>
                <input id="name" class="input-field" required />
              </div>
              
              <div>
                <label class="label-text" for="project_name" data-i18n="form.project_name">Project Name (Required)</label>
                <input id="project_name" class="input-field" required />
              </div>
              
              <div>
                <label class="label-text" for="latitude" data-i18n="form.latitude">Latitude (Required)</label>
                <input id="latitude" type="number" step="any" class="input-field" required />
              </div>
              
              <div>
                <label class="label-text" for="longitude" data-i18n="form.longitude">Longitude (Required)</label>
                <input id="longitude" type="number" step="any" class="input-field" required />
              </div>

              <div>
                <label class="label-text" for="system_category" data-i18n="form.system_category">System Type (Required)</label>
                <select id="system_category" class="input-field cursor-pointer" required>
                  <option value="Crops">Crops</option>
                  <option value="Livestock">Livestock</option>
                  <option value="Ecovoltaics">Ecovoltaics</option>
                  <option value="Aquaculture">Aquaculture</option>
                  <option value="Mixed">Mixed</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div>
                <label class="label-text" for="start_year" data-i18n="form.start_year">Start Year (Required)</label>
                <input id="start_year" type="number" class="input-field" required />
              </div>

              <div class="md:col-span-2">
                <label class="label-text" for="associated_crops" data-i18n="form.associated_crops">Target Species / Crops (Required)</label>
                <input id="associated_crops" class="input-field" required placeholder="e.g. Tomatoes, Sheep, Native Pollinators..." />
              </div>
              
              <div class="md:col-span-2">
                <label class="label-text" for="av_system_type" data-i18n="form.av_system_type">AV System Tech (Required)</label>
                <input id="av_system_type" class="input-field" placeholder="e.g., Elevated, Tracking, Vertical..." required />
              </div>

              <div class="md:col-span-2"><hr class="border-gray-200 my-2"></div>

              <div>
                <label class="label-text" for="generating_capacity_kw" data-i18n="form.generating_capacity_kw">Capacity (kW)</label>
                <input id="generating_capacity_kw" type="number" step="any" class="input-field" />
              </div>
              
              <div>
                <label class="label-text" for="area" data-i18n="form.area">Area (m²)</label>
                <input id="area" class="input-field" />
              </div>

              <div>
                <label class="label-text" for="keywords" data-i18n="form.keywords">Keywords</label>
                <input id="keywords" class="input-field" placeholder="Research, Commercial..." />
              </div>
              
              <div>
                <label class="label-text" for="link" data-i18n="form.link">Website Link</label>
                <input id="link" type="url" class="input-field" />
              </div>

              <div class="md:col-span-2">
                <label class="label-text" for="affiliation" data-i18n="form.affiliation">Affiliation</label>
                <input id="affiliation" class="input-field" />
              </div>

              <!-- RICH TEXT EDITORS -->
              <div class="md:col-span-2">
                <label class="label-text" data-i18n="form.description">Description</label>
                <div class="editor-wrapper">
                  <div id="description"></div>
                </div>
              </div>
              
              <div class="md:col-span-2">
                <label class="label-text" data-i18n="form.leadership">Leadership</label>
                <div class="editor-wrapper">
                  <div id="leadership"></div>
                </div>
              </div>
              
              <div class="md:col-span-2">
                <label class="label-text" data-i18n="form.facilities">Facilities</label>
                <div class="editor-wrapper">
                  <div id="facilities"></div>
                </div>
              </div>
              
              <div class="md:col-span-2">
                <label class="label-text" data-i18n="form.equipment">Equipment</label>
                <div class="editor-wrapper">
                  <div id="equipment"></div>
                </div>
              </div>
              
              <div class="md:col-span-2">
                <label class="label-text" data-i18n="form.capabilities">Capabilities</label>
                <div class="editor-wrapper">
                  <div id="capabilities"></div>
                </div>
              </div>
              
              <div class="md:col-span-2">
                <label class="label-text" data-i18n="form.experiments">Experiments</label>
                <div class="editor-wrapper">
                  <div id="experiments"></div>
                </div>
              </div>

            </div>

            <div class="mt-6 pt-6 border-t border-gray-200 flex justify-end gap-3 bg-gray-50/50 sticky bottom-0 z-20">
              <button type="button" id="cancelBtn" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-gray-200 rounded-xl transition-colors" data-i18n="form.cancel">Cancel</button>
              <button type="submit" id="saveBtn" class="px-5 py-2 text-sm font-bold text-white bg-brand-600 hover:bg-brand-700 rounded-xl shadow-sm transition-colors" data-i18n="form.save">Save Point</button>
            </div>
          </form>
        </div>
      </div>

      <!-- TABLE PANEL -->
      <div class="flex-1 lg:flex-[1.2] rounded-[1.5rem] overflow-hidden border border-gray-200 shadow-sm bg-white flex flex-col relative">
        <div class="flex-1 overflow-y-auto custom-scrollbar">
          <table id="projects-table" class="w-full text-left border-collapse">
            <thead class="bg-white sticky top-0 z-10 shadow-sm text-xs font-bold uppercase text-slate-500 tracking-wider">
              <tr>
                <th class="p-4 border-b border-gray-100" data-sort="project_name"><div class="flex items-center gap-1"><span data-i18n="table.project_name">Project Name</span><i class="sort-icon" data-lucide="chevrons-up-down"></i></div></th>
                <th class="p-4 border-b border-gray-100" data-sort="name"><div class="flex items-center gap-1"><span data-i18n="table.institution">Institution</span><i class="sort-icon" data-lucide="chevrons-up-down"></i></div></th>
                <th class="p-4 border-b border-gray-100" data-sort="system_category"><div class="flex items-center gap-1"><span data-i18n="table.category">System Type</span><i class="sort-icon" data-lucide="chevrons-up-down"></i></div></th>
                <th class="p-4 border-b border-gray-100 sort-desc" data-sort="generating_capacity_kw"><div class="flex items-center gap-1"><span data-i18n="table.capacity">Capacity (kW)</span><i class="sort-icon" data-lucide="chevron-down"></i></div></th>
                <th class="p-4 border-b border-gray-100" data-sort="start_year"><div class="flex items-center gap-1"><span data-i18n="table.start_year">Year</span><i class="sort-icon" data-lucide="chevrons-up-down"></i></div></th>
              </tr>
            </thead>
            <tbody class="text-sm text-slate-700 divide-y divide-gray-50"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { renderLayout } from './layout.js';
    import { authState, initAuth, signOut } from './auth.js';
    import { initSharedUI, renderHeader, applyI18n as applySharedI18n, getAvatarUrl, show, hide } from './ui.js';
    import { initMap } from './map.js';

    renderLayout('map');

    const t = {
      en: {
        auth: { signin: "Sign in", signout: "Sign out" },
        nav: { schedule: "Schedule", archive: "Archive", about: "About", network: "Network", map: "Map", admin: "Admin" },
        footer: { note: "Bilingual, community-driven seminar on agrivoltaics in the Americas." },
        map: { add: "Add New Point", add_panel_title: "Add New Point" },
        form: {
          media: "Media", collaborators: "Collaborators", institution: "Institution (Required)",
          project_name: "Project Name (Required)", latitude: "Latitude (Required)", longitude: "Longitude (Required)",
          start_year: "Start Year (Required)", area: "Area (m²)", associated_crops: "Target Species / Crops (Required)",
          av_system_type: "AV System Tech (Required)", system_category: "System Type (Required)", generating_capacity_kw: "Capacity (kW)",
          keywords: "Keywords", affiliation: "Affiliation", link: "Website Link", description: "Description",
          leadership: "Leadership", facilities: "Facilities", equipment: "Equipment", capabilities: "Capabilities",
          experiments: "Experiments", cancel: "Cancel", save: "Save Point"
        },
        table: { project_name: "Project Name", institution: "Institution", start_year: "Year", capacity: "Capacity (kW)", category: "System Type" }
      },
      es: {
        auth: { signin: "Ingresar", signout: "Salir" },
        nav: { schedule: "Programa", archive: "Archivo", about: "Acerca de", network: "Red", map: "Mapa", admin: "Admin" },
        footer: { note: "Seminario bilingüe impulsado por la comunidad sobre agrovoltaica en las Américas." },
        map: { add: "Añadir Nuevo Punto", add_panel_title: "Añadir Nuevo Punto" },
        form: {
          media: "Multimedia", collaborators: "Colaboradores", institution: "Institución (Obligatorio)",
          project_name: "Nombre del Proyecto (Obligatorio)", latitude: "Latitud (Obligatorio)", longitude: "Longitud (Obligatorio)",
          start_year: "Año de Inicio (Obligatorio)", area: "Superficie (m²)", associated_crops: "Especies Objetivo / Cultivos (Obligatorio)",
          av_system_type: "Tecnología de Sistema AV (Obligatorio)", system_category: "Tipo de Sistema (Obligatorio)", generating_capacity_kw: "Capacidad (kW)",
          keywords: "Palabras Clave", affiliation: "Afiliación", link: "Sitio Web", description: "Descripción",
          leadership: "Liderazgo", facilities: "Instalaciones", equipment: "Equipamiento", capabilities: "Capacidades",
          experiments: "Experimentos", cancel: "Cancelar", save: "Guardar Punto"
        },
        table: { project_name: "Nombre del Proyecto", institution: "Institución", start_year: "Año", capacity: "Capacidad (kW)", category: "Tipo de Sistema" }
      }
    };

    function updateLangToggleUI(lang) {
      const s = document.querySelector('#langSwitchDesktop div:last-child');
      if (s) { s.style.transform = lang === 'es' ? 'translateX(100%)' : 'translateX(0)'; s.innerText = lang.toUpperCase(); }
    }

    function handleLangSwitch() {
      const currentLang = localStorage.getItem("lang") || "en";
      const newLang = currentLang === 'en' ? 'es' : 'en';
      localStorage.setItem("lang", newLang);
      applySharedI18n(t, newLang);
      updateLangToggleUI(newLang);
    }

    (async function main() {
      try {
        initSharedUI({ onLangSwitch: handleLangSwitch, onSignOut: signOut });
        document.addEventListener('click', e => { if (e.target.id === 'userName') window.location.href = 'profile.html'; });

        const initialLang = localStorage.getItem("lang") || "en";
        await initAuth({
          onAuthReady: (currentAuthState) => {
            renderHeader(currentAuthState, t, initialLang);
            updateLangToggleUI(initialLang);
            if (currentAuthState.profile?.avatar_url) {
              getAvatarUrl(currentAuthState.profile.avatar_url).then(url => {
                const img = document.getElementById('userAvatar');
                if (url && img) { img.src = url; show(img); hide(document.getElementById('userInitial')); }
              });
            }
          },
          onAuthChange: (currentAuthState) => {
            const currentLang = localStorage.getItem("lang") || "en";
            renderHeader(currentAuthState, t, currentLang);
            updateLangToggleUI(currentLang);
          }
        });
        
        initMap();
        applySharedI18n(t, initialLang);
        lucide.createIcons();
        setTimeout(() => { if (window.map && typeof window.map.invalidateSize === 'function') window.map.invalidateSize(); }, 200);
      } catch (error) { console.error('[map.html] Initialization error:', error); }
    })();
  </script>
</body>
</html>