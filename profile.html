<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50 antialiased">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile Dashboard â€¢ Agrovoltaicos sin Fronteras</title>

    <!-- Critical pre-render script to prevent UI flicker -->
    <script src="auth-preloader.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="theme.js"></script>

    <!-- Tom Select (Modern Dropdown Library) -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.default.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <!-- Quill.js (Rich Text Editor) -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

    <!-- Custom CSS -->
    <style type="text/tailwindcss">
        @layer utilities {
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    }

    html, body { height: 100%; overflow: hidden; }
    
    /* Flash Notification */
    #flash {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(-150%);
        background-color: #0f172a;
        color: white;
        padding: 10px 20px;
        border-radius: 9999px;
        font-weight: 500;
        font-size: 0.9rem;
        z-index: 9999;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex; align-items: center; gap: 8px; opacity: 0;
    }
    #flash.visible { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Avatar Hover Overlay */
    .avatar-overlay {
      background: rgba(0,0,0,0.4);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .avatar-container:hover .avatar-overlay { opacity: 1; }

    /* Quill Editor Customization */
    .editor-wrapper {
      @apply w-full bg-gray-50 border border-gray-200 rounded-xl transition-all overflow-hidden;
    }
    .editor-wrapper:hover {
      @apply bg-white shadow-sm border-gray-300;
    }
    .editor-wrapper:focus-within {
      @apply ring-2 ring-brand-100 border-brand-500 bg-white;
    }
    
    .ql-toolbar.ql-snow {
      border: none !important;
      border-bottom: 1px solid rgba(0,0,0,0.05) !important;
      background: rgba(255,255,255,0.5);
      padding: 6px 8px !important;
    }
    .ql-container.ql-snow {
      border: none !important;
      font-family: 'Inter', sans-serif !important;
      font-size: 14px !important;
    }
    .ql-editor {
      min-height: 100px;
      padding: 12px 16px !important;
      color: #1e293b;
    }
    .ql-editor.ql-blank::before {
      color: #94a3b8 !important;
      font-style: normal !important;
    }
    /* Fix toolbars icons color */
    .ql-snow .ql-stroke { stroke: #64748b !important; }
    .ql-snow .ql-fill { fill: #64748b !important; }
    .ql-snow .ql-picker { color: #64748b !important; }

    /* Tom Select Customization to match theme */
    .ts-control {
        @apply w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-800 shadow-none transition-all;
        min-height: 46px;
        display: flex; align-items: center;
    }
    .ts-control.focus {
        @apply ring-2 ring-brand-100 border-brand-500 bg-white shadow-none;
    }
    .ts-dropdown {
        @apply rounded-xl border-gray-200 shadow-lg mt-1 overflow-hidden z-50;
    }
    .ts-dropdown .option {
        @apply px-4 py-2.5 text-sm text-slate-700 cursor-pointer;
    }
    .ts-dropdown .active {
        @apply bg-brand-50 text-brand-700;
    }
  </style>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="text-slate-800 flex flex-col h-full overflow-hidden font-sans">

    <!-- Main App Container (Header/Footer injected via layout.js) -->
    <main class="flex-1 relative overflow-hidden bg-gray-50 overflow-y-auto">

        <!-- View: Loading Spinner -->
        <div id="view-loading" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-50">
            <div class="w-10 h-10 border-2 border-gray-200 border-t-brand-600 rounded-full animate-spin"></div>
        </div>

        <!-- View: Auth Required Prompt -->
        <div id="view-auth-required" class="hidden min-h-full flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-8 max-w-md w-full text-center">
                <div
                    class="w-16 h-16 bg-brand-50 text-brand-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="lock" class="w-8 h-8"></i>
                </div>
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-3" data-i18n="auth.signin_prompt_title">
                    Please Sign In</h2>
                <p class="text-slate-500 mb-8 leading-relaxed" data-i18n="auth.signin_prompt_body">Access to your
                    profile dashboard requires authentication.</p>
                <a href="signin.html?return_to=profile.html"
                    class="block w-full py-3 px-4 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition-colors shadow-lg shadow-brand-200"
                    data-i18n="auth.signin_prompt_button">Go to Sign In</a>
            </div>
        </div>

        <!-- View: Profile Form -->
        <div id="view-profile" class="hidden max-w-[1600px] mx-auto px-4 sm:px-6 py-8">
            <form id="profileForm" class="grid grid-cols-1 lg:grid-cols-[340px_1fr] gap-6">

                <!-- Left Panel: Identity & Actions -->
                <div class="flex flex-col gap-6">
                    <div
                        class="bg-white rounded-[1.5rem] border border-gray-200 shadow-sm p-8 flex flex-col items-center text-center relative overflow-hidden">

                        <!-- Avatar -->
                        <label
                            class="avatar-container w-40 h-40 rounded-full bg-gray-100 border-4 border-white shadow-lg relative cursor-pointer overflow-hidden mb-6 group ring-1 ring-gray-200">
                            <img id="avatarImg" class="hidden w-full h-full object-cover" alt="Avatar" />
                            <span id="avatarInitials"
                                class="w-full h-full flex items-center justify-center text-4xl font-bold text-brand-300">U</span>
                            <div class="avatar-overlay absolute inset-0 flex items-center justify-center text-white">
                                <i data-lucide="camera" class="w-8 h-8"></i>
                            </div>
                            <input type="file" id="avatarInput" hidden accept="image/*" />
                        </label>

                        <div class="mb-1">
                            <h2 id="displayUsername" class="font-display font-bold text-xl text-slate-800">@username
                            </h2>
                            <p id="displayEmail" class="text-sm text-slate-400 font-medium">user@example.com</p>
                        </div>

                        <button type="button" id="removeAvatarBtn"
                            class="hidden mt-2 text-xs font-bold text-red-500 hover:text-red-600 hover:bg-red-50 px-3 py-1 rounded-full transition-colors"
                            data-i18n="profile.remove_image">Remove Picture</button>
                    </div>

                    <!-- Actions -->
                    <div class="bg-white rounded-[1.5rem] border border-gray-200 shadow-sm p-6 flex flex-col gap-3">
                        <button type="submit" id="saveBtn"
                            class="w-full py-3 px-4 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition-all shadow-md shadow-brand-100 flex items-center justify-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span data-i18n="profile.save">Save Changes</span>
                        </button>
                        <button type="button" id="backBtn"
                            class="w-full py-3 px-4 bg-white border border-gray-200 hover:bg-gray-50 text-slate-600 font-bold rounded-xl transition-colors flex items-center justify-center gap-2">
                            <span data-i18n="back.general">Go Back</span>
                        </button>
                    </div>
                </div>

                <!-- Right Panel: Details Form -->
                <div class="bg-white rounded-[1.5rem] border border-gray-200 shadow-sm p-6 md:p-8">
                    <div class="flex items-center justify-between border-b border-gray-100 pb-6 mb-8">
                        <h1 class="font-display font-bold text-2xl text-slate-800" data-i18n="profile.title">Edit
                            Profile</h1>
                        <span
                            class="text-xs font-semibold text-slate-400 bg-gray-50 px-2 py-1 rounded border border-gray-200"><span
                                class="text-red-500">*</span> Required</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">

                        <!-- Full Name -->
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider"
                                for="fullName"><span data-i18n="profile.full_name">Full Name</span> <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="fullName" required
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                placeholder="e.g. Dr. Jane Doe" />
                        </div>

                        <!-- Username -->
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider"
                                for="username"><span data-i18n="profile.username">Username</span> <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="username" required pattern="[a-zA-Z0-9_-]+"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                placeholder="janedoe" />
                        </div>

                        <!-- Country Selection (New) -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider"
                                for="country"><span data-i18n="profile.country">Country</span> <span
                                    class="text-red-500">*</span></label>
                            <select id="country" required placeholder="Select a country..." autocomplete="off">
                                <option value="">Select a country...</option>
                            </select>
                        </div>

                        <!-- Affiliation (Autocomplete/Searchable) -->
                        <div class="space-y-1.5 relative md:col-span-2" id="affiliation-wrapper">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider"
                                for="affiliation"><span data-i18n="profile.affiliation">Affiliation</span> <span
                                    class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="text" id="affiliation" required autocomplete="off"
                                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                    placeholder="Search or type University / Organization" />

                                <!-- Search Icon (Decorative) -->
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                </div>

                                <!-- Autocomplete Dropdown -->
                                <ul id="affiliation-list"
                                    class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto overflow-x-hidden">
                                    <!-- Items injected via JS -->
                                </ul>
                            </div>
                        </div>

                        <!-- Department (Autocomplete Dependent) -->
                        <div class="space-y-1.5 relative" id="department-wrapper">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider" for="department"
                                data-i18n="profile.department">Department</label>
                            <div class="relative">
                                <input type="text" id="department" autocomplete="off"
                                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                    placeholder="e.g. Dept of Agriculture" />

                                <!-- Icon -->
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                </div>

                                <!-- Autocomplete Dropdown -->
                                <ul id="department-list"
                                    class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto overflow-x-hidden">
                                </ul>
                            </div>
                        </div>

                        <!-- Working Group (Autocomplete Dependent) -->
                        <div class="space-y-1.5 relative" id="workingGroup-wrapper">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider" for="workingGroup"
                                data-i18n="profile.working_group">Working Group</label>
                            <div class="relative">
                                <input type="text" id="workingGroup" autocomplete="off"
                                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                    placeholder="e.g. Soil Analysis Group" />

                                <!-- Icon -->
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                </div>

                                <!-- Autocomplete Dropdown -->
                                <ul id="workingGroup-list"
                                    class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto overflow-x-hidden">
                                </ul>
                            </div>
                        </div>

                        <!-- Work Email -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider"
                                for="workEmail"><span data-i18n="profile.work_email">Work Email</span> <span
                                    class="text-red-500">*</span></label>
                            <input type="email" id="workEmail" required
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                placeholder="jane@university.edu" />
                        </div>

                        <div class="col-span-1 md:col-span-2 border-t border-gray-100 my-2"></div>

                        <!-- Personal Website -->
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider"
                                for="personalWebsite" data-i18n="profile.personal_website">Personal Website</label>
                            <div class="relative">
                                <i data-lucide="globe"
                                    class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                <input type="url" id="personalWebsite"
                                    class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-10 pr-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                    placeholder="https://" />
                            </div>
                        </div>

                        <!-- Professional Website -->
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider"
                                for="professionalWebsite" data-i18n="profile.professional_website">Lab Website</label>
                            <div class="relative">
                                <i data-lucide="flask-conical"
                                    class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                <input type="url" id="professionalWebsite"
                                    class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-10 pr-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                    placeholder="https://" />
                            </div>
                        </div>

                        <!-- Google Scholar -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider" for="googleScholar"
                                data-i18n="profile.google_scholar">Google Scholar</label>
                            <div class="relative">
                                <i data-lucide="graduation-cap"
                                    class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                <input type="url" id="googleScholar"
                                    class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-10 pr-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400"
                                    placeholder="https://scholar.google.com/..." />
                            </div>
                        </div>

                        <!-- Research Interests (Tags) -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider" for="fieldsOfStudy"
                                data-i18n="profile.fields_section">Research Interests (tags, comma-separated)</label>
                            <textarea id="fieldsOfStudy"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-100 focus:border-brand-500 transition-all placeholder-slate-400 min-h-[100px] resize-y"
                                placeholder="Agrivoltaics, carbon fluxes, soil monitoring..."
                                data-i18n-placeholder="profile.fields_hint"></textarea>
                            <p class="mt-1 text-xs text-slate-500" data-i18n="profile.fields_help">
                                Enter short keywords separated by commas (e.g. agrivoltaics, carbon fluxes, remote
                                sensing). These will appear as tags on your profile.
                            </p>
                            <div id="fieldsOfStudyTags" class="mt-2 flex flex-wrap gap-2"></div>
                        </div>

                        <!-- Profile Description (Optional) - Rich Text -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider" for="description"
                                data-i18n="profile.description_section">Profile Description (optional)</label>
                            <!-- Editor Container -->
                            <div class="editor-wrapper">
                                <div id="description"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </form>
        </div>

    </main>

    <!-- Logic -->
    <script type="module">
        import { renderLayout } from './layout.js';
        import { supabase, authState, initAuth, signOut } from './auth.js';
        import { renderHeader, $, $$, show, hide, applyI18n, tr, setFlash, getAvatarUrl } from './ui.js';
        import { formatRichText } from './rich-text.js';

        // 1. Inject Layout
        renderLayout('');

        const state = {
            language: localStorage.getItem("lang") || "en",
            profile: null,
            avatarFile: null,
            avatarRemoved: false,
            existingAffiliations: [],
            deptSuggestions: [],
            wgSuggestions: [],
            quillEditor: null,
            countrySelect: null
        };

        const t = {
            en: {
                auth: { signin_prompt_title: "Please Sign In", signin_prompt_body: "Access to your profile dashboard requires authentication.", signin_prompt_button: "Go to Sign In" },
                profile: {
                    title: "Edit Profile",
                    full_name: "Full Name",
                    username: "Username",
                    country: "Country",
                    affiliation: "Affiliation",
                    department: "Department",
                    working_group: "Working Group",
                    work_email: "Work Email",
                    personal_website: "Personal Website",
                    professional_website: "Lab Website",
                    google_scholar: "Google Scholar Profile",
                    fields_section: "Research Interests (tags, comma-separated)",
                    fields_hint: "e.g. agrivoltaics, carbon fluxes, remote sensing...",
                    fields_help: "Enter short keywords separated by commas (e.g. agrivoltaics, carbon fluxes, remote sensing). These will appear as tags on your profile.",
                    description_section: "Profile Description (optional)",
                    description_hint: "Brief bio, current projects, and how you collaborate (optional).",
                    save: "Save Changes",
                    saving: "Saving...",
                    saved: "Dashboard updated successfully",
                    remove_image: "Remove Picture",
                    upload_error: "Failed to upload image. Please try again.",
                    no_affiliation_results: "No matches found. Typing will create a new one.",
                    no_results: "No existing options found."
                },
                back: { general: "Go Back" }
            },
            es: {
                auth: { signin_prompt_title: "Inicia SesiÃ³n", signin_prompt_body: "El acceso al panel de perfil requiere autenticaciÃ³n.", signin_prompt_button: "Iniciar SesiÃ³n" },
                profile: {
                    title: "Editar Perfil",
                    full_name: "Nombre Completo",
                    username: "Usuario",
                    country: "PaÃ­s",
                    affiliation: "AfiliaciÃ³n",
                    department: "Departamento",
                    working_group: "Grupo de Trabajo",
                    work_email: "Correo Trabajo",
                    personal_website: "Sitio Personal",
                    professional_website: "Sitio Laboratorio",
                    google_scholar: "Perfil Google Scholar",
                    fields_section: "Intereses de investigaciÃ³n (etiquetas separadas por comas)",
                    fields_hint: "ej. agrovoltaica, flujos de carbono, teledetecciÃ³n...",
                    fields_help: "Introduce palabras clave cortas separadas por comas (ej. agrovoltaica, flujos de carbono, teledetecciÃ³n). Se mostrarÃ¡n como etiquetas en tu perfil.",
                    description_section: "DescripciÃ³n del perfil (opcional)",
                    description_hint: "Breve biografÃ­a, proyectos actuales y cÃ³mo colaboras (opcional).",
                    save: "Guardar Cambios",
                    saving: "Guardando...",
                    saved: "Panel actualizado con Ã©xito",
                    remove_image: "Eliminar Foto",
                    upload_error: "Error al subir la imagen. Por favor intenta de nuevo.",
                    no_affiliation_results: "No se encontraron coincidencias. Escribir crearÃ¡ uno nuevo.",
                    no_results: "No se encontraron opciones existentes."
                },
                back: { general: "Regresar" }
            }
        };

        // --- Country Data (ISO Alpha-2 + Emoji + Name) ---
        const countries = [
            { code: "AF", name: "Afghanistan", flag: "ğŸ‡¦ğŸ‡«" }, { code: "AL", name: "Albania", flag: "ğŸ‡¦ğŸ‡±" }, { code: "DZ", name: "Algeria", flag: "ğŸ‡©ğŸ‡¿" },
            { code: "AS", name: "American Samoa", flag: "ğŸ‡¦ğŸ‡¸" }, { code: "AD", name: "Andorra", flag: "ğŸ‡¦ğŸ‡©" }, { code: "AO", name: "Angola", flag: "ğŸ‡¦ğŸ‡´" },
            { code: "AI", name: "Anguilla", flag: "ğŸ‡¦ğŸ‡®" }, { code: "AG", name: "Antigua and Barbuda", flag: "ğŸ‡¦ğŸ‡¬" }, { code: "AR", name: "Argentina", flag: "ğŸ‡¦ğŸ‡·" },
            { code: "AM", name: "Armenia", flag: "ğŸ‡¦ğŸ‡²" }, { code: "AW", name: "Aruba", flag: "ğŸ‡¦ğŸ‡¼" }, { code: "AU", name: "Australia", flag: "ğŸ‡¦ğŸ‡º" },
            { code: "AT", name: "Austria", flag: "ğŸ‡¦ğŸ‡¹" }, { code: "AZ", name: "Azerbaijan", flag: "ğŸ‡¦ğŸ‡¿" }, { code: "BS", name: "Bahamas", flag: "ğŸ‡§ğŸ‡¸" },
            { code: "BH", name: "Bahrain", flag: "ğŸ‡§ğŸ‡­" }, { code: "BD", name: "Bangladesh", flag: "ğŸ‡§ğŸ‡©" }, { code: "BB", name: "Barbados", flag: "ğŸ‡§ğŸ‡§" },
            { code: "BY", name: "Belarus", flag: "ğŸ‡§ğŸ‡¾" }, { code: "BE", name: "Belgium", flag: "ğŸ‡§ğŸ‡ª" }, { code: "BZ", name: "Belize", flag: "ğŸ‡§ğŸ‡¿" },
            { code: "BJ", name: "Benin", flag: "ğŸ‡§ğŸ‡¯" }, { code: "BM", name: "Bermuda", flag: "ğŸ‡§ğŸ‡²" }, { code: "BT", name: "Bhutan", flag: "ğŸ‡§ğŸ‡¹" },
            { code: "BO", name: "Bolivia", flag: "ğŸ‡§ğŸ‡´" }, { code: "BA", name: "Bosnia and Herzegovina", flag: "ğŸ‡§ğŸ‡¦" }, { code: "BW", name: "Botswana", flag: "ğŸ‡§ğŸ‡¼" },
            { code: "BR", name: "Brazil", flag: "ğŸ‡§ğŸ‡·" }, { code: "BN", name: "Brunei", flag: "ğŸ‡§ğŸ‡³" }, { code: "BG", name: "Bulgaria", flag: "ğŸ‡§ğŸ‡¬" },
            { code: "BF", name: "Burkina Faso", flag: "ğŸ‡§ğŸ‡«" }, { code: "BI", name: "Burundi", flag: "ğŸ‡§ğŸ‡®" }, { code: "KH", name: "Cambodia", flag: "ğŸ‡°ğŸ‡­" },
            { code: "CM", name: "Cameroon", flag: "ğŸ‡¨ğŸ‡²" }, { code: "CA", name: "Canada", flag: "ğŸ‡¨ğŸ‡¦" }, { code: "CV", name: "Cape Verde", flag: "ğŸ‡¨ğŸ‡»" },
            { code: "KY", name: "Cayman Islands", flag: "ğŸ‡°ğŸ‡¾" }, { code: "CF", name: "Central African Republic", flag: "ğŸ‡¨ğŸ‡«" }, { code: "TD", name: "Chad", flag: "ğŸ‡¹ğŸ‡©" },
            { code: "CL", name: "Chile", flag: "ğŸ‡¨ğŸ‡±" }, { code: "CN", name: "China", flag: "ğŸ‡¨ğŸ‡³" }, { code: "CO", name: "Colombia", flag: "ğŸ‡¨ğŸ‡´" },
            { code: "KM", name: "Comoros", flag: "ğŸ‡°ğŸ‡²" }, { code: "CG", name: "Congo", flag: "ğŸ‡¨ğŸ‡¬" }, { code: "CD", name: "Congo (DRC)", flag: "ğŸ‡¨ğŸ‡©" },
            { code: "CR", name: "Costa Rica", flag: "ğŸ‡¨ğŸ‡·" }, { code: "HR", name: "Croatia", flag: "ğŸ‡­ğŸ‡·" }, { code: "CU", name: "Cuba", flag: "ğŸ‡¨ğŸ‡º" },
            { code: "CY", name: "Cyprus", flag: "ğŸ‡¨ğŸ‡¾" }, { code: "CZ", name: "Czech Republic", flag: "ğŸ‡¨ğŸ‡¿" }, { code: "DK", name: "Denmark", flag: "ğŸ‡©ğŸ‡°" },
            { code: "DJ", name: "Djibouti", flag: "ğŸ‡©ğŸ‡¯" }, { code: "DM", name: "Dominica", flag: "ğŸ‡©ğŸ‡²" }, { code: "DO", name: "Dominican Republic", flag: "ğŸ‡©ğŸ‡´" },
            { code: "EC", name: "Ecuador", flag: "ğŸ‡ªğŸ‡¨" }, { code: "EG", name: "Egypt", flag: "ğŸ‡ªğŸ‡¬" }, { code: "SV", name: "El Salvador", flag: "ğŸ‡¸ğŸ‡»" },
            { code: "GQ", name: "Equatorial Guinea", flag: "ğŸ‡¬ğŸ‡¶" }, { code: "ER", name: "Eritrea", flag: "ğŸ‡ªğŸ‡·" }, { code: "EE", name: "Estonia", flag: "ğŸ‡ªğŸ‡ª" },
            { code: "ET", name: "Ethiopia", flag: "ğŸ‡ªğŸ‡¹" }, { code: "FJ", name: "Fiji", flag: "ğŸ‡«ğŸ‡¯" }, { code: "FI", name: "Finland", flag: "ğŸ‡«ğŸ‡®" },
            { code: "FR", name: "France", flag: "ğŸ‡«ğŸ‡·" }, { code: "GF", name: "French Guiana", flag: "ğŸ‡¬ğŸ‡«" }, { code: "PF", name: "French Polynesia", flag: "ğŸ‡µğŸ‡«" },
            { code: "GA", name: "Gabon", flag: "ğŸ‡¬ğŸ‡¦" }, { code: "GM", name: "Gambia", flag: "ğŸ‡¬ğŸ‡²" }, { code: "GE", name: "Georgia", flag: "ğŸ‡¬ğŸ‡ª" },
            { code: "DE", name: "Germany", flag: "ğŸ‡©ğŸ‡ª" }, { code: "GH", name: "Ghana", flag: "ğŸ‡¬ğŸ‡­" }, { code: "GR", name: "Greece", flag: "ğŸ‡¬ğŸ‡·" },
            { code: "GD", name: "Grenada", flag: "ğŸ‡¬ğŸ‡©" }, { code: "GP", name: "Guadeloupe", flag: "ğŸ‡¬ğŸ‡µ" }, { code: "GU", name: "Guam", flag: "ğŸ‡¬ğŸ‡º" },
            { code: "GT", name: "Guatemala", flag: "ğŸ‡¬ğŸ‡¹" }, { code: "GN", name: "Guinea", flag: "ğŸ‡¬ğŸ‡³" }, { code: "GW", name: "Guinea-Bissau", flag: "ğŸ‡¬ğŸ‡¼" },
            { code: "GY", name: "Guyana", flag: "ğŸ‡¬ğŸ‡¾" }, { code: "HT", name: "Haiti", flag: "ğŸ‡­ğŸ‡¹" }, { code: "HN", name: "Honduras", flag: "ğŸ‡­ğŸ‡³" },
            { code: "HK", name: "Hong Kong", flag: "ğŸ‡­ğŸ‡°" }, { code: "HU", name: "Hungary", flag: "ğŸ‡­ğŸ‡º" }, { code: "IS", name: "Iceland", flag: "ğŸ‡®ğŸ‡¸" },
            { code: "IN", name: "India", flag: "ğŸ‡®ğŸ‡³" }, { code: "ID", name: "Indonesia", flag: "ğŸ‡®ğŸ‡©" }, { code: "IR", name: "Iran", flag: "ğŸ‡®ğŸ‡·" },
            { code: "IQ", name: "Iraq", flag: "ğŸ‡®ğŸ‡¶" }, { code: "IE", name: "Ireland", flag: "ğŸ‡®ğŸ‡ª" }, { code: "IL", name: "Israel", flag: "ğŸ‡®ğŸ‡±" },
            { code: "IT", name: "Italy", flag: "ğŸ‡®ğŸ‡¹" }, { code: "JM", name: "Jamaica", flag: "ğŸ‡¯ğŸ‡²" }, { code: "JP", name: "Japan", flag: "ğŸ‡¯ğŸ‡µ" },
            { code: "JO", name: "Jordan", flag: "ğŸ‡¯ğŸ‡´" }, { code: "KZ", name: "Kazakhstan", flag: "ğŸ‡°ğŸ‡¿" }, { code: "KE", name: "Kenya", flag: "ğŸ‡°ğŸ‡ª" },
            { code: "KI", name: "Kiribati", flag: "ğŸ‡°ğŸ‡®" }, { code: "KP", name: "North Korea", flag: "ğŸ‡°ğŸ‡µ" }, { code: "KR", name: "South Korea", flag: "ğŸ‡°ğŸ‡·" },
            { code: "KW", name: "Kuwait", flag: "ğŸ‡°ğŸ‡¼" }, { code: "KG", name: "Kyrgyzstan", flag: "ğŸ‡°ğŸ‡¬" }, { code: "LA", name: "Laos", flag: "ğŸ‡±ğŸ‡¦" },
            { code: "LV", name: "Latvia", flag: "ğŸ‡±ğŸ‡»" }, { code: "LB", name: "Lebanon", flag: "ğŸ‡±ğŸ‡§" }, { code: "LS", name: "Lesotho", flag: "ğŸ‡±ğŸ‡¸" },
            { code: "LR", name: "Liberia", flag: "ğŸ‡±ğŸ‡·" }, { code: "LY", name: "Libya", flag: "ğŸ‡±ğŸ‡¾" }, { code: "LI", name: "Liechtenstein", flag: "ğŸ‡±ğŸ‡®" },
            { code: "LT", name: "Lithuania", flag: "ğŸ‡±ğŸ‡¹" }, { code: "LU", name: "Luxembourg", flag: "ğŸ‡±ğŸ‡º" }, { code: "MO", name: "Macau", flag: "ğŸ‡²ğŸ‡´" },
            { code: "MK", name: "Macedonia", flag: "ğŸ‡²ğŸ‡°" }, { code: "MG", name: "Madagascar", flag: "ğŸ‡²ğŸ‡¬" }, { code: "MW", name: "Malawi", flag: "ğŸ‡²ğŸ‡¼" },
            { code: "MY", name: "Malaysia", flag: "ğŸ‡²ğŸ‡¾" }, { code: "MV", name: "Maldives", flag: "ğŸ‡²ğŸ‡»" }, { code: "ML", name: "Mali", flag: "ğŸ‡²ğŸ‡±" },
            { code: "MT", name: "Malta", flag: "ğŸ‡²ğŸ‡¹" }, { code: "MH", name: "Marshall Islands", flag: "ğŸ‡²ğŸ‡­" }, { code: "MQ", name: "Martinique", flag: "ğŸ‡²ğŸ‡¶" },
            { code: "MR", name: "Mauritania", flag: "ğŸ‡²ğŸ‡·" }, { code: "MU", name: "Mauritius", flag: "ğŸ‡²ğŸ‡º" }, { code: "YT", name: "Mayotte", flag: "ğŸ‡¾ğŸ‡¹" },
            { code: "MX", name: "Mexico", flag: "ğŸ‡²ğŸ‡½" }, { code: "FM", name: "Micronesia", flag: "ğŸ‡«ğŸ‡²" }, { code: "MD", name: "Moldova", flag: "ğŸ‡²ğŸ‡©" },
            { code: "MC", name: "Monaco", flag: "ğŸ‡²ğŸ‡¨" }, { code: "MN", name: "Mongolia", flag: "ğŸ‡²ğŸ‡³" }, { code: "ME", name: "Montenegro", flag: "ğŸ‡²ğŸ‡ª" },
            { code: "MS", name: "Montserrat", flag: "ğŸ‡²ğŸ‡¸" }, { code: "MA", name: "Morocco", flag: "ğŸ‡²ğŸ‡¦" }, { code: "MZ", name: "Mozambique", flag: "ğŸ‡²ğŸ‡¿" },
            { code: "MM", name: "Myanmar", flag: "ğŸ‡²ğŸ‡²" }, { code: "NA", name: "Namibia", flag: "ğŸ‡³ğŸ‡¦" }, { code: "NR", name: "Nauru", flag: "ğŸ‡³ğŸ‡·" },
            { code: "NP", name: "Nepal", flag: "ğŸ‡³ğŸ‡µ" }, { code: "NL", name: "Netherlands", flag: "ğŸ‡³ğŸ‡±" }, { code: "NC", name: "New Caledonia", flag: "ğŸ‡³ğŸ‡¨" },
            { code: "NZ", name: "New Zealand", flag: "ğŸ‡³ğŸ‡¿" }, { code: "NI", name: "Nicaragua", flag: "ğŸ‡³ğŸ‡®" }, { code: "NE", name: "Niger", flag: "ğŸ‡³ğŸ‡ª" },
            { code: "NG", name: "Nigeria", flag: "ğŸ‡³ğŸ‡¬" }, { code: "NU", name: "Niue", flag: "ğŸ‡³ğŸ‡º" }, { code: "NF", name: "Norfolk Island", flag: "ğŸ‡³ğŸ‡«" },
            { code: "MP", name: "Northern Mariana Islands", flag: "ğŸ‡²ğŸ‡µ" }, { code: "NO", name: "Norway", flag: "ğŸ‡³ğŸ‡´" }, { code: "OM", name: "Oman", flag: "ğŸ‡´ğŸ‡²" },
            { code: "PK", name: "Pakistan", flag: "ğŸ‡µğŸ‡°" }, { code: "PW", name: "Palau", flag: "ğŸ‡µğŸ‡¼" }, { code: "PS", name: "Palestine", flag: "ğŸ‡µğŸ‡¸" },
            { code: "PA", name: "Panama", flag: "ğŸ‡µğŸ‡¦" }, { code: "PG", name: "Papua New Guinea", flag: "ğŸ‡µğŸ‡¬" }, { code: "PY", name: "Paraguay", flag: "ğŸ‡µğŸ‡¾" },
            { code: "PE", name: "Peru", flag: "ğŸ‡µğŸ‡ª" }, { code: "PH", name: "Philippines", flag: "ğŸ‡µğŸ‡­" }, { code: "PN", name: "Pitcairn", flag: "ğŸ‡µğŸ‡³" },
            { code: "PL", name: "Poland", flag: "ğŸ‡µğŸ‡±" }, { code: "PT", name: "Portugal", flag: "ğŸ‡µğŸ‡¹" }, { code: "PR", name: "Puerto Rico", flag: "ğŸ‡µğŸ‡·" },
            { code: "QA", name: "Qatar", flag: "ğŸ‡¶ğŸ‡¦" }, { code: "RE", name: "Reunion", flag: "ğŸ‡·ğŸ‡ª" }, { code: "RO", name: "Romania", flag: "ğŸ‡·ğŸ‡´" },
            { code: "RU", name: "Russia", flag: "ğŸ‡·ğŸ‡º" }, { code: "RW", name: "Rwanda", flag: "ğŸ‡·ğŸ‡¼" }, { code: "BL", name: "Saint Barthelemy", flag: "ğŸ‡§ğŸ‡±" },
            { code: "SH", name: "Saint Helena", flag: "ğŸ‡¸ğŸ‡­" }, { code: "KN", name: "Saint Kitts and Nevis", flag: "ğŸ‡°ğŸ‡³" }, { code: "LC", name: "Saint Lucia", flag: "ğŸ‡±ğŸ‡¨" },
            { code: "MF", name: "Saint Martin", flag: "ğŸ‡²ğŸ‡«" }, { code: "PM", name: "Saint Pierre and Miquelon", flag: "ğŸ‡µğŸ‡²" },
            { code: "VC", name: "Saint Vincent and the Grenadines", flag: "ğŸ‡»ğŸ‡¨" }, { code: "WS", name: "Samoa", flag: "ğŸ‡¼ğŸ‡¸" }, { code: "SM", name: "San Marino", flag: "ğŸ‡¸ğŸ‡²" },
            { code: "ST", name: "Sao Tome and Principe", flag: "ğŸ‡¸ğŸ‡¹" }, { code: "SA", name: "Saudi Arabia", flag: "ğŸ‡¸ğŸ‡¦" }, { code: "SN", name: "Senegal", flag: "ğŸ‡¸ğŸ‡³" },
            { code: "RS", name: "Serbia", flag: "ğŸ‡·ğŸ‡¸" }, { code: "SC", name: "Seychelles", flag: "ğŸ‡¸ğŸ‡¨" }, { code: "SL", name: "Sierra Leone", flag: "ğŸ‡¸ğŸ‡±" },
            { code: "SG", name: "Singapore", flag: "ğŸ‡¸ğŸ‡¬" }, { code: "SX", name: "Sint Maarten", flag: "ğŸ‡¸ğŸ‡½" }, { code: "SK", name: "Slovakia", flag: "ğŸ‡¸ğŸ‡°" },
            { code: "SI", name: "Slovenia", flag: "ğŸ‡¸ğŸ‡®" }, { code: "SB", name: "Solomon Islands", flag: "ğŸ‡¸ğŸ‡§" }, { code: "SO", name: "Somalia", flag: "ğŸ‡¸ğŸ‡´" },
            { code: "ZA", name: "South Africa", flag: "ğŸ‡¿ğŸ‡¦" }, { code: "GS", name: "South Georgia and the South Sandwich Islands", flag: "ğŸ‡¬ğŸ‡¸" },
            { code: "SS", name: "South Sudan", flag: "ğŸ‡¸ğŸ‡¸" }, { code: "ES", name: "Spain", flag: "ğŸ‡ªğŸ‡¸" }, { code: "LK", name: "Sri Lanka", flag: "ğŸ‡±ğŸ‡°" },
            { code: "SD", name: "Sudan", flag: "ğŸ‡¸ğŸ‡©" }, { code: "SR", name: "Suriname", flag: "ğŸ‡¸ğŸ‡·" }, { code: "SJ", name: "Svalbard and Jan Mayen", flag: "ğŸ‡¸ğŸ‡¯" },
            { code: "SZ", name: "Swaziland", flag: "ğŸ‡¸ğŸ‡¿" }, { code: "SE", name: "Sweden", flag: "ğŸ‡¸ğŸ‡ª" }, { code: "CH", name: "Switzerland", flag: "ğŸ‡¨ğŸ‡­" },
            { code: "SY", name: "Syria", flag: "ğŸ‡¸ğŸ‡¾" }, { code: "TW", name: "Taiwan", flag: "ğŸ‡¹ğŸ‡¼" }, { code: "TJ", name: "Tajikistan", flag: "ğŸ‡¹ğŸ‡¯" },
            { code: "TZ", name: "Tanzania", flag: "ğŸ‡¹ğŸ‡¿" }, { code: "TH", name: "Thailand", flag: "ğŸ‡¹ğŸ‡­" }, { code: "TL", name: "Timor-Leste", flag: "ğŸ‡¹ğŸ‡±" },
            { code: "TG", name: "Togo", flag: "ğŸ‡¹ğŸ‡¬" }, { code: "TK", name: "Tokelau", flag: "ğŸ‡¹ğŸ‡°" }, { code: "TO", name: "Tonga", flag: "ğŸ‡¹ğŸ‡´" },
            { code: "TT", name: "Trinidad and Tobago", flag: "ğŸ‡¹ğŸ‡¹" }, { code: "TN", name: "Tunisia", flag: "ğŸ‡¹ğŸ‡³" }, { code: "TR", name: "Turkey", flag: "ğŸ‡¹ğŸ‡·" },
            { code: "TM", name: "Turkmenistan", flag: "ğŸ‡¹ğŸ‡²" }, { code: "TC", name: "Turks and Caicos Islands", flag: "ğŸ‡¹ğŸ‡¨" }, { code: "TV", name: "Tuvalu", flag: "ğŸ‡¹ğŸ‡»" },
            { code: "UG", name: "Uganda", flag: "ğŸ‡ºğŸ‡¬" }, { code: "UA", name: "Ukraine", flag: "ğŸ‡ºğŸ‡¦" }, { code: "AE", name: "United Arab Emirates", flag: "ğŸ‡¦ğŸ‡ª" },
            { code: "GB", name: "United Kingdom", flag: "ğŸ‡¬ğŸ‡§" }, { code: "US", name: "United States", flag: "ğŸ‡ºğŸ‡¸" }, { code: "UY", name: "Uruguay", flag: "ğŸ‡ºğŸ‡¾" },
            { code: "UZ", name: "Uzbekistan", flag: "ğŸ‡ºğŸ‡¿" }, { code: "VU", name: "Vanuatu", flag: "ğŸ‡»ğŸ‡º" }, { code: "VE", name: "Venezuela", flag: "ğŸ‡»ğŸ‡ª" },
            { code: "VN", name: "Vietnam", flag: "ğŸ‡»ğŸ‡³" }, { code: "WF", name: "Wallis and Futuna", flag: "ğŸ‡¼ğŸ‡«" }, { code: "YE", name: "Yemen", flag: "ğŸ‡¾ğŸ‡ª" },
            { code: "ZM", name: "Zambia", flag: "ğŸ‡¿ğŸ‡²" }, { code: "ZW", name: "Zimbabwe", flag: "ğŸ‡¿ğŸ‡¼" }
        ];

        function localTr(key) { return tr(t, state.language, key); }

        function handleLangSwitch() {
            state.language = state.language === "en" ? "es" : "en";
            localStorage.setItem("lang", state.language);
            applyI18n(t, state.language);
            renderHeader(authState, t, state.language);
        }

        // --- Helper to init Quill ---
        function initQuill(selector) {
            if (!window.Quill) return null;
            return new Quill(selector, {
                theme: 'snow',
                placeholder: localTr('profile.description_hint'),
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'clean']
                    ]
                }
            });
        }

        // --- Helper to init Tom Select (Country Picker) ---
        function initCountryPicker() {
            if(state.countrySelect) return;
            
            state.countrySelect = new TomSelect('#country', {
                options: countries,
                valueField: 'code',
                labelField: 'name',
                searchField: 'name',
                placeholder: "Select a country...",
                maxItems: 1,
                render: {
                    option: function(data, escape) {
                        return `<div><span class="text-xl mr-2">${data.flag}</span> <span class="text-slate-700">${escape(data.name)}</span></div>`;
                    },
                    item: function(data, escape) {
                        return `<div><span class="text-xl mr-2">${data.flag}</span> ${escape(data.name)}</div>`;
                    }
                }
            });
        }

        // Helper to get content from Quill
        function getQuillContent(quill) {
            if (!quill) return null;
            // Check if empty (Quill leaves <p><br></p> even when empty)
            if (quill.getText().trim().length === 0 && quill.root.innerHTML === '<p><br></p>') return null;
            return quill.root.innerHTML;
        }

        // --- Routing Logic ---
        async function handleRoute() {
            const loadingEl = $('#view-loading');
            const authReqEl = $('#view-auth-required');
            const profileEl = $('#view-profile');

            if (!authState.session) {
                hide(loadingEl);
                hide(profileEl);
                show(authReqEl);
            } else {
                hide(authReqEl);
                show(profileEl);
                hide(loadingEl);

                // Initialize editor if not already
                if (!state.quillEditor) {
                    state.quillEditor = initQuill('#description');
                }

                // Initialize Country Picker
                initCountryPicker();

                await Promise.all([
                    loadProfileData(),
                    fetchExistingAffiliations()
                ]);
            }
        }

        // --- Data Fetching ---

        async function fetchExistingAffiliations() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('affiliation')
                    .not('affiliation', 'is', null)
                    .neq('affiliation', '');

                if (error) throw error;

                const uniqueSet = new Set(data.map(item => item.affiliation.trim()));
                state.existingAffiliations = Array.from(uniqueSet).sort((a, b) => a.localeCompare(b));

            } catch (err) {
                console.error('Error fetching affiliations:', err);
            }
        }

        async function fetchDependentOptions(affiliationName) {
            if (!affiliationName) {
                state.deptSuggestions = [];
                state.wgSuggestions = [];
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('department, working_group')
                    .eq('affiliation', affiliationName);

                if (error) throw error;

                const depts = new Set(
                    data.map(i => i.department)
                        .filter(d => d && d.trim() !== '')
                        .map(d => d.trim())
                );
                state.deptSuggestions = Array.from(depts).sort((a, b) => a.localeCompare(b));

                const groups = new Set(
                    data.map(i => i.working_group)
                        .filter(w => w && w.trim() !== '')
                        .map(w => w.trim())
                );
                state.wgSuggestions = Array.from(groups).sort((a, b) => a.localeCompare(b));

            } catch (err) {
                console.error('Error fetching dependent options:', err);
            }
        }

        async function loadProfileData() {
            if (!authState.session) return;

            const { data, error } = await supabase
                .from("profiles")
                .select("*")
                .eq("id", authState.session.user.id)
                .single();

            if (error) {
                console.error("Error fetching profile:", error);
                state.profile = {
                    full_name: authState.session.user.user_metadata?.full_name || '',
                    email: authState.session.user.email
                };
            } else {
                state.profile = data || {};
            }

            // Populate Form Fields
            const fields = [
                'fullName', 'username', 'affiliation', 'department', 'workingGroup',
                'workEmail', 'personalWebsite', 'professionalWebsite',
                'googleScholar', 'fieldsOfStudy'
            ];

            fields.forEach(id => {
                const dbKey = id.replace(/[A-Z]/g, m => '_' + m.toLowerCase());
                const el = $(`#${id}`);
                if (el) el.value = state.profile[dbKey] || '';
            });

            // Set Country
            if (state.countrySelect && state.profile.country) {
                state.countrySelect.setValue(state.profile.country);
            }

            // Populate Description in Quill
            if (state.quillEditor) {
                state.quillEditor.root.innerHTML = state.profile.description || '';
            }

            if (!$('#workEmail').value) $('#workEmail').value = authState.session.user.email;
            if (!$('#username').value) $('#username').value = authState.session.user.email.split('@')[0];

            if (state.profile.affiliation) {
                await fetchDependentOptions(state.profile.affiliation);
            }

            updatePreviewText();
            renderFieldsTags();

            if (state.profile.avatar_url) {
                const url = await getAvatarUrl(state.profile.avatar_url);
                setAvatar(url);
            } else {
                setAvatar(null);
            }
        }

        function setAvatar(url) {
            const img = $('#avatarImg');
            const initials = $('#avatarInitials');
            const removeBtn = $('#removeAvatarBtn');

            if (url) {
                img.src = url;
                show(img);
                hide(initials);
                show(removeBtn);
            } else {
                hide(img);
                show(initials);
                hide(removeBtn);
                updateInitials();
            }
        }

        function updateInitials() {
            const name = $('#fullName').value || 'User';
            $('#avatarInitials').textContent = name.charAt(0).toUpperCase();
        }

        function updatePreviewText() {
            $('#displayUsername').textContent = '@' + ($('#username').value || 'username');
            $('#displayEmail').textContent = $('#workEmail').value || 'user@example.com';
        }

        function renderFieldsTags() {
            const container = $('#fieldsOfStudyTags');
            if (!container) return;
            const textarea = $('#fieldsOfStudy');
            if (!textarea) return;

            const raw = textarea.value || '';
            const tags = raw.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

            container.innerHTML = '';
            if (tags.length === 0) return;

            tags.forEach(tag => {
                const pill = document.createElement('span');
                pill.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-brand-50 text-brand-700 border border-brand-100';
                pill.textContent = tag;
                container.appendChild(pill);
            });
        }

        // --- Autocomplete Logic ---

        function setupAffiliationAutocomplete() {
            const input = $('#affiliation');
            const list = $('#affiliation-list');
            const wrapper = $('#affiliation-wrapper');

            const renderList = (items) => {
                list.innerHTML = '';
                if (items.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'px-4 py-3 text-sm text-slate-400 italic bg-gray-50';
                    li.textContent = localTr('profile.no_affiliation_results');
                    list.appendChild(li);
                } else {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'px-4 py-2.5 text-sm text-slate-700 hover:bg-brand-50 hover:text-brand-700 cursor-pointer border-b border-gray-50 last:border-none transition-colors';
                        li.textContent = item;
                        li.addEventListener('click', async () => {
                            input.value = item;
                            hide(list);
                            await fetchDependentOptions(item);
                        });
                        list.appendChild(li);
                    });
                }
                show(list);
            };

            const handleInput = () => {
                const val = input.value.toLowerCase();
                const filtered = state.existingAffiliations.filter(aff => aff.toLowerCase().includes(val));
                const toShow = val === '' ? state.existingAffiliations.slice(0, 50) : filtered;
                renderList(toShow);
            };

            input.addEventListener('focus', handleInput);
            input.addEventListener('input', handleInput);

            input.addEventListener('blur', async () => {
                const val = input.value.trim();
                if (val) await fetchDependentOptions(val);
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) hide(list);
            });
        }

        function setupGenericAutocomplete(inputId, listId, wrapperId, getSourceArray) {
            const input = $(`#${inputId}`);
            const list = $(`#${listId}`);
            const wrapper = $(`#${wrapperId}`);

            const renderList = (items) => {
                list.innerHTML = '';
                if (items.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'px-4 py-3 text-sm text-slate-400 italic bg-gray-50';
                    li.textContent = localTr('profile.no_results');
                    list.appendChild(li);
                } else {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'px-4 py-2.5 text-sm text-slate-700 hover:bg-brand-50 hover:text-brand-700 cursor-pointer border-b border-gray-50 last:border-none transition-colors';
                        li.textContent = item;
                        li.addEventListener('click', () => {
                            input.value = item;
                            hide(list);
                        });
                        list.appendChild(li);
                    });
                }
                show(list);
            };

            const handleInput = () => {
                const source = getSourceArray();
                if (!source || source.length === 0) return;

                const val = input.value.toLowerCase();
                const filtered = source.filter(s => s.toLowerCase().includes(val));
                const toShow = val === '' ? source : filtered;
                renderList(toShow);
            };

            input.addEventListener('focus', handleInput);
            input.addEventListener('input', handleInput);

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) hide(list);
            });
        }

        async function saveProfile(e) {
            e.preventDefault();
            const btn = $('#saveBtn');
            
            // Manual check for country requirement since TomSelect hides native input
            if(!$('#country').value) {
                alert("Please select a country.");
                return;
            }

            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> <span>${localTr('profile.saving')}</span>`;

            try {
                let avatar_url = state.profile?.avatar_url;

                if (state.avatarFile) {
                    const fileExt = state.avatarFile.name.split('.').pop();
                    const fileName = `${authState.session.user.id}/${Date.now()}.${fileExt}`;
                    const { error: uploadError } = await supabase.storage.from('avatars').upload(fileName, state.avatarFile);
                    if (uploadError) throw new Error(localTr('profile.upload_error'));

                    if (avatar_url) await supabase.storage.from('avatars').remove([avatar_url]);
                    avatar_url = fileName;
                }
                else if (state.avatarRemoved && avatar_url) {
                    await supabase.storage.from('avatars').remove([avatar_url]);
                    avatar_url = null;
                }

                const updates = {
                    id: authState.session.user.id,
                    updated_at: new Date().toISOString(),
                    avatar_url,
                    full_name: $('#fullName').value.trim(),
                    username: $('#username').value.trim(),
                    country: $('#country').value.trim(), // Save Country Code
                    affiliation: $('#affiliation').value.trim(),
                    department: $('#department').value.trim() || null,
                    working_group: $('#workingGroup').value.trim() || null,
                    work_email: $('#workEmail').value.trim(),
                    personal_website: $('#personalWebsite').value.trim() || null,
                    professional_website: $('#professionalWebsite').value.trim() || null,
                    google_scholar: $('#googleScholar').value.trim() || null,
                    fields_of_study: $('#fieldsOfStudy').value.trim() || null,
                    description: getQuillContent(state.quillEditor),
                };

                const { error } = await supabase.from('profiles').upsert(updates);
                if (error) throw error;

                state.profile = { ...state.profile, ...updates };
                state.avatarFile = null;
                state.avatarRemoved = false;
                setFlash(localTr('profile.saved'));

                if (authState.profile) {
                    Object.assign(authState.profile, updates);
                    renderHeader(authState, t, state.language);
                }

                const returnTo = new URLSearchParams(location.search).get('return_to');
                if (returnTo) setTimeout(() => window.location.href = returnTo, 1000);

            } catch (err) {
                console.error(err);
                setFlash(err.message || "Error saving profile");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                lucide.createIcons();
            }
        }

        function bindEvents() {
            $('#avatarInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                state.avatarFile = file;
                state.avatarRemoved = false;
                const reader = new FileReader();
                reader.onload = (ev) => setAvatar(ev.target.result);
                reader.readAsDataURL(file);
            });

            $('#removeAvatarBtn').addEventListener('click', () => {
                state.avatarFile = null;
                state.avatarRemoved = true;
                setAvatar(null);
                $('#avatarInput').value = '';
            });

            $('#fullName').addEventListener('input', updateInitials);
            $('#username').addEventListener('input', updatePreviewText);
            $('#workEmail').addEventListener('input', updatePreviewText);
            $('#fieldsOfStudy').addEventListener('input', renderFieldsTags);
            $('#profileForm').addEventListener('submit', saveProfile);

            $('#backBtn').addEventListener('click', () => {
                if (document.referrer && document.referrer.includes(window.location.host)) {
                    history.back();
                } else {
                    window.location.href = 'index.html';
                }
            });

            // Initialize All Autocompletes
            setupAffiliationAutocomplete();
            setupGenericAutocomplete('department', 'department-list', 'department-wrapper', () => state.deptSuggestions);
            setupGenericAutocomplete('workingGroup', 'workingGroup-list', 'workingGroup-wrapper', () => state.wgSuggestions);
        }

        // --- Main ---
        (async function main() {
            applyI18n(t, state.language);
            bindEvents();
            lucide.createIcons();

            await initAuth({
                onAuthReady: () => {
                    renderHeader(authState, t, state.language);
                    handleRoute();
                },
                onAuthChange: () => {
                    renderHeader(authState, t, state.language);
                    handleRoute();
                }
            });

            window.addEventListener('lang-switch', handleLangSwitch);
        })();
    </script>
</body>

</html>