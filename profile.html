<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50 antialiased">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Profile â€¢ Agrovoltaicos sin Fronteras</title>
  <meta name="description" content="Manage your user profile and settings.">

  <!-- Critical pre-render script -->
  <script src="auth-preloader.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&family=Poppins:wght@600;700;800&display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Global Styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Tom Select -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.default.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <!-- Quill.js -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

  <!-- External Tailwind Config -->
  <script src="theme.js"></script>

  <!-- Custom Styles -->
  <style type="text/tailwindcss">
    @layer utilities {
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
      .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; border: 2px solid transparent; background-clip: content-box; }
    }

    html, body { height: 100%; overflow: hidden; }
    
    .input-field {
        @apply w-full px-4 py-2.5 bg-[var(--bg-input)] border border-transparent rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--color-brand-light)] focus:border-[var(--color-brand)] transition-all text-sm text-slate-800 placeholder:text-slate-400 shadow-inner;
    }
    .input-field:hover { @apply bg-white shadow-sm; }
    .label-text { @apply block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5; }

    .avatar-overlay { background: rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.2s; }
    .avatar-container:hover .avatar-overlay { opacity: 1; }

    .editor-wrapper { @apply w-full bg-[var(--bg-input)] border border-transparent rounded-xl transition-all shadow-inner overflow-hidden; }
    .editor-wrapper:hover { @apply bg-white shadow-sm; }
    .editor-wrapper:focus-within { @apply ring-2 ring-[var(--color-brand-light)] border-[var(--color-brand)] bg-white; }
    
    .ql-toolbar.ql-snow { border: none !important; border-bottom: 1px solid rgba(0,0,0,0.05) !important; background: rgba(255,255,255,0.5); padding: 6px 8px !important; }
    .ql-container.ql-snow { border: none !important; font-family: 'Inter', sans-serif !important; font-size: 0.875rem !important; }
    .ql-editor { min-height: 100px; padding: 12px 16px !important; color: #1e293b; }
    .ql-editor.ql-blank::before { color: #94a3b8 !important; font-style: normal !important; }
    .ql-snow .ql-stroke { stroke: #64748b !important; }
    .ql-snow .ql-fill { fill: #64748b !important; }
    .ql-snow .ql-picker { color: #64748b !important; }

    .ts-control { @apply w-full px-4 py-2.5 bg-[var(--bg-input)] border border-transparent rounded-xl transition-all text-sm text-slate-800 placeholder:text-slate-400 shadow-inner !important; min-height: 42px; display: flex; align-items: center; gap: 4px; }
    .ts-control.focus { @apply ring-2 ring-[var(--color-brand-light)] border-[var(--color-brand)] bg-white shadow-none !important; }
    .ts-wrapper.multi .ts-control > div.item { background-color: #f0f9ff !important; color: #0369a1 !important; border: 1px solid #e0f2fe !important; border-radius: 9999px !important; font-weight: 600 !important; font-size: 0.75rem !important; padding: 3px 8px 3px 12px !important; margin: 2px 3px 2px 0 !important; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important; text-shadow: none !important; }
    .ts-wrapper.plugin-remove_button .item .remove { border-left: 1px solid #bae6fd !important; margin-left: 8px !important; padding-left: 8px !important; padding-right: 0px !important; color: #0c4a6e !important; font-size: 1.1em !important; opacity: 0.6; vertical-align: middle; }
    .ts-wrapper.plugin-remove_button .item .remove:hover { background: transparent !important; color: #ef4444 !important; opacity: 1; }
    .ts-wrapper.multi .ts-control > div.item.active { background-color: #e0f2fe !important; border-color: #bae6fd !important; }
    .ts-dropdown { @apply rounded-xl border-gray-200 shadow-xl mt-1 overflow-hidden z-50 !important; }
    .ts-dropdown .option { @apply px-4 py-2.5 text-sm text-slate-700 cursor-pointer border-b border-gray-50 last:border-0; }
    .ts-dropdown .active { @apply bg-brand-50 text-brand-700 font-medium; }
  </style>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="text-slate-800 flex flex-col h-full overflow-hidden selection:bg-brand-100 selection:text-brand-900 font-sans">

  <main class="flex-1 relative overflow-hidden bg-gray-50">
    <div id="flash" class="flash"></div>

    <div class="absolute inset-0 overflow-y-auto custom-scrollbar">
      <div class="max-w-[1600px] mx-auto px-4 sm:px-6 py-6 flex flex-col h-full min-h-full">

        <!-- Loading State -->
        <div id="view-loading" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-50">
          <div class="w-10 h-10 border-2 border-gray-200 border-t-brand-600 rounded-full animate-spin"></div>
        </div>

        <!-- Auth Required State -->
        <div id="view-auth-required" class="hidden m-auto max-w-md w-full">
          <div class="bg-white/80 backdrop-blur-md rounded-2xl p-8 text-center border border-gray-200 shadow-xl">
            <div class="w-16 h-16 bg-brand-50 text-brand-600 rounded-full flex items-center justify-center mx-auto mb-4 border border-brand-100">
              <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 class="font-display font-bold text-2xl text-slate-800 mb-2" data-i18n="auth.signin_prompt_title">Please Sign In</h2>
            <p class="text-slate-500 mb-6" data-i18n="auth.signin_prompt_body">Access to your profile dashboard requires authentication.</p>
            <a href="signin.html?return_to=profile.html" class="inline-flex items-center justify-center px-6 py-2.5 border border-transparent text-sm font-bold rounded-xl text-white bg-brand-600 hover:bg-brand-700 transition-all shadow-lg shadow-brand-500/20" data-i18n="auth.signin_prompt_button">Go to Sign In</a>
          </div>
        </div>

        <!-- Profile Form Content -->
        <div id="view-profile" class="hidden grid grid-cols-1 lg:grid-cols-[340px_1fr] gap-6 pb-6">
          
          <div class="flex flex-col gap-6">
            <div class="bg-white/90 backdrop-blur-sm rounded-[1.5rem] border border-gray-200 shadow-sm p-8 flex flex-col items-center text-center relative overflow-hidden">
              <label class="avatar-container w-40 h-40 rounded-full bg-gray-50 border-4 border-white shadow-lg relative cursor-pointer overflow-hidden mb-6 group ring-1 ring-gray-200">
                <img id="avatarImg" class="hidden w-full h-full object-cover" alt="Avatar" />
                <span id="avatarInitials" class="w-full h-full flex items-center justify-center text-4xl font-bold text-brand-300">U</span>
                <div class="avatar-overlay absolute inset-0 flex items-center justify-center text-white"><i data-lucide="camera" class="w-8 h-8"></i></div>
                <input type="file" id="avatarInput" hidden accept="image/*" />
              </label>
              <div class="mb-1">
                <h2 id="displayUsername" class="font-display font-bold text-xl text-slate-800">@username</h2>
                <p id="displayEmail" class="text-xs text-slate-400 font-medium">user@example.com</p>
              </div>
              <button type="button" id="removeAvatarBtn" class="hidden mt-3 text-xs font-bold text-red-500 hover:text-red-600 hover:bg-red-50 px-3 py-1 rounded-full transition-colors border border-transparent hover:border-red-100" data-i18n="profile.remove_image">Remove Picture</button>
            </div>

            <div class="bg-white/90 backdrop-blur-sm rounded-[1.5rem] border border-gray-200 shadow-sm p-6 flex flex-col gap-3">
              <button type="submit" form="profileForm" id="saveBtn" class="w-full py-3 px-4 bg-brand-600 hover:bg-brand-700 text-white text-sm font-bold rounded-xl shadow-lg shadow-brand-500/20 hover:shadow-xl hover:shadow-brand-500/30 transition-all flex items-center justify-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i><span data-i18n="profile.save">Save Changes</span>
              </button>
              <button type="button" id="backBtn" class="w-full py-3 px-4 bg-white border border-gray-200 hover:bg-gray-50 text-slate-600 text-sm font-bold rounded-xl transition-colors flex items-center justify-center gap-2">
                <span data-i18n="back.general">Go Back</span>
              </button>
            </div>
          </div>

          <div class="bg-white/90 backdrop-blur-sm rounded-[1.5rem] border border-gray-200 shadow-sm p-6 md:p-8">
            <div class="flex items-center justify-between border-b border-gray-100 pb-5 mb-6">
              <h1 class="font-display font-bold text-xl text-slate-800" data-i18n="profile.title">Edit Profile</h1>
              <span class="text-[10px] font-bold text-slate-400 bg-gray-50 px-2 py-1 rounded border border-gray-200 uppercase tracking-wider">Required *</span>
            </div>

            <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
              <div class="space-y-1">
                <label class="label-text" for="fullName"><span data-i18n="profile.full_name">Full Name</span> <span class="text-red-500">*</span></label>
                <input type="text" id="fullName" required class="input-field" placeholder="e.g. Dr. Jane Doe" />
              </div>
              <div class="space-y-1">
                <label class="label-text" for="username"><span data-i18n="profile.username">Username</span> <span class="text-red-500">*</span></label>
                <input type="text" id="username" required pattern="[a-zA-Z0-9_-]+" class="input-field" placeholder="janedoe" />
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="label-text" for="country"><span data-i18n="profile.country">Country</span> <span class="text-red-500">*</span></label>
                <select id="country" required placeholder="Select a country..." autocomplete="off"></select>
              </div>
              <div class="space-y-1 relative md:col-span-2" id="affiliation-wrapper">
                <label class="label-text" for="affiliation"><span data-i18n="profile.affiliation">Affiliation</span> <span class="text-red-500">*</span></label>
                <div class="relative">
                  <input type="text" id="affiliation" required autocomplete="off" class="input-field pr-10" placeholder="Search or type University / Organization" />
                  <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"><i data-lucide="search" class="w-4 h-4 text-slate-400"></i></div>
                  <ul id="affiliation-list" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto overflow-x-hidden custom-scrollbar"></ul>
                </div>
              </div>
              <div class="space-y-1 relative" id="department-wrapper">
                <label class="label-text" for="department" data-i18n="profile.department">Department</label>
                <div class="relative">
                  <input type="text" id="department" autocomplete="off" class="input-field" placeholder="e.g. Dept of Agriculture" />
                  <ul id="department-list" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto custom-scrollbar"></ul>
                </div>
              </div>
              <div class="space-y-1 relative" id="workingGroup-wrapper">
                <label class="label-text" for="workingGroup" data-i18n="profile.working_group">Working Group</label>
                <div class="relative">
                  <input type="text" id="workingGroup" autocomplete="off" class="input-field" placeholder="e.g. Soil Analysis Group" />
                  <ul id="workingGroup-list" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto custom-scrollbar"></ul>
                </div>
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="label-text" for="workEmail"><span data-i18n="profile.work_email">Work Email</span> <span class="text-red-500">*</span></label>
                <input type="email" id="workEmail" required class="input-field" placeholder="jane@university.edu" />
              </div>
              <div class="col-span-1 md:col-span-2 border-t border-gray-100 my-2"></div>
              <div class="space-y-1">
                <label class="label-text" for="personalWebsite" data-i18n="profile.personal_website">Personal Website</label>
                <input type="url" id="personalWebsite" class="input-field" placeholder="https://" />
              </div>
              <div class="space-y-1">
                <label class="label-text" for="professionalWebsite" data-i18n="profile.professional_website">Lab Website</label>
                <input type="url" id="professionalWebsite" class="input-field" placeholder="https://" />
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="label-text" for="googleScholar" data-i18n="profile.google_scholar">Google Scholar</label>
                <div class="relative">
                    <i data-lucide="graduation-cap" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 z-10"></i>
                    <input type="url" id="googleScholar" class="input-field pl-10" placeholder="https://scholar.google.com/..." />
                </div>
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="label-text" for="fieldsOfStudy" data-i18n="profile.fields_section">Research Interests</label>
                <textarea id="fieldsOfStudy" class="input-field min-h-[80px] resize-y" placeholder="e.g. agrivoltaics, carbon fluxes, remote sensing..." data-i18n-placeholder="profile.fields_hint"></textarea>
                <div id="fieldsOfStudyTags" class="pt-2 flex flex-wrap gap-2"></div>
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="label-text" for="collaborators" data-i18n="profile.collaborators">Collaborators</label>
                <select id="collaborators" multiple placeholder="Search for people..." autocomplete="off"></select>
                <p class="text-[10px] text-slate-400 mt-1" data-i18n="profile.collaborators_help">Type to search existing members.</p>
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="label-text" for="description" data-i18n="profile.description_section">Bio / Description</label>
                <div class="editor-wrapper"><div id="description"></div></div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { renderLayout } from './layout.js';
    import { supabase, authState, initAuth, signOut } from './auth.js';
    import { initSharedUI, renderHeader, $, $$, show, hide, applyI18n, tr, setFlash, getAvatarUrl } from './ui.js';

    renderLayout('');

    const state = {
        language: localStorage.getItem("lang") || "en",
        profile: null,
        avatarFile: null,
        avatarRemoved: false,
        existingAffiliations: [],
        deptSuggestions: [],
        wgSuggestions: [],
        quillEditor: null,
        countrySelect: null,
        collaboratorSelect: null
    };

    const t = {
        en: {
            auth: { signin_prompt_title: "Please Sign In", signin_prompt_body: "Access to your profile dashboard requires authentication.", signin_prompt_button: "Go to Sign In" },
            profile: {
                title: "Edit Profile", full_name: "Full Name", username: "Username", country: "Country", affiliation: "Affiliation", department: "Department", working_group: "Working Group", work_email: "Work Email", personal_website: "Personal Website", professional_website: "Lab Website", google_scholar: "Google Scholar Profile", fields_section: "Research Interests (tags, comma-separated)", fields_hint: "e.g. agrivoltaics, carbon fluxes, remote sensing...", collaborators: "Collaborators (Optional)", collaborators_help: "Type to search for existing members.", description_section: "Profile Description (optional)", description_hint: "Brief bio, current projects, and how you collaborate (optional).", save: "Save Changes", saving: "Saving...", saved: "Dashboard updated successfully", remove_image: "Remove Picture", upload_error: "Failed to upload image. Please try again.", no_affiliation_results: "No matches found. Typing will create a new one.", no_results: "No existing options found.", username_taken: "Username already taken. Please choose another."
            },
            back: { general: "Go Back" }
        },
        es: {
            auth: { signin_prompt_title: "Inicia SesiÃ³n", signin_prompt_body: "El acceso al panel de perfil requiere autenticaciÃ³n.", signin_prompt_button: "Iniciar SesiÃ³n" },
            profile: {
                title: "Editar Perfil", full_name: "Nombre Completo", username: "Usuario", country: "PaÃ­s", affiliation: "AfiliaciÃ³n", department: "Departamento", working_group: "Grupo de Trabajo", work_email: "Correo Trabajo", personal_website: "Sitio Personal", professional_website: "Sitio Laboratorio", google_scholar: "Perfil Google Scholar", fields_section: "Intereses de investigaciÃ³n (etiquetas separadas por comas)", fields_hint: "ej. agrovoltaica, flujos de carbono, teledetecciÃ³n...", collaborators: "Colaboradores (Opcional)", collaborators_help: "Escribe para buscar miembros existentes.", description_section: "DescripciÃ³n del perfil (opcional)", description_hint: "Breve biografÃ­a, proyectos actuales y cÃ³mo colaboras.", save: "Guardar Cambios", saving: "Guardando...", saved: "Panel actualizado con Ã©xito", remove_image: "Eliminar Foto", upload_error: "Error al subir la imagen. Por favor intenta de nuevo.", no_affiliation_results: "No se encontraron coincidencias. Escribir crearÃ¡ uno nuevo.", no_results: "No se encontraron opciones existentes.", username_taken: "El nombre de usuario ya estÃ¡ en uso."
            },
            back: { general: "Regresar" }
        }
    };

    const countries = [ { code: "AF", name: "Afghanistan", flag: "ðŸ‡¦ðŸ‡«" }, { code: "AL", name: "Albania", flag: "ðŸ‡¦ðŸ‡±" }, { code: "US", name: "United States", flag: "ðŸ‡ºðŸ‡¸" }, { code: "MX", name: "Mexico", flag: "ðŸ‡²ðŸ‡½" }, { code: "CA", name: "Canada", flag: "ðŸ‡¨ðŸ‡¦" }, { code: "CO", name: "Colombia", flag: "ðŸ‡¨ðŸ‡´" }, { code: "CL", name: "Chile", flag: "ðŸ‡¨ðŸ‡±" }, { code: "AR", name: "Argentina", flag: "ðŸ‡¦ðŸ‡·" }, { code: "PE", name: "Peru", flag: "ðŸ‡µðŸ‡ª" }, { code: "ES", name: "Spain", flag: "ðŸ‡ªðŸ‡¸" }, { code: "GB", name: "United Kingdom", flag: "ðŸ‡¬ðŸ‡§" }, { code: "DE", name: "Germany", flag: "ðŸ‡©ðŸ‡ª" }, { code: "FR", name: "France", flag: "ðŸ‡«ðŸ‡·" }, { code: "IT", name: "Italy", flag: "ðŸ‡®ðŸ‡¹" }, { code: "BR", name: "Brazil", flag: "ðŸ‡§ðŸ‡·" } ];

    function localTr(key) { return tr(t, state.language, key); }

    function handleLangSwitch() {
        state.language = state.language === "en" ? "es" : "en";
        localStorage.setItem("lang", state.language);
        applyI18n(t, state.language);
        const offset = state.language === 'es' ? '100%' : '0%';
        const slider = document.querySelector('#langSwitchDesktop div:last-child');
        if (slider) slider.style.transform = `translateX(${offset})`;
    }

    function initQuill(selector) {
        if (!window.Quill) return null;
        return new Quill(selector, { theme: 'snow', placeholder: localTr('profile.description_hint'), modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'clean']] } });
    }

    function initCountryPicker() {
        if(state.countrySelect) return;
        state.countrySelect = new TomSelect('#country', { options: countries, valueField: 'code', labelField: 'name', searchField: 'name', placeholder: "Select a country...", maxItems: 1, render: { option: (d, e) => `<div><span class="text-xl mr-2">${d.flag}</span> <span class="text-slate-700">${e(d.name)}</span></div>`, item: (d, e) => `<div><span class="text-xl mr-2">${d.flag}</span> ${e(d.name)}</div>` } });
    }

    function initCollaboratorPicker() {
        if (state.collaboratorSelect) return;
        state.collaboratorSelect = new TomSelect('#collaborators', { plugins: ['remove_button'], valueField: 'id', labelField: 'full_name', searchField: 'full_name', placeholder: localTr('profile.collaborators_help'), maxItems: null, preload: false, load: function(query, callback) {
                if (!query.length) return callback();
                supabase.from('profiles').select('id, full_name, avatar_url').ilike('full_name', `%${query}%`).limit(10).then(({ data }) => callback((data || []).filter(p => p.id !== authState.session?.user?.id))).catch(() => callback());
            }, render: { option: (d, e) => `<div class="flex items-center gap-2 py-1.5 px-2"><div class="w-6 h-6 rounded-full bg-brand-100 flex items-center justify-center text-xs text-brand-700 font-bold shrink-0">${d.full_name?d.full_name.charAt(0).toUpperCase():'?'}</div><span class="text-sm font-medium text-slate-700">${e(d.full_name || 'Unknown')}</span></div>`, item: (d, e) => `<div>${e(d.full_name || 'Unknown')}</div>` } });
    }

    function getQuillContent(quill) { if (!quill) return null; if (quill.getText().trim().length === 0 && quill.root.innerHTML === '<p><br></p>') return null; return quill.root.innerHTML; }

    async function handleRoute() {
        if (!authState.session) { hide($('#view-loading')); hide($('#view-profile')); show($('#view-auth-required')); } else { hide($('#view-auth-required')); show($('#view-profile')); hide($('#view-loading')); if (!state.quillEditor) state.quillEditor = initQuill('#description'); initCountryPicker(); initCollaboratorPicker(); await Promise.all([loadProfileData(), fetchExistingAffiliations()]); }
    }

    async function fetchExistingAffiliations() {
        const { data } = await supabase.from('profiles').select('affiliation').not('affiliation', 'is', null).neq('affiliation', '');
        if(data) { const uniqueSet = new Set(data.map(item => item.affiliation.trim())); state.existingAffiliations = Array.from(uniqueSet).sort((a, b) => a.localeCompare(b)); }
    }

    async function fetchDependentOptions(affiliationName) {
        if (!affiliationName) { state.deptSuggestions = []; state.wgSuggestions = []; return; }
        const { data } = await supabase.from('profiles').select('department, working_group').eq('affiliation', affiliationName);
        if(data) {
            state.deptSuggestions = Array.from(new Set(data.map(i => i.department).filter(d => d?.trim()).map(d => d.trim()))).sort();
            state.wgSuggestions = Array.from(new Set(data.map(i => i.working_group).filter(w => w?.trim()).map(w => w.trim()))).sort();
        }
    }

    async function loadProfileData() {
        if (!authState.session) return;
        const { data, error } = await supabase.from("profiles").select("*").eq("id", authState.session.user.id).single();
        state.profile = error ? { full_name: authState.session.user.user_metadata?.full_name || '', email: authState.session.user.email } : (data || {});
        ['fullName', 'username', 'affiliation', 'department', 'workingGroup', 'workEmail', 'personalWebsite', 'professionalWebsite', 'googleScholar', 'fieldsOfStudy'].forEach(id => { const el = $(`#${id}`); if (el) el.value = state.profile[id.replace(/[A-Z]/g, m => '_' + m.toLowerCase())] || ''; });
        if (state.countrySelect && state.profile.country) state.countrySelect.setValue(state.profile.country);
        if (state.collaboratorSelect && state.profile.collaborators && state.profile.collaborators.length > 0) {
            const { data: collabData } = await supabase.from('profiles').select('id, full_name').in('id', state.profile.collaborators);
            if (collabData) { collabData.forEach(item => state.collaboratorSelect.addOption(item)); state.collaboratorSelect.setValue(state.profile.collaborators); }
        }
        if (state.quillEditor) state.quillEditor.root.innerHTML = state.profile.description || '';
        if (!$('#workEmail').value) $('#workEmail').value = authState.session.user.email;
        if (!$('#username').value) $('#username').value = authState.session.user.email.split('@')[0];
        if (state.profile.affiliation) await fetchDependentOptions(state.profile.affiliation);
        updatePreviewText(); renderFieldsTags();
        setAvatar(state.profile.avatar_url ? await getAvatarUrl(state.profile.avatar_url) : null);
    }

    function setAvatar(url) {
        const img = $('#avatarImg'), initials = $('#avatarInitials'), removeBtn = $('#removeAvatarBtn');
        if (url) { img.src = url; show(img); hide(initials); show(removeBtn); } else { hide(img); show(initials); hide(removeBtn); updateInitials(); }
    }

    function updateInitials() { $('#avatarInitials').textContent = ($('#fullName').value || 'User').charAt(0).toUpperCase(); }
    function updatePreviewText() { $('#displayUsername').textContent = '@' + ($('#username').value || 'username'); $('#displayEmail').textContent = $('#workEmail').value || 'user@example.com'; }
    function renderFieldsTags() {
        const c = $('#fieldsOfStudyTags'); if (!c) return; c.innerHTML = '';
        ($('#fieldsOfStudy').value || '').split(',').map(t => t.trim()).filter(Boolean).forEach(t => c.insertAdjacentHTML('beforeend', `<span class="inline-flex items-center px-2 py-0.5 rounded-lg text-xs font-semibold bg-brand-50 text-brand-700 border border-brand-100">${t}</span>`));
    }

    function setupGenericAutocomplete(inputId, listId, wrapperId, getSourceArray) {
        const input = $(`#${inputId}`), list = $(`#${listId}`), wrapper = $(`#${wrapperId}`);
        const renderList = (items) => {
            list.innerHTML = '';
            if (!items.length) list.insertAdjacentHTML('beforeend', `<li class="px-4 py-3 text-sm text-slate-400 italic bg-gray-50">${localTr('profile.no_results')}</li>`);
            else items.forEach(item => { const li = document.createElement('li'); li.className = 'px-4 py-2 text-sm text-slate-700 hover:bg-brand-50 hover:text-brand-700 cursor-pointer border-b border-gray-50 last:border-none transition-colors'; li.textContent = item; li.onclick = async () => { input.value = item; hide(list); if(inputId === 'affiliation') await fetchDependentOptions(item); }; list.appendChild(li); });
            show(list);
        };
        input.oninput = () => { const v = input.value.toLowerCase(), s = getSourceArray(); if (!s || !s.length) return; renderList(v === '' ? s.slice(0,50) : s.filter(i => i.toLowerCase().includes(v))); };
        input.onfocus = input.oninput;
        document.addEventListener('click', e => { if (!wrapper.contains(e.target)) hide(list); });
    }

    async function saveProfile(e) {
        e.preventDefault();
        const btn = $('#saveBtn');
        if(!$('#country').value) { alert("Please select a country."); return; }
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> <span>${localTr('profile.saving')}</span>`;

        try {
            let avatar_url = state.profile?.avatar_url;
            if (state.avatarFile) {
                const ext = state.avatarFile.name.split('.').pop();
                const path = `${authState.session.user.id}/${Date.now()}.${ext}`;
                const { error } = await supabase.storage.from('avatars').upload(path, state.avatarFile);
                if (error) throw error;
                avatar_url = path;
            } else if (state.avatarRemoved) avatar_url = null;

            const updates = {
                updated_at: new Date().toISOString(),
                avatar_url,
                full_name: $('#fullName').value.trim(),
                username: $('#username').value.trim(),
                country: $('#country').value.trim(),
                affiliation: $('#affiliation').value.trim(),
                department: $('#department').value.trim() || null,
                working_group: $('#workingGroup').value.trim() || null,
                work_email: $('#workEmail').value.trim(),
                personal_website: $('#personalWebsite').value.trim() || null,
                professional_website: $('#professionalWebsite').value.trim() || null,
                google_scholar: $('#googleScholar').value.trim() || null,
                fields_of_study: $('#fieldsOfStudy').value.trim() || null,
                collaborators: state.collaboratorSelect ? state.collaboratorSelect.getValue() : [],
                description: getQuillContent(state.quillEditor),
            };

            // FIX 1: Use .update() instead of .upsert()
            // FIX 2: Check for unique username error
            const { error } = await supabase.from('profiles').update(updates).eq('id', authState.session.user.id);
            if (error) {
                if (error.code === '23505') throw new Error(localTr('profile.username_taken'));
                throw error;
            }

            state.profile = { ...state.profile, ...updates };
            state.avatarFile = null; state.avatarRemoved = false;
            setFlash(localTr('profile.saved'));
            if (authState.profile) { Object.assign(authState.profile, updates); renderHeader(authState, t, state.language); if (avatar_url) getAvatarUrl(avatar_url).then(u => { const i = $('#userAvatar'); if(i) i.src = u; }); }
            const ret = new URLSearchParams(location.search).get('return_to');
            if (ret) setTimeout(() => window.location.href = ret, 1000);

        } catch (err) { console.error(err); setFlash(err.message || "Error", true); } finally { btn.disabled = false; btn.innerHTML = originalContent; lucide.createIcons(); }
    }

    (async function main() {
        initSharedUI({ onLangSwitch: handleLangSwitch, onSignOut: signOut });
        applyI18n(t, state.language);
        lucide.createIcons();
        $('#avatarInput').onchange = e => { const f = e.target.files[0]; if(f) { state.avatarFile = f; state.avatarRemoved = false; const r = new FileReader(); r.onload = ev => setAvatar(ev.target.result); r.readAsDataURL(f); } };
        $('#removeAvatarBtn').onclick = () => { state.avatarFile = null; state.avatarRemoved = true; setAvatar(null); $('#avatarInput').value = ''; };
        $('#fullName').oninput = updateInitials; $('#username').oninput = updatePreviewText; $('#workEmail').oninput = updatePreviewText; $('#fieldsOfStudy').oninput = renderFieldsTags;
        $('#profileForm').onsubmit = saveProfile;
        $('#backBtn').onclick = () => { if (document.referrer && document.referrer.includes(window.location.host)) history.back(); else window.location.href = 'index.html'; };
        setupGenericAutocomplete('affiliation', 'affiliation-list', 'affiliation-wrapper', () => state.existingAffiliations);
        setupGenericAutocomplete('department', 'department-list', 'department-wrapper', () => state.deptSuggestions);
        setupGenericAutocomplete('workingGroup', 'workingGroup-list', 'workingGroup-wrapper', () => state.wgSuggestions);

        await initAuth({ onAuthReady: () => { renderHeader(authState, t, state.language); handleRoute(); }, onAuthChange: () => { renderHeader(authState, t, state.language); handleRoute(); } });
    })();
  </script>
</body>
</html>