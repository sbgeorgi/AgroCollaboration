<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Your Profile • Almuerzo Agrivoltaico</title>
    <meta name="description" content="Manage your profile for the Almuerzo Agrivoltaico seminar series." />
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* --- CORE LAYOUT --- */
        @media (min-width: 961px) {
            html,
            body {
                height: 100vh;
                max-height: 100vh;
                overflow: hidden;
            }
        }
        
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--background, #121317);
            color: var(--text, #f1f1f1);
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        .site-header,
        .site-footer {
            flex-shrink: 0;
        }

        main.container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding: var(--space-3);
            box-sizing: border-box;
            width: 100%;
            max-width: 100% !important;
            margin: 0;
        }

        #profile,
        #publicProfileView,
        #signInPrompt {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-4);
            flex-grow: 1;
            min-height: 0;
            overflow-y: auto;
        }

        /* --- PROFILE FORM STYLING --- */
        .profile-intro {
            color: var(--text-muted);
            margin-bottom: var(--space-4);
        }

        .form-section {
            margin-bottom: var(--space-5);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--border);
        }
        .form-section:last-of-type { border-bottom: none; margin-bottom: 0; }

        .form-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: var(--space-3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        .form-field.col-span-2 { grid-column: 1 / -1; }
        
        .form-field label {
            font-size: 0.85rem;
            font-weight: 500;
            opacity: 0.9;
        }
        .form-field.required label::after {
            content: " *";
            color: var(--color-danger);
        }
        
        .form-field input,
        .form-field textarea {
            background-color: var(--card-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space-2);
            color: var(--text);
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-field input:focus,
        .form-field textarea:focus {
            border-color: var(--brand-2);
            outline: none;
            box-shadow: 0 0 0 3px var(--brand-2-muted);
        }
        .form-field textarea { resize: vertical; min-height: 100px; }

        .field-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .form-actions {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--border);
        }

        /* --- Avatar Upload Section --- */
        .avatar-upload-section {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--card-2);
            display: grid;
            place-content: center;
            font-weight: 600;
            font-size: 2.5rem;
            overflow: hidden;
            position: relative;
            border: 3px solid var(--border);
            flex-shrink: 0;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-controls {
            flex: 1;
        }

        .avatar-upload-controls h4 {
            margin: 0 0 var(--space-2) 0;
            font-size: 1rem;
        }

        .avatar-buttons {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background-color: var(--brand-2);
            color: white;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        .file-input-label:hover {
            background-color: var(--brand-2-hover);
        }

        input[type="file"] {
            display: none;
        }

        /* --- Public Profile View --- */
        #publicProfileView .public-profile-header {
            display: grid; grid-template-columns: auto 1fr; align-items: center;
            gap: var(--space-4); margin-bottom: var(--space-4);
            padding-bottom: var(--space-4); border-bottom: 1px solid var(--border);
        }
        #publicProfileView .avatar-circle-large {
            width: 80px; height: 80px; border-radius: 50%; background-color: var(--card-2);
            display: grid; place-content: center; font-weight: 600; font-size: 2.2rem;
            overflow: hidden;
        }
        #publicProfileView .avatar-circle-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #publicProfileView h2 { margin: 0; font-size: 1.4rem; }
        #publicProfileView .public-profile-meta { display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-2); }
        #publicProfileView .meta-chip { display: inline-flex; align-items: center; gap: .4rem; padding: .2rem .5rem; border-radius: 999px; background: var(--card-2); font-size: .8rem; }
        #publicProfileView .email a { color: var(--brand-2); text-decoration: none; }
        #publicProfileView .link-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: var(--space-2); }
        #publicProfileView .link-list a { text-decoration: none; color: var(--brand-2); display: inline-flex; align-items: center; gap: var(--space-2); font-weight: 500; }
        #publicProfileView .chips { display: flex; flex-wrap: wrap; gap: var(--space-2); }

        /* --- HEADER & NAVIGATION --- */
        .mobile-menu-btn { display: none; }
        .nav { display: flex; align-items: center; gap: var(--space-2); }
        .mobile-nav-overlay {
          display: none; flex-direction: column; justify-content: center; align-items: center;
          gap: var(--space-4); position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
          background: rgba(18, 19, 23, 0.9); backdrop-filter: blur(10px);
          z-index: 1000; opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .mobile-nav-overlay.is-open { display: flex; opacity: 1; }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 960px) {
            main.container { padding: var(--space-2); }
            .form-grid { grid-template-columns: 1fr; gap: var(--space-3); }
            .form-field.col-span-2 { grid-column: 1; }

            .mobile-menu-btn {
                display: block; background: none; border: none; color: var(--text);
                font-size: 2rem; cursor: pointer; z-index: 1001; padding: 0; line-height: 0;
            }
            .header-grid > .nav { display: none; }
            .mobile-nav-overlay .nav { display: flex; flex-direction: column; align-items: center; gap: var(--space-4); }
            .mobile-nav-overlay .link { font-size: 1.8rem; font-weight: 500; }
            .mobile-nav-overlay .divider { display: none; }
            .mobile-nav-overlay .auth-area { margin-top: var(--space-2); display: flex; flex-direction: column; align-items: center; gap: var(--space-3); }
            .mobile-nav-close-btn { position: absolute; top: var(--space-3); right: var(--space-3); background: none; border: none; color: var(--text); cursor: pointer; line-height: 1; padding: 0; }
            body.menu-open { overflow: hidden; }
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="container header-grid">
            <div class="brand">
                <a href="index.html" style="display: contents; text-decoration: none;">
                    <div class="logo-circle">A</div>
                    <div class="brand-text">
                        <div class="title">Almuerzo Agrivoltaico</div>
                        <div class="subtitle" data-i18n="tagline">
                            An informal seminar series to share advances in agrivoltaics in Latin America
                        </div>
                    </div>
                </a>
            </div>
            
            <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>

            <nav class="nav">
                <a href="index.html" class="link" data-i18n="nav.schedule">Schedule</a>
                <a href="archive.html" class="link" data-i18n="nav.archive">Archive</a>
                <a href="about.html" class="link" data-i18n="nav.about">About</a>
                <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
                <div class="divider"></div>
                <div id="langSwitchDesktop" class="lang-switch-slider" data-lang="en">
                    <span>EN</span>
                    <span>ES</span>
                </div>
                <div class="auth-area">
                    <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile">
                        <span id="userInitial"></span>
                        <img id="userAvatar" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                    </button>
                    <span id="userName"></span>
                    <button id="btnSignIn" class="btn-primary" data-i18n="auth.signin">Sign in</button>
                    <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
                        Sign out
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <div id="mobileNavOverlay" class="mobile-nav-overlay">
        <!-- Content will be injected by JS -->
    </div>

    <div id="flash" class="flash" role="status" aria-live="polite"></div>

    <main class="container">
        <!-- Profile Edit View -->
        <section id="profile" class="card" aria-labelledby="profileTitle" style="display: none">
            <button class="btn-ghost" id="backButton" style="margin-bottom: var(--space-3); align-self: flex-start;">
                ← <span data-i18n="back.general">Back</span>
            </button>
            <h2 id="profileTitle" data-i18n="profile.title">Complete Your Profile</h2>
            <p id="profileIntro" class="profile-intro" data-i18n="profile.intro">Please complete your profile to
                continue. Fields marked with * are required.</p>

            <form id="profileForm" class="profile-form">
                <!-- Avatar Upload Section -->
                <div class="form-section">
                    <h3 data-i18n="profile.avatar">Profile Picture</h3>
                    <div class="avatar-upload-section">
                        <div class="avatar-preview" id="avatarPreview">
                            <span id="avatarInitial">U</span>
                            <img id="avatarImage" style="display: none;" />
                        </div>
                        <div class="avatar-upload-controls">
                            <h4 data-i18n="profile.avatar_upload">Upload a profile picture</h4>
                            <p class="field-hint" data-i18n="profile.avatar_hint">JPG, PNG or GIF. Max 2MB.</p>
                            <div class="avatar-buttons">
                                <label class="file-input-label">
                                    <span>📷</span>
                                    <span data-i18n="profile.choose_image">Choose Image</span>
                                    <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/gif" />
                                </label>
                                <button type="button" class="btn-ghost" id="removeAvatar" style="display: none;" data-i18n="profile.remove_image">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="form-section">
                    <h3 data-i18n="profile.basic_info">Basic Information</h3>
                    <div class="form-grid">
                        <div class="form-field required">
                            <label for="fullName" data-i18n="profile.full_name">Full Name</label>
                            <input id="fullName" required />
                        </div>
                        <div class="form-field required">
                            <label for="username" data-i18n="profile.username">Username</label>
                            <input id="username" required pattern="[a-zA-Z0-9_-]+"
                                title="Only letters, numbers, underscores and hyphens allowed" />
                            <small class="field-hint" data-i18n="profile.username_hint">Used for @mentions and profile
                                URL</small>
                        </div>
                        <div class="form-field required col-span-2">
                            <label for="affiliation" data-i18n="profile.affiliation">Affiliation/Organization</label>
                            <input id="affiliation" required />
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="form-section">
                    <h3 data-i18n="profile.contact_info">Contact Information</h3>
                    <div class="form-grid">
                        <div class="form-field required col-span-2">
                            <label for="workEmail" data-i18n="profile.work_email">Work Email</label>
                            <input id="workEmail" type="email" required />
                        </div>
                    </div>
                </div>

                <!-- Professional Links -->
                <div class="form-section">
                    <h3 data-i18n="profile.professional_links">Professional Links</h3>
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="personalWebsite" data-i18n="profile.personal_website">Personal Website</label>
                            <input id="personalWebsite" type="url" placeholder="https://..." />
                        </div>
                        <div class="form-field">
                            <label for="professionalWebsite" data-i18n="profile.professional_website">Professional/Lab
                                Website</label>
                            <input id="professionalWebsite" type="url" placeholder="https://..." />
                        </div>
                        <div class="form-field col-span-2">
                            <label for="googleScholar" data-i18n="profile.google_scholar">Google Scholar Profile</label>
                            <input id="googleScholar" type="url" placeholder="https://scholar.google.com/..." />
                        </div>
                    </div>
                </div>

                <!-- Fields of Study -->
                <div class="form-section">
                    <h3 data-i18n="profile.fields_section">Research Interests</h3>
                    <div class="form-field">
                        <label for="fieldsOfStudy" data-i18n="profile.fields_of_study">Fields of Study</label>
                        <textarea id="fieldsOfStudy" rows="3"
                            placeholder="e.g., Solar Energy, Agricultural Systems, Environmental Science..."></textarea>
                        <small class="field-hint" data-i18n="profile.fields_hint">Separate multiple fields with
                            commas</small>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn-primary" type="submit" data-i18n="profile.save">
                        Save Profile
                    </button>
                    <button class="btn-ghost" type="button" id="skipProfile" style="display: none;"
                        data-i18n="profile.skip">
                        Skip for now
                    </button>
                </div>
            </form>
        </section>

        <!-- Public Profile View -->
        <section id="publicProfileView" class="card" style="display: none;">
            <button class="btn-ghost" id="backFromPublicProfile" style="margin-bottom: var(--space-3); align-self: flex-start;">
                 ← <span data-i18n="back.general">Back</span>
            </button>
            <div class="public-profile-header">
                <div class="avatar-circle-large" id="publicProfileAvatar">
                    <span id="publicProfileInitial"></span>
                    <img id="publicProfileImage" style="display: none;" />
                </div>
                <div>
                    <h2 id="publicProfileName"></h2>
                    <p id="publicProfileAffiliation" class="text-muted"></p>
                    <div class="public-profile-meta">
                        <span id="publicProfileUsername" class="meta-chip" style="display:none;">
                            <span class="emoji">👤</span><span class="txt"></span>
                        </span>
                        <span id="publicProfileEmail" class="meta-chip email" style="display:none;">
                            <span class="emoji">📧</span><a class="txt" href="#"></a>
                        </span>
                        <span id="publicProfileRole" class="meta-chip" style="display:none;">
                            <span class="emoji">🛡️</span><span class="txt"></span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="public-profile-body">
                <div class="form-section">
                    <h3 data-i18n="profile.professional_links">Professional Links</h3>
                    <ul id="publicProfileLinks" class="link-list"></ul>
                </div>
                <div class="form-section">
                    <h3 data-i18n="profile.fields_section">Research Interests</h3>
                    <div id="publicProfileFields" class="chips"></div>
                </div>
            </div>
        </section>

        <!-- Sign-in prompt if not logged in and trying to view own profile -->
        <section id="signInPrompt" class="card" style="display: none; text-align: center;">
             <h2 data-i18n="auth.signin_prompt_title">Please Sign In</h2>
             <p data-i18n="auth.signin_prompt_body">You need to be signed in to view and edit your profile.</p>
             <a href="index.html" class="btn-primary" data-i18n="auth.signin_prompt_button">Sign in on main page</a>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <small>
                © <span id="year"></span> Almuerzo Agrivoltaico •
                <span data-i18n="footer.note">Bilingual, community-driven seminar on agrivoltaics in Latin
                    America.</span>
            </small>
        </div>
    </footer>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const SUPABASE_URL = "https://iuzgfldgvueuehybgntm.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1emdmbGRndnVldWVoeWJnbnRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4Mjc0MjUsImV4cCI6MjA3MjQwMzQyNX0.do919Hvw2AK-Ql-2V5guoRRH2yx4Rmset4eeVXi__o8";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true }});

        const state = {
            session: null, profile: null, profileCache: new Map(),
            language: localStorage.getItem("lang") || "en",
            avatarFile: null,
            currentAvatarUrl: null
        };
        
        const t = {
            en: {
                tagline: "An informal seminar series to share advances in agrivoltaics in Latin America",
                nav: { schedule: "Schedule", archive: "Archive", about: "About", admin: "Admin" },
                auth: { signin: "Sign in", signout: "Sign out", signin_prompt_title: "Please Sign In", signin_prompt_body: "You need to be signed in to view and edit your profile.", signin_prompt_button: "Sign in on main page"},
                profile: { 
                    title: "Complete Your Profile", 
                    intro: "Please complete your profile to continue. Fields marked with * are required.", 
                    avatar: "Profile Picture",
                    avatar_upload: "Upload a profile picture",
                    avatar_hint: "JPG, PNG or GIF. Max 2MB.",
                    choose_image: "Choose Image",
                    remove_image: "Remove",
                    basic_info: "Basic Information", 
                    contact_info: "Contact Information", 
                    professional_links: "Professional Links", 
                    fields_section: "Research Interests", 
                    full_name: "Full Name", 
                    username: "Username", 
                    username_hint: "Used for @mentions and profile URL", 
                    affiliation: "Affiliation/Organization", 
                    work_email: "Work Email", 
                    personal_website: "Personal Website", 
                    professional_website: "Professional/Lab Website", 
                    google_scholar: "Google Scholar Profile", 
                    fields_of_study: "Fields of Study", 
                    fields_hint: "Separate multiple fields with commas", 
                    save: "Save Profile", 
                    saved: "Profile updated", 
                    skip: "Skip for now",
                    upload_error: "Failed to upload image. Please try again."
                },
                back: { general: "Back" },
                footer: { note: "Bilingual, community-driven seminar on agrivoltaics in Latin America." },
            },
            es: {
                tagline: "Serie de seminarios informales para compartir avances en agrofotovoltaica en América Latina",
                nav: { schedule: "Calendario", archive: "Archivo", about: "Acerca de", admin: "Admin" },
                auth: { signin: "Iniciar sesión", signout: "Cerrar sesión", signin_prompt_title: "Por favor, inicia sesión", signin_prompt_body: "Necesitas iniciar sesión para ver y editar tu perfil.", signin_prompt_button: "Iniciar sesión en la página principal"},
                profile: { 
                    title: "Completa tu Perfil", 
                    intro: "Por favor completa tu perfil para continuar. Los campos marcados con * son obligatorios.", 
                    avatar: "Foto de Perfil",
                    avatar_upload: "Subir una foto de perfil",
                    avatar_hint: "JPG, PNG o GIF. Máximo 2MB.",
                    choose_image: "Elegir Imagen",
                    remove_image: "Eliminar",
                    basic_info: "Información Básica", 
                    contact_info: "Información de Contacto", 
                    professional_links: "Enlaces Profesionales", 
                    fields_section: "Intereses de Investigación", 
                    full_name: "Nombre Completo", 
                    username: "Usuario", 
                    username_hint: "Usado para @menciones y URL del perfil", 
                    affiliation: "Afiliación/Organización", 
                    work_email: "Correo de Trabajo", 
                    personal_website: "Sitio Web Personal", 
                    professional_website: "Sitio Web Profesional/Laboratorio", 
                    google_scholar: "Perfil de Google Scholar", 
                    fields_of_study: "Campos de Estudio", 
                    fields_hint: "Separa múltiples campos con comas", 
                    save: "Guardar Perfil", 
                    saved: "Perfil actualizado", 
                    skip: "Omitir por ahora",
                    upload_error: "Error al subir la imagen. Por favor intenta de nuevo."
                },
                back: { general: "Atrás" },
                footer: { note: "Seminario bilingüe y comunitario sobre agrofotovoltaica en América Latina." },
            },
        };

        const $ = (sel) => document.querySelector(sel);
        function tr(key, fallback = "") { const lang = state.language; const parts = key.split("."); let obj = t[lang]; for (const p of parts) obj = obj?.[p]; return obj ?? fallback; }
        function setFlash(msg, timeout = 3000) { const el = $("#flash"); if (!el) return; el.textContent = msg; el.style.display = "block"; clearTimeout(setFlash._t); if (timeout > 0) setFlash._t = setTimeout(() => (el.style.display = "none"), timeout); }
        function escapeHtml(s = "") { return String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])); }
        function applyI18n() { document.querySelectorAll("[data-i18n]").forEach((el) => { el.textContent = tr(el.dataset.i18n, el.textContent); }); document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => { el.placeholder = tr(el.dataset.i18nPlaceholder, el.placeholder); }); document.querySelectorAll(".lang-switch-slider").forEach(el => el.dataset.lang = state.language); }
        
        async function fetchProfile(userId, { refresh = false } = {}) {
            if (!userId) return null;
            if (!refresh && state.profileCache.has(userId)) return state.profileCache.get(userId);
            const { data } = await supabase.from("profiles").select("*").eq("id", userId).single();
            if (data) state.profileCache.set(userId, data);
            return data;
        }

        async function getAvatarUrl(avatarPath) {
            if (!avatarPath) return null;
            const { data } = await supabase.storage.from("avatars").createSignedUrl(avatarPath, 3600);
            return data?.signedUrl;
        }

        function showView(which) {
            $("#profile").style.display = 'none';
            $("#publicProfileView").style.display = 'none';
            $("#signInPrompt").style.display = 'none';
            if(which) $(`#${which}`).style.display = 'block';
        }

        function updateAvatarPreview(url, initial) {
            const avatarImage = $("#avatarImage");
            const avatarInitial = $("#avatarInitial");
            
            if (url) {
                avatarImage.src = url;
                avatarImage.style.display = "block";
                avatarInitial.style.display = "none";
                $("#removeAvatar").style.display = "inline-block";
            } else {
                avatarImage.style.display = "none";
                avatarInitial.style.display = "block";
                avatarInitial.textContent = initial || "U";
                $("#removeAvatar").style.display = "none";
            }
        }

        async function populateProfileForm() {
            if (!state.profile) return;
            $("#fullName").value = state.profile.full_name || "";
            $("#username").value = state.profile.username || "";
            $("#affiliation").value = state.profile.affiliation || "";
            $("#workEmail").value = state.profile.work_email || state.session?.user?.email || "";
            $("#personalWebsite").value = state.profile.personal_website || "";
            $("#professionalWebsite").value = state.profile.professional_website || "";
            $("#googleScholar").value = state.profile.google_scholar || "";
            $("#fieldsOfStudy").value = state.profile.fields_of_study || "";
            
            // Handle avatar
            const initial = (state.profile.full_name || "U").charAt(0).toUpperCase();
            if (state.profile.avatar_url) {
                const avatarUrl = await getAvatarUrl(state.profile.avatar_url);
                state.currentAvatarUrl = avatarUrl;
                updateAvatarPreview(avatarUrl, initial);
            } else {
                updateAvatarPreview(null, initial);
            }
        }

        async function renderPublicProfile(userId) {
            const profile = await fetchProfile(userId, { refresh: true });
            if (!profile) {
                $("#publicProfileView").innerHTML = `<div class="empty">User not found.</div>`;
                showView('publicProfileView');
                return;
            }
            
            // Handle avatar in public profile
            const publicInitial = $("#publicProfileInitial");
            const publicImage = $("#publicProfileImage");
            const initial = (profile.full_name || "?").charAt(0).toUpperCase();
            
            publicInitial.textContent = initial;
            
            if (profile.avatar_url) {
                const avatarUrl = await getAvatarUrl(profile.avatar_url);
                if (avatarUrl) {
                    publicImage.src = avatarUrl;
                    publicImage.style.display = "block";
                    publicInitial.style.display = "none";
                } else {
                    publicImage.style.display = "none";
                    publicInitial.style.display = "block";
                }
            } else {
                publicImage.style.display = "none";
                publicInitial.style.display = "block";
            }
            
            $("#publicProfileName").textContent = profile.full_name || "Unnamed User";
            $("#publicProfileAffiliation").textContent = profile.affiliation || "No affiliation provided.";
            $("#publicProfileUsername .txt").textContent = `@${profile.username}`;
            $("#publicProfileUsername").style.display = profile.username ? 'inline-flex' : 'none';
            $("#publicProfileRole .txt").textContent = profile.role;
            $("#publicProfileRole").style.display = profile.role ? 'inline-flex' : 'none';
            const emailElement = $("#publicProfileEmail .txt");
            emailElement.textContent = profile.work_email;
            emailElement.href = `mailto:${profile.work_email}`;
            $("#publicProfileEmail").style.display = profile.work_email ? 'inline-flex' : 'none';
            const linksList = $("#publicProfileLinks");
            linksList.innerHTML = "";
            const linkItem = (url, labelKey, emoji) => `<li><a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer"><span class="link-icon">${emoji}</span><span>${escapeHtml(tr(labelKey))}</span></a></li>`;
            if (profile.personal_website) linksList.innerHTML += linkItem(profile.personal_website, 'profile.personal_website', "🏠");
            if (profile.professional_website) linksList.innerHTML += linkItem(profile.professional_website, 'profile.professional_website', "🏛️");
            if (profile.google_scholar) linksList.innerHTML += linkItem(profile.google_scholar, 'profile.google_scholar', "🎓");
            if (!linksList.innerHTML) linksList.innerHTML = `<li class="text-muted">No links provided.</li>`;
            const fields = (profile.fields_of_study || "").split(",").map(s => s.trim()).filter(Boolean);
            $("#publicProfileFields").innerHTML = fields.length ? fields.map(f => `<span class="chip">${escapeHtml(f)}</span>`).join("") : `<span class="text-muted">No research interests.</span>`;
            showView('publicProfileView');
        }
        
        function openMenu() {
            $("#mobileNavOverlay")?.classList.add("is-open");
            document.body.classList.add("menu-open");
            const btn = $("#mobileMenuBtn");
            if(btn) {
                btn.setAttribute("aria-expanded", "true");
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            }
        }
        function closeMenu() {
            $("#mobileNavOverlay")?.classList.remove("is-open");
            document.body.classList.remove("menu-open");
            const btn = $("#mobileMenuBtn");
            if(btn) {
                btn.setAttribute("aria-expanded", "false");
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
            }
        }
        function handleLangSwitch() {
            state.language = state.language === "en" ? "es" : "en";
            localStorage.setItem("lang", state.language);
            applyI18n();
        }
        function setupMobileMenu() {
            const mobileNavOverlay = $("#mobileNavOverlay");
            const desktopNav = document.querySelector('.header-grid .nav');
            if (!mobileNavOverlay || !desktopNav) return;
            mobileNavOverlay.innerHTML = '';
            const closeBtn = document.createElement('button');
            closeBtn.className = 'mobile-nav-close-btn';
            closeBtn.setAttribute('aria-label', 'Close menu');
            closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
            const content = desktopNav.cloneNode(true);
            content.id = '';
            const langSwitchMobile = content.querySelector('#langSwitchDesktop');
            if (langSwitchMobile) langSwitchMobile.id = 'langSwitchMobile';
            mobileNavOverlay.appendChild(closeBtn);
            mobileNavOverlay.appendChild(content);
            closeBtn.addEventListener('click', closeMenu);
            mobileNavOverlay.addEventListener('click', (e) => { if (e.target === mobileNavOverlay) closeMenu(); });
            langSwitchMobile?.addEventListener('click', handleLangSwitch);
            content.querySelector("#btnSignIn")?.addEventListener("click", () => window.location.href = 'index.html');
            content.querySelector("#btnSignOut")?.addEventListener("click", () => supabase.auth.signOut());
            content.querySelector("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');
        }
        async function renderHeader() {
            const isOrganizer = ["organizer", "admin"].includes(state.profile?.role);
            if (state.session) {
                $("#btnSignIn").style.display = "none"; $("#btnSignOut").style.display = "inline-block";
                $("#btnProfile").style.display = "grid"; $("#userName").style.display = "inline";
                $("#userName").textContent = state.profile?.full_name || state.profile?.username || "";
                
                // Handle avatar in header button
                const userInitial = $("#userInitial");
                const userAvatar = $("#userAvatar");
                
                if (state.profile?.avatar_url) {
                    const avatarUrl = await getAvatarUrl(state.profile.avatar_url);
                    if (avatarUrl) {
                        userAvatar.src = avatarUrl;
                        userAvatar.style.display = "block";
                        userInitial.style.display = "none";
                    } else {
                        userAvatar.style.display = "none";
                        userInitial.style.display = "block";
                        userInitial.textContent = (state.profile?.full_name || "U").charAt(0).toUpperCase();
                    }
                } else {
                    userAvatar.style.display = "none";
                    userInitial.style.display = "block";
                    userInitial.textContent = (state.profile?.full_name || "U").charAt(0).toUpperCase();
                }
                
                $("#btnAdmin").style.display = isOrganizer ? "inline-block" : "none";
            } else {
                $("#btnSignIn").style.display = "inline-block"; $("#btnSignOut").style.display = "none";
                $("#btnProfile").style.display = "none"; $("#userName").style.display = "none";
                $("#btnAdmin").style.display = "none";
            }
            setupMobileMenu();
        }
        async function initAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            state.session = session;
            if (session) state.profile = await fetchProfile(session.user.id);
            supabase.auth.onAuthStateChange(async (_event, newSession) => {
                state.session = newSession;
                state.profile = newSession ? await fetchProfile(newSession.user.id) : null;
                renderHeader();
                handlePageLogic();
            });
        }
        
        function handlePageLogic() {
            const urlParams = new URLSearchParams(window.location.search);
            const viewUserId = urlParams.get('id') || urlParams.get('user');

            if (viewUserId) {
                renderPublicProfile(viewUserId);
            } else if (state.session) {
                populateProfileForm();
                showView('profile');
            } else {
                showView('signInPrompt');
            }
        }
        
        async function uploadAvatar(file) {
            if (!file || !state.session) return null;
            
            // Check file size (2MB limit)
            if (file.size > 2 * 1024 * 1024) {
                setFlash("Image must be less than 2MB");
                return null;
            }
            
            const userId = state.session.user.id;
            const fileExt = file.name.split('.').pop();
            const fileName = `${userId}-${Date.now()}.${fileExt}`;
            const filePath = `avatars/${fileName}`;
            
            // Upload to storage
            const { data, error } = await supabase.storage
                .from('avatars')
                .upload(filePath, file, {
                    upsert: false,
                    contentType: file.type
                });
            
            if (error) {
                console.error('Upload error:', error);
                return null;
            }
            
            return data.path;
        }
        
        async function deleteOldAvatar(path) {
            if (!path) return;
            await supabase.storage.from('avatars').remove([path]);
        }
        
        function wireUI() {
            $("#btnSignOut")?.addEventListener("click", () => supabase.auth.signOut());
            $("#btnSignIn")?.addEventListener("click", () => window.location.href = `index.html`);
            $("#btnProfile")?.addEventListener("click", () => window.location.href = `profile.html`);
            $("#langSwitchDesktop")?.addEventListener('click', handleLangSwitch);
            $("#mobileMenuBtn")?.addEventListener("click", () => {
                const overlay = $("#mobileNavOverlay");
                if (overlay && !overlay.classList.contains('is-open')) openMenu(); else closeMenu();
            });
            
            $("#backButton")?.addEventListener("click", () => history.back());
            $("#backFromPublicProfile")?.addEventListener("click", () => history.back());

            const urlParams = new URLSearchParams(window.location.search);
            const returnTo = urlParams.get('return_to');
            const forceCompletion = urlParams.get('force') === 'true';

            if (forceCompletion) {
                if ($("#backButton")) $("#backButton").style.display = 'none';
                if ($("#skipProfile")) $("#skipProfile").style.display = 'none';
            } else {
                if ($("#skipProfile")) $("#skipProfile").style.display = 'inline-block';
            }

            $("#skipProfile")?.addEventListener("click", () => {
                if (returnTo) window.location.href = returnTo; else history.back();
            });

            // Avatar upload handling
            $("#avatarInput")?.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        setFlash("Please select an image file");
                        return;
                    }
                    
                    state.avatarFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const initial = ($("#fullName").value || "U").charAt(0).toUpperCase();
                        updateAvatarPreview(e.target.result, initial);
                    };
                    reader.readAsDataURL(file);
                }
            });

            $("#removeAvatar")?.addEventListener("click", () => {
                state.avatarFile = null;
                state.currentAvatarUrl = null;
                const initial = ($("#fullName").value || "U").charAt(0).toUpperCase();
                updateAvatarPreview(null, initial);
            });

            // Update avatar initial when name changes
            $("#fullName")?.addEventListener("input", (e) => {
                const initial = (e.target.value || "U").charAt(0).toUpperCase();
                $("#avatarInitial").textContent = initial;
            });

            $("#profileForm")?.addEventListener("submit", async (e) => {
                e.preventDefault();
                if (!state.session) return;
                
                let avatarPath = state.profile?.avatar_url;
                
                // Handle avatar upload if there's a new file
                if (state.avatarFile) {
                    const newAvatarPath = await uploadAvatar(state.avatarFile);
                    if (newAvatarPath) {
                        // Delete old avatar if it exists
                        if (state.profile?.avatar_url) {
                            await deleteOldAvatar(state.profile.avatar_url);
                        }
                        avatarPath = newAvatarPath;
                    } else {
                        setFlash(tr("profile.upload_error"));
                        return;
                    }
                } else if (state.currentAvatarUrl === null && state.profile?.avatar_url) {
                    // User removed their avatar
                    await deleteOldAvatar(state.profile.avatar_url);
                    avatarPath = null;
                }
                
                const profileData = {
                    full_name: $("#fullName").value.trim(), 
                    username: $("#username").value.trim(),
                    affiliation: $("#affiliation").value.trim(), 
                    work_email: $("#workEmail").value.trim(),
                    personal_website: $("#personalWebsite").value.trim() || null,
                    professional_website: $("#professionalWebsite").value.trim() || null,
                    google_scholar: $("#googleScholar").value.trim() || null,
                    fields_of_study: $("#fieldsOfStudy").value.trim() || null,
                    avatar_url: avatarPath
                };
                
                const { error } = await supabase.from("profiles").update(profileData).eq("id", state.session.user.id);
                if (!error) {
                    setFlash(tr("profile.saved"));
                    state.profile = await fetchProfile(state.session.user.id, { refresh: true });
                    state.avatarFile = null; // Clear the file after successful save
                    const profileComplete = !!(state.profile?.full_name && state.profile?.username && state.profile?.affiliation && state.profile?.work_email);
                    populateProfileForm();
                    renderHeader();
                    if(profileComplete && returnTo) {
                        setTimeout(() => window.location.href = returnTo, 1000);
                    }
                } else {
                    setFlash("Error: " + error.message);
                }
            });

            $("#year").textContent = new Date().getFullYear();
        }
        
        (async function main() {
            applyI18n();
            wireUI();
            await initAuth();
            renderHeader();
            handlePageLogic();
        })();
    </script>
</body>

</html>