<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPV Research Network | Publications & Collaboration Graph</title>
    <script src="auth-preloader.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script>tailwind.config = { theme: { extend: { fontFamily: { 'inter': ['Inter', 'sans-serif'] }, colors: { 'brand': '#16a34a', 'brand-light': '#dcfce7' } } } }; </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            transition: background-color .3s, color .3s
        }

        body.dark-mode {
            background-color: #0f172a;
            color: #cbd5e1
        }

        body.dark-mode .bg-white,
        body.dark-mode .bg-slate-50,
        body.dark-mode .bg-slate-50\/80 {
            background-color: #1e293b !important
        }

        body.dark-mode .bg-slate-100 {
            background-color: #334155 !important
        }

        body.dark-mode .border-slate-200,
        body.dark-mode .border-slate-100,
        body.dark-mode .border-b {
            border-color: #334155 !important
        }

        body.dark-mode .text-slate-800,
        body.dark-mode .text-slate-700,
        body.dark-mode .text-slate-900 {
            color: #e2e8f0 !important
        }

        body.dark-mode .text-slate-600,
        body.dark-mode .text-slate-500 {
            color: #94a3b8 !important
        }

        body.dark-mode .text-slate-400 {
            color: #64748b !important
        }

        body.dark-mode .pub-card:hover {
            background: #334155
        }

        body.dark-mode #graphContainer {
            background: radial-gradient(circle at 1px 1px, #94a3b810 1px, transparent 1px) -8px -8px / 24px 24px
        }

        body.dark-mode .d3-tooltip {
            background: #1e293bf2;
            border-color: #334155;
            color: #e2e8f0
        }

        body.dark-mode .modal-overlay {
            background: #000000aa
        }

        body.dark-mode .profile-modal,
        body.dark-mode .profile-modal>div {
            background: #1e293b !important;
            color: #e2e8f0
        }

        body.dark-mode input,
        body.dark-mode select {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important
        }

        body.dark-mode .node-label {
            stroke: #1e293bcc;
            fill: #e2e8f0
        }

        body.dark-mode .external-author {
            background-color: #334155;
            color: #94a3b8;
            border-color: #475569
        }

        body.dark-mode .edge-tooltip {
            background: #1e293bf2;
            border-color: #334155;
            color: #e2e8f0
        }

        body.dark-mode .filter-section {
            border-color: #334155
        }

        body.dark-mode .hull-path {
            opacity: 0.08
        }

        body.dark-mode .constellation-node {
            stroke: #334155
        }
        
        body.dark-mode .heatmap-tooltip {
            background: #1e293bf2;
            color: #e2e8f0;
            border-color: #334155;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
            height: 4px
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: 0 0
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8
        }

        .split-handle {
            cursor: col-resize;
            width: 1px;
            background: #e2e8f0;
            position: relative;
            z-index: 20;
            transition: background .2s
        }

        .split-handle::after {
            content: '';
            position: absolute;
            inset: 0 -2px;
            z-index: 10
        }

        .split-handle:active,
        .split-handle:hover {
            background: #16a34a;
            width: 2px
        }

        .pub-card {
            transition: all .2s ease;
            border-bottom: 1px solid #f1f5f9;
            position: relative
        }

        .pub-card:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px #0000000d;
            z-index: 10;
            border-radius: 6px
        }

        .network-member {
            background-color: #dcfce7;
            color: #15803d;
            border: 1px solid #86efac
        }

        .external-author {
            background-color: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0
        }

        .d3-tooltip,
        .edge-tooltip {
            pointer-events: none;
            position: absolute;
            background: #fffffff2;
            backdrop-filter: blur(4px);
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            z-index: 50;
            box-shadow: 0 4px 15px -3px #0000001a;
            min-width: 200px;
            font-size: 11px
        }

        .d3-tooltip {
            max-width: 320px
        }

        .edge-tooltip {
            padding: 8px 10px;
            z-index: 51;
            min-width: 180px;
            max-width: 280px;
            font-size: 10px
        }
        
        /* UPDATED: Heatmap Tooltip to block only bottom portion */
        .heatmap-tooltip {
            pointer-events: none;
            position: absolute;
            inset: auto 0 0 0; /* Bottom: 0, Left: 0, Right: 0, Top: Auto */
            height: 36px; /* Fixed small height */
            background: #fffffff2;
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: row; /* Horizontal layout */
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: opacity 0.2s;
            text-align: center;
            padding: 0 10px;
            font-size: 8px;
            border-top: 1px solid #e2e8f0;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: #00000066;
            backdrop-filter: blur(2px);
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: .2s;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto
        }

        .profile-modal {
            transform: scale(.95);
            transition: .2s
        }

        .modal-overlay.active .profile-modal {
            transform: scale(1)
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin .8s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1
            }

            100% {
                transform: scale(2.2);
                opacity: 0
            }
        }

        .pulse-highlight {
            animation: pulse-ring 1.2s ease-out infinite
        }

        #graphContainer {
            background: radial-gradient(circle at 1px 1px, #94a3b826 1px, transparent 1px) -8px -8px / 24px 24px;
            position: relative
        }

        #graphContainer:active {
            cursor: grabbing
        }

        #particleCanvas {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1
        }

        #networkGraph {
            position: relative;
            z-index: 2
        }

        .node-label {
            paint-order: stroke;
            stroke: #ffffffcc;
            stroke-width: 3px;
            stroke-linejoin: round;
            font-family: 'Inter', sans-serif;
            letter-spacing: -.01em
        }

        .hull-path {
            stroke-linejoin: round;
            stroke-linecap: round;
            opacity: 0.12;
            transition: opacity 0.3s
        }

        .hull-path:hover {
            opacity: 0.25
        }

        .temporal-arc {
            pointer-events: none
        }

        input[type=range] {
            -webkit-appearance: none;
            background: 0 0
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #16a34a;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 1px 2px #0003
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 1px
        }

        .timeline-bar {
            fill: #16a34a;
            opacity: .4;
            cursor: pointer;
            transition: opacity .15s
        }

        .timeline-bar:hover {
            opacity: .8
        }

        .timeline-bar.selected {
            opacity: 1;
            fill: #15803d
        }

        .bookmark-btn {
            transition: all .15s ease
        }

        .bookmark-btn.active {
            color: #f59e0b !important
        }

        .bookmark-btn:hover {
            transform: scale(1.2)
        }

        .pub-checkbox {
            accent-color: #16a34a;
            width: 13px;
            height: 13px;
            cursor: pointer;
            flex-shrink: 0
        }

        .batch-bar {
            transition: all .3s ease;
            transform: translateY(100%)
        }

        .batch-bar.visible {
            transform: translateY(0)
        }

        .sparkline-container {
            display: inline-block;
            vertical-align: middle
        }

        .graph-search-input {
            transition: width .3s ease, opacity .3s ease
        }

        .scroll-mode-infinite #paginationContainer {
            display: none !important
        }

        .heatmap-cell {
            cursor: pointer;
            transition: opacity .15s
        }

        .heatmap-cell:hover {
            opacity: 0.9
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f5f9;
            margin-bottom: 12px
        }

        .filter-header {
            font-size: 10px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .constellation-panel {
            display: none;
            position: relative;
            width: 100%;
            height: 100%
        }

        .constellation-panel.active {
            display: flex;
            flex-direction: column
        }

        .constellation-node {
            cursor: pointer;
            transition: r 0.15s, opacity 0.15s;
            stroke: #fff;
            stroke-width: 0.5
        }

        .constellation-node:hover {
            opacity: 1 !important
        }

        .constellation-link {
            stroke: #94a3b8;
            stroke-opacity: 0.15
        }

        .ego-mini-node {
            cursor: default
        }

        .ego-mini-link {
            stroke: #94a3b8;
            stroke-width: 1
        }
    </style>
</head>

<body class="bg-white text-slate-700 h-screen w-screen flex flex-col overflow-hidden">
    <!-- Body content remains same, just updated CSS above and JS logic below -->
    <div id="scholarApp" class="flex flex-1 overflow-hidden min-h-0 w-full">
        <aside
            class="w-[320px] flex flex-col border-r border-slate-200 bg-slate-50/80 shrink-0 h-full z-30 backdrop-blur-sm">
            <!-- Sidebar content -->
            <div class="p-4 border-b border-slate-200 bg-white">
                <div class="flex items-center gap-2.5 mb-3">
                    <div
                        class="w-8 h-8 rounded-lg bg-green-600 text-white flex items-center justify-center shadow-md shadow-green-200/50">
                        <i class="fas fa-leaf text-sm"></i></div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <h1 class="font-bold text-slate-800 text-sm leading-tight">AgriPV Network</h1>
                            <button id="bookmarkFilterBtn" onclick="app.toggleBookmarkFilter()"
                                class="flex items-center gap-1 px-1.5 py-0.5 rounded-full text-[8px] font-bold border transition-all bg-slate-50 text-slate-500 border-slate-200 hover:bg-amber-50 hover:text-amber-600 hover:border-amber-200"><i
                                    class="fas fa-bookmark"></i> <span id="bookmarkCount">0</span></button>
                        </div>
                        <p class="text-[9px] text-slate-400 font-medium uppercase tracking-wider">Research Explorer</p>
                    </div>
                    <div class="flex items-center gap-1">
                        <button id="darkModeToggle" title="Toggle Dark Mode"
                            class="w-7 h-7 flex items-center justify-center rounded-md hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"><i
                                class="fas fa-moon text-xs" id="darkModeIcon"></i></button>
                    </div>
                </div>
                <div class="relative group">
                    <input type="text" id="globalSearch" placeholder="Search title, author, topic, abstract..."
                        class="w-full bg-slate-100 border-none rounded-md py-2 pl-9 pr-3 text-xs font-medium focus:ring-1 focus:ring-green-500 focus:bg-white transition-all placeholder:text-slate-400">
                    <i
                        class="fas fa-search text-slate-400 absolute left-3 top-2.5 text-xs group-focus-within:text-green-600"></i>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scroll p-4">
                <div class="filter-section">
                    <div class="filter-header">Network Stats</div>
                    <div class="grid grid-cols-4 gap-1.5" id="statsGrid"></div>
                </div>
                <div class="filter-section">
                    <div class="filter-header">Publication Timeline</div>
                    <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-2"><svg id="timelineChart"
                            width="100%" height="50"></svg>
                        <div class="text-[8px] text-slate-400 mt-1 leading-snug text-center">Click to filter.
                            Shift+click for range.</div>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex flex-col">
                            <div class="filter-header">Pub Year</div>
                            <div
                                class="flex items-center gap-1 bg-white px-1 rounded-lg border border-slate-200 shadow-sm h-8">
                                <input type="number" id="yearFrom" min="2000" max="2026" placeholder="2000"
                                    class="w-full border-none bg-transparent text-center text-[10px] font-medium focus:ring-0 p-1 text-slate-600 placeholder:text-slate-300"><span
                                    class="text-slate-300 text-[8px] font-bold">-</span><input type="number" id="yearTo"
                                    min="2000" max="2026" placeholder="2025"
                                    class="w-full border-none bg-transparent text-center text-[10px] font-medium focus:ring-0 p-1 text-slate-600 placeholder:text-slate-300">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <div class="filter-header">Min Score: <span class="text-green-600 font-mono"
                                    id="valMinRel">4.0</span></div>
                            <div
                                class="bg-white px-2 rounded-lg border border-slate-200 shadow-sm flex items-center h-8">
                                <input type="range" id="minRelevance" min="0" max="30" step="0.5" value="2"
                                    class="w-full block"></div>
                        </div>
                    </div>
                </div>
                <div class="filter-section h-48">
                    <div class="filter-header">Institutions <button class="text-green-600 hover:underline"
                            onclick="app.clear('insts')">Reset</button></div>
                    <div id="institutionFilters" class="flex-1 overflow-y-auto custom-scroll pr-1 space-y-0.5 max-h-40">
                    </div>
                </div>
                <div class="filter-section">
                    <div class="filter-header">Topics <button class="text-green-600 hover:underline"
                            onclick="app.clear('topics')">Reset</button></div>
                    <div id="topicFilters" class="flex flex-wrap gap-1 max-h-40 overflow-y-auto custom-scroll"></div>
                </div>
                <div class="mt-2">
                    <div class="filter-header">Topic Co-occurrence</div>
                    <div id="heatmapContainer"
                        class="bg-white rounded-lg border border-slate-200 shadow-sm p-2 mt-2 relative overflow-hidden">
                        <svg id="heatmapChart" width="100%" height="200"></svg>
                        <div id="heatmapTooltip" class="heatmap-tooltip opacity-0 pointer-events-none"></div>
                        <div class="text-[8px] text-slate-400 mt-1 leading-snug text-center">Select cell to filter
                            interactions</div>
                    </div>
                </div>
            </div>
            <div id="activeFiltersPanel" class="px-4 py-3 bg-white border-t border-slate-200 hidden shrink-0">
                <div class="flex justify-between items-center mb-2"><span
                        class="text-[10px] font-semibold text-slate-500"><span id="activeFilterCount">0</span> filters
                        active</span><button class="text-[9px] text-red-500 font-semibold hover:text-red-700"
                        onclick="app.reset()">Clear All</button></div>
                <div id="activeFilterTags" class="flex flex-wrap gap-1 max-h-14 overflow-y-auto custom-scroll"></div>
            </div>
        </aside>
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-white relative">
            <header
                class="h-12 border-b border-slate-200 flex items-center justify-between px-4 bg-white shrink-0 z-20">
                <div class="flex gap-0.5 p-0.5 bg-slate-100 rounded-md border border-slate-200">
                    <button data-view="both"
                        class="view-btn px-2.5 py-1 text-[11px] font-semibold rounded bg-white shadow-sm text-slate-800"><i
                            class="fas fa-columns mr-1.5"></i>Split</button>
                    <button data-view="publications"
                        class="view-btn px-2.5 py-1 text-[11px] font-semibold rounded text-slate-500 hover:text-slate-700"><i
                            class="fas fa-list mr-1.5"></i>List</button>
                    <button data-view="network"
                        class="view-btn px-2.5 py-1 text-[11px] font-semibold rounded text-slate-500 hover:text-slate-700"><i
                            class="fas fa-project-diagram mr-1.5"></i>Graph</button>
                    <button data-view="constellation"
                        class="view-btn px-2.5 py-1 text-[11px] font-semibold rounded text-slate-500 hover:text-slate-700"><i
                            class="fas fa-star mr-1.5"></i>Constellation</button>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-[11px] text-slate-500 font-medium">Found <span id="filteredCount"
                            class="text-slate-900 font-bold">0</span> results</div>
                    <div class="h-3 w-px bg-slate-300"></div>
                    <button id="scrollModeBtn" onclick="app.toggleScrollMode()"
                        class="text-[10px] text-slate-500 hover:text-slate-700 font-medium flex items-center gap-1"
                        title="Toggle between paginated and infinite scroll"><i class="fas fa-stream text-[9px]"></i>
                        <span id="scrollModeLabel">Pages</span></button>
                    <div class="h-3 w-px bg-slate-300"></div>
                    <select id="sortSelect"
                        class="text-[11px] font-medium bg-transparent border-none outline-none text-slate-600 cursor-pointer hover:text-slate-900 focus:ring-0 py-0 pl-0 pr-6">
                        <option value="recent">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="relevance">Relevance Score</option>
                        <option value="cited">Most Cited</option>
                        <option value="title">A-Z Title</option>
                        <option value="bookmarked">Bookmarked First</option>
                    </select>
                    <div class="relative" id="exportDropdown">
                        <button
                            class="px-2.5 py-1 bg-slate-900 text-white text-[11px] font-semibold rounded hover:bg-slate-800 shadow-sm transition-colors flex items-center gap-1.5"
                            onclick="app.toggleExportMenu()"><i class="fas fa-download"></i>Export <i
                                class="fas fa-chevron-down text-[8px] opacity-60"></i></button>
                        <div id="exportMenu"
                            class="absolute right-0 top-full mt-1 w-44 bg-white border border-slate-200 rounded-lg shadow-lg py-1 hidden z-50">
                            <button onclick="app.exportData('csv')"
                                class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                    class="fas fa-file-csv w-4 text-green-600"></i>CSV Spreadsheet</button>
                            <button onclick="app.exportData('bib')"
                                class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                    class="fas fa-code w-4 text-purple-600"></i>BibTeX (.bib)</button>
                            <button onclick="app.exportData('ris')"
                                class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                    class="fas fa-file-import w-4 text-blue-600"></i>RIS (Zotero)</button>
                            <div class="border-t border-slate-100 my-1"></div>
                            <button onclick="app.exportData('csv', true)" id="exportSelectedBtn"
                                class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2 hidden"><i
                                    class="fas fa-check-square w-4 text-green-600"></i>Selected as CSV</button>
                            <button onclick="app.exportData('bib', true)" id="exportSelectedBibBtn"
                                class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2 hidden"><i
                                    class="fas fa-check-square w-4 text-purple-600"></i>Selected as BibTeX</button>
                            <div id="exportSelectedDivider" class="border-t border-slate-100 my-1 hidden"></div>
                            <button onclick="app.exportGraphSVG()"
                                class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                    class="fas fa-image w-4 text-rose-600"></i>Graph as SVG</button>
                            <button onclick="app.exportGraphPNG()"
                                class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                    class="fas fa-file-image w-4 text-orange-600"></i>Graph as PNG</button>
                        </div>
                    </div>
                </div>
            </header>
            <div id="contentArea" class="flex-1 flex overflow-hidden relative">
                <!-- Content panels (list, graph, constellation) -->
                <div id="publicationsPanel"
                    class="flex flex-col min-w-0 w-1/2 bg-white h-full border-r border-slate-100">
                    <div
                        class="flex items-center justify-between px-3 py-1.5 border-b border-slate-100 shrink-0 bg-slate-50/50 min-h-[28px]">
                        <div id="batchActions" class="flex items-center gap-1 hidden">
                            <span class="text-[9px] text-slate-500 font-medium"><span id="selectedCount">0</span>
                                selected</span>
                            <button onclick="app.batchCite()"
                                class="px-1.5 py-0.5 text-[9px] font-semibold text-slate-500 hover:text-green-600 bg-slate-100 rounded border border-slate-200"
                                title="Cite Selected"><i class="fas fa-quote-left"></i></button>
                            <button onclick="app.batchBookmark()"
                                class="px-1.5 py-0.5 text-[9px] font-semibold text-slate-500 hover:text-amber-500 bg-slate-100 rounded border border-slate-200"
                                title="Bookmark Selected"><i class="fas fa-bookmark"></i></button>
                            <button onclick="app.clearSelection()"
                                class="px-1.5 py-0.5 text-[9px] font-semibold text-red-400 hover:text-red-600 bg-slate-100 rounded border border-slate-200"
                                title="Clear Selection"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div id="publicationsList" class="flex-1 overflow-y-auto p-2 custom-scroll bg-white"></div>
                    <div class="p-2 border-t border-slate-200 bg-white shrink-0 flex flex-col gap-2">
                        <div class="flex justify-between items-center text-[10px] text-slate-400 px-1"><span><span
                                    id="showingFrom">0</span>-<span id="showingTo">0</span> of <span
                                    id="totalPublications">0</span></span></div>
                        <div id="paginationContainer" class="flex justify-center gap-1"></div>
                    </div>
                </div>
                <div id="splitHandle" class="split-handle" title="Drag to resize"></div>
                <div id="networkPanel" class="flex flex-col min-w-0 w-1/2 bg-slate-50 relative h-full">
                    <button onclick="document.getElementById('networkInfoModal').classList.add('active')" class="absolute top-3 right-40 z-20 w-6 h-6 flex items-center justify-center bg-white/80 backdrop-blur border border-slate-200 rounded-full text-slate-400 hover:text-blue-500 hover:border-blue-300 shadow-sm transition-colors" title="Graph Information"><i class="fas fa-info text-[10px]"></i></button>
                    <!-- Controls and Graph container -->
                    <div class="absolute top-3 left-3 z-10 flex flex-col gap-2">
                         <div
                            class="bg-white/80 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-0.5 flex flex-col gap-0.5">
                            <button
                                class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                                onclick="app.zoom(1.3)" title="Zoom In"><i class="fas fa-plus text-[10px]"></i></button>
                            <button
                                class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                                onclick="app.zoom(0.7)" title="Zoom Out"><i
                                    class="fas fa-minus text-[10px]"></i></button>
                            <button
                                class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                                onclick="app.fitGraph()" title="Fit to Screen"><i
                                    class="fas fa-compress-arrows-alt text-[10px]"></i></button>
                        </div>
                        <div
                            class="bg-white/80 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-0.5 flex flex-col gap-0.5">
                            <button
                                class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                                onclick="app.toggleCluster()" title="Toggle Grouping"><i
                                    class="fas fa-layer-group text-[10px]"></i></button>
                            <button
                                class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                                onclick="app.toggleLabels()" title="Toggle Labels"><i
                                    class="fas fa-tag text-[10px]"></i></button>
                            <button
                                class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                                onclick="app.toggleParticles()" title="Toggle Flow Particles" id="particleToggleBtn"><i
                                    class="fas fa-water text-[10px]"></i></button>
                        </div>
                    </div>
                    <div class="absolute top-3 right-3 z-10 flex flex-col gap-2">
                        <div
                            class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-2 w-32 space-y-2">
                            <div>
                                <div class="flex justify-between mb-0.5"><label
                                        class="text-[8px] font-bold text-slate-400 uppercase">Link Dist</label></div>
                                <input type="range" id="linkDistance" min="50" max="320" value="120"
                                    class="w-full block">
                            </div>
                            <div>
                                <div class="flex justify-between mb-0.5"><label
                                        class="text-[8px] font-bold text-slate-400 uppercase">Gravity</label></div>
                                <input type="range" id="chargeStrength" min="100" max="900" value="320"
                                    class="w-full block">
                            </div>
                        </div>
                        <div class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-1.5 w-32">
                            <div class="flex items-center gap-1 mb-1"><i
                                    class="fas fa-search text-[8px] text-slate-400"></i><label
                                    class="text-[8px] font-bold text-slate-400 uppercase">Find Node</label></div>
                            <input type="text" id="graphSearchInput" placeholder="Researcher..."
                                class="graph-search-input w-full bg-slate-50 border border-slate-200 rounded py-1 px-1.5 text-[10px] focus:ring-1 focus:ring-green-500 focus:bg-white placeholder:text-slate-300">
                        </div>
                    </div>
                    <div class="absolute bottom-3 left-3 z-10 pointer-events-none">
                        <div
                            class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-2 max-h-32 overflow-y-auto custom-scroll w-40 pointer-events-auto">
                            <div class="text-[8px] font-bold text-slate-400 uppercase mb-1">Affiliations</div>
                            <div id="legendContainer" class="space-y-0.5"></div>
                        </div>
                    </div>
                    <div id="graphContainer" class="flex-1 w-full h-full cursor-grab overflow-hidden">
                        <canvas id="particleCanvas"></canvas>
                        <svg id="networkGraph" width="100%" height="100%"></svg>
                    </div>
                    <div id="tooltip" class="d3-tooltip hidden"></div>
                    <div id="edgeTooltip" class="edge-tooltip hidden"></div>
                </div>
                <div id="constellationPanel" class="constellation-panel min-w-0 bg-slate-50 relative h-full">
                    <button onclick="document.getElementById('constellationInfoModal').classList.add('active')" class="absolute top-3 right-3 z-20 w-6 h-6 flex items-center justify-center bg-white/80 backdrop-blur border border-slate-200 rounded-full text-slate-400 hover:text-blue-500 hover:border-blue-300 shadow-sm transition-colors" title="Constellation Information"><i class="fas fa-info text-[10px]"></i></button>
                    <div class="absolute top-3 left-3 z-10">
                        <div class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-2 w-40">
                            <div class="text-[8px] font-bold text-slate-400 uppercase mb-1">Publication Similarity</div>
                            <div class="text-[9px] text-slate-500">Papers cluster by shared topics. Edges = â‰¥2 shared topics. Color = dominant topic.</div>
                        </div>
                    </div>
                    <div id="constellationTooltip" class="d3-tooltip hidden"></div>
                    <svg id="constellationGraph" width="100%" height="100%"></svg>
                </div>
            </div>
        </main>
    </div>
    <!-- Modals remain same -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="spinner mb-4 border-slate-200 border-t-green-600"></div>
        <h3 class="text-base font-bold text-slate-800 tracking-tight">Initializing Explorer</h3>
        <p id="loadingStatus" class="text-xs text-slate-400 mt-1 font-medium">Connecting to network...</p>
        <div class="w-48 bg-slate-100 rounded-full h-1 mt-6 overflow-hidden">
            <div id="loadingProgress" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
        </div>
    </div>
    <div id="citationModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="profile-modal w-full max-w-lg bg-white rounded-xl shadow-2xl border border-slate-100 p-5">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                <h3 class="font-bold text-sm text-slate-800">Cite Publication</h3><button
                    onclick="document.getElementById('citationModal').classList.remove('active')"
                    class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">APA</label>
                    <div
                        class="bg-slate-50 p-2.5 rounded border border-slate-200 relative group text-xs text-slate-600 font-mono leading-relaxed">
                        <span id="citeAPA"></span><button
                            class="absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-white border border-slate-200 rounded shadow-sm text-slate-400 hover:text-green-600 text-[10px]"
                            onclick="app.copy('citeAPA')"><i class="fas fa-copy"></i></button></div>
                </div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">BibTeX</label>
                    <div
                        class="bg-slate-50 p-2.5 rounded border border-slate-200 relative group text-xs text-slate-600 font-mono leading-relaxed break-all">
                        <span id="citeBib"></span><button
                            class="absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-white border border-slate-200 rounded shadow-sm text-slate-400 hover:text-green-600 text-[10px]"
                            onclick="app.copy('citeBib')"><i class="fas fa-copy"></i></button></div>
                </div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">RIS</label>
                    <div
                        class="bg-slate-50 p-2.5 rounded border border-slate-200 relative group text-xs text-slate-600 font-mono leading-relaxed break-all">
                        <span id="citeRIS"></span><button
                            class="absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-white border border-slate-200 rounded shadow-sm text-slate-400 hover:text-green-600 text-[10px]"
                            onclick="app.copy('citeRIS')"><i class="fas fa-copy"></i></button></div>
                </div>
            </div>
        </div>
    </div>
    <div id="detailModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div
            class="profile-modal w-full max-w-4xl max-h-[90vh] bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div id="detailContent" class="overflow-y-auto p-8 custom-scroll"></div>
        </div>
    </div>
    <div id="researcherModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div
            class="profile-modal w-full max-w-lg bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden max-h-[85vh]">
            <div id="researcherContent" class="overflow-y-auto custom-scroll p-0"></div>
        </div>
    </div>
    <div id="compareModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div
            class="profile-modal w-full max-w-3xl max-h-[90vh] bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div id="compareContent" class="overflow-y-auto p-6 custom-scroll"></div>
        </div>
    </div>
    <div id="batchCiteModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div
            class="profile-modal w-full max-w-2xl max-h-[85vh] bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-slate-100">
                <h3 class="font-bold text-sm text-slate-800">Batch Citations</h3><button
                    onclick="document.getElementById('batchCiteModal').classList.remove('active')"
                    class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="batchCiteContent" class="overflow-y-auto p-5 custom-scroll space-y-3"></div>
        </div>
    </div>
    <div id="networkInfoModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="profile-modal w-full max-w-md bg-white rounded-xl shadow-2xl border border-slate-100 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sm text-slate-800">About the Collaboration Graph</h3>
                <button onclick="document.getElementById('networkInfoModal').classList.remove('active')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3 text-xs text-slate-600 leading-relaxed">
                <p>This graph visualizes the collaboration network between researchers in the AgriPV field.</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li><strong class="text-slate-800">Nodes:</strong> Represent individual researchers. Size indicates the number of publications and citations.</li>
                    <li><strong class="text-slate-800">Edges:</strong> Represent co-authorship. Thicker lines mean more shared publications.</li>
                    <li><strong class="text-slate-800">Colors:</strong> Represent the researcher's primary institution.</li>
                    <li><strong class="text-slate-800">Groups (Hulls):</strong> Background shapes group researchers from the same institution.</li>
                    <li><strong class="text-slate-800">Particles:</strong> Moving particles indicate the "flow" of collaboration intensity.</li>
                </ul>
                <p class="text-slate-400 italic mt-2">Use the controls in the top-left to toggle features like particles or clustering.</p>
            </div>
        </div>
    </div>
    <div id="constellationInfoModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="profile-modal w-full max-w-md bg-white rounded-xl shadow-2xl border border-slate-100 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sm text-slate-800">About the Constellation View</h3>
                <button onclick="document.getElementById('constellationInfoModal').classList.remove('active')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3 text-xs text-slate-600 leading-relaxed">
                <p>The Constellation view organizes publications based on thematic similarity rather than authorship.</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li><strong class="text-slate-800">Nodes:</strong> Represent individual publications. Size scales with citation count.</li>
                    <li><strong class="text-slate-800">Links:</strong> Connect papers that share at least 2 major topics.</li>
                    <li><strong class="text-slate-800">Colors:</strong> Indicate the dominant topic of the paper (see legend).</li>
                    <li><strong class="text-slate-800">Clustering:</strong> Papers with similar topics naturally pull together, revealing thematic clusters in the research landscape.</li>
                </ul>
                <p class="text-slate-400 italic mt-2">Hover over nodes to see paper details. Click to open the full abstract view.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase, authState, initAuth, signOut } from "./auth.js";
        import { renderLayout } from './layout.js';
        import { initSharedUI, renderHeader, getAvatarUrl, $, show, hide } from './ui.js';

        renderLayout('scholar');
        const sleep = ms => new Promise(r => setTimeout(r, ms)), el = id => document.getElementById(id), norm = s => (s || "").trim().toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " "), esc = s => s ? s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '{': '&#123;', '}': '&#125;', '"': '&quot;', "'": '&#39;' }[c])) : "", clamp = (v, a, b) => Math.max(a, Math.min(b, v));
        const COLORS = ["#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6", "#06b6d4", "#ec4899", "#6366f1", "#84cc16", "#f97316", "#64748b", "#14b8a6"], CFG = { api: "https://api.openalex.org", key: "asf_network_v15", now: new Date().getFullYear(), minRel: 1.0, cap: 50, conc: 8, defMin: 4.0 };
        const RX = { explicit: /\b(agri[\s-]?(pv|photo)?voltai[ckqs]?(s)?|agro[\s-]?(photo)?voltai[ckqs]?(s)?|agri[\s-]?pv|agro[\s-]?pv|solar[\s-]?sharing|solar[\s-]?farm(ing|er)|farming[\s-]?(with|under)[\s-]?(solar|pv)|photovoltaic[\s-]?greenhouse|greenhouse[\s-]?photovoltaic|range[\s-]?voltaic|ecovoltaic|aqua[\s-]?voltaic|aqua[\s-]?pv)\b/i, solar: /\b(pv|photovoltai[ckqs]?|solar\s*(module|panel|array|collector|energy|power|cell|park|installation|tracker|generator))\b/i, agri: /\b(crop|harvest|biomass|agronom|horticultur|viticultur|orchard|vineyard|greenhouse|livestock|pasture|grazing|sheep|cattle|arable|cultivat|irrigation|soil\s*moisture|shade\s*tolerant|photosynthe|transpiration|pollinator|forage|silage|hay\b|food\s*production|food\s*security|aquacultur|silvopastur)\b/i, interaction: /\b(dual[\s-]?use|co[\s-]?locat|land[\s-]?use[\s-]?efficien|ler\b|land[\s-]?equivalent[\s-]?ratio|shading\s*effect|beneath\s*(panels?|arrays?)|under\s*(panels?|arrays?)|inter[\s-]?row|microclimat|light[\s-]?management|par\b|photosynthetical[\s-]?active|food[\s-]?energy[\s-]?water|water[\s-]?energy[\s-]?food|nexus)\b/i, neg: /\b(uncolog|cancer|tumor|biomed|patient|surgery|clinic|hospital|medic|therap|gene(tic|ome|s)?\b|rna|dna|protein|cell\s*(culture|line|signaling)|molecular|disease|syndrome|disorder|health|morbidity|mortality|epidemi|virus|bacteri|infection|parkinson|alzheimer|stroke|diabetes|insulin|obesity|cardio|respiratory|lewy|dementia|schizo|autism|spin\b|magnetic|galaxy|telescope|neutron|boson|nanotube|graphene|supercapacit|lithium|battery(?!.*(solar|pv|storage)))\b/i, prox: /\b(solar|pv|photovoltai).{0,80}(crop|farm|agri|plant|yield|soil)|(crop|farm|agri|plant|yield|soil).{0,80}(solar|pv|photovoltai)/i, tech: /\b(bifacial|tracking|inverter|mounting|racking|albedo|ground[\s-]?cover|gcr|row[\s-]?spacing|tilt[\s-]?angle|elevation|stilt|vertical[\s-]?pv|semi[\s-]?transparent)\b/i };
        const TOPIC_NEG = new Set(["parkinson's disease mechanisms and treatments", "air quality and health impacts", "global health care issues", "climate change and health impacts", "global public health policies and epidemiology", "global maternal and child health", "neurological diseases and metabolism", "health disparities and outcomes", "genetic associations and epidemiology", "nuclear receptors and signaling", "covid-19 epidemiological studies", "cellular transport and secretion", "autism spectrum disorder research", "sars-cov-2 and covid-19 research", "sphingolipid metabolism and signaling", "neurological disorders and treatments", "advanced sensor and energy harvesting materials", "dielectric materials and actuators", "advanced materials and mechanics", "atmospheric chemistry and aerosols", "air quality monitoring and forecasting", "geology and paleoclimatology research", "genetics and neurodevelopmental disorders", "lysosomal storage disorders research", "antibiotic resistance in bacteria", "genomic variations and chromosomal abnormalities", "genomics and rare diseases", "dementia and cognitive impairment research", "sars-cov-2 detection and testing", "healthcare cost, quality, practices", "rna regulation and disease", "liver disease diagnosis and treatment", "epigenetics and dna methylation", "genetic syndromes and imprinting", "supercapacitor materials and fabrication", "carbon nanotubes in composites", "graphene research and applications", "genomics and phylogenetic studies", "mxene and max phase materials", "child nutrition and water access", "liver disease and transplantation", "microbial community ecology and physiology", "alzheimer's disease research and treatments", "genetic neurodegenerative diseases", "rna and protein synthesis mechanisms", "rna research and splicing", "diabetes, cardiovascular risks, and lipoproteins", "health systems, economic evaluations, quality of life", "cryospheric studies and observations", "rna modifications and cancer", "antibiotic use and resistance", "nutritional studies and diet", "alcohol consumption and health effects", "smoking behavior and cessation", "endoplasmic reticulum stress and disease", "aeolian processes and effects", "energy harvesting in wireless networks", "health, environment, cognitive aging", "healthcare systems and reforms"].map(s => norm(s)));
        const INST_MAP = [['arizona', 'Univ. of Arizona'], ['unam', 'UNAM'], ['nacional autonoma', 'UNAM'], ['chile', 'Univ. de Chile'], ['fraunhofer', 'Fraunhofer ISE'], ['wageningen', 'Wageningen UR'], ['nrel', 'NREL'], ['davis', 'UC Davis'], ['umass', 'UMass Amherst'], ['massachusetts', 'UMass Amherst']], TOPIC_BLOCK = new Set(["medicine", "physics", "materials science", "computer science", "chemistry", "biology", "mathematics", "philosophy", "art", "psychology", "geology", "sociology"]);
        /* ... existing functions fetchJSON, getInst, invIdx, Storage, scoreWork ... */
        const fetchJSON = async (u, r = 3) => {
            u += (u.includes('?') ? '&' : '?') + 'mailto=research-tool@agripv.org';
            for (let i = 0; i < r; i++) {
                try { const d = await fetch(u); if (d.ok) return await d.json(); if (d.status === 429) await sleep((parseFloat(d.headers.get("Retry-After") || 1) * 1000) * (i + 1)); else if (d.status >= 500) await sleep(500 * (i + 1)); else return null } catch { if (i === r - 1) return null; await sleep(250) }
            }
        }, getInst = i => { if (!i) return "Unknown"; const l = norm(i), h = INST_MAP.find(x => l.includes(x[0])); return h ? h[1] : i.replace(/university/gi, 'Univ.').replace(/institute/gi, 'Inst.').split(',')[0].trim().substring(0, 28) }, invIdx = i => { if (!i) return ''; const a = []; for (const [w, p] of Object.entries(i)) for (const x of p) a[x] = w; return a.join(' ') }, Storage = { get: k => { try { const i = JSON.parse(localStorage.getItem(k)); return i && i.e > Date.now() ? i.v : null } catch { return null } }, set: (k, v) => { try { localStorage.setItem(k, JSON.stringify({ v, e: Date.now() + 2592e6 })) } catch { localStorage.clear() } } };

        const scoreWork = (w, abs = "") => {
            let s = 0, why = [];
            const t = norm(w.title || ""), kw = norm((w.keywords || []).map(k => k.display_name || k.keyword).join(" ")), ab = norm(abs), full = `${t} ${kw} ${ab}`;
            const expT = RX.explicit.test(t), expK = !expT && RX.explicit.test(kw), expA = !expT && !expK && RX.explicit.test(ab);
            if (expT) { s += 45; why.push('explicit-title') } else if (expK) { s += 30; why.push('explicit-keyword') } else if (expA) { s += 20; why.push('explicit-abstract') }
            const hSol = RX.solar.test(full), hAgr = RX.agri.test(full), hInt = RX.interaction.test(full);
            if (hSol && hAgr) {
                if (RX.prox.test(t)) { s += 20; why.push('solar+agri-prox-title') } else if (RX.prox.test(ab)) { s += 12; why.push('solar+agri-prox-abs') } else { s += 5; why.push('solar+agri-dist') }
                if (hInt) { s += 8; why.push('interaction-term') }
            } else if (hSol && hInt) { s += 5; why.push('solar+interaction') }
            if (RX.tech.test(full)) { s += 3; why.push('tech-detail') }
            if (w.concepts?.some(c => norm(c.display_name).includes('agrivoltaic') && c.score > 0.4)) { s += 10; why.push('concept-match') }
            s += Math.min(4, Math.log10((w.cited_by_count || 0) + 1) * 1.5); if (w.publication_year >= CFG.now - 2) s += 1.5;
            if (RX.neg.test(full) && !expT && !expK) { s -= 30; why.push('neg-filter') }
            if ((w.topics || []).some(tp => (tp.score || 0) >= 0.25 && !TOPIC_NEG.has(norm(tp.display_name))) === false && (w.topics || []).length > 0) { s = 0; why.push('neg-topic-only') }
            return { s: Math.max(0, Math.round(s * 10) / 10), why, tier: s >= 35 ? 'Core' : s >= 15 ? 'Strong' : s >= 8 ? 'Related' : 'Peripheral' };
        };

        /* ... existing graph/helper functions (computeHullPath, ParticleSystem, etc.) ... */
        const computeHullPath = (points, pad = 24) => { if (points.length < 3) { if (points.length === 2) { const [a, b] = points, dx = b[0] - a[0], dy = b[1] - a[1], len = Math.sqrt(dx * dx + dy * dy) || 1, nx = -dy / len * pad, ny = dx / len * pad; return `M${a[0] + nx},${a[1] + ny}L${b[0] + nx},${b[1] + ny}L${b[0] - nx},${b[1] - ny}L${a[0] - nx},${a[1] - ny}Z` } if (points.length === 1) { const [cx, cy] = points[0]; return `M${cx - pad},${cy}A${pad},${pad} 0 1,0 ${cx + pad},${cy}A${pad},${pad} 0 1,0 ${cx - pad},${cy}Z` } return '' } const hull = d3.polygonHull(points); if (!hull) return ''; const cx = d3.mean(hull, d => d[0]), cy = d3.mean(hull, d => d[1]), expanded = hull.map(([x, y]) => { const dx = x - cx, dy = y - cy, len = Math.sqrt(dx * dx + dy * dy) || 1; return [x + dx / len * pad, y + dy / len * pad] }); return d3.line().curve(d3.curveCatmullRomClosed.alpha(0.5))(expanded) };
        class ParticleSystem { constructor(canvas) { this.canvas = canvas; this.ctx = canvas.getContext('2d'); this.particles = []; this.links = []; this.active = true; this.transform = { x: 0, y: 0, k: 1 }; this._raf = null; this._lastTime = 0 } setLinks(links) { this.links = links; this.particles = []; for (const link of links) { const count = Math.min(Math.max(1, link.w), 5); for (let i = 0; i < count; i++) { this.particles.push({ link, t: Math.random(), speed: (0.3 + Math.random() * 0.4) * (0.5 + link.w * 0.15) }) } } } setTransform(t) { this.transform = t } resize() { const r = devicePixelRatio || 1, w = this.canvas.parentElement.clientWidth, h = this.canvas.parentElement.clientHeight; this.canvas.width = w * r; this.canvas.height = h * r; this.canvas.style.width = w + 'px'; this.canvas.style.height = h + 'px'; this.ctx.setTransform(r, 0, 0, r, 0, 0) } start() { this.active = true; this._lastTime = performance.now(); const loop = (now) => { if (!this.active) return; const dt = Math.min((now - this._lastTime) / 1000, 0.05); this._lastTime = now; this._update(dt); this._draw(); this._raf = requestAnimationFrame(loop) }; this._raf = requestAnimationFrame(loop) } stop() { this.active = false; if (this._raf) cancelAnimationFrame(this._raf); this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height) } _update(dt) { for (const p of this.particles) { p.t += p.speed * dt * 0.4; if (p.t > 1) p.t -= 1 } } _draw() { const ctx = this.ctx, { x: tx, y: ty, k } = this.transform, w = this.canvas.clientWidth, h = this.canvas.clientHeight; ctx.clearRect(0, 0, w, h); ctx.save(); ctx.translate(tx, ty); ctx.scale(k, k); const isDark = document.body.classList.contains('dark-mode'), fillColor = isDark ? 'rgba(134,239,172,0.7)' : 'rgba(22,163,74,0.6)'; ctx.fillStyle = fillColor; for (const p of this.particles) { const src = p.link.source, tgt = p.link.target; if (src.x == null || tgt.x == null) continue; const px = src.x + (tgt.x - src.x) * p.t, py = src.y + (tgt.y - src.y) * p.t; ctx.beginPath(); ctx.arc(px, py, 1.5 / k, 0, Math.PI * 2); ctx.fill() } ctx.restore() } }
        const buildEgoMiniSVG = (centerId, adj, nodesMap, linksMap, maxNeighbors = 10) => { const neighbors = [...(adj.get(centerId) || [])].slice(0, maxNeighbors); if (!neighbors.length) return ''; const center = nodesMap.get(centerId); if (!center) return ''; const w = 180, h = 140, cx = w / 2, cy = h / 2, r = 45; let svg = `<svg width="${w}" height="${h}" class="mt-2" style="display:block">`; neighbors.forEach((nid, i) => { const angle = (i / neighbors.length) * Math.PI * 2 - Math.PI / 2, nx = cx + Math.cos(angle) * r, ny = cy + Math.sin(angle) * r, n = nodesMap.get(nid), linkKey = [centerId, nid].sort().join('|'), lw = linksMap.get(linkKey)?.w || 1; svg += `<line class="ego-mini-link" x1="${cx}" y1="${cy}" x2="${nx}" y2="${ny}" stroke-opacity="${0.3 + lw * 0.1}"/>`; svg += `<circle class="ego-mini-node" cx="${nx}" cy="${ny}" r="6" fill="${n ? n.color : '#94a3b8'}" stroke="white" stroke-width="1"/>`; const label = n ? n.display_name.split(' ').pop().substring(0, 6) : '?'; svg += `<text x="${nx}" y="${ny + 14}" text-anchor="middle" font-size="7" fill="#64748b">${esc(label)}</text>`; svg += `<text x="${(cx + nx) / 2}" y="${(cy + ny) / 2 - 3}" text-anchor="middle" font-size="7" fill="#16a34a" font-weight="600">${lw}</text>` }); svg += `<circle cx="${cx}" cy="${cy}" r="9" fill="${center.color}" stroke="white" stroke-width="1.5"/>`; svg += `<text x="${cx}" y="${cy + 3.5}" text-anchor="middle" font-size="7" fill="white" font-weight="700">${center.display_name.substring(0, 2)}</text>`; svg += '</svg>'; return svg };
        const buildTemporalArcs = (researcherId, pubs, currentYear) => { const yearCounts = new Map(); pubs.forEach(p => { if (p.memA.some(a => a.id === researcherId) && p.year) { yearCounts.set(p.year, (yearCounts.get(p.year) || 0) + 1) } }); if (!yearCounts.size) return []; const years = [...yearCounts.keys()].sort((a, b) => a - b), total = [...yearCounts.values()].reduce((s, v) => s + v, 0), colorScale = d3.scaleSequential(d3.interpolateGreens).domain([years[0] - 1, currentYear + 1]), arcGen = d3.arc(); let startAngle = 0; const arcs = []; for (const yr of years) { const frac = yearCounts.get(yr) / total, endAngle = startAngle + frac * Math.PI * 2; arcs.push({ path: arcGen({ innerRadius: 0, outerRadius: 1, startAngle, endAngle }), color: colorScale(yr), year: yr, count: yearCounts.get(yr) }); startAngle = endAngle } return arcs };

        const app = {
            /* ... existing app data structure and init/resolve/build logic ... */
            data: { researchers: [], pubs: [], topics: new Map, graph: { nodes: [], links: [] } },
            state: { filters: { q: '', topics: new Set, insts: new Set, yFrom: null, yTo: null, minRel: CFG.defMin, bm: false, co: null }, page: 1, sort: 'recent', graph: { cluster: true, labels: true, particles: true }, last: [], sel: new Set, cmp: [], mode: 'paginated', dark: localStorage.getItem('agripv_dark') === '1', hm: true, view: 'both' },
            d3: {}, col: new Map, bm: new Set(JSON.parse(localStorage.getItem('agripv_bookmarks') || '[]')), cache: new Map, particles: null, constellationSim: null,
            init: async () => { /* ... existing init code ... */ app.ui(); app.gr(); app.dark(); el('bookmarkCount').textContent = app.bm.size; const pg = (p, t) => { el('loadingProgress').style.width = p + '%'; el('loadingStatus').textContent = t }; try { pg(5, "Fetching network members..."); const { data: P } = await supabase.from("profiles").select("id,full_name,work_email,affiliation").not("full_name", "is", null); if (!P?.length) throw "No members"; const hx = P.map(p => p.id).sort().join('|'), c = Storage.get(CFG.key); if (Storage.get(CFG.key + "_hash") === hx && c) { pg(85, "Loading from cache..."); app.restore(c) } else { pg(10, "Resolving profiles..."); const R = await app.resolve(P, pg); pg(30, "Discovering publications..."); const W = await app.discoverWorks(R, pg); app.build(R, W); Storage.set(CFG.key + "_hash", hx); Storage.set(CFG.key, app.pack()) } pg(100, "Done"); setTimeout(() => { el('loadingOverlay').classList.add('hidden'); app.render(); setTimeout(app.fitGraph, 400) }, 450) } catch (e) { console.error(e); alert("Failed to load data.") } },
            resolve: async (P, pg) => { /* ... existing resolve code ... */ const out = []; for (let i = 0; i < P.length; i += 12) { out.push(...await Promise.all(P.slice(i, i + 12).map(async p => { let qn = p.full_name; if (/[\._\d]/.test(qn)) qn = qn.replace(/[\._]/g, ' ').replace(/\d+/g, '').trim(); const d = await fetchJSON(`${CFG.api}/authors?search=${encodeURIComponent(qn)}&per_page=10&select=id,display_name,works_count,cited_by_count,last_known_institutions`); let best = null, bS = -1, w = norm(qn), af = norm(p.affiliation || ""); (d?.results || []).forEach(r => { let sc = 0, n = norm(r.display_name || ""), in_ = norm(r.last_known_institutions?.[0]?.display_name || ""); if (n === w) sc += 10; else if (n.includes(w) || w.includes(n)) sc += 4; if (af && in_ && (in_.includes(af) || af.includes(in_))) sc += 4; sc += Math.min(2, (r.works_count || 0) / 200); if (sc > bS) { bS = sc; best = r } }); const m = best || d?.results?.[0], inst = getInst(m?.last_known_institutions?.[0]?.display_name || p.affiliation); return { id: m?.id || `local:${p.id}`, display_name: m?.display_name || p.full_name, inst, color: app.gCol(inst), net_works: 0, net_cited: 0, topics: {}, deg: 0, _wc: m?.works_count || 0 } }))); pg(10 + (Math.min(i + 12, P.length) / P.length) * 18, "Resolving profiles..."); await sleep(30) } return out },
discoverWorks: async (R, pg) => {
    const W = new Map;
    const ids = R.filter(a => !a.id.startsWith('local:')).map(a => a.id);
    const batches = [];
    const max = 40;
    for (let i = 0; i < ids.length; i += max) 
        batches.push(ids.slice(i, i + max));

    // MERGED queries: reduced from 12 to 7 by combining overlapping terms
    const queries = [
        // Q1: All explicit agrivoltaic terms (was queries 1 + 10)
        {
            q: 'agrivoltaic|agrivoltaics|agrophotovoltaic|agrophotovoltaics|' +
               '"agri-PV"|"agro-PV"|"agri-photovoltaic"|"agro-photovoltaic"|' +
               '"solar sharing"|rangevoltaic|ecovoltaic|' +
               '"photovoltaic greenhouse"|"greenhouse photovoltaic"',
            type: 'search', pages: 12
        },
        // Q2: Dual-use / co-location + solar+ag (was queries 2 + 3)
        {
            q: '"dual use"|"dual-use"|"co-location"|"co-locate"|' +
               '"solar panel"|"solar array"|"solar farm"|"solar canopy"|' +
               '"solar park" agriculture|crop|greenhouse|farming|' +
               'grazing|vegetation|yield|land',
            type: 'search', pages: 8
        },
        // Q3: Technical mounting/design terms (was query 4)
        {
            q: 'bifacial|"stilt mounted"|"vertical PV"|"semi-transparent"|' +
               '"ground-mounted" solar|photovoltaic agriculture|crop|' +
               'farm|grazing|albedo',
            type: 'search', pages: 6
        },
        // Q4: Livestock + solar (was query 5)
        {
            q: 'solar|photovoltaic grazing|sheep|cattle|livestock|' +
               'pasture|"solar grazing"',
            type: 'search', pages: 6
        },
        // Q5: Nexus + food security + crop yield (was queries 6 + 8 + 9)
        {
            q: '"food-energy-water"|"water-energy-food"|nexus|' +
               '"food production"|"food security"|"crop production"|' +
               '"crop yield"|aquavoltaic|aquavoltaics|' +
               '"floating solar" aquaculture|solar|photovoltaic',
            type: 'search', pages: 6
        },
        // Q6: Microclimate / PAR / shade (was query 7)
        {
            q: '"land equivalent ratio"|"shade tolerance"|microclimate|' +
               '"photosynthetically active radiation" solar|photovoltaic ' +
               'crop|agriculture|plant|soil',
            type: 'search', pages: 6
        },
        // Q7: Concept-based (agrivoltaics wikidata concept only â€” 
        //     the generic "agriculture" concept Q12705 is too broad 
        //     and was producing mostly noise that gets filtered out)
        { q: 'concepts.wikidata:Q109680063', type: 'concept', pages: 8 }
    ];

    // Early-termination tracking: if a full page of 200 results yields
    // fewer than 5% new works, stop paginating that query
    const NEW_WORK_THRESHOLD = 0.05;

    const runQuery = async (filterStr, maxPages = 10) => {
        let cursor = '*', pn = 0, consecutiveLowYield = 0;
        while (cursor && pn++ < maxPages) {
            const beforeSize = W.size;
            const r = await fetchJSON(
                `${CFG.api}/works?filter=${filterStr}` +
                `&per_page=200&cursor=${encodeURIComponent(cursor)}` +
                `&sort=cited_by_count:desc` +
                `&select=id,title,publication_year,cited_by_count,type,` +
                `primary_location,open_access,doi,authorships,concepts,` +
                `topics,keywords`
            );
            if (!r?.results?.length) break;

            r.results.forEach(w => {
                if (!W.has(w.id)) {
                    const sc = scoreWork(w);
                    if (sc.s >= CFG.minRel || 
                        (sc.s >= 0.5 && sc.tier !== 'Peripheral')) {
                        W.set(w.id, { 
                            ...w, _r: sc.s, _w: sc.why, _t: sc.tier 
                        });
                    }
                }
            });

            const newWorks = W.size - beforeSize;
            const yieldRate = newWorks / r.results.length;

            // Early termination: if we're getting <5% new relevant 
            // works from a full page, stop paginating this query
            if (yieldRate < NEW_WORK_THRESHOLD) {
                consecutiveLowYield++;
                if (consecutiveLowYield >= 2) break; // 2 consecutive low pages
            } else {
                consecutiveLowYield = 0;
            }

            cursor = r.meta?.next_cursor;
            if (!cursor || r.results.length < 200) break;
            await sleep(15);
        }
    };

    let done = 0;
    const total = queries.length * batches.length;

    // Run queries with higher concurrency (was 6, now 8 since fewer queries)
    for (let i = 0; i < queries.length; i += 8) {
        await Promise.all(
            queries.slice(i, i + 8).map(async qObj => {
                for (const b of batches) {
                    const authorFilter = 
                        `authorships.author.id:${b.join('|')}`;
                    const dateFilter = 
                        `from_publication_date:` +
                        `${Math.max(1990, CFG.now - 25)}-01-01`;
                    const searchFilter = qObj.type === 'search' 
                        ? `default.search:${qObj.q}` 
                        : qObj.q;
                    const f = `${authorFilter},${searchFilter},${dateFilter}`;
                    
                    await runQuery(f, qObj.pages || 10);
                    done++;
                    pg(
                        30 + (done / total) * 40,
                        `Searching: ${done}/${total} (${W.size} works)...`
                    );
                }
            })
        );
        await sleep(20);
    }

    // === Enrichment phase (unchanged logic, improved threshold) ===
    const authScores = new Map;
    W.forEach(w => (w.authorships || []).forEach(a => {
        if (ids.includes(a.author?.id))
            authScores.set(
                a.author.id, 
                (authScores.get(a.author.id) || 0) + w._r
            );
    }));

    // Raised threshold from 30 â†’ 40 to reduce enrichment calls
    // (only truly prolific authors get extra queries)
    const topA = [...authScores.entries()]
        .filter(([, s]) => s >= 40)
        .map(([id]) => id);

    if (topA.length) {
        pg(73, `Enriching ${topA.length} top authors...`);
        // Reduced from 2 search strings to 1 combined
        const enrichSearch = 
            'agrivoltaic|agrophotovoltaic|"solar sharing"|' +
            '"dual use"|"co-location"|solar|photovoltaic|renewable ' +
            'crop|agriculture|farm|food|land|vegetation|grazing';
        
        for (let i = 0; i < topA.length; i += 8) {
            await Promise.all(
                topA.slice(i, i + 8).map(async aid => {
                    await runQuery(
                        `authorships.author.id:${aid.split('/').pop()},` +
                        `default.search:${enrichSearch},` +
                        `from_publication_date:` +
                        `${Math.max(1990, CFG.now - 25)}-01-01`,
                        8
                    );
                })
            );
            pg(
                73 + ((i + 8) / topA.length) * 12, 
                "Targeted enrichment..."
            );
        }
    }

    // === Borderline abstract enrichment (unchanged) ===
    const border = [...W.values()]
        .filter(w => 
            w._r >= (CFG.minRel - 0.5) && 
            w._r < (CFG.minRel + 2) && 
            !w._w?.some(x => x.includes('explicit'))
        )
        .sort((a, b) => b._r - a._r)
        .slice(0, CFG.cap);

    if (border.length) {
        pg(87, `Fetching abstracts for ${border.length} borderline works...`);
        let k = 0;
        await Promise.all(
            Array.from(
                { length: Math.min(CFG.conc, border.length) }, 
                async () => {
                    while (k < border.length) {
                        const w = border[k++];
                        const d = await fetchJSON(
                            `${CFG.api}/works/${w.id.split('/').pop()}` +
                            `?select=abstract_inverted_index`
                        );
                        if (d?.abstract_inverted_index) {
                            const ab = invIdx(d.abstract_inverted_index);
                            const sc = scoreWork(w, ab);
                            if (sc.s > w._r) {
                                w._r = sc.s;
                                w._t = sc.tier;
                                w._w = [
                                    ...new Set([...w._w, ...sc.why, 'abs'])
                                ];
                            }
                            app.cache.set(w.id, ab);
                        }
                        pg(
                            87 + (k / border.length) * 8,
                            `Enriching ${k}/${border.length}...`
                        );
                        await sleep(10);
                    }
                }
            )
        );
    }

    // Final filter
    for (const [id, w] of W) {
        if (w._r < CFG.minRel && !w._w.some(x => x.includes('explicit'))) 
            W.delete(id);
    }

    return [...W.values()];
},            build: (R, P) => { /* ... existing build code ... */ const rM = new Map(R.map(r => [r.id, r])); app.data.pubs = P.map(p => { const m = (p.authorships || []).filter(a => rM.has(a.author?.id)).map(a => rM.get(a.author.id)); if (!m.length) return null; let ts = (p.topics || []).filter(t => (t.score || 0) >= 0.25).map(t => t.display_name).slice(0, 7); if (!ts.length) ts = (p.concepts || []).filter(c => (c.score || 0) > 0.55 && (c.level || 0) > 0 && !TOPIC_BLOCK.has(norm(c.display_name))).map(c => c.display_name).slice(0, 7); const cts = ts.filter(t => !TOPIC_NEG.has(norm(t))); m.forEach(r => { r.net_works++; r.net_cited += (p.cited_by_count || 0); cts.forEach(t => { r.topics[t] = (r.topics[t] || 0) + 1; app.data.topics.set(t, (app.data.topics.get(t) || 0) + 1) }) }); if (!cts.length && ts.length) return null; return { id: p.id, title: p.title, year: p.publication_year, cites: p.cited_by_count || 0, doi: p.doi, url: p.primary_location?.landing_page_url || p.doi || p.primary_location?.pdf_url, source: p.primary_location?.source?.display_name, oa: p.open_access?.is_oa, type: p.type, score: p._r || 0, why: p._w || [], tier: p._t || 'Weak', topics: cts, allA: (p.authorships || []).map(a => ({ id: a.author?.id, name: a.author?.display_name, mem: rM.has(a.author?.id) })), memA: m } }).filter(Boolean); app.data.researchers = R.filter(r => app.data.pubs.some(p => p.memA.includes(r))); app.buildGraph() },
            buildGraph: () => { /* ... existing buildGraph code ... */ const L = new Map, D = new Map; app.data.pubs.forEach(p => { const i = p.memA.map(a => a.id); for (let x = 0; x < i.length; x++)for (let y = x + 1; y < i.length; y++) { const k = [i[x], i[y]].sort().join('|'), l = L.get(k) || { source: i[x], target: i[y], w: 0, p: [] }; l.w++; l.p.push(p.id); L.set(k, l); D.set(i[x], (D.get(i[x]) || 0) + 1); D.set(i[y], (D.get(i[y]) || 0) + 1) } }); app.data.graph = { nodes: app.data.researchers.map(r => ({ ...r, deg: D.get(r.id) || 0, rad: clamp(10 + Math.sqrt(r.net_works || 0) * 3 + Math.sqrt(D.get(r.id) || 0) * 1.5, 10, 30) })), links: [...L.values()] } },
            pack: () => { /* ... existing pack code ... */ const D = { t: [], s: [] }, gx = (a, v) => { if (!v) return -1; let i = a.indexOf(v); return i === -1 ? (a.push(v), a.length - 1) : i }; return { r: app.data.researchers.map(r => ({ id: r.id, n: r.display_name, i: r.inst, nw: r.net_works, nc: r.net_cited, t: Object.keys(r.topics).map(t => gx(D.t, t)), d: r.deg })), p: app.data.pubs.map(p => ({ id: p.id, t: p.title, y: p.year, c: p.cites, d: p.doi, u: p.url, s: gx(D.s, p.source), oa: p.oa ? 1 : 0, r: p.score, w: p.why, ti: p.tier === 'Core' ? 3 : (p.tier === 'Strong' ? 2 : 1), tp: p.topics.map(t => gx(D.t, t)), aa: p.allA.slice(0, 10).map(a => a.name), ma: p.memA.map(m => m.id) })), D } },
            restore: c => { /* ... existing restore code ... */ const D = c.D || { t: [], s: [] }; app.data.researchers = c.r.map(r => ({ id: r.id, display_name: r.n, inst: r.i, net_works: r.nw, net_cited: r.nc, topics: (r.t || []).reduce((a, i) => { if (D.t[i]) a[D.t[i]] = 1; return a }, {}), deg: r.deg || 0, color: app.gCol(r.i) })); const rM = new Map(app.data.researchers.map(r => [r.id, r])); app.data.pubs = c.p.map(p => { const m = (p.ma || []).map(i => rM.get(i)).filter(Boolean), rt = (p.tp || []).map(i => D.t[i]).filter(Boolean), ct = rt.filter(t => !TOPIC_NEG.has(norm(t))); if (!ct.length && rt.length) return null; return { id: p.id, title: p.t, year: p.y, cites: p.c, doi: p.d, url: p.u, source: typeof p.s === 'number' ? D.s[p.s] : p.s, oa: !!p.oa, type: p.ty, score: p.r, why: p.w || [], tier: p.ti === 3 ? 'Core' : (p.ti === 2 ? 'Strong' : 'Weak'), topics: ct, allA: (p.aa || []).map(n => { const f = m.find(z => z.display_name === n); return { name: n, id: f ? f.id : null, mem: !!f } }), memA: m } }).filter(Boolean); app.data.topics = new Map; app.data.pubs.forEach(p => p.topics.forEach(t => app.data.topics.set(t, (app.data.topics.get(t) || 0) + 1))); app.buildGraph() },
            gCol: i => { if (!app.col.has(i)) app.col.set(i, COLORS[app.col.size % COLORS.length]); return app.col.get(i) },
            spark: (d, w = 48, h = 16) => { const m = Math.max(...d, 1), pts = d.map((v, i) => `${(i / (d.length - 1)) * w},${h - (v / m) * (h - 2) - 1}`).join(' '); return `<svg class="sparkline-container" width="${w}" height="${h}"><polyline fill="none" stroke="#16a34a" stroke-width="1.5" points="${pts}"/></svg>` },
            render: () => { /* ... existing render code ... */ const { q, topics: T, insts: I, yFrom: yf, yTo: yt, minRel: mr, bm: bo, co } = app.state.filters, ql = norm(q); let F = app.data.pubs.filter(p => p.score >= mr && (!yf || p.year >= yf) && (!yt || p.year <= yt) && (!I.size || p.memA.some(a => I.has(a.inst))) && (!T.size || p.topics.some(t => T.has(t))) && (!bo || app.bm.has(p.id))); if (ql) F = F.filter(p => norm(p.title).includes(ql) || p.allA.some(a => norm(a.name).includes(ql)) || p.topics.some(t => norm(t).includes(ql)) || (app.cache.has(p.id) && norm(app.cache.get(p.id)).includes(ql))); if (co) F = F.filter(p => p.topics.includes(co.t1) && p.topics.includes(co.t2)); app.state.last = F; const am = new Set(F.flatMap(p => p.memA.map(a => a.id))), yc = new Map, cc = new Map; F.forEach(p => { if (p.year) { yc.set(p.year, (yc.get(p.year) || 0) + 1); cc.set(p.year, (cc.get(p.year) || 0) + p.cites) } }); const yrs = [...yc.keys()].sort((a, b) => a - b); el('statsGrid').innerHTML = [['MEMBERS', am.size], ['WORKS', F.length, yrs.map(y => yc.get(y))], ['CITES', F.reduce((s, p) => s + p.cites, 0), yrs.map(y => cc.get(y))], ['TOPICS', new Set(F.flatMap(p => p.topics)).size]].map(([l, v, s]) => `<div class="bg-white py-1.5 px-0.5 rounded border border-slate-200 shadow-sm flex flex-col items-center hover:border-green-300"><span class="text-xs font-bold text-slate-700">${v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v}</span>${s ? `<div class="mt-0.5">${app.spark(s, 36, 12)}</div>` : ''}<span class="text-[7px] text-slate-400 font-bold mt-0.5">${l}</span></div>`).join(''); el('filteredCount').textContent = F.length; app.timeline(F, yc); const sF = { cited: (a, b) => b.cites - a.cites, relevance: (a, b) => b.score - a.score || b.cites - a.cites, title: (a, b) => a.title.localeCompare(b.title), recent: (a, b) => b.year - a.year || b.score - a.score, oldest: (a, b) => a.year - b.year || b.score - a.score, bookmarked: (a, b) => (app.bm.has(b.id) ? 1 : 0) - (app.bm.has(a.id) ? 1 : 0) || b.score - a.score }; F.sort(sF[app.state.sort] || sF.recent); const inf = app.state.mode === 'infinite', sz = inf ? F.length : 12, pgs = inf ? 1 : Math.ceil(F.length / sz), pg = app.state.page = clamp(app.state.page, 1, Math.max(1, pgs)), st = inf ? 0 : (pg - 1) * sz; el('publicationsList').innerHTML = F.slice(st, st + sz).map(app.pubCard).join('') || '<div class="text-center py-20 text-slate-400 text-xs">No results.</div>'; if (!inf) el('publicationsList').scrollTop = 0; ['showingFrom', 'showingTo', 'totalPublications'].forEach((id, i) => el(id).textContent = [F.length ? st + 1 : 0, Math.min(st + sz, F.length), F.length][i]); if (!inf && pgs > 1) { const b = [], ad = (p, l, a) => b.push(`<button onclick="app.setPage(${p})" class="w-6 h-6 flex items-center justify-center rounded text-[9px] font-medium ${a ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">${l}</button>`); ad(Math.max(1, pg - 1), '<i class="fas fa-chevron-left"></i>'); (pgs <= 5 ? Array.from({ length: pgs }, (_, i) => i + 1) : (pg <= 3 ? [1, 2, 3, '...', pgs] : (pg >= pgs - 2 ? [1, '...', pgs - 2, pgs - 1, pgs] : [1, '...', pg, pg + 1, '...', pgs]))).forEach(x => x === '...' ? b.push('<span class="text-[9px] text-slate-400 self-end px-1">...</span>') : ad(x, x, x === pg)); ad(Math.min(pgs, pg + 1), '<i class="fas fa-chevron-right"></i>'); el('paginationContainer').innerHTML = b.join('') } else el('paginationContainer').innerHTML = ''; app.renderGraph(F, am); if (app.state.view === 'constellation') app.renderConstellation(F); const ic = new Map, tc = new Map; app.data.researchers.forEach(r => am.has(r.id) && ic.set(r.inst, (ic.get(r.inst) || 0) + 1)); F.forEach(p => p.topics.forEach(t => tc.set(t, (tc.get(t) || 0) + 1))); el('institutionFilters').innerHTML = [...ic].sort((a, b) => b[1] - a[1]).map(([i, c]) => `<label class="flex items-center gap-1.5 cursor-pointer hover:bg-slate-50 p-1 rounded group"><input type="checkbox" onchange="app.tog('insts','${jsStr(i)}')" class="rounded border-slate-300 text-green-600 w-3 h-3" ${I.has(i) ? 'checked' : ''}><div class="w-1.5 h-1.5 rounded-full shrink-0" style="background:${app.gCol(i)}"></div><span class="text-[10px] text-slate-600 truncate flex-1">${esc(i)}</span><span class="text-[8px] text-slate-400 font-mono bg-slate-100 px-1 rounded">${c}</span></label>`).join(''); el('topicFilters').innerHTML = [...tc].sort((a, b) => b[1] - a[1]).slice(0, 35).map(([t, c]) => `<button onclick="app.tog('topics','${jsStr(t)}')" class="px-1.5 py-0.5 rounded text-[9px] border flex gap-1 ${T.has(t) ? 'bg-green-100 text-green-800 border-green-200' : 'bg-slate-50 text-slate-500 hover:bg-white'}">${esc(t)} <span class="opacity-50 text-[8px]">${c}</span></button>`).join(''); const fc = T.size + I.size + (bo ? 1 : 0) + (co ? 1 : 0), tg = (l, k, c) => `<span class="${c} px-1.5 py-0.5 rounded border text-[9px] flex gap-1 items-center font-medium">${esc(l)}<button onclick="app.tog('${k}','${jsStr(l)}')" class="hover:text-red-500 ml-0.5"><i class="fas fa-times"></i></button></span>`; el('activeFiltersPanel').classList.toggle('hidden', !fc); el('activeFilterCount').textContent = fc; el('activeFilterTags').innerHTML = (bo ? '<span class="bg-amber-50 text-amber-700 border-amber-200 px-1.5 py-0.5 rounded border text-[9px] flex gap-1 items-center font-medium">Bookmarked<button onclick="app.toggleBookmarkFilter()" class="hover:text-red-500 ml-0.5"><i class="fas fa-times"></i></button></span>' : '') + (co ? `<span class="bg-purple-50 text-purple-700 border-purple-200 px-1.5 py-0.5 rounded border text-[9px] flex gap-1 items-center font-medium">Interact: ${co.t1.substring(0, 8)}... & ${co.t2.substring(0, 8)}...<button onclick="app.clrCo()" class="hover:text-red-500 ml-0.5"><i class="fas fa-times"></i></button></span>` : '') + [...T].map(t => tg(t, 'topics', 'bg-green-50 text-green-700 border-green-200')).join('') + [...I].map(i => tg(i, 'insts', 'bg-blue-50 text-blue-700 border-blue-200')).join(''); const actInst = [...app.col].filter(([i]) => app.data.researchers.some(r => r.inst === i && am.has(r.id))); el('legendContainer').innerHTML = actInst.map(([i, c]) => `<div class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full" style="background:${c}"></span><span class="text-[9px] text-slate-600 truncate">${esc(i)}</span></div>`).join(''); app.updSel(); app.updBm(); if (app.state.hm) app.heatmap(F) },
            pubCard: p => `<div class="pub-card p-3 bg-white mb-2 cursor-pointer" onclick="app.detail('${p.id}')"><div class="flex items-start gap-2"><input type="checkbox" class="pub-checkbox mt-1" ${app.state.sel.has(p.id) ? 'checked' : ''} onclick="event.stopPropagation();app.togSel('${p.id}')"><div class="flex-1 min-w-0"><div class="flex items-start justify-between gap-2 mb-1.5"><h4 class="font-bold text-slate-800 text-xs leading-snug flex-1">${esc(p.title)}</h4><div class="shrink-0 flex items-center gap-1"><button class="bookmark-btn ${app.bm.has(p.id) ? 'active text-amber-500' : 'text-slate-300 hover:text-amber-400'} p-1 text-xs" onclick="event.stopPropagation();app.togBm('${p.id}')"><i class="fas fa-bookmark"></i></button>${p.oa ? '<span class="px-1.5 py-0.5 bg-amber-50 text-amber-700 text-[8px] font-bold rounded border border-amber-100 uppercase">OA</span>' : ''} ${p.tier === 'Core' ? '<span class="px-1.5 py-0.5 rounded text-[8px] font-bold uppercase bg-green-100 text-green-800 border border-green-200">Core</span>' : (p.tier === 'Strong' ? '<span class="px-1.5 py-0.5 rounded text-[8px] font-bold uppercase bg-blue-50 text-blue-700 border border-blue-200">Strong</span>' : '')}</div></div><div class="flex flex-wrap gap-1 mb-2">${p.allA.slice(0, 5).map(a => `<span class="px-1.5 py-0.5 rounded text-[9px] truncate max-w-[100px] ${a.mem ? 'network-member font-medium' : 'external-author'}">${esc(a.name)}</span>`).join('')}${p.allA.length > 5 ? `<span class="text-[9px] text-slate-400 self-center">+${p.allA.length - 5}</span>` : ''}</div><div class="flex items-center gap-3 text-[9px] text-slate-500 font-medium"><span class="flex items-center gap-1"><i class="fas fa-calendar-alt text-slate-400"></i> ${p.year || ''}</span><span class="flex items-center gap-1"><i class="fas fa-quote-right text-slate-400"></i> ${p.cites}</span><span class="ml-auto text-green-700 bg-green-50 px-1.5 py-0.5 rounded border border-green-100 font-semibold">Score: ${p.score.toFixed(1)}</span><div class="flex gap-1 ml-1"><button class="hover:text-brand p-1" onclick="event.stopPropagation();app.cite('${p.id}')"><i class="fas fa-quote-left"></i></button>${p.doi ? `<button class="hover:text-blue-600 p-1 transition-colors" onclick="event.stopPropagation();app.cpD(event, '${jsStr(p.doi)}')" title="Copy DOI"><i class="fas fa-copy"></i></button><a href="https://doi.org/${p.doi}" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 p-1 transition-colors" onclick="event.stopPropagation()" title="Open Paper"><i class="fas fa-external-link-alt"></i></a>` : ''}</div></div></div></div></div>`,
            timeline: (F, yc) => { const svg = d3.select('#timelineChart'); svg.selectAll('*').remove(); if (!yc.size) return; const yrs = [...yc.keys()].sort((a, b) => a - b), min = yrs[0], max = yrs[yrs.length - 1], all = Array.from({ length: max - min + 1 }, (_, i) => min + i); const W = el('timelineChart').clientWidth, H = 50, m = { t: 2, r: 2, b: 12, l: 2 }, x = d3.scaleBand().domain(all).range([m.l, W - m.r]).padding(0.2), y = d3.scaleLinear().domain([0, d3.max([...yc.values()]) || 1]).range([H - m.b, m.t]); const g = svg.append('g'), { yFrom: yf, yTo: yt } = app.state.filters; g.selectAll('rect').data(all).enter().append('rect').attr('class', d => `timeline-bar ${(yf && d >= yf && (!yt || d <= yt)) || (yt && d <= yt && (!yf || d >= yf)) ? 'selected' : ''}`).attr('x', d => x(d)).attr('y', d => y(yc.get(d) || 0)).attr('width', x.bandwidth()).attr('height', d => H - m.b - y(yc.get(d) || 0)).attr('rx', 1).on('click', (e, d) => { if (e.shiftKey && yf) { app.state.filters.yTo = d; el('yearTo').value = d } else if (yf === d && !yt) { app.state.filters.yFrom = app.state.filters.yTo = null; el('yearFrom').value = el('yearTo').value = '' } else { app.state.filters.yFrom = d; app.state.filters.yTo = null; el('yearFrom').value = d; el('yearTo').value = '' } app.render() }); const lbl = all.length > 12 ? 3 : (all.length > 6 ? 2 : 1); g.selectAll('.yl').data(all.filter((_, i) => i % lbl === 0 || _ === max)).enter().append('text').attr('x', d => x(d) + x.bandwidth() / 2).attr('y', H - 1).attr('text-anchor', 'middle').attr('font-size', 7).attr('fill', '#94a3b8').text(d => d.toString().slice(-2)) },
            heatmap: F => {
                const svg = d3.select('#heatmapChart'); svg.selectAll('*').remove();
                const pairs = new Map, tc = new Map;
                F.forEach(p => { const ts = p.topics.slice(0, 5); ts.forEach(t => tc.set(t, (tc.get(t) || 0) + 1)); for (let i = 0; i < ts.length; i++)for (let j = i + 1; j < ts.length; j++)pairs.set([ts[i], ts[j]].sort().join('|'), (pairs.get([ts[i], ts[j]].sort().join('|')) || 0) + 1) });
                const top = [...tc.entries()].sort((a, b) => b[1] - a[1]).slice(0, 8).map(([t]) => t); if (top.length < 2) return;
                const W = el('heatmapChart').clientWidth, H = 200, m = { t: 60, r: 10, b: 10, l: 60 }, cW = (W - m.l - m.r) / top.length, cH = (H - m.t - m.b) / top.length, max = Math.max(...[...pairs.values()], 1), col = d3.scaleSequential(d3.interpolateGreens).domain([0, max]), g = svg.append('g').attr('transform', `translate(${m.l},${m.t})`);
                const tt = el('heatmapTooltip');
                top.forEach((t, i) => { g.append('text').attr('x', i * cW + cW / 2).attr('y', -6).attr('transform', `rotate(-45, ${i * cW + cW / 2}, -6)`).attr('font-size', 8).attr('fill', '#64748b').text(t.length > 12 ? t.substring(0, 12) + 'â€¦' : t); g.append('text').attr('x', -6).attr('y', i * cH + cH / 2 + 3).attr('text-anchor', 'end').attr('font-size', 8).attr('fill', '#64748b').text(t.length > 12 ? t.substring(0, 12) + 'â€¦' : t) });
                for (let i = 0; i < top.length; i++)for (let j = 0; j < top.length; j++) {
                    const k = [top[i], top[j]].sort().join('|'), v = i === j ? (tc.get(top[i]) || 0) : (pairs.get(k) || 0), sel = app.state.filters.co && (app.state.filters.co.t1 === top[i] && app.state.filters.co.t2 === top[j] || app.state.filters.co.t1 === top[j] && app.state.filters.co.t2 === top[i]);
                    const r = g.append('rect').attr('class', 'heatmap-cell').attr('x', j * cW).attr('y', i * cH).attr('width', cW - 1).attr('height', cH - 1).attr('rx', 2).attr('fill', v > 0 ? col(v) : '#f8fafc').attr('stroke', sel ? '#16a34a' : 'none').attr('stroke-width', sel ? 2 : 0);
                    if (v > 0) {
                        g.append('text').attr('x', j * cW + cW / 2).attr('y', i * cH + cH / 2 + 2).attr('text-anchor', 'middle').attr('font-size', '8px').attr('fill', v > max / 2 ? 'white' : '#334155').attr('pointer-events', 'none').text(v);
                        r.on('mouseover', () => {
                            // UPDATED: Compact horizontal format for bottom bar tooltip
                            tt.innerHTML = `<div class="flex items-center gap-1.5"><span class="text-slate-500 font-semibold">Filter:</span><span class="text-slate-700 font-bold">${top[i]}</span><span class="text-slate-400">&</span><span class="text-slate-700 font-bold">${top[j]}</span><span class="ml-1 bg-green-100 text-green-800 px-1.5 py-0.5 rounded font-bold">${v}</span></div>`;
                            tt.classList.remove('opacity-0', 'pointer-events-none');
                        }).on('mouseout', () => tt.classList.add('opacity-0', 'pointer-events-none'))
                        .on('click', () => { app.state.filters.co = sel ? null : { t1: top[i], t2: top[j] }; app.render() });
                    }
                }
            },
            gr: () => {  const svg = d3.select('#networkGraph'), g = svg.append('g'), defs = svg.append('defs'); COLORS.forEach(c => defs.append('radialGradient').attr('id', 'g-' + c.slice(1)).attr('cx', '30%').attr('cy', '30%').call(gg => { gg.append('stop').attr('offset', '0%').attr('stop-color', d3.color(c).brighter(1.2)); gg.append('stop').attr('offset', '100%').attr('stop-color', c) })); const z = d3.zoom().scaleExtent([.1, 8]).on('zoom', e => { g.attr('transform', e.transform); app.d3.k = e.transform.k; if (app.d3.lbl) app.d3.lbl.style('display', app.state.graph.labels && app.d3.k >= 0.8 ? null : 'none'); if (app.particles) app.particles.setTransform({ x: e.transform.x, y: e.transform.y, k: e.transform.k }) }); app.d3 = { svg, g, zoom: z, sim: d3.forceSimulation().force('link', d3.forceLink().id(d => d.id).distance(120).strength(.3)).force('charge', d3.forceManyBody().strength(-320)).force('collide', d3.forceCollide().radius(d => d.rad + 4).iterations(3)), k: 1 }; svg.call(z); app.particles = new ParticleSystem(el('particleCanvas')); const resizeObs = new ResizeObserver(() => { app.resizeGraph() }); resizeObs.observe(el('graphContainer')); window.addEventListener('resize', app.resizeGraph); app.resizeGraph() },
            resizeGraph: () => { const c = el('graphContainer'), w = c.clientWidth || 800, h = c.clientHeight || 600; app.d3.svg.attr('viewBox', `0 0 ${w} ${h}`); app.d3.sim.force('center', d3.forceCenter(w / 2, h / 2)); app.clus(); app.d3.sim.alpha(.3).restart(); if (app.particles) app.particles.resize() },
            clus: () => {  if (!app.d3.nodes || !app.state.graph.cluster) { app.d3.sim.force('x', null).force('y', null); return } const w = el('graphContainer').clientWidth, h = el('graphContainer').clientHeight, insts = [...new Set(app.d3.nodes.map(n => n.inst))].sort(), r = Math.min(w, h) * 0.28, pos = new Map(insts.map((i, x) => [i, { x: w / 2 + Math.cos((x / insts.length) * Math.PI * 2 - Math.PI / 2) * r, y: h / 2 + Math.sin((x / insts.length) * Math.PI * 2 - Math.PI / 2) * r }])); app.d3.sim.force('x', d3.forceX(d => pos.get(d.inst)?.x).strength(.15)).force('y', d3.forceY(d => pos.get(d.inst)?.y).strength(.15)) },
            renderGraph: (P, vis) => {  const nodes = app.data.graph.nodes.filter(n => vis.has(n.id)), links = app.data.graph.links.filter(l => vis.has(l.source.id || l.source) && vis.has(l.target.id || l.target)); app.d3.nodes = nodes; const { g, sim } = app.d3; g.selectAll('*').remove(); const adj = new Map, linksMap = new Map, nodesMap = new Map; nodes.forEach(n => nodesMap.set(n.id, n)); links.forEach(l => { const sid = l.source.id || l.source, tid = l.target.id || l.target; (adj.get(sid) || adj.set(sid, new Set).get(sid)).add(tid); (adj.get(tid) || adj.set(tid, new Set).get(tid)).add(sid); linksMap.set([sid, tid].sort().join('|'), l) }); const maxW = d3.max(links, d => d.w) || 1, wS = d3.scaleSqrt().domain([1, maxW]).range([.5, 3]), tip = el('tooltip'), et = el('edgeTooltip'); const hullGroup = g.append('g').attr('class', 'hull-layer'); const instGroups = new Map(); nodes.forEach(n => { if (!instGroups.has(n.inst)) instGroups.set(n.inst, []); instGroups.get(n.inst).push(n) }); const hullPaths = []; instGroups.forEach((groupNodes, inst) => { if (groupNodes.length < 1) return; const path = hullGroup.append('path').attr('class', 'hull-path').attr('fill', app.gCol(inst)).attr('stroke', app.gCol(inst)).attr('stroke-width', 20).attr('d', ''); hullPaths.push({ path, nodes: groupNodes, inst }) }); const updateHulls = () => { if (!app.state.graph.cluster) { hullPaths.forEach(h => h.path.attr('d', '')); return } for (const hp of hullPaths) { const pts = hp.nodes.filter(n => n.x != null).map(n => [n.x, n.y]); hp.path.attr('d', computeHullPath(pts, 20)) } }; const lnk = g.append('g').selectAll('line').data(links).enter().append('line').attr('stroke', '#cbd5e1').attr('stroke-opacity', d => .4 + .3 * (d.w / maxW)).attr('stroke-width', d => wS(d.w)).on('mouseover', (e, d) => { const r = el('graphContainer').getBoundingClientRect(); Object.assign(et.style, { left: Math.min(e.clientX - r.left + 10, r.width - 200) + 'px', top: Math.min(e.clientY - r.top + 10, r.height - 100) + 'px' }); et.innerHTML = `<div class="font-bold text-slate-700">${esc((d.source.display_name || d.source) + ' â†” ' + (d.target.display_name || d.target))}</div><div class="text-[9px] text-green-700">${d.w} papers</div>`; et.classList.remove('hidden') }).on('mouseout', () => et.classList.add('hidden')); const nd = g.append('g').selectAll('g').data(nodes).enter().append('g').call(d3.drag().on('start', (e, d) => { if (!e.active) sim.alphaTarget(.3).restart(); d.fx = d.x; d.fy = d.y }).on('drag', (e, d) => { d.fx = e.x; d.fy = e.y }).on('end', (e, d) => { if (!e.active) sim.alphaTarget(0); d.fx = null; d.fy = null })); nd.append('circle').attr('class', 'search-highlight-ring').attr('r', d => d.rad + 6).attr('fill', 'none').attr('stroke', '#16a34a').attr('stroke-width', 2).attr('opacity', 0); nd.each(function (d) { const arcs = buildTemporalArcs(d.id, P, CFG.now); if (!arcs.length) return; const arcGroup = d3.select(this).append('g').attr('class', 'temporal-arc'); const outerR = d.rad + 4, innerR = d.rad + 1, arcGen = d3.arc(); let startAngle = 0, total = arcs.reduce((s, a) => s + a.count, 0); for (const arc of arcs) { const frac = arc.count / total, endAngle = startAngle + frac * Math.PI * 2; arcGroup.append('path').attr('d', arcGen({ innerRadius: innerR, outerRadius: outerR, startAngle, endAngle })).attr('fill', arc.color).attr('opacity', 0.7); startAngle = endAngle } }); nd.append('circle').attr('r', d => d.rad).attr('fill', d => `url(#g-${d.color.slice(1)})`).attr('stroke', '#ffffff4d').attr('stroke-width', 1.5).style('cursor', 'pointer'); nd.append('text').text(d => d.display_name.split(' ').filter(Boolean).slice(0, 2).map(x => x[0]).join('').toUpperCase()).attr('dy', '0.35em').attr('text-anchor', 'middle').attr('fill', 'white').attr('font-size', d => Math.max(8, d.rad * .45)).attr('font-weight', '600').style('pointer-events', 'none'); app.d3.lbl = nd.append('text').attr('class', 'node-label').text(d => d.display_name.split(' ').pop().replace(/[,;]/g, '')).attr('text-anchor', 'middle').attr('y', d => d.rad + 12).attr('fill', '#334155').attr('font-size', 10).attr('font-weight', '600').style('pointer-events', 'none').style('display', app.state.graph.labels ? null : 'none'); app.d3.nd = nd; nd.on('mouseover', (e, d) => { nd.transition().duration(200).attr('opacity', n => (n.id === d.id || adj.get(d.id)?.has(n.id)) ? 1 : .1); lnk.transition().duration(200).attr('stroke', l => ((l.source.id || l.source) === d.id || (l.target.id || l.target) === d.id) ? '#475569' : '#e2e8f0').attr('stroke-opacity', l => ((l.source.id || l.source) === d.id || (l.target.id || l.target) === d.id) ? 1 : .05); const r = el('graphContainer').getBoundingClientRect(); Object.assign(tip.style, { left: Math.min(e.clientX - r.left + 15, r.width - 340) + 'px', top: Math.min(e.clientY - r.top + 15, r.height - 200) + 'px' }); const egoSVG = buildEgoMiniSVG(d.id, adj, nodesMap, linksMap); tip.innerHTML = `<div class="font-bold text-slate-800">${esc(d.display_name)}</div><div class="text-[9px] text-slate-500 mb-2">${esc(d.inst)}</div><div class="flex gap-2 text-center"><div class="bg-slate-50 border rounded px-1.5 py-0.5 flex-1"><div class="font-bold text-slate-700">${d.net_works}</div><div class="text-[7px] uppercase">Works</div></div><div class="bg-slate-50 border rounded px-1.5 py-0.5 flex-1"><div class="font-bold text-slate-700">${d.net_cited}</div><div class="text-[7px] uppercase">Cites</div></div><div class="bg-slate-50 border rounded px-1.5 py-0.5 flex-1"><div class="font-bold text-slate-700">${adj.get(d.id)?.size || 0}</div><div class="text-[7px] uppercase">Collab</div></div></div>${egoSVG ? `<div class="mt-1 border-t border-slate-100 pt-1"><div class="text-[8px] font-bold text-slate-400 uppercase">Collaboration Network</div>${egoSVG}</div>` : ''}`; tip.classList.remove('hidden') }).on('mouseout', () => { nd.transition().duration(200).attr('opacity', 1); lnk.transition().duration(200).attr('stroke', '#cbd5e1').attr('stroke-opacity', d => .4 + .3 * (d.w / maxW)); tip.classList.add('hidden') }).on('click', (e, d) => { e.stopPropagation(); e.shiftKey ? app.cmp(d) : app.profile(d) }); if (app.particles) { app.particles.setLinks(links); if (app.state.graph.particles) { app.particles.resize(); app.particles.start() } else { app.particles.stop() } } app.clus(); sim.nodes(nodes).on('tick', () => { const cw = el('graphContainer').clientWidth, ch = el('graphContainer').clientHeight; nodes.forEach(n => { n.x = clamp(n.x, 25 + n.rad, cw - 25 - n.rad); n.y = clamp(n.y, 25 + n.rad, ch - 25 - n.rad) }); lnk.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y); nd.attr('transform', d => `translate(${d.x},${d.y})`); updateHulls() }); sim.force('link').links(links); sim.alpha(1).restart(); app.hl() },
            renderConstellation: (F) => {  const svg = d3.select('#constellationGraph'); svg.selectAll('*').remove(); if (!F.length) return; const container = el('constellationPanel'); const W = container.clientWidth || 800; const H = container.clientHeight || 600; svg.attr('viewBox', `0 0 ${W} ${H}`); const topicColors = new Map(); const tc = new Map(); F.forEach(p => p.topics.forEach(t => tc.set(t, (tc.get(t) || 0) + 1))); const sortedTopics = [...tc.entries()].sort((a, b) => b[1] - a[1]); sortedTopics.forEach(([t], i) => topicColors.set(t, COLORS[i % COLORS.length])); const cNodes = F.slice(0, 200).map(p => ({ id: p.id, title: p.title, year: p.year, cites: p.cites, topics: p.topics, score: p.score, color: topicColors.get(p.topics[0]) || '#94a3b8', r: clamp(3 + Math.sqrt(p.cites) * 0.5, 3, 12) })); const cLinks = []; for (let i = 0; i < cNodes.length; i++) { for (let j = i + 1; j < cNodes.length; j++) { const shared = cNodes[i].topics.filter(t => cNodes[j].topics.includes(t)).length; if (shared >= 2) { cLinks.push({ source: cNodes[i].id, target: cNodes[j].id, w: shared }) } } } const g = svg.append('g'); const zoom = d3.zoom().scaleExtent([0.2, 5]).on('zoom', e => g.attr('transform', e.transform)); svg.call(zoom); const cSim = d3.forceSimulation(cNodes).force('link', d3.forceLink(cLinks).id(d => d.id).distance(40).strength(d => d.w * 0.05)).force('charge', d3.forceManyBody().strength(-15)).force('center', d3.forceCenter(W / 2, H / 2)).force('collide', d3.forceCollide().radius(d => d.r + 2)); if (app.constellationSim) app.constellationSim.stop(); app.constellationSim = cSim; const link = g.append('g').selectAll('line').data(cLinks).enter().append('line').attr('class', 'constellation-link').attr('stroke-width', d => d.w * 0.5); const node = g.append('g').selectAll('circle').data(cNodes).enter().append('circle').attr('class', 'constellation-node').attr('r', d => d.r).attr('fill', d => d.color).attr('opacity', 0.7); const cTip = el('constellationTooltip'); node.on('mouseover', (e, d) => { const r = container.getBoundingClientRect(); Object.assign(cTip.style, { left: Math.min(e.clientX - r.left + 10, r.width - 220) + 'px', top: Math.min(e.clientY - r.top + 10, r.height - 120) + 'px' }); cTip.innerHTML = `<div class="font-bold text-slate-800 text-[11px] leading-snug mb-1">${esc(d.title)}</div><div class="text-[9px] text-slate-500">${d.year} Â· ${d.cites} cites Â· Score ${d.score.toFixed(1)}</div><div class="flex flex-wrap gap-1 mt-1">${d.topics.slice(0, 4).map(t => `<span class="px-1 py-0.5 rounded text-[8px] border" style="background:${topicColors.get(t) || '#f1f5f9'}20;border-color:${topicColors.get(t) || '#e2e8f0'};color:${topicColors.get(t) || '#64748b'}">${esc(t.substring(0, 20))}</span>`).join('')}</div>`; cTip.classList.remove('hidden') }).on('mouseout', () => cTip.classList.add('hidden')).on('click', (e, d) => { e.stopPropagation(); app.detail(d.id) }); cSim.on('tick', () => { link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y); node.attr('cx', d => d.x).attr('cy', d => d.y) }); const legendG = svg.append('g').attr('transform', `translate(${W - 150}, 20)`); legendG.append('rect').attr('width', 140).attr('height', Math.min(sortedTopics.length, 8) * 14 + 22).attr('rx', 6).attr('fill', 'white').attr('fill-opacity', 0.9).attr('stroke', '#e2e8f0'); legendG.append('text').attr('x', 8).attr('y', 14).attr('font-size', 8).attr('font-weight', 700).attr('fill', '#94a3b8').text('TOPIC COLORS'); sortedTopics.slice(0, 8).forEach(([t], i) => { legendG.append('circle').attr('cx', 12).attr('cy', 28 + i * 14).attr('r', 4).attr('fill', topicColors.get(t)); legendG.append('text').attr('x', 22).attr('y', 31 + i * 14).attr('font-size', 8).attr('fill', '#64748b').text(t.length > 18 ? t.substring(0, 18) + 'â€¦' : t) }) },
            hl: () => { const q = norm(el('graphSearchInput')?.value || ''); if (!app.d3.nd) return; app.d3.nd.select('.search-highlight-ring').attr('opacity', d => q && norm(d.display_name).includes(q) ? 1 : 0).each(function (d) { d3.select(this).classed('pulse-highlight', q && norm(d.display_name).includes(q)) }) },
            cmp: d => { const i = app.state.cmp.findIndex(n => n.id === d.id); if (i >= 0) { app.state.cmp.splice(i, 1); return } app.state.cmp.push(d); if (app.state.cmp.length >= 2) { const [a, b] = app.state.cmp; el('compareModal').classList.add('active'); app.state.cmp = []; const ap = app.data.pubs.filter(p => p.memA.some(m => m.id === a.id)), bp = app.data.pubs.filter(p => p.memA.some(m => m.id === b.id)), sh = ap.filter(p => p.memA.some(m => m.id === b.id)), at = new Set(ap.flatMap(p => p.topics)), bt = new Set(bp.flatMap(p => p.topics)); el('compareContent').innerHTML = `<div class="flex justify-between items-start mb-6"><h2 class="text-lg font-bold text-slate-800">Researcher Comparison</h2><button onclick="document.getElementById('compareModal').classList.remove('active')"><i class="fas fa-times"></i></button></div><div class="grid grid-cols-2 gap-6 mb-6"><div class="text-center"><div class="w-16 h-16 rounded-full mx-auto flex items-center justify-center text-white font-bold text-xl shadow-lg mb-2" style="background:${a.color}">${a.display_name.substring(0, 2)}</div><h3 class="font-bold text-slate-800 text-sm">${esc(a.display_name)}</h3></div><div class="text-center"><div class="w-16 h-16 rounded-full mx-auto flex items-center justify-center text-white font-bold text-xl shadow-lg mb-2" style="background:${b.color}">${b.display_name.substring(0, 2)}</div><h3 class="font-bold text-slate-800 text-sm">${esc(b.display_name)}</h3></div></div><div class="grid grid-cols-3 gap-3 mb-6 text-center"><div class="bg-blue-50 rounded-lg p-3"><div class="grid grid-cols-2"><div><span class="block font-bold text-lg">${ap.length}</span><span class="text-[8px]">Works</span></div><div><span class="block font-bold text-lg">${bp.length}</span><span class="text-[8px]">Works</span></div></div></div><div class="bg-green-50 rounded-lg p-3"><span class="block font-bold text-lg">${sh.length}</span><span class="text-[8px]">Shared</span></div><div class="bg-purple-50 rounded-lg p-3"><div class="grid grid-cols-2"><div><span class="block font-bold text-lg">${ap.reduce((s, p) => s + p.cites, 0)}</span><span class="text-[8px]">Cites</span></div><div><span class="block font-bold text-lg">${bp.reduce((s, p) => s + p.cites, 0)}</span><span class="text-[8px]">Cites</span></div></div></div></div>` } },
            tog: (k, v) => { app.state.filters[k].has(v) ? app.state.filters[k].delete(v) : app.state.filters[k].add(v); app.state.page = 1; app.render() },
            clear: k => { app.state.filters[k].clear(); app.state.page = 1; app.render() }, clrCo: () => { app.state.filters.co = null; app.render() },
            reset: () => { app.state.filters = { q: '', topics: new Set, insts: new Set, yFrom: null, yTo: null, minRel: CFG.defMin, bm: false, co: null };['globalSearch', 'yearFrom', 'yearTo'].forEach(i => el(i).value = ''); el('minRelevance').value = CFG.defMin; el('valMinRel').textContent = CFG.defMin.toFixed(1); app.state.page = 1; app.updBmBtn(); app.render() },
            setPage: p => { app.state.page = p; app.render() }, zoom: k => app.d3.svg.transition().duration(600).call(app.d3.zoom.scaleBy, k), fitGraph: () => { const b = app.d3.g.node().getBBox(); if (!b.width) return; const s = Math.min(0.9, 1 / Math.max(b.width / (el('graphContainer').clientWidth - 100), b.height / (el('graphContainer').clientHeight - 100))); app.d3.svg.transition().duration(750).call(app.d3.zoom.transform, d3.zoomIdentity.translate(el('graphContainer').clientWidth / 2 - (b.x + b.width / 2) * s, el('graphContainer').clientHeight / 2 - (b.y + b.height / 2) * s).scale(s)) },
            toggleCluster: () => { app.state.graph.cluster = !app.state.graph.cluster; app.clus(); app.d3.sim.alpha(.3).restart() },
            toggleLabels: () => { app.state.graph.labels = !app.state.graph.labels; if (app.d3.lbl) app.d3.lbl.style('display', app.state.graph.labels && app.d3.k >= 0.8 ? null : 'none') },
            toggleParticles: () => { app.state.graph.particles = !app.state.graph.particles; if (app.particles) { if (app.state.graph.particles) { app.particles.resize(); app.particles.start() } else { app.particles.stop() } } const btn = el('particleToggleBtn'); if (btn) btn.style.opacity = app.state.graph.particles ? '1' : '0.4' },
            togBm: id => { app.bm.has(id) ? app.bm.delete(id) : app.bm.add(id); localStorage.setItem('agripv_bookmarks', JSON.stringify([...app.bm])); app.updBm(); app.render() },
            updBm: () => { el('bookmarkCount').textContent = app.bm.size }, toggleBookmarkFilter: () => { app.state.filters.bm = !app.state.filters.bm; app.state.page = 1; app.updBmBtn(); app.render() },
            updBmBtn: () => { const b = el('bookmarkFilterBtn'); b.className = app.state.filters.bm ? 'flex items-center gap-1 px-1.5 py-0.5 rounded-full text-[8px] font-bold border transition-all bg-amber-100 text-amber-700 border-amber-300' : 'flex items-center gap-1 px-1.5 py-0.5 rounded-full text-[8px] font-bold border transition-all bg-slate-50 text-slate-500 border-slate-200 hover:bg-amber-50 hover:text-amber-600' },
            togSel: id => { app.state.sel.has(id) ? app.state.sel.delete(id) : app.state.sel.add(id); app.updSel() }, clearSelection: () => { app.state.sel.clear(); app.render() },
            updSel: () => { const c = app.state.sel.size; el('selectedCount').textContent = c; el('batchActions').classList.toggle('hidden', !c); el('exportSelectedBtn').classList.toggle('hidden', !c); el('exportSelectedBibBtn').classList.toggle('hidden', !c); el('exportSelectedDivider').classList.toggle('hidden', !c) },
            batchBookmark: () => { app.state.sel.forEach(id => app.bm.add(id)); localStorage.setItem('agripv_bookmarks', JSON.stringify([...app.bm])); app.updBm(); app.clearSelection(); app.render() },
            batchCite: () => { const P = app.data.pubs.filter(p => app.state.sel.has(p.id)); if (!P.length) return; el('batchCiteModal').classList.add('active'); el('batchCiteContent').innerHTML = P.map(p => `<div class="bg-slate-50 p-2.5 rounded border border-slate-200 text-xs text-slate-600 font-mono leading-relaxed relative group"><span>${esc(`${p.allA.slice(0, 5).map(a => a.name).join(', ')}${p.allA.length > 5 ? ', et al.' : ''} (${p.year}). ${p.title}. ${p.source || 'Journal'}.`)}</span><button class="absolute top-1 right-1 px-1.5 py-0.5 bg-white border border-slate-200 rounded shadow-sm opacity-0 group-hover:opacity-100" onclick="navigator.clipboard.writeText(this.previousElementSibling.textContent)"><i class="fas fa-copy"></i></button></div>`).join('') },
            toggleScrollMode: () => { app.state.mode = app.state.mode === 'paginated' ? 'infinite' : 'paginated'; el('scrollModeLabel').textContent = app.state.mode === 'paginated' ? 'Pages' : 'Scroll'; el('publicationsPanel').classList.toggle('scroll-mode-infinite', app.state.mode === 'infinite'); app.state.page = 1; app.render() },
            dark: () => { document.body.classList.toggle('dark-mode', app.state.dark); if (el('darkModeIcon')) el('darkModeIcon').className = app.state.dark ? 'fas fa-sun text-xs' : 'fas fa-moon text-xs' }, toggleDarkMode: () => { app.state.dark = !app.state.dark; localStorage.setItem('agripv_dark', app.state.dark ? '1' : '0'); app.dark() },
            cpD: (e, d) => { navigator.clipboard.writeText(d); const btn = e.currentTarget; const originalHTML = btn.innerHTML; btn.innerHTML = '<i class="fas fa-check"></i>'; btn.classList.add('text-green-600'); setTimeout(() => { btn.innerHTML = originalHTML; btn.classList.remove('text-green-600') }, 1500) },
            profile: r => { el('researcherModal').classList.add('active'); const P = app.data.pubs.filter(p => p.memA.some(a => a.id === r.id)).sort((a, b) => b.year - a.year), yc = new Map; P.forEach(p => yc.set(p.year, (yc.get(p.year) || 0) + 1)); const top = [...Object.entries(r.topics)].sort((a, b) => b[1] - a[1]).slice(0, 8); el('researcherContent').innerHTML = `<div class="sticky top-0 bg-white z-10 p-5 border-b border-slate-100"><div class="flex justify-between items-start"><div class="flex items-center gap-4"><div class="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg" style="background:${r.color}">${r.display_name.substring(0, 2)}</div><div><h2 class="text-lg font-bold text-slate-800">${esc(r.display_name)}</h2><p class="text-xs text-slate-500">${esc(r.inst)}</p></div></div><button onclick="document.getElementById('researcherModal').classList.remove('active')"><i class="fas fa-times"></i></button></div><div class="grid grid-cols-3 gap-3 mt-4 text-center"><div class="bg-slate-50 p-2 rounded"><span class="block font-bold text-xl">${P.length}</span><span class="text-[9px]">Pubs</span></div><div class="bg-slate-50 p-2 rounded"><span class="block font-bold text-xl">${P.reduce((s, p) => s + p.cites, 0)}</span><span class="text-[9px]">Citations</span></div><div class="bg-slate-50 p-2 rounded flex flex-col items-center justify-center">${app.spark([...yc.keys()].sort().map(y => yc.get(y)), 80, 20)}<span class="text-[9px] mt-1">Trend</span></div></div>${top.length ? `<div class="mt-3"><div class="flex flex-wrap gap-1">${top.map(([t, c]) => `<span class="px-1.5 py-0.5 bg-green-50 text-green-700 text-[9px] rounded border border-green-100">${esc(t)}</span>`).join('')}</div></div>` : ''}</div><div class="p-5 space-y-2">${P.slice(0, 15).map(p => `<div class="p-2.5 rounded border hover:bg-slate-50 cursor-pointer" onclick="document.getElementById('researcherModal').classList.remove('active');app.detail('${p.id}')"><div class="font-semibold text-xs mb-1">${esc(p.title)}</div><div class="text-[10px] text-slate-400">${p.year} â€¢ ${p.score.toFixed(1)} score</div></div>`).join('')}</div>` },
            detail: async id => { const p = app.data.pubs.find(x => x.id === id); if (!p) return; el('detailModal').classList.add('active'); const rel = app.data.pubs.filter(r => r.id !== p.id && (r.memA.some(a => p.memA.includes(a)) || r.topics.some(t => p.topics.includes(t)))).sort((a, b) => (b.topics.filter(t => p.topics.includes(t)).length) - (a.topics.filter(t => p.topics.includes(t)).length)).slice(0, 5); const show = ab => { if (ab) app.cache.set(p.id, ab); el('detailContent').innerHTML = `<div class="flex justify-between items-start mb-4 pb-3 border-b"><div class="flex-1"><h2 class="text-lg font-bold pr-8">${esc(p.title)}</h2></div><div class="flex gap-2"><button onclick="app.togBm('${p.id}');app.detail('${p.id}')" class="text-lg ${app.bm.has(p.id) ? 'text-amber-500' : 'text-slate-300'}"><i class="fas fa-bookmark"></i></button><button onclick="document.getElementById('detailModal').classList.remove('active')"><i class="fas fa-times"></i></button></div></div><div class="flex flex-wrap gap-3 text-xs text-slate-500 mb-6 font-medium"><span class="flex items-center gap-1.5"><i class="fas fa-calendar"></i> ${p.year}</span><span class="flex items-center gap-1.5"><i class="fas fa-quote-right"></i> ${p.cites}</span>${p.source ? `<span class="flex items-center gap-1.5"><i class="fas fa-book"></i> ${esc(p.source)}</span>` : ''}${p.doi ? `<button onclick="app.cpD(event, '${jsStr(p.doi)}')" class="text-blue-600 bg-blue-50 px-1.5 rounded">DOI</button>` : ''}</div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2"><h4 class="font-bold text-xs uppercase mb-2">Abstract</h4>${ab ? `<div class="text-slate-600 text-xs leading-relaxed bg-slate-50 p-4 rounded-lg border text-justify">${esc(ab)}</div>` : `<div class="text-slate-400 text-xs italic bg-slate-50 p-4 rounded-lg text-center">No Abstract</div>`}${rel.length ? `<div class="mt-6"><h4 class="font-bold text-xs uppercase mb-2">Related</h4><div class="space-y-1.5">${rel.map(r => `<div class="p-2 rounded border hover:bg-slate-50 cursor-pointer" onclick="app.detail('${r.id}')"><div class="font-semibold text-[11px]">${esc(r.title)}</div></div>`).join('')}</div></div>` : ''}</div><div><h4 class="font-bold text-xs uppercase mb-2">Authors</h4><div class="flex flex-col gap-1.5">${p.allA.map(a => `<div class="flex items-center gap-2 text-xs p-1.5 rounded-lg border ${a.mem ? 'border-green-200 bg-green-50 cursor-pointer' : 'border-transparent'}" ${a.mem ? `onclick="document.getElementById('detailModal').classList.remove('active');app.profile(app.data.researchers.find(r=>r.id==='${a.id}'))"` : ''}>${a.mem ? '<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>' : ''}<span class="truncate">${esc(a.name)}</span></div>`).join('')}</div><div class="mt-6"><h4 class="font-bold text-xs uppercase mb-2">Topics</h4><div class="flex flex-wrap gap-1">${p.topics.map(t => `<span class="px-1.5 py-0.5 bg-slate-100 text-slate-600 text-[10px] rounded border">${esc(t)}</span>`).join('')}</div></div></div></div>` }; if (app.cache.has(p.id)) show(app.cache.get(p.id)); else { try { const d = await fetchJSON(`${CFG.api}/works/${p.id.split('/').pop()}?select=abstract_inverted_index`); show(d?.abstract_inverted_index ? invIdx(d.abstract_inverted_index) : null) } catch { show(null) } } },
            cite: id => { const p = app.data.pubs.find(x => x.id === id), aa = p.allA.map(a => a.name); el('citationModal').classList.add('active'); el('citeAPA').textContent = `${aa.slice(0, 5).join(', ')}${aa.length > 5 ? ', et al.' : ''} (${p.year}). ${p.title}. ${p.source || 'Journal'}.`; el('citeBib').textContent = `@article{${(aa[0] || 'u').split(' ').pop().toLowerCase().replace(/[^a-z]/g, '')}${p.year}, author={${aa.join(' and ')}}, title={${p.title}}, year={${p.year}}, journal={${p.source || 'Journal'}}}`; el('citeRIS').textContent = `TY  - JOUR\nTI  - ${p.title}\nPY  - ${p.year}\n${aa.map(a => `AU  - ${a}`).join('\n')}\nJO  - ${p.source || ''}\nDO  - ${p.doi || ''}\nER  -` },
            copy: id => { navigator.clipboard.writeText(el(id).textContent); const b = event.currentTarget; b.innerHTML = '<i class="fas fa-check text-green-600"></i>'; setTimeout(() => b.innerHTML = '<i class="fas fa-copy"></i>', 1500) },
            toggleExportMenu: () => { el('exportMenu').classList.toggle('hidden') },
            exportData: (fmt, sel = false) => { const d = sel ? app.data.pubs.filter(p => app.state.sel.has(p.id)) : app.state.last; const down = (c, t, e) => { const u = URL.createObjectURL(new Blob([c], { type: t })); Object.assign(document.createElement('a'), { href: u, download: `agripv.${e}` }).click(); URL.revokeObjectURL(u); el('exportMenu').classList.add('hidden') }; if (fmt === 'csv') down([['Title', 'Year', 'Score', 'Cites', 'Authors', 'DOI'], ...d.map(p => [`"${p.title.replace(/"/g, '""')}"`, p.year, p.score, p.cites, `"${p.allA.map(a => a.name).join(';')}"`, p.doi || ''])].map(r => r.join(',')).join('\n'), 'text/csv', 'csv'); if (fmt === 'bib') down(d.map(p => `@article{${p.id.split('/').pop()}, author={${p.allA.map(a => a.name).join(' and ')}}, title={${p.title}}, year={${p.year}}}`).join('\n\n'), 'application/x-bibtex', 'bib'); if (fmt === 'ris') down(d.map(p => `TY - JOUR\nTI - ${p.title}\nPY - ${p.year}\n${p.allA.map(a => 'AU - ' + a.name).join('\n')}\nER -`).join('\n\n'), 'text/plain', 'ris') },
            exportGraphSVG: () => { const s = el('networkGraph').cloneNode(true); s.setAttribute('xmlns', "http://www.w3.org/2000/svg"); s.insertBefore(Object.assign(document.createElement('style'), { textContent: `circle{stroke:#fff;stroke-width:1px}line{stroke:#94a3b8}text{font-family:sans-serif}` }), s.firstChild); const u = URL.createObjectURL(new Blob([new XMLSerializer().serializeToString(s)], { type: 'image/svg+xml' })); Object.assign(document.createElement('a'), { href: u, download: 'agripv_graph.svg' }).click() },
            exportGraphPNG: () => { const c = Object.assign(document.createElement('canvas'), { width: 1600, height: 1200 }), ctx = c.getContext('2d'), img = new Image(); img.onload = () => { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, 1600, 1200); ctx.drawImage(img, 0, 0, 1600, 1200); c.toBlob(b => { Object.assign(document.createElement('a'), { href: URL.createObjectURL(b), download: 'agripv_graph.png' }).click() }) }; img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(new XMLSerializer().serializeToString(el('networkGraph'))))) },
            setView: v => { app.state.view = v; const both = v === 'both'; const isPub = v === 'publications'; const isNet = v === 'network'; const isCon = v === 'constellation'; el('publicationsPanel').style.width = both ? '50%' : (isPub ? '100%' : '0%'); el('publicationsPanel').style.display = (isPub || both) ? 'flex' : 'none'; el('networkPanel').style.width = both ? '50%' : (isNet ? '100%' : '0%'); el('networkPanel').style.display = (isNet || both) ? 'flex' : 'none'; el('constellationPanel').style.width = isCon ? '100%' : '0%'; el('constellationPanel').classList.toggle('active', isCon); el('splitHandle').style.display = both ? 'block' : 'none'; if (isNet || both) { setTimeout(() => { app.resizeGraph(); app.d3.sim.alpha(1).restart(); app.fitGraph() }, 150) } if (isCon) { setTimeout(() => app.renderConstellation(app.state.last), 150) } if (app.particles) { if ((isNet || both) && app.state.graph.particles) { app.particles.resize(); app.particles.start() } else { app.particles.stop() } } document.querySelectorAll('.view-btn').forEach(b => { const active = b.dataset.view === v; b.className = `view-btn px-2.5 py-1 text-[11px] font-semibold rounded ${active ? 'bg-white shadow-sm text-slate-800' : 'text-slate-500 hover:text-slate-700'}` }) },
            ui: () => { let tm; el('globalSearch').oninput = e => { clearTimeout(tm); tm = setTimeout(() => { app.state.filters.q = e.target.value; app.state.page = 1; app.render() }, 300) }; el('sortSelect').onchange = e => { app.state.sort = e.target.value; app.render() }; ['yearFrom', 'yearTo'].forEach(i => el(i).onchange = e => { app.state.filters[i === 'yearFrom' ? 'yFrom' : 'yTo'] = e.target.value ? clamp(+e.target.value, 2000, 2026) : null; app.render() }); el('minRelevance').oninput = e => { const v = +e.target.value; el('valMinRel').textContent = v.toFixed(1); clearTimeout(tm); tm = setTimeout(() => { app.state.filters.minRel = v; app.render() }, 200) }; el('linkDistance').oninput = e => { app.d3.sim.force('link').distance(+e.target.value); app.d3.sim.alpha(.3).restart() }; el('chargeStrength').oninput = e => { app.d3.sim.force('charge').strength(-e.target.value); app.d3.sim.alpha(.3).restart() }; document.querySelectorAll('.view-btn').forEach(b => b.onclick = () => app.setView(b.dataset.view)); let d = false; el('splitHandle').onmousedown = () => { d = true; document.body.style.cursor = 'col-resize' }; document.onmouseup = () => { if (d) app.resizeGraph(); d = false; document.body.style.cursor = 'default' }; document.onmousemove = e => { if (d) { const p = (e.clientX - 320) / (document.body.clientWidth - 320) * 100; if (p > 15 && p < 85) { el('publicationsPanel').style.width = p + '%'; el('networkPanel').style.width = (100 - p) + '%'; app.resizeGraph() } } }; document.addEventListener('click', e => { if (!el('exportDropdown').contains(e.target)) el('exportMenu').classList.add('hidden') }); el('darkModeToggle').onclick = () => app.toggleDarkMode(); el('graphSearchInput').oninput = () => setTimeout(app.hl, 200) }
        };
        const jsStr = s => (s || "").replace(/\\/g, "\\\\").replace(/'/g, "\\'");
        document.addEventListener('DOMContentLoaded', () => { initSharedUI({ onSignOut: signOut }); initAuth({ onAuthReady: () => { renderHeader(authState, { en: { nav: { schedule: "Schedule", archive: "Archive", scholar: "Scholar", network: "Network", map: "Map", about: "About", admin: "Admin" }, auth: { signin: "Sign in", signout: "Sign out" } }, es: { nav: { schedule: "Programa", archive: "Archivo", scholar: "AcadÃ©mico", network: "Red", map: "Mapa", about: "Acerca de", admin: "Admin" }, auth: { signin: "Ingresar", signout: "Salir" } } }, localStorage.getItem('lang') || 'en'); if (authState.profile?.avatar_url) getAvatarUrl(authState.profile.avatar_url).then(u => { if (u) { $('#userAvatar').src = u; show($('#userAvatar')); hide($('#userInitial')) } }) }, onAuthChange: () => { } }); app.init() }); window.app = app;
    </script>
</body>

</html>
