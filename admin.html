<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Almuerzo Agrivoltaico</title>
  <meta name="description" content="Organizer tools for managing the Almuerzo Agrivoltaico seminar series." />
  <link rel="stylesheet" href="styles.css" />

  <!-- FullCalendar (global build + locales) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales-all.global.min.js"></script>

  <style>
    /* --- CORE LAYOUT: Full viewport, no page scrolling --- */
    html, body {
      height: 100vh;
      max-height: 100vh;
      overflow: hidden;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    body {
      display: flex;
      flex-direction: column;
      background-color: var(--background, #121317);
      color: var(--text, #f1f1f1);
    }

    .site-header {
      flex-shrink: 0; /* Prevent header from shrinking */
      z-index: 10;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    /* Main container takes all remaining vertical space */
    main.container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Crucial for flex children overflow */
      padding: var(--space-2);
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }

    /* Admin card fills the main container */
    #admin.card {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      width: 100%;
      max-width: 100%;
      margin: 0;
      padding: var(--space-2);
      box-sizing: border-box;
      overflow: hidden; /* Hide any accidental overflow */
    }

    /* The two-column grid layout for the admin tools */
    .admin-layout-inner {
      flex-grow: 1;
      min-height: 0;
      display: grid;
      /* Flexible columns: form gets a min width, calendar takes up more space */
      grid-template-columns: minmax(400px, 1.2fr) 2fr;
      gap: var(--space-3);
      overflow: hidden;
    }

    /* --- COLUMN STYLING --- */
    .organizer-form-container,
    .admin-side {
      display: flex;
      flex-direction: column;
      min-height: 0; /* Prevent content from expanding the container */
      overflow: hidden; /* Contains children */
    }

    .organizer-form-container h2,
    .admin-side h2 {
      margin: 0 0 var(--space-2) 0;
      flex-shrink: 0; /* Prevent title from shrinking */
      font-size: 1.3rem;
      border-bottom: 1px solid var(--border, #333);
      padding-bottom: var(--space-1);
    }

    /* --- LEFT COLUMN: FORM --- */
    /* Make the form itself scrollable, not the whole column */
    #createEventForm {
      flex-grow: 1;
      overflow-y: auto; /* The magic for the form panel */
      overflow-x: hidden;
      padding-right: var(--space-1); /* Space for scrollbar */
      display: flex;
      flex-direction: column;
    }

    .grid-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2);
      align-items: start;
    }

    .grid-form .col-span-2 { grid-column: span 2; }
    .grid-form label { font-size: 0.8rem; margin-bottom: 4px; display: block; opacity: 0.8; }
    .grid-form textarea { min-height: 80px; resize: vertical; }

    /* Speakers section - with its own scroll if needed */
    .speakers-fieldset {
      border: 1px solid var(--border, #333);
      border-radius: var(--radius-2, 8px);
      padding: var(--space-1) var(--space-2);
      margin-top: var(--space-1);
      background: var(--card-2, #1d1f24);
      max-height: 200px; /* Limit height and allow scrolling */
      overflow-y: auto;
    }

    .speakers-fieldset legend { font-weight: 600; padding: 0 6px; font-size: 0.9rem; }
    .speaker-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto auto;
      gap: var(--space-1);
      align-items: center;
      margin-bottom: var(--space-1);
      padding-bottom: var(--space-1);
      border-bottom: 1px solid var(--color-surface-strong, rgba(255, 255, 255, 0.08));
    }
    .speaker-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .speaker-row label { font-size: 0.7rem; margin-bottom: 2px; }
    .speaker-row .checkbox-field { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; gap: 2px; }

    .btn-danger-ghost {
        padding: 4px 8px; font-size: 1rem; line-height: 1; height: fit-content; align-self: end;
    }
    
    #createEventForm > .col-span-2:last-of-type {
      margin-top: auto; /* Pushes the create button to the bottom */
      padding-top: var(--space-2);
    }

    /* --- RIGHT COLUMN: CALENDAR --- */
    .calendar-tools {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      margin-bottom: var(--space-2);
      flex-shrink: 0;
    }
    .calendar-tools .tool {
      display: flex;
      align-items: center;
      border: 1px solid var(--border, #333);
      border-radius: var(--radius-2, 8px);
      background: var(--card-2, #1d1f24);
      padding: 0 var(--space-1);
    }
    .calendar-tools input {
      border: none; outline: none; background: transparent; color: var(--text);
      height: 36px;
    }

    #calendar {
      flex-grow: 1;
      min-height: 0; /* Critical for FullCalendar sizing */
      position: relative;
    }

    /* FullCalendar Dark Theme Overrides */
    :root {
      --fc-bg-color: var(--card-2);
      --fc-border-color: var(--border, #333);
      --fc-text-color: var(--text, #f1f1f1);
      --fc-neutral-bg-color: rgba(255, 255, 255, 0.05);
      --fc-today-bg-color: rgba(91, 214, 160, 0.1);
      --fc-event-bg-color: var(--brand-2, #5bd6a0);
      --fc-event-border-color: var(--brand-2, #5bd6a0);
      --fc-event-text-color: #000;
      --fc-button-bg-color: var(--card-2, #1d1f24);
      --fc-button-border-color: var(--border, #333);
      --fc-button-text-color: var(--text, #f1f1f1);
      --fc-button-active-bg-color: var(--brand-2, #5bd6a0);
      --fc-button-active-border-color: var(--brand-2, #5bd6a0);
      --fc-button-hover-bg-color: var(--border, #333);
    }
    #calendar .fc { height: 100%; }
    .fc-col-header-cell-cushion { text-decoration: none; color: var(--text) !important; }
    .fc-daygrid-day-number { text-decoration: none; }
    
    /* Calendar event tags */
    .ev-tags {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
    }
    .mini-chip {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.3);
      color: rgba(255, 255, 255, 0.9);
      font-size: 10px;
      line-height: 14px;
      font-weight: 500;
      white-space: nowrap;
    }

    /* --- MODAL & MISC --- */
    #edit-event-modal {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      color: var(--text); box-shadow: var(--shadow-lg);
      width: 90%; max-width: 700px; max-height: 90vh;
      padding: var(--space-3); overflow-y: auto;
    }
    .conflict-row { font-size: 0.8rem; color: #ffbe0b; line-height: 1.4; }
    #accessDenied.card { max-width: 600px; margin: var(--space-4) auto; }

    /* --- HEADER & NAVIGATION --- */
    .mobile-menu-btn { display: none; }
    .nav { display: flex; align-items: center; gap: var(--space-2); }
    .mobile-nav-overlay {
      display: none; flex-direction: column; justify-content: center; align-items: center;
      gap: var(--space-4); position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
      background: rgba(18, 19, 23, 0.9); backdrop-filter: blur(10px);
      z-index: 1000; opacity: 0; transition: opacity 0.3s ease-in-out;
    }
    .mobile-nav-overlay.is-open { display: flex; opacity: 1; }

    /* --- RESPONSIVE: Tablet & Mobile --- */
    @media (max-width: 960px) {
      html, body {
        overflow-y: auto; /* Allow page scrolling on mobile */
        height: auto;
        max-height: none;
      }
      main.container {
        padding: var(--space-1);
        min-height: auto;
      }
      .admin-layout-inner {
        grid-template-columns: 1fr; /* Stack columns */
        grid-template-rows: auto auto; /* Let them size naturally */
        gap: var(--space-3);
      }
      .organizer-form-container {
         max-height: 70vh; /* Give form a max height */
      }
      .admin-side {
        min-height: 70vh; /* Ensure calendar has enough space */
      }

      /* Mobile Header Styles */
      .mobile-menu-btn {
        display: block; background: none; border: none; color: var(--text);
        font-size: 2rem; cursor: pointer; z-index: 1001; padding: 0; line-height: 0;
      }
      .header-grid > .nav { display: none; }
      
      .mobile-nav-overlay .nav {
        display: flex; flex-direction: column; align-items: center;
        gap: var(--space-4);
      }
      .mobile-nav-overlay .link { font-size: 1.8rem; font-weight: 500; }
      .mobile-nav-overlay .divider { display: none; }
      .mobile-nav-overlay .auth-area {
        margin-top: var(--space-2); display: flex; flex-direction: column;
        align-items: center; gap: var(--space-3);
      }
      .mobile-nav-close-btn {
        position: absolute; top: var(--space-3); right: var(--space-3);
        background: none; border: none; color: var(--text);
        cursor: pointer; line-height: 1; padding: 0;
      }
      body.menu-open { overflow: hidden; }
    }
  </style>
</head>

<body>
  <header class="site-header">
  <div class="container header-grid">
    <div class="brand">
      <a href="index.html" style="display: contents; text-decoration: none;">
        
        <!-- MODIFICATION: Replaced the old logo div with your new image -->
        <img src="static/icon.png" alt="Almuerzo Agrivoltaico logo" class="logo-image">
        
        <div class="brand-text">
          <div class="title">Almuerzo Agrivoltaico</div>
          <div class="subtitle" data-i18n="tagline">
            An informal seminar series to share advances in agrivoltaics in Latin America
          </div>
        </div>
      </a>
    </div>
    
    <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <!-- Desktop Nav -->
    <nav class="nav">
      <a href="index.html" class="link" data-i18n="nav.schedule">Schedule</a>
      <a href="archive.html" class="link" data-i18n="nav.archive">Archive</a>
      <a href="about.html" class="link" data-i18n="nav.about">About</a>
      <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
      <div class="divider"></div>
      <div id="langSwitchDesktop" class="lang-switch-slider" data-lang="en">
        <span>EN</span>
        <span>ES</span>
      </div>
      <div class="auth-area">
        <!-- PRESERVED: This is the user profile button, which is handled by your JS -->
        <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile">
          <span id="userInitial"></span>
          <img id="userAvatar" style="display: none; width: 100%; height: 100%; object-fit: cover;" />
        </button>
        <span id="userName"></span>
        <button id="btnSignIn" class="btn-primary" data-i18n="auth.signin">Sign in</button>
        <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
          Sign out
        </button>
      </div>
    </nav>
  </div>
</header>
  
  <div id="mobileNavOverlay" class="mobile-nav-overlay">
    <!-- Content will be injected by JS -->
  </div>

  <div id="flash" class="flash" role="status" aria-live="polite"></div>

  <main class="container">
    <section id="admin" class="card" style="display: none;">
      <div class="admin-layout-inner">
        <!-- Left Side: Create Form -->
        <div class="organizer-form-container">
          <h2 data-i18n="admin.title">Organizer Tools</h2>
          <form id="createEventForm" class="grid-form">
            <!-- Form fields are wrapped in a div to ensure the final button is pushed to the bottom -->
            <div>
              <div class="grid-form">
                <div><label data-i18n="event.title_en">Title (EN)</label><input id="titleEn" required /></div>
                <div><label data-i18n="event.title_es">Title (ES)</label><input id="titleEs" /></div>
                <div class="col-span-2"><label data-i18n="event.desc_en">Description (EN)</label><textarea
                    id="descEn"></textarea></div>
                <div class="col-span-2"><label data-i18n="event.desc_es">Description (ES)</label><textarea
                    id="descEs"></textarea></div>
                <div><label data-i18n="event.start">Start time</label><input id="startTime" type="text"
                    placeholder="mm/dd/yyyy --:-- --" required /></div>
                <div><label data-i18n="event.end">End time</label><input id="endTime" type="text"
                    placeholder="mm/dd/yyyy --:-- --" /></div>
                <div><label data-i18n="event.lang">Language</label>
                  <select id="eventLang">
                    <option value="bi">Bilingual</option>
                    <option value="en">English</option>
                    <option value="es">Español</option>
                  </select>
                </div>
                <div><label data-i18n="event.host">Host org</label><input id="hostOrg"
                    placeholder="UNAM, University of Arizona…" /></div>
                <div class="col-span-2"><label data-i18n="event.zoom">Zoom URL (members only)</label><input id="zoomUrl"
                    type="url" /></div>

                <!-- Tags Section (Create) -->
                <div class="tags-field col-span-2">
                  <label data-i18n="tags.label">Tags (optional)</label>
                  <div class="tags-input" id="createTagsInput" role="group" aria-label="Create tags input">
                    <div class="chips-wrap"></div>
                    <input id="createTagsField" data-i18n-placeholder="tags.placeholder"
                      placeholder="Press Enter or comma to add. Not mandatory." />
                  </div>
                </div>

                <!-- Speakers Section -->
                <fieldset class="speakers-fieldset col-span-2">
                  <legend data-i18n="speakers.title">Speakers</legend>
                  <div id="createSpeakersContainer"></div>
                  <button type="button" class="btn-secondary" id="addCreateSpeakerBtn" data-i18n="speakers.add">Add
                    Speaker</button>
                </fieldset>
              </div>
              <div id="slotConflicts" class="slot-conflicts col-span-2" style="margin-top: 1rem;"></div>
            </div>

            <div class="col-span-2">
              <button class="btn-primary" type="submit" data-i18n="event.create">Create Event</button>
            </div>
          </form>
        </div>

        <!-- Right Side: Interactive Calendar -->
        <div class="admin-side">
          <h2 data-i18n="calendar.title">Event Calendar</h2>
          <div class="calendar-tools">
            <div class="tool">
              <span>#</span>
              <input id="tagFilterInput" data-i18n-placeholder="tags.filter"
                placeholder="Filter by tags (comma separated)" />
            </div>
            <span class="hint" style="opacity: 0.7;">Filter calendar events by tag</span>
          </div>
          <div id="calendar"></div>
        </div>
      </div>
    </section>

    <div id="accessDenied" class="card" style="display: none; text-align: center;">
      <h2>Access Denied</h2>
      <p>You must be an organizer to view this page. Please sign in with an authorized account.</p>
      <a href="index.html" class="btn-secondary">Back to Schedule</a>
    </div>
  </main>

  <!-- Modal for Editing Events -->
  <dialog id="edit-event-modal">
    <div class="modal-header">
      <h2 data-i18n="event.edit_title">Edit Event</h2>
      <button id="close-modal-btn" class="btn-ghost" style="padding: 4px 8px;" aria-label="Close">✕</button>
    </div>
    <form id="editEventForm" class="grid-form">
      <input type="hidden" id="editEventId">
      <div><label data-i18n="event.title_en">Title (EN)</label><input id="editTitleEn" required /></div>
      <div><label data-i18n="event.title_es">Title (ES)</label><input id="editTitleEs" /></div>
      <div class="col-span-2"><label data-i18n="event.desc_en">Description (EN)</label><textarea
          id="editDescEn"></textarea></div>
      <div class="col-span-2"><label data-i18n="event.desc_es">Description (ES)</label><textarea
          id="editDescEs"></textarea></div>
      <div><label data-i18n="event.start">Start time</label><input id="editStartTime" type="datetime-local" required />
      </div>
      <div><label data-i18n="event.end">End time</label><input id="editEndTime" type="datetime-local" /></div>
      <div><label data-i18n="event.lang">Language</label>
        <select id="editEventLang">
          <option value="bi">Bilingual</option>
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </div>
      <div><label data-i18n="event.host">Host org</label><input id="editHostOrg" /></div>
      <div class="col-span-2"><label data-i18n="event.zoom">Zoom URL (members only)</label><input id="editZoomUrl"
          type="url" /></div>

      <!-- Tags Section (Edit) -->
      <div class="tags-field col-span-2">
        <label data-i18n="tags.label">Tags (optional)</label>
        <div class="tags-input" id="editTagsInput" role="group" aria-label="Edit tags input">
          <div class="chips-wrap"></div>
          <input id="editTagsField" data-i18n-placeholder="tags.placeholder"
            placeholder="earth science, agriculture, environment" />
        </div>
        <p class="muted" data-i18n="tags.hint">Press Enter or comma to add. Not mandatory.</p>
      </div>

      <!-- Speakers Section for Edit Modal -->
      <fieldset class="speakers-fieldset col-span-2">
        <legend data-i18n="speakers.title">Speakers</legend>
        <div id="editSpeakersContainer"></div>
        <button type="button" class="btn-secondary" id="addEditSpeakerBtn" data-i18n="speakers.add">Add Speaker</button>
      </fieldset>

      <div id="editConflicts" class="slot-conflicts col-span-2" style="margin-top: 0.5rem;"></div>
      <div class="col-span-2"
        style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <button class="btn-primary" type="submit" data-i18n="save">Save Changes</button>
        <button id="btnDeleteEvent" class="btn-danger" type="button" data-i18n="event.delete">Delete</button>
      </div>
    </form>
  </dialog>

  <!-- JS Logic -->
  <script type="module">
    // Import all shared logic from the central auth.js file
    import { 
      supabase,
      initAuth,
      initSharedUI,
      renderHeader // Import the centralized renderHeader
    } from './auth.js';

    let calendar = null;

    const state = {
      language: localStorage.getItem("lang") || "en",
      events: [],
      profiles: [],
      tagFilter: [], // for calendar filtering
    };

    // Basic i18n
    const t = {
      en: {
        tagline: "An informal seminar series to share advances in agrivoltaics in Latin America",
        nav: { schedule: "Schedule", about: "About", admin: "Admin", archive: "Archive" },
        auth: { signin: "Sign in", signout: "Sign out" },
        admin: { title: "Organizer Tools" },
        calendar: { title: "Event Calendar" },
        event: {
          title_en: "Title (EN)", title_es: "Title (ES)", desc_en: "Description (EN)", desc_es: "Description (ES)",
          start: "Start time", end: "End time", host: "Host org", zoom: "Zoom URL (members only)", lang: "Language",
          create: "Create Event", edit_title: "Edit Event", delete: "Delete"
        },
        speakers: {
          title: "Speakers", add: "Add Speaker", name: "Name*", affiliation: "Affiliation",
          link_profile: "Link Profile", primary: "Primary", remove: "Remove"
        },
        tags: {
          label: "Tags (optional)",
          placeholder: "earth science, agriculture, environment",
          hint: "Press Enter or comma to add. Not mandatory.",
          filter: "Filter by tags (comma separated)"
        },
        slots: { blocked: "Blocked/conflicting times" },
        save: "Save Changes",
        errors: {
          overlap: "Selected time overlaps an existing event.",
          create_event: "Could not create event",
          update_event: "Could not update event",
          delete_event: "Could not delete event",
          load_profiles: "Could not load user profiles"
        },
      },
      es: {
        tagline: "Serie de seminarios informales para compartir avances en agrofotovoltaica en América Latina",
        nav: { schedule: "Calendario", about: "Acerca de", admin: "Admin", archive: "Archivo" },
        auth: { signin: "Iniciar sesión", signout: "Cerrar sesión" },
        admin: { title: "Herramientas para organizadores" },
        calendar: { title: "Calendario de Eventos" },
        event: {
          title_en: "Título (EN)", title_es: "Título (ES)", desc_en: "Descripción (EN)", desc_es: "Descripción (ES)",
          start: "Inicio", end: "Fin", host: "Institución anfitriona", zoom: "Enlace de Zoom (solo miembros)",
          lang: "Idioma", create: "Crear evento", edit_title: "Editar Evento", delete: "Eliminar"
        },
        speakers: {
          title: "Ponentes", add: "Añadir Ponente", name: "Nombre*", affiliation: "Afiliación",
          link_profile: "Vincular Perfil", primary: "Principal", remove: "Quitar"
        },
        tags: {
          label: "Etiquetas (opcional)",
          placeholder: "ciencias de la tierra, agricultura, medio ambiente",
          hint: "Presiona Enter o coma para añadir. No es obligatorio.",
          filter: "Filtrar por etiquetas (separadas por comas)"
        },
        slots: { blocked: "Horarios bloqueados/en conflicto" },
        save: "Guardar Cambios",
        errors: {
          overlap: "El horario seleccionado se cruza con otro evento.",
          create_event: "No se pudo crear el evento",
          update_event: "No se pudo actualizar el evento",
          delete_event: "No se pudo eliminar el evento",
          load_profiles: "No se pudieron cargar los perfiles de usuario"
        },
      },
    };

    /* ============== Utility Helpers ============== */
    const $ = (sel) => document.querySelector(sel);
    const tr = (key, fallback = "") => { const parts = key.split("."); let obj = t[state.language]; for (const p of parts) obj = obj?.[p]; return obj ?? fallback; };
    const setFlash = (msg, isError = false) => {
      const el = $("#flash"); if (!el) return;
      el.textContent = msg;
      el.style.backgroundColor = isError ? 'var(--color-danger)' : '';
      el.style.color = isError ? 'white' : '';
      el.style.display = "block";
      clearTimeout(setFlash._t);
      setFlash._t = setTimeout(() => { el.style.display = "none"; el.style.backgroundColor = ''; el.style.color = ''; }, 4000);
    };
    const toIsoOrNull = (v) => { if (!v) return null; const d = new Date(v); return isNaN(d.getTime()) ? null : d.toISOString(); };
    const toLocalInputValue = (d) => { if (!d) return ""; d = new Date(d); const p = (n) => String(n).padStart(2, "0"); return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; };
    const overlaps = (aStart, aEnd, bStart, bEnd) => {
      if (!aStart || !bStart) return false;
      const aS = new Date(aStart).getTime();
      const aE = aEnd ? new Date(aEnd).getTime() : aS + 3600000;
      const bS = new Date(bStart).getTime();
      const bE = bEnd ? new Date(bEnd).getTime() : bS + 3600000;
      return Math.max(aS, bS) < Math.min(aE, bE);
    };
    const findConflicts = (startIso, endIso, excludeId = null) => {
      if (!startIso) return [];
      return state.events.filter(ev => {
        if (ev.status === 'canceled') return false;
        if (excludeId != null && String(ev.id) === String(excludeId)) return false;
        return overlaps(startIso, endIso, ev.start_time, ev.end_time);
      });
    };
    const escapeHtml = (s) => (s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');

    /* --- Tag helpers --- */
    const normalizeTags = (arr) => {
      const out = [];
      const seen = new Set();
      (arr || []).forEach(t => {
        const v = String(t || '').trim().toLowerCase();
        if (v && !seen.has(v)) { seen.add(v); out.push(v); }
      });
      return out;
    };
    const splitTokens = (s) => String(s || '').split(/[,\n]/g).map(t => t.trim()).filter(Boolean);

    const applyI18n = () => {
      document.querySelectorAll("[data-i18n]").forEach(e => e.textContent = tr(e.dataset.i18n, e.textContent));
      document.querySelectorAll("[data-i18n-placeholder]").forEach(e => e.placeholder = tr(e.dataset.i18nPlaceholder, e.placeholder));
      document.querySelectorAll(".lang-switch-slider").forEach(el => el.dataset.lang = state.language);
      if (calendar) calendar.setOption('locale', state.language === 'es' ? 'es' : 'en');
    };
    
    const handleLangSwitch = () => {
        state.language = state.language === "en" ? "es" : "en";
        localStorage.setItem("lang", state.language);
        applyI18n();
        if (calendar) calendar.render();
    };

    const checkAccess = async (authState) => {
      const isAllowed = ["organizer", "admin"].includes(authState.profile?.role);
      if (isAllowed) {
        $("#admin").style.display = 'flex';
        $("#accessDenied").style.display = 'none';
        await loadProfiles();
        if (!calendar) initializeCalendar();
        await loadEvents();
      } else {
        $("#admin").style.display = 'none';
        $("#accessDenied").style.display = 'block';
      }
    };

    /* ============= Speakers & Profiles ============= */
    const loadProfiles = async () => {
      const { data, error } = await supabase.from('profiles').select('id, full_name, affiliation').order('full_name');
      if (error) {
        setFlash(tr('errors.load_profiles'), true);
        state.profiles = [];
      } else {
        state.profiles = data || [];
      }
    };

    const createProfileOptions = (selectedId) => {
      return `
        <option value="">--</option>
        ${state.profiles.map(p => `<option value="${p.id}" ${p.id === selectedId ? 'selected' : ''}>${escapeHtml(p.full_name || '')}</option>`).join('')}
      `;
    };

    const renderSpeakerFields = (containerId, speakers = []) => {
      const container = $(`#${containerId}`);
      container.innerHTML = '';
      if (speakers.length === 0) {
        addSpeakerField(containerId); // Add one empty field by default
      } else {
        speakers.forEach(speaker => addSpeakerField(containerId, speaker));
      }
    };

    const addSpeakerField = (containerId, speaker = {}) => {
      const container = $(`#${containerId}`);
      const speakerRow = document.createElement('div');
      speakerRow.className = 'speaker-row';
      speakerRow.innerHTML = `
        <div><label>${tr('speakers.name')}</label><input type="text" class="speaker-name" value="${escapeHtml(speaker.name || '')}" required></div>
        <div><label>${tr('speakers.affiliation')}</label><input type="text" class="speaker-affiliation" value="${escapeHtml(speaker.affiliation || '')}"></div>
        <div><label>${tr('speakers.link_profile')}</label><select class="speaker-profile">${createProfileOptions(speaker.profile_id)}</select></div>
        <div style="display: flex; gap: 1rem; align-items: flex-end;">
          <div class="checkbox-field">
              <label>${tr('speakers.primary')}</label>
              <input type="checkbox" class="speaker-primary" ${speaker.primary_speaker ? 'checked' : ''}>
          </div>
          <button type="button" class="btn-danger-ghost remove-speaker-btn" title="${tr('speakers.remove')}">✕</button>
        </div>
      `;
      container.appendChild(speakerRow);
    };

    /* ============= Tags Input Component ============= */
    const getTags = (containerId) => {
      const el = document.getElementById(containerId);
      try { const arr = JSON.parse(el?.dataset.tags || '[]'); return Array.isArray(arr) ? arr : []; }
      catch { return []; }
    };
    const setTags = (containerId, arr) => {
      const el = document.getElementById(containerId);
      if (!el) return;
      const tags = normalizeTags(arr);
      el.dataset.tags = JSON.stringify(tags);
      const wrap = el.querySelector('.chips-wrap');
      if (wrap) {
        wrap.innerHTML = tags.map((t, i) => `
          <span class="tag-chip" title="${escapeHtml(t)}">
            <span>#${escapeHtml(t)}</span>
            <button type="button" class="chip-remove" data-index="${i}" aria-label="Remove ${escapeHtml(t)}">×</button>
          </span>
        `).join('');
      }
    };
    const addTags = (containerId, newOnes) => setTags(containerId, [...getTags(containerId), ...normalizeTags(newOnes)]);
    const removeTagAt = (containerId, idx) => {
      const arr = getTags(containerId);
      arr.splice(idx, 1);
      setTags(containerId, arr);
    };
    const initTagsInput = (containerId, fieldId, initial = []) => {
      const inputEl = document.getElementById(fieldId);
      setTags(containerId, initial);
      const addFromInput = () => {
        const val = inputEl.value;
        const tokens = splitTokens(val);
        if (tokens.length) addTags(containerId, tokens);
        inputEl.value = '';
      };
      inputEl.onkeydown = (e) => {
        if (e.key === 'Enter' || e.key === ',' || e.key === 'Tab') {
          e.preventDefault(); addFromInput();
        } else if (e.key === 'Backspace' && !inputEl.value) {
          const arr = getTags(containerId);
          if (arr.length) { arr.pop(); setTags(containerId, arr); }
        }
      };
      inputEl.onpaste = (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        addTags(containerId, splitTokens(text));
      };
      const container = document.getElementById(containerId);
      container.addEventListener('click', (e) => {
        const btn = e.target.closest('.chip-remove');
        if (btn) { removeTagAt(containerId, parseInt(btn.dataset.index, 10)); }
      });
    };

    /* ============= Events: Load / Map ============= */
    const languageColors = { en: '#3a86ff', es: '#ffbe0b', bi: 'var(--brand-2)' };

    const passesTagFilter = (ev) => {
      if (!state.tagFilter.length) return true;
      const tags = normalizeTags(ev.topic_tags || []);
      return state.tagFilter.every(t => tags.includes(t));
    };

    const loadEvents = async () => {
      const { data, error } = await supabase.from("events").select("*").order("start_time");
      if (error) { console.error(error); return; }
      state.events = data || [];
      if (calendar) calendar.refetchEvents();
    };

    const formatEventsForCalendar = () =>
      state.events
        .filter(passesTagFilter)
        .map(ev => {
          const eventColor = ev.status === 'canceled' ? '#555' : (languageColors[ev.language] || languageColors.bi);
          return {
            id: ev.id,
            title: state.language === 'es' ? (ev.title_es || ev.title_en) : (ev.title_en || ev.title_es),
            start: ev.start_time,
            end: ev.end_time,
            backgroundColor: eventColor,
            borderColor: eventColor,
            textColor: ev.language === 'es' || ev.language === 'bi' ? '#000' : '#fff',
            extendedProps: ev
          }
        });

    /* ============= Calendar ============= */
    const handleEventClick = async ({ event }) => {
      const ev = event.extendedProps;
      $("#editEventId").value = String(ev.id);
      $("#editTitleEn").value = ev.title_en || "";
      $("#editTitleEs").value = ev.title_es || "";
      $("#editDescEn").value = ev.description_en || "";
      $("#editDescEs").value = ev.description_es || "";
      $("#editStartTime").value = toLocalInputValue(ev.start_time);
      $("#editEndTime").value = toLocalInputValue(ev.end_time);
      $("#editEventLang").value = ev.language || "bi";
      $("#editHostOrg").value = ev.host_org || "";
      $("#editZoomUrl").value = ev.zoom_url || "";
      $("#editConflicts").innerHTML = '';

      const { data: speakers } = await supabase.from('event_speakers').select('*').eq('event_id', ev.id);
      renderSpeakerFields('editSpeakersContainer', speakers || []);

      initTagsInput('editTagsInput', 'editTagsField', ev.topic_tags || []);

      $("#edit-event-modal").showModal();
    };

    const handleTimeSelect = ({ start, end }) => {
      $("#startTime").value = toLocalInputValue(start);
      $('#startTime').type = 'datetime-local';
      $("#endTime").value = toLocalInputValue(end);
      $('#endTime').type = 'datetime-local';
      calendar.unselect();
      checkCreateFormConflicts();
      $("#titleEn").focus();
    };

    const handleDateClick = (info) => {
      let start = new Date(info.date);
      if (info.allDay) start.setHours(12, 0, 0, 0);
      const end = new Date(start.getTime() + 60 * 60 * 1000);
      $("#startTime").value = toLocalInputValue(start);
      $("#endTime").value = toLocalInputValue(end);
      $('#startTime').type = 'datetime-local';
      $('#endTime').type = 'datetime-local';
      checkCreateFormConflicts();
      $("#titleEn").focus();
    };

    const handleEventMove = async ({ event, revert }) => {
      const conflicts = findConflicts(event.start.toISOString(), event.end?.toISOString(), event.id);
      if (conflicts.length > 0) { setFlash(tr('errors.overlap'), true); revert(); return; }
      if (!confirm(`Are you sure you want to move "${event.title}"?`)) { revert(); return; }
      const { error } = await supabase.from("events")
        .update({ start_time: event.start.toISOString(), end_time: event.end ? event.end.toISOString() : null })
        .eq("id", event.id);
      if (error) { setFlash(tr('errors.update_event'), true); revert(); }
      else { setFlash("Event time updated!"); await loadEvents(); }
    };

    const initializeCalendar = () => {
      const mountEl = $('#calendar');
      if (!mountEl || !window.FullCalendar) return;
      calendar = new FullCalendar.Calendar(mountEl, {
        initialView: 'timeGridWeek',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
        editable: true, selectable: true, selectMirror: true,
        slotMinTime: '08:00:00', slotMaxTime: '20:00:00', height: '100%',
        eventClick: handleEventClick, select: handleTimeSelect, dateClick: handleDateClick,
        eventDrop: handleEventMove, eventResize: handleEventMove,
        events: (_fetchInfo, success, _failure) => success(formatEventsForCalendar()),
        eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },
        locale: state.language === 'es' ? 'es' : 'en'
      });
      calendar.render();
    };

    /* ============= Create / Update / Delete ============= */
    const checkCreateFormConflicts = () => {
      const startIso = toIsoOrNull($("#startTime").value); const endIso = toIsoOrNull($("#endTime").value);
      const conflicts = findConflicts(startIso, endIso, null);
      $("#slotConflicts").innerHTML = conflicts.length ? conflicts.map(ev => `<div class="conflict-row">⚠️ ${new Date(ev.start_time).toLocaleString()} — ${(ev.title_en || ev.title_es || '').replace(/</g, '&lt;')}</div>`).join("") : '';
      return conflicts.length > 0;
    };
    const checkEditFormConflicts = () => {
      const id = $("#editEventId").value; const startIso = toIsoOrNull($("#editStartTime").value); const endIso = toIsoOrNull($("#editEndTime").value);
      const conflicts = findConflicts(startIso, endIso, id);
      $("#editConflicts").innerHTML = conflicts.length ? conflicts.map(ev => `<div class="conflict-row">⚠️ ${new Date(ev.start_time).toLocaleString()} — ${(ev.title_en || ev.title_es || '').replace(/</g, '&lt;')}</div>`).join("") : '';
      return conflicts.length > 0;
    };

    const getSpeakersFromForm = (containerId) => {
      const container = document.getElementById(containerId);
      return Array.from(container.querySelectorAll('.speaker-row')).map(row => {
        return {
          name: row.querySelector('.speaker-name').value.trim(),
          affiliation: row.querySelector('.speaker-affiliation').value.trim() || null,
          profile_id: row.querySelector('.speaker-profile').value || null,
          primary_speaker: row.querySelector('.speaker-primary').checked,
        };
      }).filter(s => s.name);
    };

    const createEvent = async (payload) => {
      if (!payload.title_en || !payload.start_time) { setFlash("Title (EN) and Start Time are required.", true); return; }
      if (checkCreateFormConflicts()) { setFlash(tr('errors.overlap'), true); return; }

      const { data: eventData, error: eventError } = await supabase.from("events").insert([{
        ...payload, status: "scheduled" // created_by is now handled by RLS policy
      }]).select().single();

      if (eventError) { setFlash(tr("errors.create_event"), true); console.error(eventError); return; }

      const speakers = getSpeakersFromForm('createSpeakersContainer');
      if (speakers.length > 0) {
        const speakersPayload = speakers.map(s => ({ ...s, event_id: eventData.id }));
        const { error: speakerError } = await supabase.from('event_speakers').insert(speakersPayload);
        if (speakerError) { setFlash('Event created, but failed to add speakers.', true); console.error(speakerError); }
      }

      setFlash("Event created successfully!");
      $("#createEventForm").reset();
      $('#startTime').type = 'text'; $('#endTime').type = 'text';
      $("#slotConflicts").innerHTML = '';
      renderSpeakerFields('createSpeakersContainer');
      initTagsInput('createTagsInput', 'createTagsField', []);
      await loadEvents();
    };

    const updateEvent = async (id, payload) => {
      const { error } = await supabase.from("events").update(payload).eq("id", id);
      if (error) { setFlash(tr('errors.update_event'), true); console.error(error); return; }

      const { error: deleteError } = await supabase.from('event_speakers').delete().eq('event_id', id);
      if (deleteError) { setFlash('Event updated, but failed to update speakers (delete step).', true); console.error(deleteError); }

      const speakers = getSpeakersFromForm('editSpeakersContainer');
      if (speakers.length > 0) {
        const speakersPayload = speakers.map(s => ({ ...s, event_id: id }));
        const { error: insertError } = await supabase.from('event_speakers').insert(speakersPayload);
        if (insertError) { setFlash('Event updated, but failed to update speakers (insert step).', true); console.error(insertError); }
      }

      setFlash("Event details saved!");
      await loadEvents();
      $("#edit-event-modal").close();
    };

    const deleteEvent = async (id) => {
      if (!confirm("Are you sure you want to permanently delete this event and all related data (speakers, RSVPs, discussions etc.)? This action cannot be undone.")) return;
      try {
        await supabase.rpc('delete_event_and_dependencies', { event_id_to_delete: id });
        setFlash("Event deleted.");
        await loadEvents();
        $("#edit-event-modal").close();
      } catch (error) {
        setFlash(tr('errors.delete_event') + ' (Check console for details)', true);
        console.error("Failed to delete event and its dependencies:", error);
      }
    };

    /* ============= Wire UI ============= */
    const wireUI = () => {
      const setupDateTimePlaceholders = (startEl, endEl) => {
        const handleFocus = (el) => { el.type = 'datetime-local'; };
        const handleBlur = (el) => { if (!el.value) el.type = 'text'; };
        startEl.addEventListener('focus', () => handleFocus(startEl)); startEl.addEventListener('blur', () => handleBlur(startEl)); if (!startEl.value) startEl.type = 'text';
        if (endEl) { endEl.addEventListener('focus', () => handleFocus(endEl)); endEl.addEventListener('blur', () => handleBlur(endEl)); if (!endEl.value) endEl.type = 'text'; }
      };
      setupDateTimePlaceholders($('#startTime'), $('#endTime'));

      $("#createEventForm")?.addEventListener("input", checkCreateFormConflicts);
      $("#createEventForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        await createEvent({
          title_en: $("#titleEn")?.value.trim(), title_es: $("#titleEs")?.value.trim() || null,
          description_en: $("#descEn")?.value.trim() || null, description_es: $("#descEs")?.value.trim() || null,
          start_time: toIsoOrNull($("#startTime")?.value), end_time: toIsoOrNull($("#endTime")?.value),
          language: $("#eventLang")?.value || "bi", host_org: $("#hostOrg")?.value.trim() || null,
          zoom_url: $("#zoomUrl")?.value.trim() || null,
          topic_tags: getTags('createTagsInput'),
        });
      });

      $("#tagFilterInput")?.addEventListener('keyup', (e) => {
        const val = e.target.value || '';
        state.tagFilter = normalizeTags(splitTokens(val));
        if (calendar) calendar.refetchEvents();
      });

      $("#close-modal-btn")?.addEventListener("click", () => { $("#edit-event-modal").close(); });
      $("#editStartTime")?.addEventListener("input", checkEditFormConflicts);
      $("#editEndTime")?.addEventListener("input", checkEditFormConflicts);
      $("#editEventForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = $("#editEventId").value;
        const start_time = toIsoOrNull($("#editStartTime").value);
        const end_time = toIsoOrNull($("#editEndTime").value);
        if (findConflicts(start_time, end_time, id).length > 0) { setFlash(tr('errors.overlap'), true); return; }
        await updateEvent(id, {
          title_en: $("#editTitleEn").value?.trim(), title_es: $("#editTitleEs").value?.trim() || null,
          description_en: $("#editDescEn").value?.trim() || null, description_es: $("#editDescEs").value?.trim() || null,
          language: $("#editEventLang").value, host_org: $("#editHostOrg").value?.trim() || null,
          zoom_url: $("#editZoomUrl").value?.trim() || null, start_time, end_time,
          topic_tags: getTags('editTagsInput'),
        });
      });
      $("#btnDeleteEvent")?.addEventListener("click", () => deleteEvent($("#editEventId").value));

      $('#addCreateSpeakerBtn')?.addEventListener('click', () => { addSpeakerField('createSpeakersContainer'); });
      $('#addEditSpeakerBtn')?.addEventListener('click', () => { addSpeakerField('editSpeakersContainer'); });
      document.body.addEventListener('click', e => {
        if (e.target.classList.contains('remove-speaker-btn')) {
          e.target.closest('.speaker-row').remove();
        }
      });

      initTagsInput('createTagsInput', 'createTagsField', []);
    };

    /* ============= Bootstrap ============= */
    (async function main() {
      applyI18n();
      
      // Initialize all shared UI elements (mobile menu, buttons, footer)
      initSharedUI({ applyI18n, handleLangSwitch });
      
      // Initialize authentication, which will handle access checks and render the header
      await initAuth({
        onAuthReady: (authState) => checkAccess(authState),
        onAuthChange: (authState) => checkAccess(authState)
      });
      
      // Wire up page-specific UI listeners after auth has run
      wireUI();
      
      renderSpeakerFields('createSpeakersContainer'); // Init with one field
    })();
  </script>
</body>

</html>