<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50 antialiased">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Admin • Agrovoltaicos sin Fronteras</title>
  <meta name="description" content="Organizer tools for managing the Agrovoltaicos sin Fronteras seminar series.">

  <!-- Critical pre-render script -->
  <script src="auth-preloader.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&family=Poppins:wght@600;700;800&display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Global Styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- FullCalendar -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales-all.global.min.js"></script>

  <!-- Quill.js (Rich Text Editor) v2.0 -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

  <!-- External Tailwind Config -->
  <script src="theme.js"></script>

  <!-- Custom Admin & Calendar Overrides -->
  <style type="text/tailwindcss">
    @layer utilities {
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
      .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; border: 2px solid transparent; background-clip: content-box; }
    }

    html, body { height: 100%; overflow: hidden; }
    
    /* Input Field matching styles.css via Tailwind layer for Admin Form ease */
    .input-field {
        @apply w-full px-4 py-2.5 bg-[var(--bg-input)] border border-transparent rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--color-brand-light)] focus:border-[var(--color-brand)] transition-all text-sm text-slate-800 placeholder:text-slate-400 shadow-inner;
    }
    .input-field:hover {
        @apply bg-white shadow-sm;
    }
    .label-text {
        @apply block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5;
    }

    /* FullCalendar Theme Overrides */
    :root {
        --fc-bg-color: transparent;
        --fc-border-color: #e2e8f0;
        --fc-text-color: #334155;
        --fc-neutral-bg-color: #f8fafc;
        --fc-today-bg-color: var(--color-brand-light);
        --fc-event-bg-color: var(--color-brand);
        --fc-event-border-color: var(--color-brand);
        --fc-event-text-color: #ffffff;
        --fc-button-bg-color: #ffffff;
        --fc-button-border-color: #e2e8f0;
        --fc-button-text-color: #64748b;
        --fc-button-active-bg-color: var(--color-brand);
        --fc-button-active-border-color: var(--color-brand);
        --fc-button-active-text-color: #fff;
        --fc-button-hover-bg-color: #f1f5f9;
    }
    .fc { font-family: 'Inter', sans-serif; font-size: 0.85rem; }
    .fc .fc-toolbar-title { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.25rem; color: var(--color-brand-dark); }
    .fc .fc-button { border-radius: 0.75rem; font-weight: 600; text-transform: capitalize; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
    .fc-col-header-cell-cushion, .fc-daygrid-day-number { color: #64748b !important; font-weight: 600; text-decoration: none !important; }

    /* Modal Styles */
    dialog::backdrop { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); }
    dialog[open] { animation: modal-pop 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes modal-pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    /* Quill Editor Customization to match Input Fields */
    .editor-wrapper {
      @apply w-full bg-[var(--bg-input)] border border-transparent rounded-xl transition-all shadow-inner overflow-hidden;
    }
    .editor-wrapper:hover {
      @apply bg-white shadow-sm;
    }
    .editor-wrapper:focus-within {
      @apply ring-2 ring-[var(--color-brand-light)] border-[var(--color-brand)] bg-white;
    }
    
    .ql-toolbar.ql-snow {
      border: none !important;
      border-bottom: 1px solid rgba(0,0,0,0.05) !important;
      background: rgba(255,255,255,0.5);
      padding: 6px 8px !important;
    }
    .ql-container.ql-snow {
      border: none !important;
      font-family: 'Inter', sans-serif !important;
      font-size: 0.875rem !important; /* text-sm */
    }
    .ql-editor {
      min-height: 100px;
      padding: 12px 16px !important;
      color: #1e293b;
    }
    .ql-editor.ql-blank::before {
      color: #94a3b8 !important; /* placeholder color */
      font-style: normal !important;
    }
    /* Toolbar button adjustments */
    .ql-snow .ql-stroke { stroke: #64748b !important; }
    .ql-snow .ql-fill { fill: #64748b !important; }
    .ql-snow .ql-picker { color: #64748b !important; }
  </style>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body
  class="text-slate-800 flex flex-col h-full overflow-hidden selection:bg-brand-100 selection:text-brand-900 font-sans">

  <!-- Note: Header/Footer injected by layout.js -->

  <!-- ================= MAIN CONTENT ================= -->
  <main class="flex-1 relative overflow-hidden bg-gray-50">
    <div id="flash" class="flash"></div>

    <!-- Scrollable Container -->
    <div class="absolute inset-0 overflow-y-auto custom-scrollbar">
      <div class="max-w-[1800px] mx-auto px-4 sm:px-6 py-6 flex flex-col h-full min-h-full">

        <!-- Access Denied View -->
        <div id="accessDenied" class="hidden m-auto max-w-md w-full">
          <div class="bg-white/80 backdrop-blur-md rounded-2xl p-8 text-center border border-gray-200 shadow-xl">
            <div
              class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-100">
              <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 class="font-display font-bold text-2xl text-slate-800 mb-2" data-i18n="access_denied.title">Access
              Denied</h2>
            <p class="text-slate-500 mb-6" data-i18n="access_denied.body">You must be an organizer to view this page.
            </p>
            <a href="index.html"
              class="inline-flex items-center justify-center px-6 py-2.5 border border-transparent text-sm font-bold rounded-xl text-brand-700 bg-brand-50 hover:bg-brand-100 transition-all">
              <span data-i18n="back.general">Go Back</span>
            </a>
          </div>
        </div>

        <!-- Dashboard Grid -->
        <div id="admin" class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full pb-6 hidden">

          <!-- LEFT PANEL: TOOLS & FORM -->
          <div class="lg:col-span-4 xl:col-span-3 flex flex-col gap-6 overflow-hidden h-full">
            <div
              class="bg-white/90 backdrop-blur-sm rounded-[1.5rem] border border-gray-200 shadow-sm flex flex-col overflow-hidden h-full">
              <div class="p-5 border-b border-gray-100 bg-white/50 sticky top-0 z-10">
                <h2 class="font-display font-bold text-xl text-slate-800 flex items-center gap-2">
                  <i data-lucide="settings-2" class="w-5 h-5 text-brand-600"></i>
                  <span data-i18n="admin.title">Organizer Tools</span>
                </h2>
              </div>

              <div class="overflow-y-auto custom-scrollbar p-5 flex-1">
                <form id="createEventForm" class="space-y-6">
                  <!-- Banner Management Card -->
                  <div class="bg-brand-50/50 border border-brand-100 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                      <div class="flex items-center gap-2 text-brand-800 font-bold text-xs uppercase tracking-wider">
                        <i data-lucide="megaphone" class="w-3 h-3"></i> Announcement Banner
                      </div>
                      <span id="bannerStatusText"
                        class="text-[10px] font-bold px-2 py-0.5 bg-white rounded text-slate-500 border border-brand-100">Inactive</span>
                    </div>
                    <div class="space-y-3">
                      <input id="bannerTextEn" class="input-field bg-white" placeholder="Banner Text (EN)...">
                      <input id="bannerTextEs" class="input-field bg-white" placeholder="Banner Text (ES)...">
                      <div class="flex flex-wrap gap-2 items-center pt-2">
                        <button type="button" id="saveBannerBtn"
                          class="px-3 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-xs font-bold rounded-lg transition-colors shadow-sm">Save
                          & Activate</button>
                        <button type="button" id="clearBannerBtn"
                          class="px-3 py-1.5 bg-white border border-gray-200 hover:bg-gray-50 text-slate-600 text-xs font-bold rounded-lg transition-colors">Deactivate</button>
                      </div>
                    </div>
                  </div>

                  <!-- Event Fields -->
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 gap-4">
                      <div><label class="label-text" data-i18n="event.title_en">Title (EN)</label><input id="titleEn"
                          class="input-field" required /></div>
                      <div><label class="label-text" data-i18n="event.title_es">Title (ES)</label><input id="titleEs"
                          class="input-field" /></div>
                    </div>
                    
                    <!-- Description EN Editor -->
                    <div>
                      <label class="label-text" data-i18n="event.desc_en">Description (EN)</label>
                      <div class="editor-wrapper">
                        <div id="editorDescEn"></div>
                      </div>
                    </div>
                    
                    <!-- Description ES Editor -->
                    <div>
                      <label class="label-text" data-i18n="event.desc_es">Description (ES)</label>
                      <div class="editor-wrapper">
                        <div id="editorDescEs"></div>
                      </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                      <div><label class="label-text" data-i18n="event.start">Start</label><input id="startTime"
                          type="text" class="input-field" placeholder="mm/dd/yyyy --:--" required /></div>
                      <div><label class="label-text" data-i18n="event.end">End</label><input id="endTime" type="text"
                          class="input-field" placeholder="mm/dd/yyyy --:--" /></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="label-text" data-i18n="event.lang">Language</label>
                        <select id="eventLang" class="input-field cursor-pointer">
                          <option value="bi">Bilingual</option>
                          <option value="en">English</option>
                          <option value="es">Español</option>
                        </select>
                      </div>
                      <div><label class="label-text" data-i18n="event.host">Host Org</label><input id="hostOrg"
                          class="input-field" placeholder="e.g. UNAM" /></div>
                    </div>

                    <div class="space-y-3">
                      <div><label class="label-text" data-i18n="event.zoom">Zoom URL</label><input id="zoomUrl"
                          type="url" class="input-field" /></div>
                      <div><label class="label-text" data-i18n="event.recording_url">Recording URL</label><input
                          id="recordingUrl" type="url" class="input-field" /></div>
                      <div><label class="label-text" data-i18n="tags.label">Tags</label><input id="tags"
                          class="input-field" data-i18n-placeholder="tags.placeholder" /></div>
                    </div>

                    <!-- Speakers Section -->
                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                      <div class="flex justify-between items-center mb-3">
                        <label class="label-text mb-0" data-i18n="speakers.title">Speakers</label>
                        <button type="button" id="addSpeakerBtn"
                          class="text-xs font-bold text-brand-600 hover:text-brand-700 hover:bg-brand-50 px-2 py-1 rounded transition-colors"
                          data-i18n="speakers.add">+ Add</button>
                      </div>
                      <div id="speakersContainer" class="space-y-3"></div>
                    </div>

                    <div id="slotConflicts" class="text-xs text-orange-600 font-medium space-y-1"></div>
                  </div>
                </form>
              </div>
              <div class="p-4 border-t border-gray-100 bg-gray-50">
                <button type="submit" form="createEventForm"
                  class="w-full py-3 px-4 bg-brand-600 hover:bg-brand-700 text-white text-sm font-bold rounded-xl shadow-lg shadow-brand-500/20 hover:shadow-xl hover:shadow-brand-500/30 transition-all flex justify-center items-center gap-2"
                  data-i18n="event.create">
                  <i data-lucide="plus-circle" class="w-4 h-4"></i> Create Event
                </button>
              </div>
            </div>
          </div>

          <!-- RIGHT PANEL: CALENDAR -->
          <div class="lg:col-span-8 xl:col-span-9 h-full">
            <div
              class="bg-white/90 backdrop-blur-sm rounded-[1.5rem] border border-gray-200 shadow-sm h-full flex flex-col overflow-hidden">
              <div
                class="p-4 border-b border-gray-100 flex items-center justify-between gap-4 bg-white/50 sticky top-0 z-10">
                <h2 class="font-display font-bold text-xl text-slate-800" data-i18n="calendar.title">Event Calendar</h2>
                <div class="relative w-64">
                  <i data-lucide="filter" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                  <input id="tagFilterInput"
                    class="w-full pl-9 pr-4 py-2 bg-[var(--bg-input)] border border-transparent hover:bg-white focus:bg-white focus:border-[var(--color-brand)] rounded-xl text-sm focus:ring-2 focus:ring-[var(--color-brand-light)] outline-none transition-all"
                    data-i18n-placeholder="tags.filter">
                </div>
              </div>
              <div class="flex-1 p-4 bg-white/50 min-h-[500px]">
                <div id="calendar" class="h-full"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </main>

  <!-- ================= EDIT MODAL ================= -->
  <dialog id="edit-event-modal"
    class="rounded-2xl p-0 bg-white shadow-2xl max-w-2xl w-full m-auto backdrop:bg-slate-900/50">
    <div class="flex flex-col h-full max-h-[90vh]">
      <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
        <h2 class="font-display font-bold text-xl text-slate-800" data-i18n="event.edit_title">Edit Event</h2>
        <button id="close-modal-btn" class="p-2 hover:bg-gray-200 rounded-full transition-colors text-slate-500"><i
            data-lucide="x" class="w-5 h-5"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
        <form id="editEventForm" class="space-y-5">
          <input type="hidden" id="editEventId">

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="label-text" data-i18n="event.title_en">Title (EN)</label><input id="editTitleEn"
                class="input-field" required /></div>
            <div><label class="label-text" data-i18n="event.title_es">Title (ES)</label><input id="editTitleEs"
                class="input-field" /></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="label-text" data-i18n="event.start">Start</label><input id="editStartTime"
                type="datetime-local" class="input-field" required /></div>
            <div><label class="label-text" data-i18n="event.end">End</label><input id="editEndTime"
                type="datetime-local" class="input-field" /></div>
          </div>

          <!-- Edit Description EN -->
          <div>
            <label class="label-text" data-i18n="event.desc_en">Description (EN)</label>
            <div class="editor-wrapper">
              <div id="editEditorDescEn"></div>
            </div>
          </div>

          <!-- Edit Description ES -->
          <div>
            <label class="label-text" data-i18n="event.desc_es">Description (ES)</label>
            <div class="editor-wrapper">
              <div id="editEditorDescEs"></div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="label-text" data-i18n="event.lang">Language</label>
              <select id="editEventLang" class="input-field">
                <option value="bi">Bilingual</option>
                <option value="en">English</option>
                <option value="es">Español</option>
              </select>
            </div>
            <div><label class="label-text" data-i18n="event.host">Host</label><input id="editHostOrg"
                class="input-field" /></div>
          </div>

          <div><label class="label-text" data-i18n="event.zoom">Zoom URL</label><input id="editZoomUrl" type="url"
              class="input-field" /></div>
          <div><label class="label-text" data-i18n="event.recording_url">Recording URL</label><input
              id="editRecordingUrl" type="url" class="input-field" /></div>
          <div><label class="label-text" data-i18n="tags.label">Tags</label><input id="editTags" class="input-field" />
          </div>

          <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
            <div class="flex justify-between items-center mb-3">
              <label class="label-text mb-0" data-i18n="speakers.title">Speakers</label>
              <button type="button" id="addEditSpeakerBtn"
                class="text-xs font-bold text-brand-600 hover:text-brand-700 hover:bg-brand-50 px-2 py-1 rounded transition-colors"
                data-i18n="speakers.add">+ Add</button>
            </div>
            <div id="editSpeakersContainer" class="space-y-3"></div>
          </div>

          <div id="editConflicts" class="text-xs text-orange-600 font-medium"></div>
        </form>
      </div>

      <div class="p-5 border-t border-gray-100 bg-gray-50 flex justify-between items-center">
        <button id="btnDeleteEvent" type="button"
          class="px-4 py-2 text-red-600 hover:bg-red-50 border border-transparent hover:border-red-100 rounded-xl font-bold text-sm transition-colors"
          data-i18n="event.delete">Delete Event</button>
        <button type="submit" form="editEventForm"
          class="px-6 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-bold text-sm shadow-sm transition-colors"
          data-i18n="save">Save Changes</button>
      </div>
    </div>
  </dialog>

  <!-- ================= DATALISTS FOR AUTOCOMPLETE ================= -->
  <datalist id="dl-profiles"></datalist>
  <datalist id="dl-affiliations"></datalist>

  <!-- ================= LOGIC ================= -->
  <script type="module">
    import { renderLayout } from './layout.js';
    import { supabase, authState, initAuth, signOut } from './auth.js';
    import { initSharedUI, renderHeader, applyI18n, tr, $, $$, show, hide, setFlash, escapeHtml, getAvatarUrl } from './ui.js';

    // Inject Layout logic (Handles Header/Footer and active states)
    renderLayout('admin');

    // --- PAGE-SPECIFIC STATE & I18N ---
    const state = {
      language: localStorage.getItem("lang") || "en",
      events: [],
      profiles: [],
      tagFilter: [],
      calendar: null,
      quillEditors: {} // Store quill instances
    };

    // Merged Translation Object (Admin Specific)
    const t = {
      en: {
        nav: { schedule: "Schedule", archive: "Archive", about: "About", network: "Network", map: "Map", admin: "Admin" },
        auth: { signin: "Sign in", signout: "Sign out" },
        footer: { note: "Bilingual, community-driven seminar on agrivoltaics in the Americas." },
        admin: { title: "Organizer Tools" },
        calendar: { title: "Event Calendar" },
        event: {
          title_en: "Title (EN)", title_es: "Title (ES)", desc_en: "Description (EN)", desc_es: "Description (ES)",
          start: "Start time", end: "End time", host: "Host org", zoom: "Zoom URL (members only)",
          lang: "Language", recording_url: "Recording URL", create: "Create Event",
          edit_title: "Edit Event", delete: "Delete"
        },
        speakers: { title: "Speakers", add: "+ Add Speaker", name: "Name*", affiliation: "Affiliation", link_profile: "Link Profile (Search)", primary: "Primary", remove: "Remove" },
        tags: { label: "Tags", placeholder: "earth science, agriculture...", filter: "Filter by tags..." },
        save: "Save Changes",
        access_denied: { title: "Access Denied", body: "You must be an organizer to view this page." },
        back: { general: "Go Back" },
        errors: {
          overlap: "Selected time overlaps an existing event.",
          create_event: "Could not create event",
          update_event: "Could not update event",
          delete_event: "Could not delete event",
          load_profiles: "Could not load user profiles"
        }
      },
      es: {
        nav: { schedule: "Programa", archive: "Archivo", about: "Acerca de", network: "Red", map: "Mapa", admin: "Admin" },
        auth: { signin: "Ingresar", signout: "Salir" },
        footer: { note: "Seminario bilingüe impulsado por la comunidad sobre agrovoltaica en las Américas." },
        admin: { title: "Herramientas de Organizador" },
        calendar: { title: "Calendario de Eventos" },
        event: {
          title_en: "Título (EN)", title_es: "Título (ES)", desc_en: "Descripción (EN)", desc_es: "Descripción (ES)",
          start: "Inicio", end: "Fin", host: "Institución anfitriona", zoom: "Zoom (solo miembros)",
          lang: "Idioma", recording_url: "URL de grabación", create: "Crear evento",
          edit_title: "Editar Evento", delete: "Eliminar"
        },
        speakers: { title: "Ponentes", add: "+ Añadir Ponente", name: "Nombre*", affiliation: "Afiliación", link_profile: "Vincular Perfil (Buscar)", primary: "Principal", remove: "Quitar" },
        tags: { label: "Etiquetas", placeholder: "ciencias, agricultura...", filter: "Filtrar etiquetas..." },
        save: "Guardar Cambios",
        access_denied: { title: "Acceso Denegado", body: "Debe ser un organizador para ver esta página." },
        back: { general: "Regresar" },
        errors: {
          overlap: "El horario se cruza con otro evento.",
          create_event: "No se pudo crear el evento",
          update_event: "No se pudo actualizar el evento",
          delete_event: "No se pudo eliminar el evento",
          load_profiles: "Error cargando perfiles"
        }
      }
    };

    // --- FUNCTIONS ---
    const toIsoOrNull = (v) => { if (!v) return null; const d = new Date(v); return isNaN(d.getTime()) ? null : d.toISOString(); };
    const toLocalInputValue = (d) => { if (!d) return ""; d = new Date(d); const p = (n) => String(n).padStart(2, "0"); return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; };
    const overlaps = (aStart, aEnd, bStart, bEnd) => { if (!aStart || !bStart) return false; const aS = new Date(aStart).getTime(); const aE = aEnd ? new Date(aEnd).getTime() : aS + 3600000; const bS = new Date(bStart).getTime(); const bE = bEnd ? new Date(bEnd).getTime() : bS + 3600000; return Math.max(aS, bS) < Math.min(aE, bE); };
    const findConflicts = (startIso, endIso, excludeId = null) => { if (!startIso) return []; return state.events.filter(ev => { if (ev.status === 'canceled' || (excludeId != null && String(ev.id) === String(excludeId))) return false; return overlaps(startIso, endIso, ev.start_time, ev.end_time); }); };
    const normalizeTags = (s) => String(s || '').split(',').map(t => t.trim().toLowerCase()).filter(Boolean);

    // Quill Initialization Helper
    const initQuill = (selector) => {
      const toolbarOptions = [
        ['bold', 'italic', 'underline'],        // toggled buttons
        [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link', 'clean']                                         // remove formatting button
      ];

      return new Quill(selector, {
        theme: 'snow',
        modules: {
          toolbar: toolbarOptions
        }
      });
    };

    function applyPageI18n() {
      applyI18n(t, state.language);
      if (state.calendar) state.calendar.setOption('locale', state.language === 'es' ? 'es' : 'en');

      // Sync language switcher from header (injected by layout)
      const offset = state.language === 'es' ? '100%' : '0%';
      const slider = document.querySelector('#langSwitchDesktop div:last-child');
      if (slider) {
        slider.style.transform = `translateX(${offset})`;
      }
    }

    function handleLangSwitch() {
      state.language = state.language === 'en' ? 'es' : 'en';
      localStorage.setItem("lang", state.language);
      applyPageI18n();
      if (state.calendar) state.calendar.render();
    }

    const checkAccess = async () => {
      const isAllowed = ["organizer", "admin"].includes(authState.profile?.role);
      if (isAllowed) {
        $('#admin').classList.remove('hidden');
        $('#accessDenied').classList.add('hidden');

        // Initialize Editors
        state.quillEditors.createEn = initQuill('#editorDescEn');
        state.quillEditors.createEs = initQuill('#editorDescEs');
        state.quillEditors.editEn = initQuill('#editEditorDescEn');
        state.quillEditors.editEs = initQuill('#editEditorDescEs');

        // Load data
        await loadProfiles();
        await loadBanner();
        renderSpeakerFields('speakersContainer');

        if (!state.calendar) initializeCalendar();
        await loadEvents();
      } else {
        $('#admin').classList.add('hidden');
        $('#accessDenied').classList.remove('hidden');
      }
    };

    const loadProfiles = async () => {
      const { data, error } = await supabase.from('profiles').select('id, full_name, affiliation').order('full_name');
      if (error) { 
        setFlash(tr(t, state.language, 'errors.load_profiles'), 3000); 
        state.profiles = []; 
      } else { 
        state.profiles = data || []; 
        
        // Populate Datalists for Dropdown + Typing
        const dlProfiles = document.getElementById('dl-profiles');
        const dlAffiliations = document.getElementById('dl-affiliations');
        
        // 1. All Profiles
        dlProfiles.innerHTML = state.profiles
            .map(p => `<option value="${escapeHtml(p.full_name)}">`)
            .join('');

        // 2. Unique Affiliations
        const uniqueAffiliations = [...new Set(state.profiles.map(p => p.affiliation).filter(Boolean))].sort();
        dlAffiliations.innerHTML = uniqueAffiliations
            .map(aff => `<option value="${escapeHtml(aff)}">`)
            .join('');
      }
    };

    const addSpeakerField = (containerId, speaker = {}) => {
      const container = $(`#${containerId}`);
      const row = document.createElement('div');
      row.className = 'speaker-row flex flex-col gap-2 p-3 bg-white border border-gray-200 rounded-lg shadow-sm mb-3 transition-all hover:shadow-md';
      
      // Determine profile name for the search box if a profile_id exists
      let profileNameVal = "";
      if (speaker.profile_id) {
          const matched = state.profiles.find(p => p.id === speaker.profile_id);
          if (matched) profileNameVal = matched.full_name;
      }

      row.innerHTML = `
        <div class="w-full space-y-2">
            <!-- Name Input -->
            <input type="text" class="speaker-name input-field w-full" 
                   placeholder="${tr(t, state.language, 'speakers.name')}" 
                   value="${escapeHtml(speaker.name || '')}" required>
            
            <!-- Affiliation Input with Datalist (Typing + Dropdown) -->
            <input type="text" class="speaker-affiliation input-field w-full" 
                   placeholder="${tr(t, state.language, 'speakers.affiliation')}" 
                   list="dl-affiliations"
                   value="${escapeHtml(speaker.affiliation || '')}">
            
            <!-- Profile Link Input with Datalist (Typing + Dropdown) + Hidden ID -->
            <div class="relative">
                <input type="text" class="speaker-profile-search input-field w-full" 
                       placeholder="${tr(t, state.language, 'speakers.link_profile')}" 
                       list="dl-profiles" 
                       autocomplete="off"
                       value="${escapeHtml(profileNameVal)}">
                <input type="hidden" class="speaker-profile-id" value="${speaker.profile_id || ''}">
            </div>
        </div>
        <div class="flex items-center justify-between pt-2 border-t border-gray-100">
            <label class="flex items-center gap-2 text-xs text-slate-600 font-medium cursor-pointer select-none hover:text-brand-600 transition-colors">
                <input type="checkbox" class="speaker-primary rounded border-gray-300 text-brand-600 focus:ring-brand-500" ${speaker.primary_speaker ? 'checked' : ''}>
                <span>${tr(t, state.language, 'speakers.primary')}</span>
            </label>
            <button type="button" class="remove-speaker-btn text-slate-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-all" title="${tr(t, state.language, 'speakers.remove')}">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        </div>
      `;
      container.appendChild(row);
      lucide.createIcons();
    };

    const renderSpeakerFields = (containerId, speakers = []) => {
      const container = $(`#${containerId}`);
      container.innerHTML = '';
      if (speakers.length === 0) addSpeakerField(containerId);
      else speakers.forEach(speaker => addSpeakerField(containerId, speaker));
    };

    // Logic to autopopulate Affiliation and Name when a profile is selected
    const setupSpeakerAutofill = (containerId) => {
        const container = $(`#${containerId}`);
        container.addEventListener('input', (e) => {
            // Check if input event came from the profile search box
            if (e.target.matches('.speaker-profile-search')) {
                const searchVal = e.target.value;
                const row = e.target.closest('.speaker-row');
                const idInput = row.querySelector('.speaker-profile-id');
                const nameInput = row.querySelector('.speaker-name');
                const affiliationInput = row.querySelector('.speaker-affiliation');

                // Find profile by exact name match from datalist
                const profile = state.profiles.find(p => p.full_name === searchVal);

                if (profile) {
                    // Match found: Link ID
                    idInput.value = profile.id;
                    
                    // Autopopulate Name if empty or if user is searching to link
                    // (Use the profile name to ensure consistency)
                    nameInput.value = profile.full_name;

                    // Autopopulate Affiliation
                    if (profile.affiliation) {
                        affiliationInput.value = profile.affiliation;
                    }
                } else {
                    // No match (user typing custom name or hasn't finished typing)
                    idInput.value = '';
                }
            }
        });
    };

    // Initialize Autofill Listeners
    setupSpeakerAutofill('speakersContainer');
    setupSpeakerAutofill('editSpeakersContainer');

    const passesTagFilter = (ev) => {
      if (!state.tagFilter.length) return true;
      const tags = normalizeTags((ev.topic_tags || []).join(','));
      return state.tagFilter.every(t => tags.includes(t));
    };

    const loadEvents = async () => {
      const { data, error } = await supabase.from("events").select("*").order("start_time");
      if (error) console.error(error);
      else {
        state.events = data || [];
        if (state.calendar) state.calendar.refetchEvents();
      }
    };

    const updateBannerUI = (isActive) => {
      const badge = $('#bannerStatusText');
      if (isActive) {
        badge.textContent = 'Active';
        badge.className = 'text-[10px] font-bold px-2 py-0.5 bg-green-100 text-green-700 rounded border border-green-200';
      } else {
        badge.textContent = 'Inactive';
        badge.className = 'text-[10px] font-bold px-2 py-0.5 bg-white text-slate-500 rounded border border-brand-100';
      }
    };

    const loadBanner = async () => {
      const { data, error } = await supabase.from('banners').select('*').order('created_at', { ascending: false }).limit(1).maybeSingle();

      if (data && data.is_active) {
        $('#bannerTextEn').value = data.text_en;
        $('#bannerTextEs').value = data.text_es || '';
        updateBannerUI(true);
      } else {
        if (data) {
          $('#bannerTextEn').value = data.text_en;
          $('#bannerTextEs').value = data.text_es || '';
        }
        updateBannerUI(false);
      }
    };

    const formatEventsForCalendar = () => state.events.filter(passesTagFilter).map(ev => ({
      id: ev.id,
      title: state.language === 'es' ? (ev.title_es || ev.title_en) : (ev.title_en || ev.title_es),
      start: ev.start_time,
      end: ev.end_time,
      backgroundColor: ev.status === 'canceled' ? '#64748b' : '#16a34a', // slate-500 vs brand green
      borderColor: ev.status === 'canceled' ? '#64748b' : '#16a34a',
      extendedProps: ev
    }));

    const handleEventClick = async ({ event }) => {
      const ev = event.extendedProps;
      $("#editEventId").value = String(ev.id);
      $("#editTitleEn").value = ev.title_en || "";
      $("#editTitleEs").value = ev.title_es || "";
      
      // Populate Editors
      state.quillEditors.editEn.root.innerHTML = ev.description_en || "";
      state.quillEditors.editEs.root.innerHTML = ev.description_es || "";

      $("#editStartTime").value = toLocalInputValue(ev.start_time);
      $("#editEndTime").value = toLocalInputValue(ev.end_time);
      $("#editEventLang").value = ev.language || "bi";
      $("#editHostOrg").value = ev.host_org || "";
      $("#editZoomUrl").value = ev.zoom_url || "";
      $("#editRecordingUrl").value = ev.recording_url || "";
      $("#editTags").value = (ev.topic_tags || []).join(', ');
      $("#editConflicts").innerHTML = '';
      const { data: speakers } = await supabase.from('event_speakers').select('*').eq('event_id', ev.id);
      renderSpeakerFields('editSpeakersContainer', speakers || []);
      $("#edit-event-modal").showModal();
    };

    const handleTimeSelect = ({ start, end }) => {
      $("#startTime").value = toLocalInputValue(start);
      $('#startTime').type = 'datetime-local';
      $("#endTime").value = toLocalInputValue(end);
      $('#endTime').type = 'datetime-local';
      state.calendar.unselect();
      checkCreateFormConflicts();
      $("#titleEn").focus();
    };

    const handleDateClick = (info) => {
      let start = new Date(info.date);
      if (info.allDay) start.setHours(12, 0, 0, 0);
      const end = new Date(start.getTime() + 60 * 60 * 1000);
      $("#startTime").value = toLocalInputValue(start);
      $("#endTime").value = toLocalInputValue(end);
      $('#startTime').type = 'datetime-local';
      $('#endTime').type = 'datetime-local';
      checkCreateFormConflicts();
      $("#titleEn").focus();
    };

    const handleEventMove = async ({ event, revert }) => {
      const conflicts = findConflicts(event.start.toISOString(), event.end?.toISOString(), event.id);
      if (conflicts.length > 0) { setFlash(tr(t, state.language, 'errors.overlap'), 3000); revert(); return; }
      if (!confirm(`Move "${event.title}"?`)) { revert(); return; }
      const { error } = await supabase.from("events").update({ start_time: event.start.toISOString(), end_time: event.end ? event.end.toISOString() : null }).eq("id", event.id);
      if (error) { setFlash(tr(t, state.language, 'errors.update_event'), 3000); revert(); }
      else { setFlash("Event time updated!"); await loadEvents(); }
    };

    const initializeCalendar = () => {
      const el = $('#calendar');
      if (!el || !window.FullCalendar) return;
      state.calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth', // Changed to Month as default
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
        editable: true, selectable: true, selectMirror: true,
        slotMinTime: '08:00:00', slotMaxTime: '20:00:00', height: '100%',
        eventClick: handleEventClick, select: handleTimeSelect, dateClick: handleDateClick,
        eventDrop: handleEventMove, eventResize: handleEventMove,
        events: (_f, s, _fail) => s(formatEventsForCalendar()),
        eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },
        locale: state.language === 'es' ? 'es' : 'en'
      });
      state.calendar.render();
    };

    const checkCreateFormConflicts = () => {
      const startIso = toIsoOrNull($("#startTime").value);
      const endIso = toIsoOrNull($("#endTime").value);
      const conflicts = findConflicts(startIso, endIso, null);
      $("#slotConflicts").innerHTML = conflicts.length ? conflicts.map(ev => `<div class="flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> ${new Date(ev.start_time).toLocaleString()} — ${escapeHtml(ev.title_en || ev.title_es || '')}</div>`).join("") : '';
      lucide.createIcons();
      return conflicts.length > 0;
    };

    const checkEditFormConflicts = () => {
      const id = $("#editEventId").value;
      const startIso = toIsoOrNull($("#editStartTime").value);
      const endIso = toIsoOrNull($("#editEndTime").value);
      const conflicts = findConflicts(startIso, endIso, id);
      $("#editConflicts").innerHTML = conflicts.length ? conflicts.map(ev => `<div class="flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> ${new Date(ev.start_time).toLocaleString()} — ${escapeHtml(ev.title_en || ev.title_es || '')}</div>`).join("") : '';
      lucide.createIcons();
      return conflicts.length > 0;
    };

    const getSpeakersFromForm = (containerId) => {
      return Array.from($(`#${containerId}`).querySelectorAll('.speaker-row')).map(row => ({
        name: row.querySelector('.speaker-name').value.trim(),
        affiliation: row.querySelector('.speaker-affiliation').value.trim() || null,
        // Get value from hidden input now
        profile_id: row.querySelector('.speaker-profile-id').value || null,
        primary_speaker: row.querySelector('.speaker-primary').checked,
      })).filter(s => s.name);
    };

    // Helper to extract content from Quill (handle empty state)
    const getQuillContent = (quill) => {
      if (quill.getText().trim().length === 0 && quill.root.innerHTML === '<p><br></p>') return null;
      return quill.root.innerHTML;
    };

    // --- FORM SUBMISSION LOGIC ---
    const createEvent = async (payload) => {
      if (!payload.title_en || !payload.start_time) { setFlash("Title (EN) and Start Time are required.", 3000); return; }
      if (checkCreateFormConflicts()) { setFlash(tr(t, state.language, 'errors.overlap'), 3000); return; }
      const { data, error } = await supabase.from("events").insert([{ ...payload, status: "scheduled" }]).select().single();
      if (error) { setFlash(tr(t, state.language, "errors.create_event"), 3000); return; }
      const speakers = getSpeakersFromForm('speakersContainer');
      if (speakers.length > 0) {
        const { error: spErr } = await supabase.from('event_speakers').insert(speakers.map(s => ({ ...s, event_id: data.id })));
        if (spErr) console.error(spErr);
      }
      setFlash("Event created!");
      $("#createEventForm").reset();
      
      // Reset editors
      state.quillEditors.createEn.setContents([]);
      state.quillEditors.createEs.setContents([]);

      $('#startTime').type = 'text'; $('#endTime').type = 'text';
      $("#slotConflicts").innerHTML = '';
      renderSpeakerFields('speakersContainer');
      await loadEvents();
    };

    const updateEvent = async (id, payload) => {
      const { error } = await supabase.from("events").update(payload).eq("id", id);
      if (error) { setFlash(tr(t, state.language, 'errors.update_event'), 3000); return; }
      await supabase.from('event_speakers').delete().eq('event_id', id);
      const speakers = getSpeakersFromForm('editSpeakersContainer');
      if (speakers.length > 0) {
        const { error: spErr } = await supabase.from('event_speakers').insert(speakers.map(s => ({ ...s, event_id: id })));
        if (spErr) console.error(spErr);
      }
      setFlash("Event details saved!");
      await loadEvents();
      $("#edit-event-modal").close();
    };

    const deleteEvent = async (id) => {
      if (!confirm("Permanently delete this event?")) return;
      try {
        await supabase.rpc('delete_event_and_dependencies', { event_id_to_delete: id });
        setFlash("Event deleted.");
        await loadEvents();
        $("#edit-event-modal").close();
      } catch (error) { setFlash(tr(t, state.language, 'errors.delete_event'), 3000); }
    };

    // --- LISTENERS ---
    const setupDateTime = (s, e) => {
      const hf = (el) => el.type = 'datetime-local';
      const hb = (el) => { if (!el.value) el.type = 'text' };
      s.addEventListener('focus', () => hf(s)); s.addEventListener('blur', () => hb(s));
      if (!s.value) s.type = 'text';
      if (e) { e.addEventListener('focus', () => hf(e)); e.addEventListener('blur', () => hb(e)); if (!e.value) e.type = 'text'; }
    };
    setupDateTime($('#startTime'), $('#endTime'));

    // Banner Save Button
    $('#saveBannerBtn')?.addEventListener('click', async () => {
      const text_en = $('#bannerTextEn').value.trim();
      const text_es = $('#bannerTextEs').value.trim();

      if (!text_en) {
        setFlash("English text is required", 3000);
        return;
      }

      await supabase.from('banners').update({ is_active: false }).neq('id', '00000000-0000-0000-0000-000000000000');

      const { error } = await supabase.from('banners').insert({
        text_en,
        text_es,
        is_active: true,
        created_by: authState.profile.id
      });

      if (error) {
        console.error(error);
        setFlash("Error saving banner", 3000);
      } else {
        setFlash("Banner updated and active!");
        updateBannerUI(true);
      }
    });

    $('#clearBannerBtn')?.addEventListener('click', async () => {
      const { error } = await supabase.from('banners').update({ is_active: false }).neq('id', '00000000-0000-0000-0000-000000000000');
      if (error) {
        setFlash("Error deactivating", 3000);
      } else {
        setFlash("Banner deactivated");
        updateBannerUI(false);
        $('#bannerTextEn').value = '';
        $('#bannerTextEs').value = '';
      }
    });

    $("#createEventForm")?.addEventListener("input", checkCreateFormConflicts);
    $("#createEventForm").addEventListener('submit', async (e) => {
      e.preventDefault();
      await createEvent({
        title_en: $("#titleEn")?.value.trim(),
        title_es: $("#titleEs")?.value.trim() || null,
        description_en: getQuillContent(state.quillEditors.createEn),
        description_es: getQuillContent(state.quillEditors.createEs),
        start_time: toIsoOrNull($("#startTime")?.value),
        end_time: toIsoOrNull($("#endTime")?.value),
        language: $("#eventLang")?.value || "bi",
        host_org: $("#hostOrg")?.value.trim() || null,
        zoom_url: $("#zoomUrl")?.value.trim() || null,
        recording_url: $("#recordingUrl")?.value.trim() || null,
        topic_tags: normalizeTags($("#tags")?.value),
      });
    });

    $("#tagFilterInput")?.addEventListener('keyup', (e) => { state.tagFilter = normalizeTags(e.target.value || ''); if (state.calendar) state.calendar.refetchEvents(); });
    $("#close-modal-btn")?.addEventListener("click", () => $("#edit-event-modal").close());
    $("#editStartTime")?.addEventListener("input", checkEditFormConflicts);
    $("#editEndTime")?.addEventListener("input", checkEditFormConflicts);

    $("#editEventForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = $("#editEventId").value;
      const start_time = toIsoOrNull($("#editStartTime").value);
      const end_time = toIsoOrNull($("#editEndTime").value);
      if (findConflicts(start_time, end_time, id).length > 0) { setFlash(tr(t, state.language, 'errors.overlap'), 3000); return; }
      await updateEvent(id, {
        title_en: $("#editTitleEn").value?.trim(),
        title_es: $("#editTitleEs").value?.trim() || null,
        description_en: getQuillContent(state.quillEditors.editEn),
        description_es: getQuillContent(state.quillEditors.editEs),
        language: $("#editEventLang").value,
        host_org: $("#editHostOrg").value?.trim() || null,
        zoom_url: $("#editZoomUrl").value?.trim() || null,
        recording_url: $("#editRecordingUrl").value?.trim() || null,
        start_time, end_time,
        topic_tags: normalizeTags($("#editTags").value)
      });
    });

    $("#btnDeleteEvent")?.addEventListener("click", () => deleteEvent($("#editEventId").value));
    $('#addSpeakerBtn')?.addEventListener('click', () => addSpeakerField('speakersContainer'));
    $('#addEditSpeakerBtn')?.addEventListener('click', () => addSpeakerField('editSpeakersContainer'));

    // Global listener for profile clicks (header injected by layout)
    document.addEventListener('click', e => {
      if (e.target.closest('.remove-speaker-btn')) e.target.closest('.speaker-row').remove();
      if (e.target.closest('#btnProfile') || e.target.id === 'userName') window.location.href = 'profile.html';
    });

    // --- INITIALIZATION ---
    (async function main() {
      initSharedUI({ onLangSwitch: handleLangSwitch, onSignOut: signOut });
      await initAuth({
        onAuthReady: () => {
          renderHeader(authState, t, state.language);
          if (authState.profile?.avatar_url) {
            getAvatarUrl(authState.profile.avatar_url).then(url => {
              if (url) { const i = $('#userAvatar'); if (i) { i.src = url; show(i); hide($('#userInitial')); } }
            });
          }
        },
        onAuthChange: () => renderHeader(authState, t, state.language)
      });
      applyPageI18n();
      await checkAccess();
      lucide.createIcons();
    })();
  </script>
</body>

</html>