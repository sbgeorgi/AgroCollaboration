<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Agrovoltaicos sin Fronteras</title>
  <meta name="description" content="Organizer tools for managing the Agrovoltaicos sin Fronteras seminar series." />
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600&family=Lato:wght@400;700&family=Poppins:wght@700;800&display=swap"
    rel="stylesheet">

  <!-- FullCalendar (global build + locales) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/locales-all.global.min.js"></script>

  <style>
    /* --- CORE PAGE LAYOUT --- */
    main.container {
      padding: var(--space-2);
    }

    #admin.card {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      width: 100%;
      max-width: 100%;
      margin: 0;
      padding: var(--space-2);
      overflow: hidden;
    }

    .admin-layout-inner {
      flex-grow: 1;
      min-height: 0;
      display: grid;
      grid-template-columns: minmax(400px, 1.2fr) 2fr;
      gap: var(--space-3);
      overflow: hidden;
    }

    /* --- COLUMN STYLING --- */
    .organizer-form-container,
    .admin-side {
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .organizer-form-container h2,
    .admin-side h2 {
      margin: 0 0 var(--space-2) 0;
      flex-shrink: 0;
      font-size: 1.3rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: var(--space-1);
    }

    /* --- LEFT COLUMN: FORM --- */
    #createEventForm {
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: var(--space-1);
      display: flex;
      flex-direction: column;
    }

    .grid-form label {
      font-size: 0.8rem;
      margin-bottom: 4px;
      display: block;
      color: var(--muted);
    }

    .speakers-fieldset {
      border: 1px solid var(--border);
      border-radius: var(--radius-2);
      padding: var(--space-1) var(--space-2);
      margin-top: var(--space-1);
      background: var(--card-2);
      max-height: 200px;
      overflow-y: auto;
    }

    .speakers-fieldset legend {
      font-weight: 600;
      padding: 0 6px;
      font-size: 0.9rem;
    }

    .speaker-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto auto;
      gap: var(--space-1);
      align-items: center;
      margin-bottom: var(--space-1);
      padding-bottom: var(--space-1);
      border-bottom: 1px solid var(--color-surface-strong);
    }

    .speaker-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .speaker-row .checkbox-field {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      gap: 2px;
    }

    #createEventForm>.col-span-2:last-of-type {
      margin-top: auto;
      padding-top: var(--space-2);
    }

    /* --- RIGHT COLUMN: CALENDAR --- */
    .calendar-tools {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      margin-bottom: var(--space-2);
      flex-shrink: 0;
    }

    .calendar-tools .tool {
      display: flex;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: var(--radius-2);
      background: var(--card-2);
      padding: 0 var(--space-1);
    }

    .calendar-tools input {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      height: 36px;
    }

    #calendar {
      flex-grow: 1;
      min-height: 0;
      position: relative;
    }

    /* FullCalendar Theme Overrides */
    :root {
      --fc-bg-color: var(--card-2);
      --fc-border-color: var(--border);
      --fc-text-color: var(--text);
      --fc-neutral-bg-color: rgba(0, 0, 0, 0.05);
      --fc-today-bg-color: color-mix(in srgb, var(--brand) 15%, transparent);
      --fc-event-bg-color: var(--brand-2);
      --fc-event-border-color: var(--brand-2);
      --fc-event-text-color: #fff;
      --fc-button-bg-color: var(--card-2);
      --fc-button-border-color: var(--border);
      --fc-button-text-color: var(--text);
      --fc-button-active-bg-color: var(--brand-2);
      --fc-button-active-border-color: var(--brand-2);
      --fc-button-active-text-color: #fff;
      --fc-button-hover-bg-color: var(--border);
    }

    #calendar .fc {
      height: 100%;
    }

    .fc-col-header-cell-cushion,
    .fc-daygrid-day-number {
      text-decoration: none;
      color: var(--text) !important;
    }

    /* --- MODAL & MISC --- */
    #edit-event-modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      padding: var(--space-3);
      overflow-y: auto;
    }

    .conflict-row {
      font-size: 0.8rem;
      color: #ffbe0b;
      line-height: 1.4;
    }

    #accessDenied.card {
      max-width: 600px;
      margin: var(--space-4) auto;
    }

    /* --- RESPONSIVE: Tablet & Mobile --- */
    @media (max-width: 960px) {

      html,
      body {
        overflow-y: auto;
        height: auto;
        max-height: none;
      }

      main.container {
        padding: var(--space-1);
        min-height: auto;
      }

      .admin-layout-inner {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
        gap: var(--space-3);
      }

      .organizer-form-container {
        max-height: 70vh;
      }

      .admin-side {
        min-height: 70vh;
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="container header-grid">
      <div class="brand">
        <a href="index.html" style="display: contents; text-decoration: none;">
          <img src="static/icon.png" alt="Agrovoltaicos sin Fronteras logo" class="logo-image">
          <div class="brand-text">
            <div class="title">Agrovoltaicos sin Fronteras</div>
            <div class="subtitle" data-i18n="tagline">
              A seminar series to share advances in agrivoltaics in the Americas
            </div>
          </div>
        </a>
      </div>

      <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <!-- Desktop Nav -->
      <nav class="nav">
        <a href="index.html" class="link" data-i18n="nav.schedule">Schedule</a>
        <a href="archive.html" class="link" data-i18n="nav.archive">Archive</a>
        <a href="about.html" class="link" data-i18n="nav.about">About</a>
        <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
        <div class="divider"></div>
        <div id="langSwitchDesktop" class="lang-switch-slider" data-lang="en">
          <span>EN</span>
          <span>ES</span>
        </div>
        <div class="auth-area">
          <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile">
            <span id="userInitial"></span>
            <img id="userAvatar" style="display: none; width: 100%; height: 100%; object-fit: cover;" />
          </button>
          <span id="userName"></span>
          <a href="signin.html" id="btnSignIn" class="btn-primary" data-i18n="auth.signin"
            style="text-decoration: none; display: inline-block;">Sign in</a>
          <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
            Sign out
          </button>
        </div>
      </nav>
    </div>
  </header>

  <div id="mobileNavOverlay" class="mobile-nav-overlay">
    <!-- Content will be injected by JS -->
  </div>

  <div id="flash" class="flash" role="status" aria-live="polite"></div>

  <main class="container">
    <section id="admin" class="card" style="display: none;">
      <div class="admin-layout-inner">
        <!-- Left Side: Create Form -->
        <div class="organizer-form-container">
          <h2 data-i18n="admin.title">Organizer Tools</h2>
          <!-- Banner Management Section -->
          <div class="banner-management"
            style="background: var(--card-2); border: 1px solid var(--color-primary); border-radius: var(--radius-2); padding: var(--space-2); margin-bottom: var(--space-3);">
            <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
              <span style="font-size: 1.5rem;">📢</span>
              <strong style="flex: 1;">Site Announcement Banner</strong>
              <button type="button" id="toggleBannerBtn" class="btn-ghost"
                style="padding: 4px 12px; font-size: 0.85rem;">
                <span id="bannerStatusText">No Active Banner</span>
              </button>
            </div>
            <div class="grid-form" style="gap: var(--space-1);">
              <div>
                <label style="font-size: 0.75rem; opacity: 0.8;">Banner Text (EN)</label>
                <input id="bannerTextEn" placeholder="Important announcement in English..." />
              </div>
              <div>
                <label style="font-size: 0.75rem; opacity: 0.8;">Banner Text (ES)</label>
                <input id="bannerTextEs" placeholder="Anuncio importante en español..." />
              </div>
              <div class="col-span-2" style="display: flex; gap: var(--space-2); align-items: center;">
                <button type="button" id="saveBannerBtn" class="btn-primary"
                  style="padding: 6px 16px; font-size: 0.9rem;">
                  <span id="saveBannerBtnText">Save & Activate</span>
                </button>
                <button type="button" id="saveDraftBtn" class="btn-secondary"
                  style="padding: 6px 16px; font-size: 0.9rem;">Save as Draft</button>
                <button type="button" id="clearBannerBtn" class="btn-ghost"
                  style="padding: 6px 16px; font-size: 0.9rem;">Deactivate All</button>
                <label
                  style="display: flex; align-items: center; gap: var(--space-1); margin-left: auto; font-size: 0.85rem; cursor: pointer; color: var(--color-success);">
                  <input type="checkbox" id="bannerActiveCheck" checked />
                  <span id="activeCheckLabel">Activate on Save</span>
                </label>
              </div>
            </div>
          </div>
          <form id="createEventForm" class="grid-form">
            <div>
              <div class="grid-form">
                <div><label data-i18n="event.title_en">Title (EN)</label><input id="titleEn" required /></div>
                <div><label data-i18n="event.title_es">Title (ES)</label><input id="titleEs" /></div>
                <div class="col-span-2"><label data-i18n="event.desc_en">Description (EN)</label><textarea
                    id="descEn"></textarea></div>
                <div class="col-span-2"><label data-i18n="event.desc_es">Description (ES)</label><textarea
                    id="descEs"></textarea></div>
                <div><label data-i18n="event.start">Start time</label><input id="startTime" type="text"
                    placeholder="mm/dd/yyyy --:-- --" required /></div>
                <div><label data-i18n="event.end">End time</label><input id="endTime" type="text"
                    placeholder="mm/dd/yyyy --:-- --" /></div>
                <div><label data-i18n="event.lang">Language</label>
                  <select id="eventLang">
                    <option value="bi">Bilingual</option>
                    <option value="en">English</option>
                    <option value="es">Español</option>
                  </select>
                </div>
                <div><label data-i18n="event.host">Host org</label><input id="hostOrg"
                    placeholder="UNAM, University of Arizona…" /></div>
                <div class="col-span-2"><label data-i18n="event.zoom">Zoom URL (members only)</label><input id="zoomUrl"
                    type="url" /></div>
                <div class="col-span-2"><label data-i18n="event.recording_url">Recording URL</label><input
                    id="recordingUrl" type="url" /></div>
                <div class="col-span-2"><label data-i18n="tags.label">Tags (optional)</label><input id="tags"
                    data-i18n-placeholder="tags.placeholder" placeholder="earth science, agriculture, environment" />
                  <p class="muted" data-i18n="tags.hint">Separate with commas. Not mandatory.</p>
                </div>

                <!-- Speakers Section -->
                <fieldset class="speakers-fieldset col-span-2">
                  <legend data-i18n="speakers.title">Speakers</legend>
                  <div id="speakersContainer"></div>
                  <button type="button" class="btn-secondary" id="addSpeakerBtn" data-i18n="speakers.add">Add
                    Speaker</button>
                </fieldset>
              </div>
              <div id="slotConflicts" class="slot-conflicts col-span-2" style="margin-top: 1rem;"></div>
            </div>
            <div class="col-span-2">
              <button class="btn-primary" type="submit" data-i18n="event.create">Create Event</button>
            </div>
          </form>
        </div>

        <!-- Right Side: Interactive Calendar -->
        <div class="admin-side">
          <h2 data-i18n="calendar.title">Event Calendar</h2>
          <div class="calendar-tools">
            <div class="tool">
              <span>#</span>
              <input id="tagFilterInput" data-i18n-placeholder="tags.filter"
                placeholder="Filter by tags (comma separated)" />
            </div>
          </div>
          <div id="calendar"></div>
        </div>
      </div>
    </section>

    <div id="accessDenied" class="card" style="display: none; text-align: center;">
      <h2>Access Denied</h2>
      <p>You must be an organizer to view this page. Please sign in with an authorized account.</p>
      <a href="index.html" class="btn-secondary">Back to Schedule</a>
    </div>
  </main>
  <footer class="site-footer">
    <div class="container">
      <small style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center;">
          © <span id="year"></span> Agrovoltaicos sin Fronteras •
          <span data-i18n="footer.note">Bilingual, community-driven seminar on agrivoltaics in Latin America.</span>
        </div>
        <div style="display: flex; align-items: center;">
          <a href="https://biosphere2.org/research/research-initiatives/agrivoltaics" target="_blank"
            rel="noopener noreferrer" style="margin-left: 8px;">
            <img src="static/b2ua.jpg" alt="Biosphere 2 Agrivoltaics"
              style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
          <a href="https://www.ier.unam.mx/ParcelaAgrovoltaica.html" target="_blank" rel="noopener noreferrer"
            style="margin-left: 8px;">
            <img src="static/unam.png" alt="UNAM"
              style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
        </div>
      </small>
    </div>
  </footer>
  <!-- Modal for Editing Events -->
  <dialog id="edit-event-modal">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
      <h2 data-i18n="event.edit_title">Edit Event</h2>
      <button id="close-modal-btn" class="btn-ghost" style="padding: 4px 8px;" aria-label="Close">✕</button>
    </div>
    <form id="editEventForm" class="grid-form">
      <input type="hidden" id="editEventId">
      <div><label data-i18n="event.title_en">Title (EN)</label><input id="editTitleEn" required /></div>
      <div><label data-i18n="event.title_es">Title (ES)</label><input id="editTitleEs" /></div>
      <div class="col-span-2"><label data-i18n="event.desc_en">Description (EN)</label><textarea
          id="editDescEn"></textarea></div>
      <div class="col-span-2"><label data-i18n="event.desc_es">Description (ES)</label><textarea
          id="editDescEs"></textarea></div>
      <div><label data-i18n="event.start">Start time</label><input id="editStartTime" type="datetime-local" required />
      </div>
      <div><label data-i18n="event.end">End time</label><input id="editEndTime" type="datetime-local" /></div>
      <div><label data-i18n="event.lang">Language</label>
        <select id="editEventLang">
          <option value="bi">Bilingual</option>
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </div>
      <div><label data-i18n="event.host">Host org</label><input id="editHostOrg" /></div>
      <div class="col-span-2"><label data-i18n="event.zoom">Zoom URL (members only)</label><input id="editZoomUrl"
          type="url" /></div>
      <div class="col-span-2"><label data-i18n="event.recording_url">Recording URL</label><input id="editRecordingUrl"
          type="url" /></div>
      <div class="col-span-2"><label data-i18n="tags.label">Tags</label><input id="editTags" /></div>
      <fieldset class="speakers-fieldset col-span-2">
        <legend data-i18n="speakers.title">Speakers</legend>
        <div id="editSpeakersContainer"></div>
        <button type="button" class="btn-secondary" id="addEditSpeakerBtn" data-i18n="speakers.add">Add
          Speaker</button>
      </fieldset>

      <div id="editConflicts" class="slot-conflicts col-span-2" style="margin-top: 0.5rem;"></div>
      <div class="col-span-2"
        style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <button class="btn-primary" type="submit" data-i18n="save">Save Changes</button>
        <button id="btnDeleteEvent" class="btn-danger" type="button" data-i18n="event.delete">Delete</button>
      </div>
    </form>
  </dialog>

  <!-- JS Logic -->
  <script type="module">
    import { supabase, initAuth, initSharedUI, renderHeader } from './auth.js';

    let calendar = null;
    const state = {
      language: localStorage.getItem("lang") || "en",
      events: [],
      profiles: [],
      tagFilter: [],
    };
    const t = {
      en: {
        tagline: "A seminar series to share advances in agrivoltaics in the Americas",
        nav: { schedule: "Schedule", about: "About", admin: "Admin", archive: "Archive" },
        auth: { signin: "Sign in", signout: "Sign out" },
        admin: { title: "Organizer Tools" },
        calendar: { title: "Event Calendar" },
        event: {
          title_en: "Title (EN)", title_es: "Title (ES)", desc_en: "Description (EN)", desc_es: "Description (ES)",
          start: "Start time", end: "End time", host: "Host org", zoom: "Zoom URL (members only)", lang: "Language", recording_url: "Recording URL",
          create: "Create Event", edit_title: "Edit Event", delete: "Delete"
        },
        speakers: { title: "Speakers", add: "Add Speaker", name: "Name*", affiliation: "Affiliation", link_profile: "Link Profile", primary: "Primary", remove: "Remove" },
        tags: { label: "Tags", placeholder: "earth science, agriculture...", hint: "Separate with commas. Not mandatory.", filter: "Filter by tags..." },
        save: "Save Changes", errors: { overlap: "Selected time overlaps an existing event.", create_event: "Could not create event", update_event: "Could not update event", delete_event: "Could not delete event", load_profiles: "Could not load user profiles" },
      },
      es: {
        tagline: "Una serie de seminarios para compartir avances en agrovoltaicos en las Américas",
        nav: { schedule: "Calendario", about: "Acerca de", admin: "Admin", archive: "Archivo" },
        auth: { signin: "Iniciar sesión", signout: "Cerrar sesión" },
        admin: { title: "Herramientas para organizadores" },
        calendar: { title: "Calendario de Eventos" },
        event: {
          title_en: "Título (EN)", title_es: "Título (ES)", desc_en: "Descripción (EN)", desc_es: "Descripción (ES)",
          start: "Inicio", end: "Fin", host: "Institución anfitriona", zoom: "Enlace de Zoom (solo miembros)", lang: "Idioma", recording_url: "URL de grabación",
          create: "Crear evento", edit_title: "Editar Evento", delete: "Eliminar"
        },
        speakers: { title: "Ponentes", add: "Añadir Ponente", name: "Nombre*", affiliation: "Afiliación", link_profile: "Vincular Perfil", primary: "Principal", remove: "Quitar" },
        tags: { label: "Etiquetas", placeholder: "ciencias de la tierra, agricultura...", hint: "Separar con comas. No es obligatorio.", filter: "Filtrar por etiquetas..." },
        save: "Guardar Cambios", errors: { overlap: "El horario seleccionado se cruza con otro evento.", create_event: "No se pudo crear el evento", update_event: "No se pudo actualizar el evento", delete_event: "No se pudo eliminar el evento", load_profiles: "No se pudieron cargar los perfiles de usuario" },
      },
    };

    const $ = (sel) => document.querySelector(sel);
    const tr = (key, fallback = "") => { const parts = key.split("."); let obj = t[state.language]; for (const p of parts) obj = obj?.[p]; return obj ?? fallback; };
    const setFlash = (msg, isError = false) => { const el = $("#flash"); if (!el) return; el.textContent = msg; el.style.backgroundColor = isError ? 'var(--color-danger)' : ''; el.style.display = "block"; clearTimeout(setFlash._t); setFlash._t = setTimeout(() => { el.style.display = "none"; el.style.backgroundColor = ''; }, 4000); };
    const toIsoOrNull = (v) => { if (!v) return null; const d = new Date(v); return isNaN(d.getTime()) ? null : d.toISOString(); };
    const toLocalInputValue = (d) => { if (!d) return ""; d = new Date(d); const p = (n) => String(n).padStart(2, "0"); return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; };
    const overlaps = (aStart, aEnd, bStart, bEnd) => { if (!aStart || !bStart) return false; const aS = new Date(aStart).getTime(); const aE = aEnd ? new Date(aEnd).getTime() : aS + 3600000; const bS = new Date(bStart).getTime(); const bE = bEnd ? new Date(bEnd).getTime() : bS + 3600000; return Math.max(aS, bS) < Math.min(aE, bE); };
    const findConflicts = (startIso, endIso, excludeId = null) => { if (!startIso) return []; return state.events.filter(ev => { if (ev.status === 'canceled' || (excludeId != null && String(ev.id) === String(excludeId))) return false; return overlaps(startIso, endIso, ev.start_time, ev.end_time); }); };
    const escapeHtml = (s) => (s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    const normalizeTags = (s) => String(s || '').split(',').map(t => t.trim().toLowerCase()).filter(Boolean);

    const applyI18n = () => { document.querySelectorAll("[data-i18n]").forEach(e => e.textContent = tr(e.dataset.i18n, e.textContent)); document.querySelectorAll("[data-i18n-placeholder]").forEach(e => e.placeholder = tr(e.dataset.i18nPlaceholder, e.placeholder)); document.querySelectorAll(".lang-switch-slider").forEach(el => el.dataset.lang = state.language); if (calendar) calendar.setOption('locale', state.language === 'es' ? 'es' : 'en'); };
    const handleLangSwitch = () => { state.language = state.language === "en" ? "es" : "en"; localStorage.setItem("lang", state.language); applyI18n(); if (calendar) calendar.render(); };
    const checkAccess = async (authState) => { const isAllowed = ["organizer", "admin"].includes(authState.profile?.role); $("#admin").style.display = isAllowed ? 'flex' : 'none'; $("#accessDenied").style.display = isAllowed ? 'none' : 'block'; if (isAllowed) { await loadProfiles(); if (!calendar) initializeCalendar(); await loadEvents(); } };
    const loadProfiles = async () => { const { data, error } = await supabase.from('profiles').select('id, full_name, affiliation').order('full_name'); if (error) { setFlash(tr('errors.load_profiles'), true); state.profiles = []; } else { state.profiles = data || []; } };
    const createProfileOptions = (selectedId) => `<option value="">--</option>${state.profiles.map(p => `<option value="${p.id}" ${p.id === selectedId ? 'selected' : ''}>${escapeHtml(p.full_name || '')}</option>`).join('')}`;
    const addSpeakerField = (containerId, speaker = {}) => { const container = $(`#${containerId}`); const row = document.createElement('div'); row.className = 'speaker-row'; row.innerHTML = `<div><label>${tr('speakers.name')}</label><input type="text" class="speaker-name" value="${escapeHtml(speaker.name || '')}" required></div><div><label>${tr('speakers.affiliation')}</label><input type="text" class="speaker-affiliation" value="${escapeHtml(speaker.affiliation || '')}"></div><div><label>${tr('speakers.link_profile')}</label><select class="speaker-profile">${createProfileOptions(speaker.profile_id)}</select></div><div style="display:flex;gap:1rem;align-items:flex-end;"><div class="checkbox-field"><label>${tr('speakers.primary')}</label><input type="checkbox" class="speaker-primary" ${speaker.primary_speaker ? 'checked' : ''}></div><button type="button" class="btn-danger-ghost remove-speaker-btn" title="${tr('speakers.remove')}">✕</button></div>`; container.appendChild(row); };
    const renderSpeakerFields = (containerId, speakers = []) => { const container = $(`#${containerId}`); container.innerHTML = ''; if (speakers.length === 0) { addSpeakerField(containerId); } else { speakers.forEach(speaker => addSpeakerField(containerId, speaker)); } };
    const passesTagFilter = (ev) => { if (!state.tagFilter.length) return true; const tags = normalizeTags(ev.topic_tags.join(',')); return state.tagFilter.every(t => tags.includes(t)); };
    const loadEvents = async () => { const { data, error } = await supabase.from("events").select("*").order("start_time"); if (error) console.error(error); else { state.events = data || []; if (calendar) calendar.refetchEvents(); } };
    const formatEventsForCalendar = () => state.events.filter(passesTagFilter).map(ev => ({ id: ev.id, title: state.language === 'es' ? (ev.title_es || ev.title_en) : (ev.title_en || ev.title_es), start: ev.start_time, end: ev.end_time, backgroundColor: ev.status === 'canceled' ? '#555' : 'var(--brand-2)', borderColor: ev.status === 'canceled' ? '#555' : 'var(--brand-2)', extendedProps: ev }));
    const handleEventClick = async ({ event }) => { const ev = event.extendedProps; $("#editEventId").value = String(ev.id); $("#editTitleEn").value = ev.title_en || ""; $("#editTitleEs").value = ev.title_es || ""; $("#editDescEn").value = ev.description_en || ""; $("#editDescEs").value = ev.description_es || ""; $("#editStartTime").value = toLocalInputValue(ev.start_time); $("#editEndTime").value = toLocalInputValue(ev.end_time); $("#editEventLang").value = ev.language || "bi"; $("#editHostOrg").value = ev.host_org || ""; $("#editZoomUrl").value = ev.zoom_url || ""; $("#editRecordingUrl").value = ev.recording_url || ""; $("#editTags").value = (ev.topic_tags || []).join(', '); $("#editConflicts").innerHTML = ''; const { data: speakers } = await supabase.from('event_speakers').select('*').eq('event_id', ev.id); renderSpeakerFields('editSpeakersContainer', speakers || []); $("#edit-event-modal").showModal(); };
    const handleTimeSelect = ({ start, end }) => { $("#startTime").value = toLocalInputValue(start); $('#startTime').type = 'datetime-local'; $("#endTime").value = toLocalInputValue(end); $('#endTime').type = 'datetime-local'; calendar.unselect(); checkCreateFormConflicts(); $("#titleEn").focus(); };
    const handleDateClick = (info) => { let start = new Date(info.date); if (info.allDay) start.setHours(12, 0, 0, 0); const end = new Date(start.getTime() + 60 * 60 * 1000); $("#startTime").value = toLocalInputValue(start); $("#endTime").value = toLocalInputValue(end); $('#startTime').type = 'datetime-local'; $('#endTime').type = 'datetime-local'; checkCreateFormConflicts(); $("#titleEn").focus(); };
    const handleEventMove = async ({ event, revert }) => { const conflicts = findConflicts(event.start.toISOString(), event.end?.toISOString(), event.id); if (conflicts.length > 0) { setFlash(tr('errors.overlap'), true); revert(); return; } if (!confirm(`Move "${event.title}"?`)) { revert(); return; } const { error } = await supabase.from("events").update({ start_time: event.start.toISOString(), end_time: event.end ? event.end.toISOString() : null }).eq("id", event.id); if (error) { setFlash(tr('errors.update_event'), true); revert(); } else { setFlash("Event time updated!"); await loadEvents(); } };
    const initializeCalendar = () => { const el = $('#calendar'); if (!el || !window.FullCalendar) return; calendar = new FullCalendar.Calendar(el, { initialView: 'timeGridWeek', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' }, editable: true, selectable: true, selectMirror: true, slotMinTime: '08:00:00', slotMaxTime: '20:00:00', height: '100%', eventClick: handleEventClick, select: handleTimeSelect, dateClick: handleDateClick, eventDrop: handleEventMove, eventResize: handleEventMove, events: (_f, s, _fail) => s(formatEventsForCalendar()), eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' }, locale: state.language === 'es' ? 'es' : 'en' }); calendar.render(); };
    const checkCreateFormConflicts = () => { const startIso = toIsoOrNull($("#startTime").value); const endIso = toIsoOrNull($("#endTime").value); const conflicts = findConflicts(startIso, endIso, null); $("#slotConflicts").innerHTML = conflicts.length ? conflicts.map(ev => `<div class="conflict-row">⚠️ ${new Date(ev.start_time).toLocaleString()} — ${(ev.title_en || ev.title_es || '').replace(/</g, '&lt;')}</div>`).join("") : ''; return conflicts.length > 0; };
    const checkEditFormConflicts = () => { const id = $("#editEventId").value; const startIso = toIsoOrNull($("#editStartTime").value); const endIso = toIsoOrNull($("#editEndTime").value); const conflicts = findConflicts(startIso, endIso, id); $("#editConflicts").innerHTML = conflicts.length ? conflicts.map(ev => `<div class="conflict-row">⚠️ ${new Date(ev.start_time).toLocaleString()} — ${(ev.title_en || ev.title_es || '').replace(/</g, '&lt;')}</div>`).join("") : ''; return conflicts.length > 0; };
    const getSpeakersFromForm = (containerId) => { return Array.from($(`#${containerId}`).querySelectorAll('.speaker-row')).map(row => ({ name: row.querySelector('.speaker-name').value.trim(), affiliation: row.querySelector('.speaker-affiliation').value.trim() || null, profile_id: row.querySelector('.speaker-profile').value || null, primary_speaker: row.querySelector('.speaker-primary').checked, })).filter(s => s.name); };
    const createEvent = async (payload) => { if (!payload.title_en || !payload.start_time) { setFlash("Title (EN) and Start Time are required.", true); return; } if (checkCreateFormConflicts()) { setFlash(tr('errors.overlap'), true); return; } const { data, error } = await supabase.from("events").insert([{ ...payload, status: "scheduled" }]).select().single(); if (error) { setFlash(tr("errors.create_event"), true); console.error(error); return; } const speakers = getSpeakersFromForm('speakersContainer'); if (speakers.length > 0) { const { error: spErr } = await supabase.from('event_speakers').insert(speakers.map(s => ({ ...s, event_id: data.id }))); if (spErr) { setFlash('Event created, but failed to add speakers.', true); console.error(spErr); } } setFlash("Event created!"); $("#createEventForm").reset(); $('#startTime').type = 'text'; $('#endTime').type = 'text'; $("#slotConflicts").innerHTML = ''; renderSpeakerFields('speakersContainer'); await loadEvents(); };
    const updateEvent = async (id, payload) => { const { error } = await supabase.from("events").update(payload).eq("id", id); if (error) { setFlash(tr('errors.update_event'), true); console.error(error); return; } await supabase.from('event_speakers').delete().eq('event_id', id); const speakers = getSpeakersFromForm('editSpeakersContainer'); if (speakers.length > 0) { const { error: spErr } = await supabase.from('event_speakers').insert(speakers.map(s => ({ ...s, event_id: id }))); if (spErr) { setFlash('Event updated, but failed to update speakers.', true); console.error(spErr); } } setFlash("Event details saved!"); await loadEvents(); $("#edit-event-modal").close(); };
    const deleteEvent = async (id) => { if (!confirm("Permanently delete this event? This cannot be undone.")) return; try { await supabase.rpc('delete_event_and_dependencies', { event_id_to_delete: id }); setFlash("Event deleted."); await loadEvents(); $("#edit-event-modal").close(); } catch (error) { setFlash(tr('errors.delete_event'), true); console.error(error); } };
    const wireUI = () => { const setupDateTime = (s, e) => { const hf = (el) => el.type = 'datetime-local'; const hb = (el) => { if (!el.value) el.type = 'text' }; s.addEventListener('focus', () => hf(s)); s.addEventListener('blur', () => hb(s)); if (!s.value) s.type = 'text'; if (e) { e.addEventListener('focus', () => hf(e)); e.addEventListener('blur', () => hb(e)); if (!e.value) e.type = 'text'; } }; setupDateTime($('#startTime'), $('#endTime')); $("#createEventForm")?.addEventListener("input", checkCreateFormConflicts); $("#createEventForm")?.addEventListener("submit", async (e) => { e.preventDefault(); await createEvent({ title_en: $("#titleEn")?.value.trim(), title_es: $("#titleEs")?.value.trim() || null, description_en: $("#descEn")?.value.trim() || null, description_es: $("#descEs")?.value.trim() || null, start_time: toIsoOrNull($("#startTime")?.value), end_time: toIsoOrNull($("#endTime")?.value), language: $("#eventLang")?.value || "bi", host_org: $("#hostOrg")?.value.trim() || null, zoom_url: $("#zoomUrl")?.value.trim() || null, recording_url: $("#recordingUrl")?.value.trim() || null, topic_tags: normalizeTags($("#tags")?.value), }); }); $("#tagFilterInput")?.addEventListener('keyup', (e) => { state.tagFilter = normalizeTags(e.target.value || ''); if (calendar) calendar.refetchEvents(); }); $("#close-modal-btn")?.addEventListener("click", () => { $("#edit-event-modal").close(); }); $("#editStartTime")?.addEventListener("input", checkEditFormConflicts); $("#editEndTime")?.addEventListener("input", checkEditFormConflicts); $("#editEventForm")?.addEventListener("submit", async (e) => { e.preventDefault(); const id = $("#editEventId").value; const start_time = toIsoOrNull($("#editStartTime").value); const end_time = toIsoOrNull($("#editEndTime").value); if (findConflicts(start_time, end_time, id).length > 0) { setFlash(tr('errors.overlap'), true); return; } await updateEvent(id, { title_en: $("#editTitleEn").value?.trim(), title_es: $("#editTitleEs").value?.trim() || null, description_en: $("#editDescEn").value?.trim() || null, description_es: $("#editDescEs").value?.trim() || null, language: $("#editEventLang").value, host_org: $("#editHostOrg").value?.trim() || null, zoom_url: $("#editZoomUrl").value?.trim() || null, recording_url: $("#editRecordingUrl").value?.trim() || null, start_time, end_time, topic_tags: normalizeTags($("#editTags").value) }); }); $("#btnDeleteEvent")?.addEventListener("click", () => deleteEvent($("#editEventId").value)); $('#addSpeakerBtn')?.addEventListener('click', () => { addSpeakerField('speakersContainer'); }); $('#addEditSpeakerBtn')?.addEventListener('click', () => { addSpeakerField('editSpeakersContainer'); }); document.body.addEventListener('click', e => { if (e.target.classList.contains('remove-speaker-btn')) { e.target.closest('.speaker-row').remove(); } }); };

    (async function main() {
      applyI18n();
      initSharedUI({ applyI18n, handleLangSwitch });
      await initAuth({ onAuthReady: checkAccess, onAuthChange: checkAccess });
      wireUI();
      renderSpeakerFields('speakersContainer');
    })();
  </script>
</body>

</html>