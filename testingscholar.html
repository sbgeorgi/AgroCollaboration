<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPV Research Network | Publications & Collaboration Graph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>tailwind.config = { theme: { extend: { fontFamily: { 'inter': ['Inter', 'sans-serif'] }, colors: { 'brand': '#16a34a', 'brand-light': '#dcfce7' } } } }; </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
            height: 4px
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: 0 0
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8
        }

        .split-handle {
            cursor: col-resize;
            width: 1px;
            background: #e2e8f0;
            position: relative;
            z-index: 20;
            transition: background .2s
        }

        .split-handle::after {
            content: '';
            position: absolute;
            inset: 0 -2px;
            z-index: 10
        }

        .split-handle:active,
        .split-handle:hover {
            background: #16a34a;
            width: 2px
        }

        .pub-card {
            transition: all .2s ease;
            border-bottom: 1px solid #f1f5f9
        }

        .pub-card:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px #0000000d;
            z-index: 10;
            border-radius: 6px
        }

        .network-member {
            background-color: #dcfce7;
            color: #15803d;
            border: 1px solid #86efac
        }

        .external-author {
            background-color: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0
        }

        .d3-tooltip {
            pointer-events: none;
            position: absolute;
            background: #fffffff2;
            backdrop-filter: blur(4px);
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            z-index: 50;
            box-shadow: 0 4px 15px -3px #0000001a;
            min-width: 200px;
            font-size: 11px
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: #00000066;
            backdrop-filter: blur(2px);
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: .2s;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto
        }

        .profile-modal {
            transform: scale(.95);
            transition: .2s
        }

        .modal-overlay.active .profile-modal {
            transform: scale(1)
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin .8s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        #graphContainer {
            background: radial-gradient(circle at 1px 1px, #94a3b826 1px, transparent 1px) -8px -8px / 24px 24px
        }

        #graphContainer:active {
            cursor: grabbing
        }

        .node-label {
            paint-order: stroke;
            stroke: #ffffffcc;
            stroke-width: 3px;
            stroke-linejoin: round;
            font-family: 'Inter', sans-serif;
            letter-spacing: -.01em
        }

        input[type=range] {
            -webkit-appearance: none;
            background: 0 0
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #16a34a;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 1px 2px #0003
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 1px
        }

        .timeline-bar {
            fill: #16a34a;
            opacity: .4;
            cursor: pointer;
            transition: opacity .15s
        }

        .timeline-bar:hover {
            opacity: .8
        }

        .timeline-bar.selected {
            opacity: 1;
            fill: #15803d
        }
    </style>
</head>

<body class="bg-white text-slate-700 h-screen w-screen flex overflow-hidden">
    <aside
        class="w-[320px] flex flex-col border-r border-slate-200 bg-slate-50/80 shrink-0 h-full z-30 backdrop-blur-sm">
        <div class="p-4 border-b border-slate-200 bg-white">
            <div class="flex items-center gap-2.5 mb-3">
                <div
                    class="w-8 h-8 rounded-lg bg-green-600 text-white flex items-center justify-center shadow-md shadow-green-200/50">
                    <i class="fas fa-leaf text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-slate-800 text-sm leading-tight">AgriPV Network</h1>
                    <p class="text-[9px] text-slate-400 font-medium uppercase tracking-wider">Research Explorer</p>
                </div>
            </div>
            <div class="relative group">
                <input type="text" id="globalSearch" placeholder="Search title, author, topic..."
                    class="w-full bg-slate-100 border-none rounded-md py-2 pl-9 pr-3 text-xs font-medium focus:ring-1 focus:ring-green-500 focus:bg-white transition-all placeholder:text-slate-400">
                <i
                    class="fas fa-search text-slate-400 absolute left-3 top-2.5 text-xs group-focus-within:text-green-600"></i>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-5">
            <div>
                <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">Network Stats</h3>
                <div class="grid grid-cols-2 gap-2" id="statsGrid"></div>
            </div>
            <div>
                <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">Publication Timeline</h3>
                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-2">
                    <svg id="timelineChart" width="100%" height="50"></svg>
                    <div class="text-[8px] text-slate-400 mt-1 leading-snug text-center">Click to filter. Shift+click
                        for range.</div>
                </div>
            </div>
            <div>
                <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">Relevance Threshold</h3>
                <div class="bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm">
                    <div class="flex justify-between mb-1.5"><label class="text-[9px] font-semibold text-slate-500">Min
                            Score</label><span class="text-[9px] font-mono text-green-600 font-bold"
                            id="valMinRel">3.0</span></div>
                    <input type="range" id="minRelevance" min="0" max="30" step="0.5" value="2" class="w-full block">
                    <div class="text-[9px] text-slate-400 mt-1.5 leading-snug">Strictness filter. Lower for broad,
                        Higher for core.</div>
                </div>
            </div>
            <div>
                <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">Publication Year</h3>
                <div class="flex items-center gap-2 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                    <input type="number" id="yearFrom" min="2000" max="2026" placeholder="2000"
                        class="w-full border-none bg-transparent text-center text-xs font-medium focus:ring-0 p-1 text-slate-600">
                    <span class="text-slate-300 text-[10px] uppercase font-bold">to</span>
                    <input type="number" id="yearTo" min="2000" max="2026" placeholder="2025"
                        class="w-full border-none bg-transparent text-center text-xs font-medium focus:ring-0 p-1 text-slate-600">
                </div>
            </div>
            <div class="flex flex-col h-40">
                <div class="flex justify-between items-center mb-1.5">
                    <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Institutions</h3><button
                        class="text-[9px] text-green-600 font-semibold hover:underline"
                        onclick="app.clear('insts')">Reset</button>
                </div>
                <div id="institutionFilters" class="flex-1 overflow-y-auto custom-scroll pr-1 space-y-0.5"></div>
            </div>
            <div class="flex flex-col h-40">
                <div class="flex justify-between items-center mb-1.5">
                    <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Topics</h3><button
                        class="text-[9px] text-green-600 font-semibold hover:underline"
                        onclick="app.clear('topics')">Reset</button>
                </div>
                <div id="topicFilters" class="flex flex-wrap gap-1 pb-2"></div>
            </div>
        </div>
        <div id="activeFiltersPanel" class="px-4 py-3 bg-white border-t border-slate-200 hidden shrink-0">
            <div class="flex justify-between items-center mb-2"><span
                    class="text-[10px] font-semibold text-slate-500"><span id="activeFilterCount">0</span> filters
                    active</span><button class="text-[9px] text-red-500 font-semibold hover:text-red-700"
                    onclick="app.reset()">Clear All</button></div>
            <div id="activeFilterTags" class="flex flex-wrap gap-1 max-h-14 overflow-y-auto custom-scroll"></div>
        </div>
    </aside>
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-white relative">
        <header class="h-12 border-b border-slate-200 flex items-center justify-between px-4 bg-white shrink-0 z-20">
            <div class="flex gap-0.5 p-0.5 bg-slate-100 rounded-md border border-slate-200">
                <button data-view="both"
                    class="view-btn px-2.5 py-1 text-[11px] font-semibold rounded bg-white shadow-sm text-slate-800"><i
                        class="fas fa-columns mr-1.5"></i>Split</button>
                <button data-view="publications"
                    class="view-btn px-2.5 py-1 text-[11px] font-semibold rounded text-slate-500 hover:text-slate-700"><i
                        class="fas fa-list mr-1.5"></i>List</button>
                <button data-view="network"
                    class="view-btn px-2.5 py-1 text-[11px] font-semibold rounded text-slate-500 hover:text-slate-700"><i
                        class="fas fa-project-diagram mr-1.5"></i>Graph</button>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-[11px] text-slate-500 font-medium">Found <span id="filteredCount"
                        class="text-slate-900 font-bold">0</span> results</div>
                <div class="h-3 w-px bg-slate-300"></div>
                <select id="sortSelect"
                    class="text-[11px] font-medium bg-transparent border-none outline-none text-slate-600 cursor-pointer hover:text-slate-900 focus:ring-0 py-0 pl-0 pr-6">
                    <option value="recent">Newest First</option>
                    <option value="relevance">Relevance Score</option>
                    <option value="cited">Most Cited</option>
                    <option value="title">A-Z Title</option>
                </select>
                <div class="relative" id="exportDropdown">
                    <button
                        class="px-2.5 py-1 bg-slate-900 text-white text-[11px] font-semibold rounded hover:bg-slate-800 shadow-sm transition-colors flex items-center gap-1.5"
                        onclick="app.toggleExportMenu()"><i class="fas fa-download"></i>Export <i
                            class="fas fa-chevron-down text-[8px] opacity-60"></i></button>
                    <div id="exportMenu"
                        class="absolute right-0 top-full mt-1 w-44 bg-white border border-slate-200 rounded-lg shadow-lg py-1 hidden z-50">
                        <button onclick="app.exportCSV()"
                            class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                class="fas fa-file-csv w-4 text-green-600"></i>CSV Spreadsheet</button>
                        <button onclick="app.exportBibTeX()"
                            class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                class="fas fa-code w-4 text-purple-600"></i>BibTeX (.bib)</button>
                        <button onclick="app.exportRIS()"
                            class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                class="fas fa-file-import w-4 text-blue-600"></i>RIS (Zotero)</button>
                        <div class="border-t border-slate-100 my-1"></div>
                        <button onclick="app.exportGraphSVG()"
                            class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                class="fas fa-image w-4 text-rose-600"></i>Graph as SVG</button>
                        <button onclick="app.exportGraphPNG()"
                            class="w-full text-left px-3 py-1.5 text-[11px] font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i
                                class="fas fa-file-image w-4 text-orange-600"></i>Graph as PNG</button>
                    </div>
                </div>
            </div>
        </header>
        <div id="contentArea" class="flex-1 flex overflow-hidden relative">
            <div id="publicationsPanel" class="flex flex-col min-w-0 w-1/2 bg-white h-full border-r border-slate-100">
                <div id="publicationsList" class="flex-1 overflow-y-auto p-2 custom-scroll bg-white"></div>
                <div class="p-2 border-t border-slate-200 bg-white shrink-0 flex flex-col gap-2">
                    <div class="flex justify-between items-center text-[10px] text-slate-400 px-1"><span><span
                                id="showingFrom">0</span>-<span id="showingTo">0</span> of <span
                                id="totalPublications">0</span></span></div>
                    <div id="paginationContainer" class="flex justify-center gap-1"></div>
                </div>
            </div>
            <div id="splitHandle" class="split-handle" title="Drag to resize"></div>
            <div id="networkPanel" class="flex flex-col min-w-0 w-1/2 bg-slate-50 relative h-full">
                <div class="absolute top-3 left-3 z-10 flex flex-col gap-2">
                    <div
                        class="bg-white/80 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-0.5 flex flex-col gap-0.5">
                        <button
                            class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                            onclick="app.zoom(1.3)" title="Zoom In"><i class="fas fa-plus text-[10px]"></i></button>
                        <button
                            class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                            onclick="app.zoom(0.7)" title="Zoom Out"><i class="fas fa-minus text-[10px]"></i></button>
                        <button
                            class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                            onclick="app.fitGraph()" title="Fit to Screen"><i
                                class="fas fa-compress-arrows-alt text-[10px]"></i></button>
                    </div>
                    <div
                        class="bg-white/80 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-0.5 flex flex-col gap-0.5">
                        <button
                            class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                            onclick="app.toggleCluster()" title="Toggle Grouping"><i
                                class="fas fa-layer-group text-[10px]"></i></button>
                        <button
                            class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600"
                            onclick="app.toggleLabels()" title="Toggle Labels"><i
                                class="fas fa-tag text-[10px]"></i></button>
                    </div>
                </div>
                <div class="absolute top-3 right-3 z-10">
                    <div
                        class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-2 w-32 space-y-2">
                        <div>
                            <div class="flex justify-between mb-0.5"><label
                                    class="text-[8px] font-bold text-slate-400 uppercase">Link Dist</label></div><input
                                type="range" id="linkDistance" min="50" max="320" value="120" class="w-full block">
                        </div>
                        <div>
                            <div class="flex justify-between mb-0.5"><label
                                    class="text-[8px] font-bold text-slate-400 uppercase">Gravity</label></div><input
                                type="range" id="chargeStrength" min="100" max="900" value="320" class="w-full block">
                        </div>
                    </div>
                </div>
                <div class="absolute bottom-3 left-3 z-10 pointer-events-none">
                    <div
                        class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-2 max-h-32 overflow-y-auto custom-scroll w-40 pointer-events-auto">
                        <div class="text-[8px] font-bold text-slate-400 uppercase mb-1">Affiliations</div>
                        <div id="legendContainer" class="space-y-0.5"></div>
                    </div>
                </div>
                <div id="graphContainer" class="flex-1 w-full h-full cursor-grab overflow-hidden"><svg id="networkGraph"
                        width="100%" height="100%"></svg></div>
                <div id="tooltip" class="d3-tooltip hidden"></div>
            </div>
        </div>
    </main>
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="spinner mb-4 border-slate-200 border-t-green-600"></div>
        <h3 class="text-base font-bold text-slate-800 tracking-tight">Initializing Explorer</h3>
        <p id="loadingStatus" class="text-xs text-slate-400 mt-1 font-medium">Connecting to network...</p>
        <div class="w-48 bg-slate-100 rounded-full h-1 mt-6 overflow-hidden">
            <div id="loadingProgress" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
        </div>
    </div>
    <div id="citationModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="profile-modal w-full max-w-lg bg-white rounded-xl shadow-2xl border border-slate-100 p-5">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                <h3 class="font-bold text-sm text-slate-800">Cite Publication</h3><button
                    onclick="document.getElementById('citationModal').classList.remove('active')"
                    class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">APA</label>
                    <div
                        class="bg-slate-50 p-2.5 rounded border border-slate-200 relative group text-xs text-slate-600 font-mono leading-relaxed">
                        <span id="citeAPA"></span><button
                            class="absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-white border border-slate-200 rounded shadow-sm text-slate-400 hover:text-green-600 text-[10px]"
                            onclick="app.copy('citeAPA')"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">BibTeX</label>
                    <div
                        class="bg-slate-50 p-2.5 rounded border border-slate-200 relative group text-xs text-slate-600 font-mono leading-relaxed break-all">
                        <span id="citeBib"></span><button
                            class="absolute top-1.5 right-1.5 px-1.5 py-0.5 bg-white border border-slate-200 rounded shadow-sm text-slate-400 hover:text-green-600 text-[10px]"
                            onclick="app.copy('citeBib')"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="detailModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div
            class="profile-modal w-full max-w-4xl max-h-[90vh] bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div id="detailContent" class="overflow-y-auto p-8 custom-scroll"></div>
        </div>
    </div>
    <div id="researcherModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div
            class="profile-modal w-full max-w-lg bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden max-h-[85vh]">
            <div id="researcherContent" class="overflow-y-auto custom-scroll p-0"></div>
        </div>
    </div>
    <script type="module">
        import { supabase } from "./auth.js";
        const sleep = ms => new Promise(r => setTimeout(r, ms)), el = id => document.getElementById(id), norm = s => (s || "").trim().toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " "), esc = s => s ? s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])) : "", jsStr = s => (s || "").replace(/\\/g, "\\\\").replace(/'/g, "\\'"), clamp = (v, a, b) => Math.max(a, Math.min(b, v));
        const COLORS = ["#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6", "#06b6d4", "#ec4899", "#6366f1", "#84cc16", "#f97316", "#64748b", "#14b8a6"];
        const CFG = { api: "https://api.openalex.org", key: "asf_network_v7", now: new Date().getFullYear(), minRel: 1.0, cap: 250, conc: 10, defMin: 3.0 };

        // IMPROVED REGEX ENGINE
        const RX = {
            // Updated to catch plurals (agrivoltaics) and hyphenated variations correctly
            explicit: /\b(agri[\s-]?(pv|photo)?voltai[ckqs]?(s)?|agro[\s-]?(photo)?voltai[ckqs]?(s)?|agri[\s-]?pv|agro[\s-]?pv|solar[\s-]?sharing|solar[\s-]?farming|farming[\s-]?(with|under)[\s-]?(solar|pv)|photovoltaic[\s-]?greenhouse|greenhouse[\s-]?photovoltaic)\b/i,
            // Component parts
            solar: /\b(pv|photovoltai[ckqs]?|solar(\s*(modules?|panels?|arrays?|energy|power|cells?|installation|park|farm))?)\b/i,
            agri: /\b(crop|yield|harvest|plant|biomass|farm(ing|er)?|agricultur|agronom|horticultur|viticultur|orchard|vineyard|greenhouse|livestock|pasture|grazing|sheep|cattle|food\s*production|arable|cultivat)\b/i,
            // Interaction terms (The "Glue" - highly predictive of APV)
            interaction: /\b(dual[\s-]?use|co[\s-]?locat(ion|ed)|combin(ed|ing)|integrat(ed|ion)|under|beneath|between|inter[\s-]?space|shading\s*effect|micro[\s-]?climat|land[\s-]?use[\s-]?efficien|ler\b|land[\s-]?equivalent[\s-]?ratio|photosynthetic|par\b|transmittan|light\s*distribution|water\s*saving)\b/i,
            // Tech specific
            tech: /\b(bifacial|spectral|stilted|elevation|tilt|ground\s*cover|vertical\s*mount|tracker|soil\s*moisture)\b/i,
            // Exclusion list
            neg: /\b(oncolog|cancer|tumor|biomed|patient|surgery|galaxy|telescope|quantum|nano(?!.*(grid|farm|solar))|perovskite(?!.*(greenhouse|crop))|thin[\s-]?film(?!.*(greenhouse|crop)))\b/i
        };

        const INST_MAP = [['arizona', 'Univ. of Arizona'], ['unam', 'UNAM'], ['nacional autonoma', 'UNAM'], ['chile', 'Univ. de Chile'], ['fraunhofer', 'Fraunhofer ISE'], ['wageningen', 'Wageningen UR'], ['nrel', 'NREL'], ['davis', 'UC Davis'], ['umass', 'UMass Amherst'], ['massachusetts', 'UMass Amherst']];
        const TOPIC_BLOCK = new Set(["medicine", "physics", "materials science", "computer science", "chemistry", "biology", "mathematics", "philosophy", "art", "psychology", "geology", "sociology"]);
        const Storage = { get: k => { try { const i = JSON.parse(localStorage.getItem(k)); return i && i.e > Date.now() ? i.v : null } catch { return null } }, set: (k, v) => { try { localStorage.removeItem(k); localStorage.setItem(k, JSON.stringify({ v, e: Date.now() + 2592e6 })) } catch (e) { try { localStorage.clear(); localStorage.setItem(k, JSON.stringify({ v, e: Date.now() + 2592e6 })) } catch { } } } };
        const fetchJSON = async (url, r = 3) => { url += (url.includes('?') ? '&' : '?') + 'mailto=research-tool@agripv.org'; for (let i = 0; i < r; i++) { try { const d = await fetch(url); if (d.ok) return await d.json(); if (d.status === 429) await sleep((parseFloat(d.headers.get("Retry-After") || 1) * 1000) * (i + 1)); else if (d.status >= 500) await sleep(500 * (i + 1)); else return null } catch { if (i === r - 1) return null; await sleep(250) } } };
        const getInst = i => { if (!i) return "Unknown"; const l = norm(i), h = INST_MAP.find(x => l.includes(x[0])); return h ? h[1] : i.replace(/university/gi, 'Univ.').replace(/institute/gi, 'Inst.').split(',')[0].trim().substring(0, 28) };

        // UPDATED SCORING FUNCTION
        const scoreWork = (w, abs = "") => {
            let s = 0, why = [];
            const t = norm(w.title || ""), kw = norm((w.keywords || []).map(k => k.display_name || k.keyword).join(" ")), ab = norm(abs);
            const full = `${t} ${kw} ${ab}`;

            // 1. EXPLICIT MATCHES (Heavily weighted to fix the "4.1" issue)
            const expT = RX.explicit.test(t);
            const expK = !expT && RX.explicit.test(kw);
            const expA = !expT && !expK && RX.explicit.test(ab);

            if (expT) { s += 45; why.push('explicit-title'); } // Immediate Core status
            else if (expK) { s += 30; why.push('explicit-keyword'); }
            else if (expA) { s += 20; why.push('explicit-abstract'); }

            // 2. COMPONENT MATCHES (Solar + Agri)
            const hasSolar = RX.solar.test(full);
            const hasAgri = RX.agri.test(full);
            const hasInt = RX.interaction.test(full);
            
            if (hasSolar && hasAgri) {
                // Proximity Check: Look for Solar near Agri in Title/Abstract
                // This rewards "Crop yield under PV" even if "Agrivoltaics" isn't said
                const proxRx = /\b(solar|pv|photovoltai).{0,80}(crop|farm|agri|plant|yield|soil)|(crop|farm|agri|plant|yield|soil).{0,80}(solar|pv|photovoltai)/i;
                
                if (proxRx.test(t)) { s += 20; why.push('solar+agri-prox-title'); }
                else if (proxRx.test(ab)) { s += 12; why.push('solar+agri-prox-abs'); }
                else { s += 5; why.push('solar+agri-dist'); }

                if (hasInt) { s += 8; why.push('interaction-term'); }
            } else if (hasSolar && hasInt) {
                // "Solar" + "Land use efficiency" implies APV
                s += 5; why.push('solar+interaction');
            }

            // 3. TECHNICAL & CONTEXT BONUSES
            if (RX.tech.test(full)) { s += 3; why.push('tech-detail'); }
            if (w.concepts?.some(c => norm(c.display_name).includes('agrivoltaic') && c.score > 0.4)) { s += 10; why.push('concept-match'); }

            // 4. METADATA BOOSTS
            s += Math.min(4, Math.log10((w.cited_by_count || 0) + 1) * 1.5); 
            if (w.publication_year >= CFG.now - 2) s += 1.5;

            // 5. PENALTIES
            if (RX.neg.test(full) && !expT && !expK) { 
                s -= 30; why.push('neg-filter'); 
            }

            s = Math.max(0, Math.round(s * 10) / 10);
            return { s, why, strong: s >= 15, tier: s >= 35 ? 'Core' : s >= 15 ? 'Strong' : s >= 8 ? 'Related' : 'Peripheral' };
        };

        const app = {
            data: { researchers: [], pubs: [], topics: new Map, graph: { nodes: [], links: [] } },
            state: { filters: { q: '', topics: new Set, insts: new Set, yFrom: null, yTo: null, minRel: CFG.defMin }, page: 1, sort: 'recent', graph: { cluster: true, labels: true }, lastFiltered: [] },
            d3: {}, instColors: new Map,
            init: async () => {
                app.setupUI(); app.setupGraph(); const pg = (p, t) => { el('loadingProgress').style.width = p + '%'; el('loadingStatus').textContent = t };
                try {
                    pg(8, "Fetching network members..."); const { data: P } = await supabase.from("profiles").select("id,full_name,work_email,affiliation").not("full_name", "is", null);
                    if (!P?.length) throw "No members"; const hx = P.map(p => p.id).sort().join('|'), c = Storage.get(CFG.key);
                    if (Storage.get(CFG.key + "_hash") === hx && c) { pg(85, "Loading from cache..."); app.restore(c) } else {
                        pg(18, "Resolving profiles..."); const R = await app.resolve(P, pg);
                        pg(38, "Fetching publications..."); const W = await app.fetchWorks(R, pg); app.build(R, W); Storage.set(CFG.key + "_hash", hx); Storage.set(CFG.key, app.pack())
                    }
                    pg(100, "Done"); setTimeout(() => { el('loadingOverlay').classList.add('hidden'); app.render(); setTimeout(app.fitGraph, 400) }, 450);
                } catch (e) { console.error(e); alert("Failed to load data.") }
            },
            resolve: async (P, pg) => {
                const out = [], chk = 12; for (let i = 0; i < P.length; i += chk) {
                    out.push(...await Promise.all(P.slice(i, i + chk).map(async p => {
                        let qn = p.full_name; if (/[\._\d]/.test(qn)) qn = qn.replace(/[\._]/g, ' ').replace(/\d+/g, '').trim();
                        const d = await fetchJSON(`${CFG.api}/authors?search=${encodeURIComponent(qn)}&per_page=10&select=id,display_name,works_count,cited_by_count,last_known_institutions`), w = norm(qn), af = norm(p.affiliation || "");
                        let best = null, bS = -1; (d?.results || []).forEach(r => { let sc = 0, n = norm(r.display_name || ""), in_ = norm(r.last_known_institutions?.[0]?.display_name || ""); if (n === w) sc += 10; else if (n.includes(w) || w.includes(n)) sc += 4; if (af && in_ && (in_.includes(af) || af.includes(in_) || in_.split(' ').some(x => x.length > 4 && af.includes(x)))) sc += 4; sc += Math.min(2, (r.works_count || 0) / 200); if (sc > bS) { bS = sc; best = r } });
                        const m = best || d?.results?.[0], inst = getInst(m?.last_known_institutions?.[0]?.display_name || p.affiliation);
                        return { id: m?.id || `local:${p.id}`, display_name: m?.display_name || p.full_name, inst, color: app.col(inst), net_works: 0, net_cited: 0, topics: {}, deg: 0 }
                    }))); pg(18 + (Math.min(i + chk, P.length) / P.length) * 18, "Resolving profiles..."); await sleep(30);
                } return out;
            },
            fetchWorks: async (A, pg) => {
                const ids = A.filter(a => !a.id.startsWith('local:')).map(a => a.id), W = new Map, batches = [];
                for (let i = 0; i < ids.length; i += 25)batches.push(ids.slice(i, i + 25));
                let done = 0; for (let i = 0; i < batches.length; i += 3)await Promise.all(batches.slice(i, i + 3).map(async b => {
                    let cur = '*', p = 0; while (cur && p++ < 10) {
                        const r = await fetchJSON(`${CFG.api}/works?filter=authorships.author.id:${b.join('|')},from_publication_date:${Math.max(1990, CFG.now - 20)}-01-01&per_page=200&cursor=${encodeURIComponent(cur)}&select=id,title,publication_year,cited_by_count,type,primary_location,open_access,doi,authorships,concepts,topics,keywords`);
                        (r?.results || []).forEach(w => { if (!W.has(w.id)) { const rl = scoreWork(w); if (rl.s >= CFG.minRel || rl.strong) W.set(w.id, { ...w, _relevance: rl.s, _why: rl.why, _tier: rl.tier }) } }); cur = r?.meta?.next_cursor; if (cur) await sleep(20);
                    } done++; pg(38 + (done / batches.length) * 42, "Fetching publications...");
                }));
                const brd = [...W.values()].filter(w => w._relevance < (CFG.defMin + 1.5) && w._relevance >= CFG.minRel && !w._why?.some(x => x.includes('explicit'))).sort((a, b) => b._relevance - a._relevance).slice(0, CFG.cap);
                if (brd.length) { let k = 0; pg(82, `Improving targeting (${brd.length})...`); await Promise.all(Array.from({ length: CFG.conc }, async () => { while (k < brd.length) { const w = brd[k++], d = await fetchJSON(`${CFG.api}/works/${w.id.split('/').pop()}?select=abstract_inverted_index`), ab = d?.abstract_inverted_index ? Object.entries(d.abstract_inverted_index).reduce((a, [x, y]) => (y.forEach(p => a[p] = x), a), []).join(' ') : ""; if (ab) { const rl = scoreWork(w, ab); if (rl.s > w._relevance) { w._relevance = rl.s; w._tier = rl.tier; w._why = [...new Set([...(w._why || []), ...rl.why, 'abs'])] } } pg(82 + (k / brd.length) * 10, `Improving targeting...`); await sleep(15) } })) }
                return [...W.values()]
            },
            build: (R, P) => {
                const rM = new Map(R.map(r => [r.id, r])); app.data.pubs = P.map(p => {
                    const m = (p.authorships || []).filter(a => rM.has(a.author?.id)).map(a => rM.get(a.author.id)); if (!m.length) return null;
                    const ts = (p.topics || []).filter(t => (t.score || 0) >= 0.25).map(t => t.display_name).filter(Boolean).slice(0, 7);
                    if (!ts.length) ts.push(...(p.concepts || []).filter(c => (c.score || 0) > 0.55 && (c.level || 0) > 0 && !TOPIC_BLOCK.has(norm(c.display_name))).map(c => c.display_name).slice(0, 7));
                    m.forEach(r => { r.net_works++; r.net_cited += (p.cited_by_count || 0); ts.forEach(t => { r.topics[t] = (r.topics[t] || 0) + 1; app.data.topics.set(t, (app.data.topics.get(t) || 0) + 1) }) });
                    return { id: p.id, title: p.title, publication_year: p.publication_year, cited_by_count: p.cited_by_count || 0, doi: p.doi, url: p.primary_location?.landing_page_url || p.doi || p.primary_location?.pdf_url, source: p.primary_location?.source?.display_name, is_oa: p.open_access?.is_oa, type: p.type, _relevance: p._relevance || 0, _why: p._why || [], _tier: p._tier || 'Weak', _topics: ts, _allAuthors: (p.authorships || []).map(a => ({ id: a.author?.id, name: a.author?.display_name, isMember: rM.has(a.author?.id) })), _memberAuthors: m }
                }).filter(Boolean); app.data.researchers = R.filter(r => app.data.pubs.some(p => p._memberAuthors.includes(r))); app.buildGraph();
            },
            buildGraph: () => {
                const L = new Map, D = new Map; app.data.pubs.forEach(p => { const i = p._memberAuthors.map(a => a.id); for (let x = 0; x < i.length; x++)for (let y = x + 1; y < i.length; y++) { const k = [i[x], i[y]].sort().join('|'), l = L.get(k) || { source: i[x], target: i[y], weight: 0 }; l.weight++; L.set(k, l); D.set(i[x], (D.get(i[x]) || 0) + 1); D.set(i[y], (D.get(i[y]) || 0) + 1) } });
                app.data.graph = { nodes: app.data.researchers.map(r => ({ ...r, deg: D.get(r.id) || 0, radius: clamp(10 + Math.sqrt(r.net_works || 0) * 3 + Math.sqrt(D.get(r.id) || 0) * 1.5, 10, 30) })), links: [...L.values()] }
            },
            pack: () => {
                const D = { t: [], s: [] }, gx = (a, v) => { if (!v) return -1; let i = a.indexOf(v); return i === -1 ? (a.push(v), a.length - 1) : i };
                return { r: app.data.researchers.map(r => ({ id: r.id, n: r.display_name, i: r.inst, nw: r.net_works, nc: r.net_cited, t: Object.keys(r.topics).map(t => gx(D.t, t)), d: r.deg })), p: app.data.pubs.map(p => ({ id: p.id, t: p.title, y: p.publication_year, c: p.cited_by_count, d: p.doi, u: p.url, s: gx(D.s, p.source), oa: p.is_oa ? 1 : 0, r: p._relevance, w: p._why, ti: p._tier === 'Core' ? 3 : (p._tier === 'Strong' ? 2 : 1), tp: p._topics.map(t => gx(D.t, t)), aa: p._allAuthors.slice(0, 10).map(a => a.name), ma: p._memberAuthors.map(m => m.id) })), D }
            },
            restore: c => {
                const D = c.D || { t: [], s: [] };
                app.data.researchers = c.r.map(r => ({ id: r.id, display_name: r.n, inst: r.i, net_works: r.nw, net_cited: r.nc, topics: (r.t || []).reduce((a, i) => { if (D.t[i]) a[D.t[i]] = 1; return a }, {}), deg: r.d || 0, color: app.col(r.i) }));
                const rM = new Map(app.data.researchers.map(r => [r.id, r]));
                app.data.pubs = c.p.map(p => { const m = (p.ma || []).map(i => rM.get(i)).filter(Boolean); return { id: p.id, title: p.t, publication_year: p.y, cited_by_count: p.c, doi: p.d, url: p.u, source: typeof p.s === 'number' ? D.s[p.s] : p.s, is_oa: !!p.oa, type: p.ty, _relevance: p.r, _why: p.w || [], _tier: p.ti === 3 ? 'Core' : (p.ti === 2 ? 'Strong' : 'Weak'), _topics: (p.tp || []).map(i => D.t[i]), _allAuthors: (p.aa || []).map(n => { const f = m.find(z => z.display_name === n); return { name: n, id: f ? f.id : null, isMember: !!f } }), _memberAuthors: m } });
                app.data.topics = new Map; app.data.pubs.forEach(p => p._topics.forEach(t => app.data.topics.set(t, (app.data.topics.get(t) || 0) + 1))); app.buildGraph()
            },
            col: i => { if (!app.instColors.has(i)) app.instColors.set(i, COLORS[app.instColors.size % COLORS.length]); return app.instColors.get(i) },
            render: () => {
                const { q, topics: T, insts: I, yFrom: yf, yTo: yt, minRel: mr } = app.state.filters, ql = norm(q);
                const F = app.data.pubs.filter(p => p._relevance >= mr && (!yf || p.publication_year >= yf) && (!yt || p.publication_year <= yt) && (!I.size || p._memberAuthors.some(a => I.has(a.inst))) && (!T.size || p._topics.some(t => T.has(t))) && (!ql || norm(p.title).includes(ql) || p._allAuthors.some(a => norm(a.name).includes(ql)) || p._topics.some(t => norm(t).includes(ql))));
                app.state.lastFiltered = F;
                const am = new Set(F.flatMap(p => p._memberAuthors.map(a => a.id)));
                el('statsGrid').innerHTML = [['MEMBERS', am.size], ['WORKS', F.length], ['CITES', F.reduce((s, p) => s + p.cited_by_count, 0)], ['TOPICS', new Set(F.flatMap(p => p._topics)).size]].map(([l, v]) => `<div class="bg-white p-2 rounded-lg border border-slate-200 shadow-sm flex flex-col items-center justify-center"><span class="text-base font-bold text-slate-700 leading-none">${typeof v === 'number' && v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v}</span><span class="text-[8px] text-slate-400 font-bold mt-0.5">${l}</span></div>`).join('');
                el('filteredCount').textContent = F.length; app.renderTimeline(F);
                F.sort({ cited: (a, b) => b.cited_by_count - a.cited_by_count, relevance: (a, b) => b._relevance - a._relevance || b.cited_by_count - a.cited_by_count, title: (a, b) => a.title.localeCompare(b.title), recent: (a, b) => b.publication_year - a.publication_year || b._relevance - a._relevance }[app.state.sort]);
                const sz = 12, pgs = Math.ceil(F.length / sz), pg = app.state.page = clamp(app.state.page, 1, Math.max(1, pgs)), st = (pg - 1) * sz;
                el('publicationsList').innerHTML = F.slice(st, st + sz).map(p => `<div class="pub-card p-3 bg-white mb-2 cursor-pointer" onclick="app.detail('${p.id}')"><div class="flex items-start justify-between gap-2 mb-1.5"><h4 class="font-bold text-slate-800 text-xs leading-snug flex-1">${esc(p.title)}</h4><div class="shrink-0 flex items-center gap-1">${p.is_oa ? '<span class="px-1.5 py-0.5 bg-amber-50 text-amber-700 text-[8px] font-bold rounded border border-amber-100 uppercase">OA</span>' : ''} ${p._tier === 'Core' ? '<span class="px-1.5 py-0.5 rounded text-[8px] font-bold uppercase bg-green-100 text-green-800 border border-green-200">Core</span>' : (p._tier === 'Strong' ? '<span class="px-1.5 py-0.5 rounded text-[8px] font-bold uppercase bg-blue-50 text-blue-700 border border-blue-200">Strong</span>' : '')}</div></div><div class="flex flex-wrap gap-1 mb-2">${p._allAuthors.slice(0, 5).map(a => `<span class="px-1.5 py-0.5 rounded text-[9px] truncate max-w-[100px] ${a.isMember ? 'network-member font-medium' : 'external-author'}">${esc(a.name)}</span>`).join('')}${p._allAuthors.length > 5 ? `<span class="text-[9px] text-slate-400 self-center">+${p._allAuthors.length - 5}</span>` : ''}</div><div class="flex items-center gap-3 text-[9px] text-slate-500 font-medium"><span class="flex items-center gap-1"><i class="fas fa-calendar-alt text-slate-400"></i> ${p.publication_year || ''}</span><span class="flex items-center gap-1"><i class="fas fa-quote-right text-slate-400"></i> ${p.cited_by_count}</span><span class="ml-auto text-green-700 bg-green-50 px-1.5 py-0.5 rounded border border-green-100 font-semibold">Score: ${p._relevance.toFixed(1)}</span><div class="flex gap-1 ml-1"><button class="hover:text-brand p-1" onclick="event.stopPropagation();app.cite('${p.id}')" title="Cite"><i class="fas fa-quote-left"></i></button>${p.url ? `<a href="${p.url}" target="_blank" onclick="event.stopPropagation()" class="hover:text-blue-600 p-1" title="Open Source"><i class="fas fa-external-link-alt"></i></a>` : ''}</div></div></div>`).join('') || '<div class="text-center py-20 text-slate-400 text-xs">No results found matching your criteria.</div>';
                el('publicationsList').scrollTop = 0;['showingFrom', 'showingTo', 'totalPublications'].forEach((id, i) => el(id).textContent = [F.length ? st + 1 : 0, Math.min(st + sz, F.length), F.length][i]);
                const btns = [], addB = (p, l, a) => btns.push(`<button onclick="app.setPage(${p})" class="w-6 h-6 flex items-center justify-center rounded text-[9px] font-medium transition-colors ${a ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">${l}</button>`);
                if (pgs > 1) { addB(Math.max(1, pg - 1), '<i class="fas fa-chevron-left"></i>'); (pgs <= 5 ? Array.from({ length: pgs }, (_, i) => i + 1) : (pg <= 3 ? [1, 2, 3, '...', pgs] : (pg >= pgs - 2 ? [1, '...', pgs - 2, pgs - 1, pgs] : [1, '...', pg, pg + 1, '...', pgs]))).forEach(x => x === '...' ? btns.push('<span class="text-[9px] text-slate-400 self-end px-1">...</span>') : addB(x, x, x === pg)); addB(Math.min(pgs, pg + 1), '<i class="fas fa-chevron-right"></i>') }
                el('paginationContainer').innerHTML = btns.join(''); app.renderGraph(F, am);
                const ic = new Map, tc = new Map; app.data.researchers.forEach(r => am.has(r.id) && ic.set(r.inst, (ic.get(r.inst) || 0) + 1)); F.forEach(p => p._topics.forEach(t => tc.set(t, (tc.get(t) || 0) + 1)));
                el('institutionFilters').innerHTML = [...ic].sort((a, b) => b[1] - a[1]).map(([i, c]) => `<label class="flex items-center gap-1.5 cursor-pointer hover:bg-slate-50 p-1 rounded group transition-colors"><input type="checkbox" onchange="app.tog('insts','${jsStr(i)}')" class="rounded border-slate-300 text-green-600 focus:ring-green-500 w-3 h-3" ${I.has(i) ? 'checked' : ''}><div class="w-1.5 h-1.5 rounded-full shrink-0" style="background:${app.col(i)}"></div><span class="text-[10px] text-slate-600 truncate flex-1 group-hover:text-slate-900">${esc(i)}</span><span class="text-[8px] text-slate-400 font-mono bg-slate-100 px-1 rounded">${c}</span></label>`).join('');
                el('topicFilters').innerHTML = [...tc].sort((a, b) => b[1] - a[1]).slice(0, 35).map(([t, c]) => `<button onclick="app.tog('topics','${jsStr(t)}')" class="px-1.5 py-0.5 rounded text-[9px] transition-all border flex items-center gap-1 ${T.has(t) ? 'bg-green-100 text-green-800 border-green-200 font-semibold' : 'bg-slate-50 text-slate-500 border-transparent hover:bg-white hover:border-slate-200'}">${esc(t)} <span class="opacity-50 text-[8px]">${c}</span></button>`).join('');
                el('activeFiltersPanel').classList.toggle('hidden', !(T.size + I.size)); el('activeFilterCount').textContent = T.size + I.size;
                const tag = (l, k, c) => `<span class="${c} px-1.5 py-0.5 rounded border text-[9px] flex gap-1 items-center font-medium">${esc(l)}<button onclick="app.tog('${k}','${jsStr(l)}')" class="hover:text-red-500 ml-0.5"><i class="fas fa-times"></i></button></span>`;
                el('activeFilterTags').innerHTML = [...T].map(t => tag(t, 'topics', 'bg-green-50 text-green-700 border-green-200')).join('') + [...I].map(i => tag(i, 'insts', 'bg-blue-50 text-blue-700 border-blue-200')).join('');
                const actInst = new Set(app.data.researchers.filter(r => am.has(r.id)).map(r => r.inst));
                el('legendContainer').innerHTML = [...app.instColors].filter(([i]) => actInst.has(i)).map(([i, c]) => `<div class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full shadow-sm" style="background:${c}"></span><span class="text-[9px] text-slate-600 truncate">${esc(i)}</span></div>`).join('');
            },
            renderTimeline: F => {
                const svg = d3.select('#timelineChart'); svg.selectAll('*').remove();
                const yc = new Map; F.forEach(p => p.publication_year && yc.set(p.publication_year, (yc.get(p.publication_year) || 0) + 1)); if (!yc.size) return;
                const yrs = [...yc.keys()].sort((a, b) => a - b), min = yrs[0], max = yrs[yrs.length - 1], all = Array.from({ length: max - min + 1 }, (_, i) => min + i);
                const W = el('timelineChart').clientWidth, H = 50, m = { t: 2, r: 2, b: 12, l: 2 }, x = d3.scaleBand().domain(all).range([m.l, W - m.r]).padding(0.2), y = d3.scaleLinear().domain([0, d3.max([...yc.values()]) || 1]).range([H - m.b, m.t]);
                const g = svg.append('g'), { yFrom: yf, yTo: yt } = app.state.filters;
                g.selectAll('rect').data(all).enter().append('rect').attr('class', d => `timeline-bar ${(yf && d >= yf && (!yt || d <= yt)) || (yt && d <= yt && (!yf || d >= yf)) ? 'selected' : ''}`).attr('x', d => x(d)).attr('y', d => y(yc.get(d) || 0)).attr('width', x.bandwidth()).attr('height', d => H - m.b - y(yc.get(d) || 0)).attr('rx', 1).on('click', (e, d) => { if (e.shiftKey && app.state.filters.yFrom) { app.state.filters.yTo = d; el('yearTo').value = d } else if (app.state.filters.yFrom === d && !app.state.filters.yTo) { app.state.filters.yFrom = null; app.state.filters.yTo = null; el('yearFrom').value = ''; el('yearTo').value = '' } else { app.state.filters.yFrom = d; app.state.filters.yTo = null; el('yearFrom').value = d; el('yearTo').value = '' } app.render() });
                const lbl = all.length > 12 ? 3 : (all.length > 6 ? 2 : 1); g.selectAll('.yl').data(all.filter((_, i) => i % lbl === 0 || _ === max)).enter().append('text').attr('x', d => x(d) + x.bandwidth() / 2).attr('y', H - 1).attr('text-anchor', 'middle').attr('font-size', 7).attr('fill', '#94a3b8').text(d => d.toString().slice(-2));
            },
            setupGraph: () => {
                const svg = d3.select('#networkGraph'), g = svg.append('g'), defs = svg.append('defs');
                COLORS.forEach(c => defs.append('radialGradient').attr('id', 'g-' + c.slice(1)).attr('cx', '30%').attr('cy', '30%').call(g => { g.append('stop').attr('offset', '0%').attr('stop-color', d3.color(c).brighter(1.2)); g.append('stop').attr('offset', '100%').attr('stop-color', c) }));
                const zoom = d3.zoom().scaleExtent([.1, 8]).on('zoom', e => { g.attr('transform', e.transform); app.d3.k = e.transform.k; if (app.d3.lbl) app.d3.lbl.style('display', app.state.graph.labels && app.d3.k >= 0.8 ? null : 'none') });
                app.d3 = { svg, g, zoom, sim: d3.forceSimulation().force('link', d3.forceLink().id(d => d.id).distance(120).strength(.3)).force('charge', d3.forceManyBody().strength(-320)).force('collide', d3.forceCollide().radius(d => d.radius + 4).iterations(3)), k: 1 };
                svg.call(zoom); window.onresize = app.resizeGraph; app.resizeGraph();
            },
            resizeGraph: () => {
                const c = el('graphContainer'), w = c.clientWidth || 800, h = c.clientHeight || 600; app.d3.svg.attr('viewBox', `0 0 ${w} ${h}`); app.d3.sim.force('center', d3.forceCenter(w / 2, h / 2));
                app.applyClusterForces(); app.d3.sim.alpha(.3).restart();
            },
            applyClusterForces: () => {
                if (!app.d3.nodes) return;
                if (!app.state.graph.cluster) { app.d3.sim.force('x', null).force('y', null); return }
                const c = el('graphContainer'), w = c.clientWidth || 800, h = c.clientHeight || 600, insts = [...new Set(app.d3.nodes.map(n => n.inst))].sort(), r = Math.min(w, h) * 0.28, pos = new Map(insts.map((i, x) => [i, { x: w / 2 + Math.cos((x / insts.length) * Math.PI * 2 - Math.PI / 2) * r, y: h / 2 + Math.sin((x / insts.length) * Math.PI * 2 - Math.PI / 2) * r }]));
                app.d3.sim.force('x', d3.forceX(d => pos.get(d.inst)?.x).strength(.15)).force('y', d3.forceY(d => pos.get(d.inst)?.y).strength(.15));
            },
            renderGraph: (P, vis) => {
                const nodes = app.data.graph.nodes.filter(n => vis.has(n.id)), links = app.data.graph.links.filter(l => vis.has(l.source.id || l.source) && vis.has(l.target.id || l.target));
                app.d3.nodes = nodes; const { g, sim } = app.d3; g.selectAll('*').remove();
                const adj = new Map; links.forEach(l => { const s = l.source.id || l.source, t = l.target.id || l.target; (adj.get(s) || adj.set(s, new Set).get(s)).add(t); (adj.get(t) || adj.set(t, new Set).get(t)).add(s) });
                const maxW = d3.max(links, d => d.weight) || 1, wS = d3.scaleSqrt().domain([1, maxW]).range([.5, 3]);
                const lnk = g.append('g').selectAll('line').data(links).enter().append('line').attr('stroke', '#cbd5e1').attr('stroke-opacity', d => .4 + .3 * (d.weight / maxW)).attr('stroke-width', d => wS(d.weight));
                const nd = g.append('g').selectAll('g').data(nodes).enter().append('g').call(d3.drag().on('start', (e, d) => { if (!e.active) sim.alphaTarget(.3).restart(); d.fx = d.x; d.fy = d.y }).on('drag', (e, d) => { d.fx = e.x; d.fy = e.y }).on('end', (e, d) => { if (!e.active) sim.alphaTarget(0); d.fx = null; d.fy = null }));
                nd.append('circle').attr('r', d => d.radius).attr('fill', d => `url(#g-${d.color.slice(1)})`).attr('stroke', 'rgba(255,255,255,0.3)').attr('stroke-width', 1.5).style('filter', 'drop-shadow(0 4px 6px rgba(0,0,0,0.15))').style('cursor', 'pointer');
                nd.append('text').text(d => d.display_name.split(' ').filter(Boolean).slice(0, 2).map(x => x[0]).join('').toUpperCase()).attr('dy', '0.35em').attr('text-anchor', 'middle').attr('fill', 'white').attr('font-size', d => Math.max(8, d.radius * .45)).attr('font-weight', '600').style('pointer-events', 'none');
                app.d3.lbl = nd.append('text').attr('class', 'node-label').text(d => d.display_name.split(' ').pop().replace(/[,;]/g, '')).attr('text-anchor', 'middle').attr('y', d => d.radius + 12).attr('fill', '#334155').attr('font-size', 10).attr('font-weight', '600').style('pointer-events', 'none').style('display', app.state.graph.labels ? null : 'none');
                const tip = el('tooltip'); nd.on('mouseover', (e, d) => { nd.transition().duration(200).attr('opacity', n => (n.id === d.id || adj.get(d.id)?.has(n.id)) ? 1 : .1); lnk.transition().duration(200).attr('stroke', l => ((l.source.id || l.source) === d.id || (l.target.id || l.target) === d.id) ? '#475569' : '#e2e8f0').attr('stroke-opacity', l => ((l.source.id || l.source) === d.id || (l.target.id || l.target) === d.id) ? 1 : .05); const r = el('graphContainer').getBoundingClientRect(); Object.assign(tip.style, { left: Math.min(e.clientX - r.left + 15, r.width - 210) + 'px', top: Math.min(e.clientY - r.top + 15, r.height - 140) + 'px' }); tip.innerHTML = `<div class="font-bold text-slate-800 mb-0.5">${esc(d.display_name)}</div><div class="text-[9px] text-slate-500 mb-2 font-medium truncate">${esc(d.inst)}</div><div class="flex gap-2 text-center"><div class="bg-slate-50 border rounded px-1.5 py-0.5 flex-1"><div class="font-bold text-slate-700">${d.net_works}</div><div class="text-[7px] uppercase text-slate-400">Works</div></div><div class="bg-slate-50 border rounded px-1.5 py-0.5 flex-1"><div class="font-bold text-slate-700">${d.net_cited}</div><div class="text-[7px] uppercase text-slate-400">Cites</div></div></div>`; tip.classList.remove('hidden') }).on('mouseout', () => { nd.transition().duration(200).attr('opacity', 1); lnk.transition().duration(200).attr('stroke', '#cbd5e1').attr('stroke-opacity', d => .4 + .3 * (d.weight / maxW)); tip.classList.add('hidden') }).on('click', (e, d) => { e.stopPropagation(); app.profile(d) });
                app.applyClusterForces(); const pad = 25; sim.nodes(nodes).on('tick', () => { const W = el('graphContainer').clientWidth || 800, H = el('graphContainer').clientHeight || 600; nodes.forEach(n => { n.x = clamp(n.x, pad + n.radius, W - pad - n.radius); n.y = clamp(n.y, pad + n.radius, H - pad - n.radius) }); lnk.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y); nd.attr('transform', d => `translate(${d.x},${d.y})`) }); sim.force('link').links(links); sim.alpha(1).restart();
            },
            tog: (k, v) => { app.state.filters[k].has(v) ? app.state.filters[k].delete(v) : app.state.filters[k].add(v); app.state.page = 1; app.render() },
            clear: k => { app.state.filters[k].clear(); app.state.page = 1; app.render() },
            reset: () => { app.state.filters = { q: '', topics: new Set, insts: new Set, yFrom: null, yTo: null, minRel: CFG.defMin };['globalSearch', 'yearFrom', 'yearTo'].forEach(i => el(i).value = ''); el('minRelevance').value = CFG.defMin; el('valMinRel').textContent = CFG.defMin.toFixed(1); app.state.page = 1; app.render() },
            setPage: p => { app.state.page = p; app.render() }, zoom: k => app.d3.svg.transition().duration(600).call(app.d3.zoom.scaleBy, k),
            fitGraph: () => { const b = app.d3.g.node().getBBox(); if (!b.width) return; const p = 50, w = el('graphContainer').clientWidth, h = el('graphContainer').clientHeight, s = Math.min(0.9, 1 / Math.max(b.width / (w - p * 2), b.height / (h - p * 2))); app.d3.svg.transition().duration(750).call(app.d3.zoom.transform, d3.zoomIdentity.translate(w / 2 - (b.x + b.width / 2) * s, h / 2 - (b.y + b.height / 2) * s).scale(s)) },
            toggleCluster: () => { app.state.graph.cluster = !app.state.graph.cluster; app.applyClusterForces(); app.d3.sim.alpha(.3).restart() },
            toggleLabels: () => { app.state.graph.labels = !app.state.graph.labels; if (app.d3.lbl) app.d3.lbl.style('display', app.state.graph.labels && app.d3.k >= 0.8 ? null : 'none') },
            profile: r => {
                el('researcherModal').classList.add('active'); const P = app.data.pubs.filter(p => p._memberAuthors.some(a => a.id === r.id)).sort((a, b) => b.publication_year - a.publication_year);
                el('researcherContent').innerHTML = `<div class="sticky top-0 bg-white z-10 p-5 border-b border-slate-100"><div class="flex justify-between items-start"><div class="flex items-center gap-4"><div class="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg" style="background:${r.color}">${r.display_name.substring(0, 2)}</div><div><h2 class="text-lg font-bold text-slate-800 leading-tight">${esc(r.display_name)}</h2><p class="text-xs text-slate-500 font-medium">${esc(r.inst)}</p></div></div><button onclick="document.getElementById('researcherModal').classList.remove('active')" class="text-slate-400 hover:text-slate-700"><i class="fas fa-times"></i></button></div><div class="grid grid-cols-2 gap-3 mt-4"><div class="bg-slate-50 p-2 rounded border border-slate-100 text-center"><span class="block font-bold text-xl text-slate-700">${P.length}</span><span class="text-[9px] font-bold uppercase text-slate-400">Publications</span></div><div class="bg-slate-50 p-2 rounded border border-slate-100 text-center"><span class="block font-bold text-xl text-slate-700">${P.reduce((s, p) => s + p.cited_by_count, 0).toLocaleString()}</span><span class="text-[9px] font-bold uppercase text-slate-400">Total Citations</span></div></div></div><div class="p-5"><h4 class="font-bold text-[10px] uppercase text-slate-400 mb-3 tracking-wider">Latest Contributions</h4><div class="space-y-2">${P.slice(0, 15).map(p => `<div class="p-2.5 rounded border border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors" onclick="document.getElementById('researcherModal').classList.remove('active');app.detail('${p.id}')"><div class="font-semibold text-xs text-slate-700 mb-1 leading-snug">${esc(p.title)}</div><div class="text-[10px] text-slate-400 flex justify-between items-center"><span>${p.publication_year}  ${p._relevance.toFixed(1)} score</span><span class="bg-slate-100 px-1.5 py-0.5 rounded">${p.cited_by_count} cites</span></div></div>`).join('')}</div></div>`;
            },
            detail: async id => {
                const p = app.data.pubs.find(x => x.id === id); if (!p) return; el('detailModal').classList.add('active');
                const sh = ab => {
                    el('detailContent').innerHTML = `<div class="flex justify-between items-start mb-4 pb-3 border-b border-slate-100"><h2 class="text-lg font-bold text-slate-800 pr-8 leading-tight">${esc(p.title)}</h2><button onclick="document.getElementById('detailModal').classList.remove('active')" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-times"></i></button></div><div class="flex flex-wrap gap-3 text-xs text-slate-500 mb-6 font-medium"><span class="flex items-center gap-1.5"><i class="fas fa-calendar"></i> ${p.publication_year}</span><span class="flex items-center gap-1.5"><i class="fas fa-quote-right"></i> ${p.cited_by_count} Citations</span>${p.source ? `<span class="flex items-center gap-1.5"><i class="fas fa-book"></i> ${esc(p.source)}</span>` : ''}<span class="flex items-center gap-1.5 text-green-600 bg-green-50 px-1.5 rounded border border-green-100">Score: ${p._relevance.toFixed(1)}</span>${p.url ? `<a href="${p.url}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1.5"><i class="fas fa-external-link-alt"></i> View Source</a>` : ''}</div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2"><h4 class="font-bold text-xs text-slate-800 uppercase tracking-wide mb-2">Abstract</h4>${ab ? `<div class="text-slate-600 text-xs leading-relaxed bg-slate-50 p-4 rounded-lg border border-slate-100 text-justify font-normal">${esc(ab)}</div>` : `<div class="text-slate-400 text-xs italic bg-slate-50 p-4 rounded-lg border border-slate-100 text-center">Abstract not available via API.</div>`}${p._why.length ? `<div class="mt-4"><h4 class="font-bold text-[9px] text-slate-400 uppercase tracking-wide mb-1.5">Relevance Factors</h4><div class="flex flex-wrap gap-1">${p._why.map(w => `<span class="px-1.5 py-0.5 bg-slate-100 text-slate-500 text-[9px] rounded border border-slate-200 font-mono">${w}</span>`).join('')}</div></div>` : ''}</div><div><h4 class="font-bold text-xs text-slate-800 uppercase tracking-wide mb-2">Authors</h4><div class="flex flex-col gap-1.5">${p._allAuthors.map(a => `<div class="flex items-center gap-2 text-xs p-1.5 rounded-lg border ${a.isMember ? 'border-green-200 bg-green-50 cursor-pointer hover:bg-green-100' : 'border-transparent text-slate-500'}" ${a.isMember ? `onclick="document.getElementById('detailModal').classList.remove('active');app.profile(app.data.researchers.find(r=>r.id==='${a.id}'))"` : ''}>${a.isMember ? '<span class="w-1.5 h-1.5 rounded-full bg-green-500 shrink-0"></span>' : ''}<span class="${a.isMember ? 'font-semibold text-green-800' : ''} truncate">${esc(a.name)}</span></div>`).join('')}</div><div class="mt-6"><h4 class="font-bold text-xs text-slate-800 uppercase tracking-wide mb-2">Topics</h4><div class="flex flex-wrap gap-1">${p._topics.map(t => `<span class="px-1.5 py-0.5 bg-slate-100 text-slate-600 text-[10px] rounded border border-slate-200">${esc(t)}</span>`).join('')}</div></div></div></div>`;
                };
                sh(null); try { const d = await fetchJSON(`${CFG.api}/works/${p.id.split('/').pop()}?select=abstract_inverted_index`); sh(d?.abstract_inverted_index ? Object.entries(d.abstract_inverted_index).reduce((a, [k, v]) => (v.forEach(p => a[p] = k), a), []).join(' ') : null) } catch { }
            },
            cite: id => {
                const p = app.data.pubs.find(x => x.id === id), aa = p._allAuthors.map(a => a.name); el('citeAPA').textContent = `${aa.length > 5 ? `${aa.slice(0, 5).join(', ')}, et al.` : aa.join(', ')} (${p.publication_year}). ${p.title}. ${p.source || 'Journal'}.`; el('citeBib').textContent = `@article{${(aa[0] || 'u').split(' ').pop().toLowerCase().replace(/[^a-z]/g, '')}${p.publication_year}, author={${aa.join(' and ')}}, title={${p.title}}, year={${p.publication_year}}, journal={${p.source || 'Journal'}}}`; el('citationModal').classList.add('active');
            },
            copy: id => { navigator.clipboard.writeText(el(id).textContent); const b = event.currentTarget, o = b.innerHTML; b.innerHTML = '<i class="fas fa-check text-green-600"></i>'; setTimeout(() => b.innerHTML = o, 1500) },
            toggleExportMenu: () => { el('exportMenu').classList.toggle('hidden') },
            downloadFile: (c, t, e) => { const u = URL.createObjectURL(new Blob([c], { type: t })); Object.assign(document.createElement('a'), { href: u, download: `agripv_network.${e}` }).click(); URL.revokeObjectURL(u); el('exportMenu').classList.add('hidden') },
            exportCSV: () => app.downloadFile([['Title', 'Year', 'Score', 'Citations', 'Authors', 'DOI', 'Source'], ...app.state.lastFiltered.map(p => [`"${p.title.replace(/"/g, '""')}"`, p.publication_year, p._relevance, p.cited_by_count, `"${p._allAuthors.map(a => a.name).join('; ')}"`, p.doi || '', `"${(p.source || '').replace(/"/g, '""')}"`])].map(r => r.join(',')).join('\n'), 'text/csv', 'csv'),
            exportBibTeX: () => app.downloadFile(app.state.lastFiltered.map(p => `@article{${p.id.split('/').pop()}, author={${p._allAuthors.map(a => a.name).join(' and ')}}, title={${p.title}}, year={${p.publication_year}}, journal={${p.source || ''}}, doi={${p.doi || ''}}}`).join('\n\n'), 'application/x-bibtex', 'bib'),
            exportRIS: () => app.downloadFile(app.state.lastFiltered.map(p => `TY  - JOUR\nTI  - ${p.title}\nPY  - ${p.publication_year}\n${p._allAuthors.map(a => `AU  - ${a.name}`).join('\n')}\nJO  - ${p.source || ''}\nDO  - ${p.doi || ''}\nER  - `).join('\n\n'), 'application/x-research-info-systems', 'ris'),
            exportGraphSVG: () => { const s = el('networkGraph').cloneNode(true); s.setAttribute('xmlns', "http://www.w3.org/2000/svg"); s.insertBefore(Object.assign(document.createElement('style'), { textContent: `circle{stroke:#fff;stroke-width:1px}line{stroke:#94a3b8}text{font-family:sans-serif}` }), s.firstChild); app.downloadFile(new XMLSerializer().serializeToString(s), 'image/svg+xml', 'svg') },
            exportGraphPNG: () => { const s = new XMLSerializer().serializeToString(el('networkGraph')), c = Object.assign(document.createElement('canvas'), { width: el('graphContainer').clientWidth * 2, height: el('graphContainer').clientHeight * 2 }), ctx = c.getContext('2d'), img = new Image(); img.onload = () => { ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, c.width, c.height); ctx.drawImage(img, 0, 0, c.width, c.height); c.toBlob(b => { const u = URL.createObjectURL(b); Object.assign(document.createElement('a'), { href: u, download: 'agripv_network.png' }).click(); el('exportMenu').classList.add('hidden') }) }; img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(s))) },
            setupUI: () => {
                let tm, drag; el('globalSearch').oninput = e => { clearTimeout(tm); tm = setTimeout(() => { app.state.filters.q = e.target.value; app.state.page = 1; app.render() }, 300) };
                el('sortSelect').onchange = e => { app.state.sort = e.target.value; app.state.page = 1; app.render() };
                ['yearFrom', 'yearTo'].forEach(id => el(id).onchange = e => { app.state.filters[id === 'yearFrom' ? 'yFrom' : 'yTo'] = e.target.value ? clamp(+e.target.value, 2000, 2026) : null; app.render() });
                el('minRelevance').oninput = e => { const v = +e.target.value; el('valMinRel').textContent = v.toFixed(1); clearTimeout(tm); tm = setTimeout(() => { app.state.filters.minRel = v; app.state.page = 1; app.render() }, 200) };
                el('linkDistance').oninput = e => { app.d3.sim.force('link').distance(+e.target.value); app.d3.sim.alpha(.3).restart() };
                el('chargeStrength').oninput = e => { app.d3.sim.force('charge').strength(-e.target.value); app.d3.sim.alpha(.3).restart() };
                document.querySelectorAll('.view-btn').forEach(b => b.onclick = () => {
                    const v = b.dataset.view, both = v === 'both', pp = el('publicationsPanel'), np = el('networkPanel');
                    pp.style.display = (both || v === 'publications') ? 'flex' : 'none'; pp.style.width = both ? '50%' : (v === 'publications' ? '100%' : '0%');
                    np.style.display = (both || v === 'network') ? 'flex' : 'none'; np.style.width = both ? '50%' : (v === 'network' ? '100%' : '0%');
                    el('splitHandle').style.display = both ? 'block' : 'none';
                    document.querySelectorAll('.view-btn').forEach(x => x.className = `view-btn px-2.5 py-1 text-[11px] font-semibold rounded transition-all ${x === b ? 'bg-white shadow-sm text-slate-800 ring-1 ring-slate-200' : 'text-slate-500 hover:text-slate-700'}`);
                    if (v === 'network' || both) setTimeout(() => { app.resizeGraph(); app.d3.sim.alpha(1).restart(); app.fitGraph() }, 150)
                });
                el('splitHandle').onmousedown = () => { drag = true; document.body.style.cursor = 'col-resize' }; document.onmouseup = () => { if (drag) app.resizeGraph(); drag = false; document.body.style.cursor = 'default' };
                document.onmousemove = e => { if (drag) { const p = (e.clientX - 320) / (document.body.clientWidth - 320) * 100; if (p > 15 && p < 85) { el('publicationsPanel').style.width = p + '%'; el('networkPanel').style.width = (100 - p) + '%'; app.resizeGraph() } } };
                document.addEventListener('click', e => { if (!el('exportDropdown').contains(e.target)) el('exportMenu').classList.add('hidden') });
            }
        };
        document.addEventListener('DOMContentLoaded', app.init); window.app = app; 
    </script>
</body>

</html>