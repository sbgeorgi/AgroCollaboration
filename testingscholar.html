<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPV Research Network | Publications & Collaboration Graph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { 'inter': ['Inter', 'sans-serif'] }, 
                    colors: { 'brand': '#16a34a', 'brand-light': '#dcfce7' } 
                } 
            }
        }
    </script>
    <style>
        :root { --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Split Pane Handle */
        .split-handle { cursor: col-resize; width: 1px; background: #e2e8f0; position: relative; z-index: 20; transition: background 0.2s; }
        .split-handle::after { content: ''; position: absolute; top: 0; bottom: 0; left: -2px; right: -2px; z-index: 10; }
        .split-handle:hover, .split-handle:active { background: #16a34a; width: 2px; }

        /* Component Styles */
        .pub-card { transition: all 0.2s ease; border: 1px solid transparent; border-bottom: 1px solid #f1f5f9; }
        .pub-card:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); z-index: 10; border-radius: 6px; }
        
        .network-member { background-color: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .external-author { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        
        .d3-tooltip { pointer-events: none; position: absolute; background: rgba(255,255,255,0.95); backdrop-filter: blur(4px); border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; z-index: 50; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); min-width: 200px; font-size: 12px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 60; opacity: 0; pointer-events: none; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .profile-modal { transform: scale(0.95); transition: 0.2s; }
        .modal-overlay.active .profile-modal { transform: scale(1); }

        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .page-btn.active { background-color: #16a34a; color: white; border-color: #16a34a; }
    </style>
</head>
<body class="bg-white text-slate-700 h-screen w-screen flex overflow-hidden">

    <!-- Left Sidebar: Fixed width, full height -->
    <aside class="w-[340px] flex flex-col border-r border-slate-200 bg-slate-50/50 shrink-0 h-full z-30">
        <!-- Header -->
        <div class="p-5 border-b border-slate-200 bg-white">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-9 h-9 rounded-lg bg-green-600 text-white flex items-center justify-center shadow-md shadow-green-200">
                    <i class="fas fa-leaf text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-slate-800 text-base leading-tight">AgriPV Network</h1>
                    <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Research Explorer</p>
                </div>
            </div>
            <div class="relative group">
                <input type="text" id="globalSearch" placeholder="Search title, author, topic..." class="w-full bg-slate-100 border-none rounded-lg py-2.5 pl-10 pr-3 text-xs font-medium focus:ring-2 focus:ring-green-500/20 focus:bg-white transition-all placeholder:text-slate-400">
                <i class="fas fa-search text-slate-400 absolute left-3.5 top-3 text-xs group-focus-within:text-green-600"></i>
            </div>
        </div>

        <!-- Scrollable Filters -->
        <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-6">
            
            <!-- Statistics Dashboard -->
            <div>
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Network Stats</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm flex flex-col items-center justify-center">
                        <span id="statResearchers" class="text-lg font-bold text-slate-700 leading-none">0</span>
                        <span class="text-[9px] text-slate-400 font-semibold mt-1">MEMBERS</span>
                    </div>
                    <div class="bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm flex flex-col items-center justify-center">
                        <span id="statPublications" class="text-lg font-bold text-slate-700 leading-none">0</span>
                        <span class="text-[9px] text-slate-400 font-semibold mt-1">WORKS</span>
                    </div>
                    <div class="bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm flex flex-col items-center justify-center">
                        <span id="statCitations" class="text-lg font-bold text-slate-700 leading-none">0</span>
                        <span class="text-[9px] text-slate-400 font-semibold mt-1">CITES</span>
                    </div>
                    <div class="bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm flex flex-col items-center justify-center">
                        <span id="statTopics" class="text-lg font-bold text-slate-700 leading-none">0</span>
                        <span class="text-[9px] text-slate-400 font-semibold mt-1">TOPICS</span>
                    </div>
                </div>
            </div>

            <!-- Date Filter -->
            <div>
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Publication Year</h3>
                <div class="flex items-center gap-2 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                    <input type="number" id="yearFrom" placeholder="2015" class="w-full border-none bg-transparent text-center text-xs font-medium focus:ring-0 p-1">
                    <span class="text-slate-300 text-xs">to</span>
                    <input type="number" id="yearTo" placeholder="2025" class="w-full border-none bg-transparent text-center text-xs font-medium focus:ring-0 p-1">
                </div>
            </div>

            <!-- Institutions -->
            <div class="flex flex-col h-48">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Institutions</h3>
                    <button class="text-[10px] text-green-600 font-semibold hover:underline" onclick="app.clearFilter('inst')">Reset</button>
                </div>
                <div id="institutionFilters" class="flex-1 overflow-y-auto custom-scroll pr-1 space-y-0.5"></div>
            </div>

            <!-- Topics -->
            <div class="flex flex-col h-48">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Topics</h3>
                    <button class="text-[10px] text-green-600 font-semibold hover:underline" onclick="app.clearFilter('topic')">Reset</button>
                </div>
                <div id="topicFilters" class="flex flex-wrap gap-1.5 pb-2"></div>
            </div>
        </div>

        <!-- Active Filters Footer -->
        <div id="activeFiltersPanel" class="p-3 bg-white border-t border-slate-200 hidden shrink-0">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-semibold text-slate-500"><span id="activeFilterCount">0</span> filters active</span>
                <button class="text-[10px] text-red-500 font-semibold hover:text-red-700" onclick="app.clearAllFilters()">Clear All</button>
            </div>
            <div id="activeFilterTags" class="flex flex-wrap gap-1 max-h-16 overflow-y-auto custom-scroll"></div>
        </div>
    </aside>

    <!-- Main Content Area: Flex-1, full height -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-white relative">
        
        <!-- Toolbar -->
        <header class="h-14 border-b border-slate-200 flex items-center justify-between px-4 bg-white shrink-0 z-20">
            <div class="flex gap-1 p-1 bg-slate-100 rounded-lg">
                <button data-view="both" class="view-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-white shadow-sm text-slate-800 transition-all"><i class="fas fa-columns mr-1.5"></i>Split</button>
                <button data-view="publications" class="view-btn px-3 py-1.5 text-xs font-semibold rounded-md text-slate-500 hover:text-slate-700 transition-all"><i class="fas fa-list mr-1.5"></i>List</button>
                <button data-view="network" class="view-btn px-3 py-1.5 text-xs font-semibold rounded-md text-slate-500 hover:text-slate-700 transition-all"><i class="fas fa-project-diagram mr-1.5"></i>Graph</button>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-xs text-slate-500 font-medium">
                    Showing <span id="filteredCount" class="text-slate-900 font-bold">0</span> results
                </div>
                <div class="h-4 w-px bg-slate-300"></div>
                <select id="sortSelect" class="text-xs font-medium bg-transparent border-none outline-none text-slate-600 cursor-pointer hover:text-slate-900 focus:ring-0">
                    <option value="recent">Newest First</option>
                    <option value="relevance">Relevance Score</option>
                    <option value="cited">Most Cited</option>
                    <option value="title">A-Z Title</option>
                </select>
                <button class="px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-md hover:bg-slate-800 shadow-sm" onclick="app.exportData()">
                    <i class="fas fa-download mr-1"></i> Export
                </button>
            </div>
        </header>

        <!-- Content Split View -->
        <div id="contentArea" class="flex-1 flex overflow-hidden relative">
            
            <!-- List View Panel -->
            <div id="publicationsPanel" class="flex flex-col min-w-0 w-1/2 bg-white h-full border-r border-slate-100">
                <div id="publicationsList" class="flex-1 overflow-y-auto p-2 custom-scroll bg-white"></div>
                
                <!-- Improved Pagination -->
                <div class="p-3 border-t border-slate-200 bg-white shrink-0 flex flex-col gap-2">
                    <div class="flex justify-between items-center text-[10px] text-slate-400">
                        <span>Showing <span id="showingFrom">0</span>-<span id="showingTo">0</span> of <span id="totalPublications">0</span></span>
                    </div>
                    <div id="paginationContainer" class="flex justify-center gap-1">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Draggable Handle -->
            <div id="splitHandle" class="split-handle" title="Drag to resize"></div>

            <!-- Graph View Panel -->
            <div id="networkPanel" class="flex flex-col min-w-0 w-1/2 bg-slate-50 relative h-full">
                <!-- Graph Toolbar -->
                <div class="absolute top-4 left-4 z-10 flex gap-2">
                    <div class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-1 flex gap-1">
                        <button class="w-7 h-7 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600 transition-colors" onclick="app.zoomGraph(1.3)" title="Zoom In"><i class="fas fa-plus text-xs"></i></button>
                        <button class="w-7 h-7 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600 transition-colors" onclick="app.zoomGraph(0.7)" title="Zoom Out"><i class="fas fa-minus text-xs"></i></button>
                        <button class="w-7 h-7 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600 transition-colors" onclick="app.resetGraph()" title="Fit to Screen"><i class="fas fa-compress-arrows-alt text-xs"></i></button>
                    </div>
                </div>

                <!-- Settings & Legend -->
                <div class="absolute top-4 right-4 z-10 flex flex-col items-end gap-2">
                     <div class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-3 w-40 space-y-3">
                        <div>
                            <div class="flex justify-between mb-1"><label class="text-[9px] font-bold text-slate-400 uppercase">Link Dist</label><span class="text-[9px] text-slate-400" id="valLink">120</span></div>
                            <input type="range" id="linkDistance" min="50" max="300" value="120" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-600 block">
                        </div>
                        <div>
                            <div class="flex justify-between mb-1"><label class="text-[9px] font-bold text-slate-400 uppercase">Gravity</label><span class="text-[9px] text-slate-400" id="valCharge">300</span></div>
                            <input type="range" id="chargeStrength" min="100" max="800" value="300" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-600 block">
                        </div>
                    </div>
                </div>

                <div class="absolute bottom-4 left-4 z-10">
                    <div class="bg-white/90 backdrop-blur border border-slate-200 rounded-lg shadow-sm p-3 max-h-40 overflow-y-auto custom-scroll w-48">
                        <div class="text-[9px] font-bold text-slate-400 uppercase mb-2">Legend</div>
                        <div id="legendContainer" class="space-y-1"></div>
                    </div>
                </div>

                <!-- SVG Container -->
                <div id="graphContainer" class="flex-1 w-full h-full cursor-grab active:cursor-grabbing overflow-hidden">
                    <svg id="networkGraph" width="100%" height="100%" preserveAspectRatio="xMidYMid slice"></svg>
                </div>
                <div id="tooltip" class="d3-tooltip hidden"></div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <h3 class="text-xl font-bold text-slate-800">Building Research Network</h3>
        <p id="loadingStatus" class="text-sm text-slate-500 mt-2">Connecting to data sources...</p>
        <div class="w-64 bg-slate-100 rounded-full h-1.5 mt-6 overflow-hidden">
            <div id="loadingProgress" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="citationModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="profile-modal w-full max-w-lg bg-white rounded-xl shadow-2xl border border-slate-100 p-6">
            <div class="flex justify-between items-center mb-5 pb-3 border-b border-slate-100">
                <h3 class="font-bold text-slate-800">Cite Publication</h3>
                <button onclick="document.getElementById('citationModal').classList.remove('active')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">APA Format</label>
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 relative group text-xs text-slate-600 font-mono leading-relaxed">
                        <span id="citeAPA"></span>
                        <button class="absolute top-2 right-2 px-2 py-1 bg-white border border-slate-200 rounded shadow-sm text-slate-400 hover:text-green-600 text-xs" onclick="app.copy('citeAPA')"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">BibTeX</label>
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 relative group text-xs text-slate-600 font-mono leading-relaxed break-all">
                        <span id="citeBib"></span>
                        <button class="absolute top-2 right-2 px-2 py-1 bg-white border border-slate-200 rounded shadow-sm text-slate-400 hover:text-green-600 text-xs" onclick="app.copy('citeBib')"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="profile-modal w-full max-w-4xl max-h-[90vh] bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div id="detailContent" class="overflow-y-auto p-8 custom-scroll"></div>
        </div>
    </div>
    
    <div id="researcherModal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="profile-modal w-full max-w-lg bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden max-h-[85vh]">
             <div id="researcherContent" class="overflow-y-auto custom-scroll p-0"></div>
        </div>
    </div>

    <script type="module">
        import { supabase } from "./auth.js";

        // Constants & Config
        const API = "https://api.openalex.org";
        const CACHE_KEY = "asf_network_v6";
        const HASH_KEY = "asf_members_hash_v6";
        const CACHE_MS = 30 * 86400 * 1000;
        const BATCH_SIZE = 25;
        const RELEVANCE_THRESHOLD = 5;
        
        // Colors for Institutions
        const COLORS = ['#16a34a','#059669','#0d9488','#0891b2','#0284c7','#2563eb','#4f46e5','#7c3aed','#9333ea','#c026d3','#db2777','#e11d48','#ea580c','#d97706'];

        // Logic Helpers
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const norm = s => (s||"").trim().toLowerCase().normalize("NFKD").replace(/\p{Diacritic}/gu, "").replace(/\s+/g, " ");
        const esc = s => (s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m]));
        const jsStr = s => String(s??"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
        const suffix = id => (id||"").split("/").pop();
        const hashStr = s => { let h=0; for(let i=0;i<s.length;i++) h=Math.imul(31,h)+s.charCodeAt(i)|0; return h.toString(16); };

        // Storage Wrapper
        const Storage = {
            get: k => { try { const i = JSON.parse(localStorage.getItem(k)); return (i && i.exp > Date.now()) ? i.val : null; } catch { return null; } },
            set: (k, v) => {
                try { localStorage.setItem(k, JSON.stringify({ val: v, exp: Date.now() + CACHE_MS })); }
                catch { Object.keys(localStorage).filter(x => x.startsWith('asf_')).forEach(x => localStorage.removeItem(x)); try { localStorage.setItem(k, JSON.stringify({ val: v, exp: Date.now() + CACHE_MS })); } catch {} }
            }
        };

        // Network Fetcher
        const fetchJSON = async (url, retries = 3) => {
            url += (url.includes('?') ? '&' : '?') + 'mailto=research-tool@agripv.org';
            for (let i = 0; i < retries; i++) {
                try {
                    const r = await fetch(url);
                    if (r.ok) return await r.json();
                    if (r.status === 429) await sleep((parseFloat(r.headers.get("Retry-After")||1)*1000)*(i+1));
                    else if (r.status >= 500) await sleep(500*(i+1));
                    else throw 0;
                } catch { if (i === retries - 1) return null; await sleep(300); }
            }
        };

        // Text Processing / Categorization
        const RX = {
            AGRIPV: /agrivoltaic|agrovoltaic|agrophotovoltaic|agri-pv|agri pv|solar sharing|dual.use.*(solar|pv)|co.locat.*(solar|pv)|farming.*(solar|pv)|(solar|pv).*farming/i,
            SOLAR: /photovolta|solar\s*(panel|energy|power|cell|array|module|farm)|pv\s*system|renewable\s*energy/i,
            LAND: /agricultur|crop|yield|farm|pasture|grazing|livestock|soil|irrigat|agronom|microclimate|shade|land\s*use/i,
            ECON: /econom|cost.benefit|lcoe|policy|regulation|adoption|market|financ|business\s*model/i,
            NEG: /\b(oncolog|cancer|clinical\s*trial|patient|surgery|nanoparticle|astrophys|galaxy|cosmolog|protein\s*fold)\b/i
        };
        const TOPIC_BLOCK = new Set(["medicine","physics","materials science","computer science","chemistry","biology","mathematics","philosophy","art","psychology","geology","sociology"]);

        const calcRel = (w) => {
            const t = norm(w.title);
            if (RX.NEG.test(t)) return 0;
            let s = 0;
            if (RX.AGRIPV.test(t)) s += 15;
            const sol = RX.SOLAR.test(t), land = RX.LAND.test(t);
            if (sol && land) s += 10; else if (sol) s += 3; else if (land) s += 2;
            if (RX.ECON.test(t) && s > 3) s += 2;
            if ((w.concepts || []).some(c => /agri|solar|renew|land/i.test(c.display_name))) s += 3;
            return s;
        };

        const getInst = (i) => {
            if (!i) return "Unknown";
            i = i.toLowerCase();
            if (i.includes('arizona')) return "Univ. of Arizona";
            if (i.includes('unam') || i.includes('nacional autÃ³noma')) return "UNAM";
            if (i.includes('chile')) return "Univ. de Chile";
            if (i.includes('fraunhofer')) return "Fraunhofer ISE";
            if (i.includes('wageningen')) return "Wageningen UR";
            if (i.includes('nrel')) return "NREL";
            if (i.includes('davis')) return "UC Davis";
            if (i.includes('umass') || i.includes('massachusetts')) return "UMass Amherst";
            return i.replace(/university/gi, 'Univ.').replace(/institute/gi, 'Inst.').split(',')[0].trim().substring(0, 25);
        };

        // Application Core
        const app = {
            data: { researchers: [], pubs: [], topics: new Map(), graph: { nodes: [], links: [] } },
            state: { filters: { q: '', topics: new Set(), insts: new Set(), yFrom: null, yTo: null }, page: 1, sort: 'recent' },
            d3: {}, instColors: new Map(),

            init: async () => {
                app.setupUI(); app.setupGraph();
                const stat = t => document.getElementById('loadingStatus').textContent = t;
                const prog = p => document.getElementById('loadingProgress').style.width = `${p}%`;

                try {
                    stat("Fetching network members..."); prog(10);
                    const { data: profiles } = await supabase.from("profiles").select("id,full_name,work_email,affiliation").not("full_name", "is", null);
                    if (!profiles?.length) throw new Error("No network members found.");

                    const hash = hashStr(profiles.map(p => p.id).sort().join('|'));
                    const cached = Storage.get(CACHE_KEY);

                    if (Storage.get(HASH_KEY) === hash && cached) {
                        stat("Loading from cache..."); prog(90);
                        app.restore(cached, profiles);
                    } else {
                        stat("Resolving author profiles..."); prog(20);
                        const researchers = await app.resolve(profiles, (c, t) => prog(20 + (c/t)*20));
                        
                        stat("Fetching publications..."); prog(40);
                        const pubs = await app.fetchWorks(researchers, (c, t) => prog(40 + (c/t)*50));
                        
                        app.build(researchers, pubs);
                        Storage.set(HASH_KEY, hash);
                        Storage.set(CACHE_KEY, app.pack());
                    }
                    prog(100);
                } catch (e) { console.error(e); alert("Failed to load network data."); }
                
                await sleep(500);
                document.getElementById('loadingOverlay').classList.add('hidden');
                app.render();
                // Ensure graph fills container on first load
                setTimeout(() => { app.resizeGraph(); app.centerGraph(); }, 200);
            },

            // 1. Resolve Profile -> OpenAlex ID
            resolve: async (profiles, onProg) => {
                const authors = [];
                for (let i = 0; i < profiles.length; i += 5) {
                    const batch = profiles.slice(i, i + 5);
                    const res = await Promise.all(batch.map(async p => {
                        const data = await fetchJSON(`${API}/authors?search=${encodeURIComponent(p.full_name)}&per_page=1`);
                        const match = data?.results?.find(r => norm(r.display_name) === norm(p.full_name)) || data?.results?.[0];
                        const inst = getInst(match?.last_known_institutions?.[0]?.display_name || p.affiliation);
                        return {
                            id: match?.id || `local:${p.id}`,
                            display_name: match?.display_name || p.full_name,
                            supabase_id: p.id, inst, color: app.col(inst),
                            net_works: 0, net_cited: 0, topics: {}
                        };
                    }));
                    authors.push(...res);
                    if (onProg) onProg(i + batch.length, profiles.length);
                    await sleep(100);
                }
                return authors;
            },

            // 2. Fetch Works
            fetchWorks: async (authors, onProg) => {
                const validIds = authors.filter(a => !a.id.startsWith('local:')).map(a => a.id);
                const works = new Map();
                const batches = [];
                for (let i = 0; i < validIds.length; i += BATCH_SIZE) batches.push(validIds.slice(i, i + BATCH_SIZE));

                const startYear = new Date().getFullYear() - 10;
                for (let i = 0; i < batches.length; i++) {
                    let cursor = '*', page = 0;
                    while (cursor && page < 6) { // Cap depth
                        const res = await fetchJSON(`${API}/works?filter=authorships.author.id:${batches[i].join('|')},from_publication_date:${startYear}-01-01&per_page=200&cursor=${cursor}&select=id,title,publication_year,cited_by_count,primary_location,authorships,concepts,doi,open_access`);
                        res?.results?.forEach(w => {
                            if (!works.has(w.id)) {
                                const rel = calcRel(w);
                                if (rel >= RELEVANCE_THRESHOLD) works.set(w.id, { ...w, _relevance: rel });
                            }
                        });
                        cursor = res?.meta?.next_cursor;
                        page++;
                        if (cursor) await sleep(50);
                    }
                    if (onProg) onProg(i + 1, batches.length);
                }
                return [...works.values()];
            },

            // 3. Build Data Structures
            build: (researchers, rawPubs) => {
                const rMap = new Map(researchers.map(r => [r.id, r]));
                app.data.pubs = rawPubs.map(p => {
                    const members = p.authorships.filter(a => rMap.has(a.author?.id)).map(a => rMap.get(a.author.id));
                    if (!members.length) return null;

                    const topics = (p.concepts || [])
                        .filter(c => c.score > 0.5 && c.level > 0 && !TOPIC_BLOCK.has(norm(c.display_name)))
                        .map(c => c.display_name).slice(0, 6);
                    
                    members.forEach(r => {
                        r.net_works++; r.net_cited += p.cited_by_count;
                        topics.forEach(t => { r.topics[t] = (r.topics[t]||0)+1; app.data.topics.set(t, (app.data.topics.get(t)||0)+1); });
                    });

                    return {
                        id: p.id, title: p.title, publication_year: p.publication_year, cited_by_count: p.cited_by_count,
                        doi: p.doi, source: p.primary_location?.source?.display_name, is_oa: p.open_access?.is_oa,
                        _relevance: p._relevance, _topics: topics,
                        _allAuthors: p.authorships.map(a => ({
                            id: a.author?.id, name: a.author?.display_name,
                            isMember: rMap.has(a.author?.id)
                        })),
                        _memberAuthors: members
                    };
                }).filter(Boolean);

                const activeIds = new Set(app.data.pubs.flatMap(p => p._memberAuthors.map(a => a.id)));
                app.data.researchers = researchers.filter(r => activeIds.has(r.id));
                app.buildGraph();
            },

            buildGraph: () => {
                const links = new Map();
                const link = (a, b) => {
                    const k = [a, b].sort().join('|');
                    const l = links.get(k) || { source: a, target: b, weight: 0 };
                    l.weight += 1; links.set(k, l);
                };
                
                app.data.pubs.forEach(p => {
                    const ids = p._memberAuthors.map(a => a.id);
                    for (let i = 0; i < ids.length; i++) for (let j = i + 1; j < ids.length; j++) link(ids[i], ids[j]);
                });
                
                app.data.graph = {
                    nodes: app.data.researchers.map(r => ({ ...r, radius: Math.min(35, 12 + Math.sqrt(r.net_works)*4) })),
                    links: [...links.values()]
                };
            },

            // 4. Cache & Restore
            pack: () => ({
                researchers: app.data.researchers.map(r => ({ id: r.id, display_name: r.display_name, inst: r.inst, net_works: r.net_works, net_cited: r.net_cited, topics: r.topics })),
                pubs: app.data.pubs.map(p => ({
                    id: p.id, title: p.title, publication_year: p.publication_year, cited_by_count: p.cited_by_count,
                    doi: p.doi, source: p.source, is_oa: p.is_oa, _relevance: p._relevance, _topics: p._topics,
                    _allAuthors: p._allAuthors, _memIds: p._memberAuthors.map(a => a.id)
                })),
                topics: [...app.data.topics]
            }),

            restore: (cache, profiles) => {
                app.data.researchers = cache.researchers.map(r => ({ ...r, color: app.col(r.inst) }));
                const rMap = new Map(app.data.researchers.map(r => [r.id, r]));
                app.data.pubs = cache.pubs.map(p => ({ ...p, _memberAuthors: (p._memIds||[]).map(id => rMap.get(id)).filter(Boolean) }));
                app.data.topics = new Map(cache.topics);
                app.buildGraph();
            },

            col: (i) => {
                if (!app.instColors.has(i)) app.instColors.set(i, COLORS[app.instColors.size % COLORS.length]);
                return app.instColors.get(i);
            },

            // 5. Renderers
            render: () => {
                const { q, topics, insts, yFrom, yTo } = app.state.filters;
                const ql = q.toLowerCase();
                
                const filtered = app.data.pubs.filter(p => {
                    if (yFrom && p.publication_year < yFrom) return false;
                    if (yTo && p.publication_year > yTo) return false;
                    if (insts.size && !p._memberAuthors.some(a => insts.has(a.inst))) return false;
                    if (topics.size && !p._topics.some(t => topics.has(t))) return false;
                    return !ql || p.title.toLowerCase().includes(ql) || p._allAuthors.some(a => a.name?.toLowerCase().includes(ql));
                });

                // Update Stats
                const uniqueMems = new Set(filtered.flatMap(p => p._memberAuthors.map(a => a.id)));
                document.getElementById('statPublications').textContent = filtered.length;
                document.getElementById('statResearchers').textContent = uniqueMems.size;
                document.getElementById('statCitations').textContent = filtered.reduce((s,p)=>s+p.cited_by_count,0).toLocaleString();
                document.getElementById('statTopics').textContent = app.data.topics.size;
                document.getElementById('filteredCount').textContent = filtered.length;

                // Sort & Page
                const sortFn = {
                    cited: (a,b) => b.cited_by_count - a.cited_by_count,
                    relevance: (a,b) => b._relevance - a._relevance,
                    title: (a,b) => a.title.localeCompare(b.title),
                    recent: (a,b) => b.publication_year - a.publication_year
                }[app.state.sort];
                
                const sorted = [...filtered].sort(sortFn);
                const pageSize = 12;
                const totalPages = Math.ceil(sorted.length / pageSize);
                if (app.state.page > totalPages) app.state.page = 1;

                const start = (app.state.page - 1) * pageSize;
                const pageItems = sorted.slice(start, start + pageSize);

                // Render List
                const listEl = document.getElementById('publicationsList');
                listEl.innerHTML = pageItems.length ? pageItems.map(p => `
                    <div class="pub-card p-4 bg-white mb-2" onclick="app.showWorkDetail('${p.id}')">
                        <div class="flex items-start justify-between gap-3 mb-2">
                            <h4 class="font-bold text-slate-800 text-sm leading-snug flex-1">${esc(p.title)}</h4>
                            ${p.is_oa ? '<span class="shrink-0 px-1.5 py-0.5 bg-amber-100 text-amber-700 text-[9px] font-bold rounded uppercase tracking-wide">OA</span>' : ''}
                        </div>
                        <div class="flex flex-wrap gap-1 mb-2.5">
                            ${p._allAuthors.slice(0,5).map(a => `<span class="px-2 py-0.5 rounded text-[10px] truncate max-w-[120px] ${a.isMember?'network-member font-medium':'external-author'}">${esc(a.name)}</span>`).join('')}
                            ${p._allAuthors.length>5?`<span class="text-[10px] text-slate-400 self-center">+${p._allAuthors.length-5}</span>`:''}
                        </div>
                        <div class="flex items-center gap-4 text-[10px] text-slate-500 font-medium">
                            <span class="flex items-center gap-1"><i class="fas fa-calendar-alt text-slate-400"></i> ${p.publication_year}</span>
                            <span class="flex items-center gap-1"><i class="fas fa-quote-right text-slate-400"></i> ${p.cited_by_count}</span>
                            <span class="ml-auto text-green-600 bg-green-50 px-2 py-0.5 rounded border border-green-100">Score: ${p._relevance}</span>
                            <div class="flex gap-1 ml-2">
                                <button class="hover:text-brand p-1" onclick="event.stopPropagation();app.cite('${p.id}')" title="Cite"><i class="fas fa-quote-left"></i></button>
                                ${p.doi ? `<a href="${p.doi}" target="_blank" onclick="event.stopPropagation()" class="hover:text-blue-600 p-1" title="DOI"><i class="fas fa-external-link-alt"></i></a>` : ''}
                            </div>
                        </div>
                    </div>`).join('') : '<div class="text-center py-20 text-slate-400 text-sm">No publications match your filters.</div>';

                listEl.scrollTop = 0;

                // Render Pagination
                document.getElementById('showingFrom').textContent = filtered.length ? start + 1 : 0;
                document.getElementById('showingTo').textContent = Math.min(start + pageSize, filtered.length);
                document.getElementById('totalPublications').textContent = filtered.length;
                app.renderPagination(totalPages, app.state.page);

                app.renderGraph(filtered);
                app.renderFilters(insts, topics);
            },

            renderPagination: (total, current) => {
                const con = document.getElementById('paginationContainer');
                if (total <= 1) { con.innerHTML = ''; return; }
                
                let btns = [];
                const add = (p, lbl=p, active=false) => btns.push(`<button onclick="app.setPage(${p})" class="w-7 h-7 flex items-center justify-center rounded text-[10px] font-medium transition-colors ${active ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">${lbl}</button>`);
                
                add(Math.max(1, current - 1), '<i class="fas fa-chevron-left"></i>');
                
                let range = [];
                if (total <= 7) range = Array.from({length: total}, (_, i) => i + 1);
                else {
                    if (current <= 4) range = [1, 2, 3, 4, 5, '...', total];
                    else if (current >= total - 3) range = [1, '...', total - 4, total - 3, total - 2, total - 1, total];
                    else range = [1, '...', current - 1, current, current + 1, '...', total];
                }

                range.forEach(r => {
                    if (r === '...') btns.push('<span class="text-xs text-slate-400 self-end px-1">...</span>');
                    else add(r, r, r === current);
                });

                add(Math.min(total, current + 1), '<i class="fas fa-chevron-right"></i>');
                con.innerHTML = btns.join('');
            },
            
            setPage: (p) => { app.state.page = p; app.render(); },

            renderFilters: (insts, topics) => {
                const iCounts = new Map(); app.data.researchers.forEach(r => iCounts.set(r.inst, (iCounts.get(r.inst)||0)+1));
                document.getElementById('institutionFilters').innerHTML = [...iCounts].sort((a,b)=>b[1]-a[1]).map(([i,c]) => `
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-1.5 rounded group transition-colors">
                        <input type="checkbox" onchange="app.togF('insts','${jsStr(i)}')" class="rounded border-slate-300 text-green-600 focus:ring-green-500 w-3.5 h-3.5" ${insts.has(i)?'checked':''}>
                        <div class="w-2 h-2 rounded-full shrink-0" style="background:${app.col(i)}"></div>
                        <span class="text-[11px] text-slate-600 truncate flex-1 group-hover:text-slate-900">${esc(i)}</span>
                        <span class="text-[9px] text-slate-400 font-mono bg-slate-100 px-1 rounded">${c}</span>
                    </label>`).join('');

                document.getElementById('topicFilters').innerHTML = [...app.data.topics].sort((a,b)=>b[1]-a[1]).slice(0,40).map(([t]) => `
                    <button onclick="app.togF('topics','${jsStr(t)}')" class="px-2 py-1 rounded text-[10px] transition-all border ${topics.has(t)?'bg-green-100 text-green-800 border-green-200 font-semibold':'bg-slate-50 text-slate-500 border-transparent hover:bg-white hover:border-slate-200 hover:shadow-sm'}">${esc(t)}</button>`).join('');

                const act = topics.size + insts.size;
                document.getElementById('activeFiltersPanel').classList.toggle('hidden', act === 0);
                document.getElementById('activeFilterCount').textContent = act;
                document.getElementById('activeFilterTags').innerHTML = 
                    [...topics].map(t => `<span class="bg-green-50 text-green-700 px-2 py-0.5 rounded border border-green-200 text-[10px] flex gap-1 items-center font-medium">${esc(t)}<button onclick="app.togF('topics','${jsStr(t)}')" class="hover:text-red-500 ml-1"><i class="fas fa-times"></i></button></span>`).join('') +
                    [...insts].map(i => `<span class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded border border-blue-200 text-[10px] flex gap-1 items-center font-medium">${esc(i)}<button onclick="app.togF('insts','${jsStr(i)}')" class="hover:text-red-500 ml-1"><i class="fas fa-times"></i></button></span>`).join('');
                
                // Update Legend
                document.getElementById('legendContainer').innerHTML = [...app.instColors].filter(([i]) => app.data.researchers.some(r=>r.inst===i)).map(([i,c]) => `
                    <div class="flex items-center gap-2 py-0.5">
                        <span class="w-2 h-2 rounded-full shadow-sm" style="background:${c}"></span>
                        <span class="text-[10px] text-slate-600 truncate">${esc(i)}</span>
                    </div>`).join('');
            },

            // Graph Logic
            setupGraph: () => {
                const svg = d3.select('#networkGraph'), g = svg.append('g');
                app.d3 = { svg, g, zoom: d3.zoom().scaleExtent([0.1, 5]).on('zoom', e => g.attr('transform', e.transform)) };
                svg.call(app.d3.zoom);
                
                // Initialize simulation with dynamic centers
                app.d3.sim = d3.forceSimulation()
                    .force('link', d3.forceLink().id(d=>d.id).distance(120))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('collide', d3.forceCollide().radius(d=>d.radius+2).iterations(2))
                    .force('center', d3.forceCenter(window.innerWidth/4, window.innerHeight/2)); // Initial guess

                // Shared gradients
                const defs = svg.append('defs');
                COLORS.forEach(c => {
                    const gr = defs.append('radialGradient').attr('id', 'g-'+c.slice(1)).attr('cx','35%').attr('cy','35%');
                    gr.append('stop').attr('offset','0%').attr('stop-color', d3.color(c).brighter(0.8));
                    gr.append('stop').attr('offset','100%').attr('stop-color', c);
                });
                
                // Resize listener
                window.addEventListener('resize', app.resizeGraph);
            },

            resizeGraph: () => {
                const con = document.getElementById('graphContainer');
                if(!con) return;
                app.d3.sim.force('center', d3.forceCenter(con.clientWidth/2, con.clientHeight/2));
                app.d3.sim.alpha(0.3).restart();
            },

            renderGraph: (pubs) => {
                const visIds = new Set(pubs.flatMap(p => p._memberAuthors.map(a => a.id)));
                const nodes = app.data.graph.nodes.filter(n => visIds.has(n.id));
                const nIds = new Set(nodes.map(n => n.id));
                const links = app.data.graph.links.filter(l => nIds.has(l.source.id||l.source) && nIds.has(l.target.id||l.target));
                const { g, sim } = app.d3;

                g.selectAll('*').remove(); // Full redraw for cleanness
                
                const link = g.append('g').selectAll('line').data(links).enter().append('line')
                    .attr('stroke', '#cbd5e1').attr('stroke-opacity', 0.6).attr('stroke-width', 1);

                const node = g.append('g').selectAll('g').data(nodes).enter().append('g')
                    .call(d3.drag().on('start', (e,d)=>{ if(!e.active)sim.alphaTarget(0.3).restart(); d.fx=d.x;d.fy=d.y; }).on('drag', (e,d)=>{ d.fx=e.x;d.fy=e.y; }).on('end', (e,d)=>{ if(!e.active)sim.alphaTarget(0); d.fx=null;d.fy=null; }));

                node.append('circle').attr('r', d=>d.radius)
                    .attr('fill', d=>`url(#g-${d.color.slice(1)})`)
                    .attr('stroke', '#fff').attr('stroke-width', 2)
                    .style('filter', 'drop-shadow(0 2px 3px rgba(0,0,0,0.15))')
                    .style('cursor', 'pointer');

                node.append('text').text(d => d.display_name.split(' ').map(n=>n[0]).slice(0,2).join(''))
                    .attr('dy', '0.35em').attr('text-anchor', 'middle')
                    .attr('fill', 'white').attr('font-size', d => Math.max(8, d.radius*0.5)+'px').attr('font-weight', '600')
                    .style('pointer-events', 'none').style('text-shadow', '0 1px 2px rgba(0,0,0,0.2)');

                // Tooltip & Interactive Logic
                const tip = document.getElementById('tooltip');
                node.on('mouseover', (e, d) => {
                    // Highlight logic
                    node.attr('opacity', n => (n.id===d.id || links.some(l => (l.source.id===d.id && l.target.id===n.id) || (l.target.id===d.id && l.source.id===n.id))) ? 1 : 0.1);
                    link.attr('stroke', l => (l.source.id===d.id||l.target.id===d.id) ? '#334155' : '#e2e8f0').attr('stroke-opacity', l => (l.source.id===d.id||l.target.id===d.id) ? 1 : 0.1).attr('stroke-width', l => (l.source.id===d.id||l.target.id===d.id) ? 2 : 1);
                    
                    // Tooltip position
                    const rect = document.getElementById('graphContainer').getBoundingClientRect();
                    tip.style.left = Math.min(e.clientX - rect.left + 20, rect.width - 220) + 'px';
                    tip.style.top = Math.min(e.clientY - rect.top, rect.height - 150) + 'px';
                    tip.innerHTML = `
                        <div class="font-bold text-slate-800 mb-0.5">${esc(d.display_name)}</div>
                        <div class="text-[10px] text-slate-500 mb-2 font-medium">${esc(d.inst)}</div>
                        <div class="flex gap-2 text-center">
                            <div class="bg-slate-50 border rounded px-2 py-1"><div class="font-bold text-slate-700">${d.net_works}</div><div class="text-[8px] uppercase text-slate-400">Works</div></div>
                            <div class="bg-slate-50 border rounded px-2 py-1"><div class="font-bold text-slate-700">${d.net_cited}</div><div class="text-[8px] uppercase text-slate-400">Cites</div></div>
                        </div>`;
                    tip.classList.remove('hidden');
                })
                .on('mouseout', () => {
                    node.attr('opacity', 1); link.attr('stroke', '#cbd5e1').attr('stroke-opacity', 0.6).attr('stroke-width', 1);
                    tip.classList.add('hidden');
                })
                .on('click', (e, d) => { e.stopPropagation(); app.showResearcherDetail(d); });

                sim.nodes(nodes).on('tick', () => {
                    link.attr('x1', d=>d.source.x).attr('y1', d=>d.source.y).attr('x2', d=>d.target.x).attr('y2', d=>d.target.y);
                    node.attr('transform', d=>`translate(${d.x},${d.y})`);
                });
                sim.force('link').links(links);
                sim.alpha(1).restart();
            },

            // Filters & Actions
            togF: (k, v) => { const s = app.state.filters[k]; s.has(v) ? s.delete(v) : s.add(v); app.state.page = 1; app.render(); },
            clearFilter: (k) => { app.state.filters[k+'s'].clear(); app.state.page = 1; app.render(); },
            clearAllFilters: () => { 
                app.state.filters = { q: '', topics: new Set(), insts: new Set(), yFrom: null, yTo: null }; 
                ['globalSearch','yearFrom','yearTo'].forEach(id=>document.getElementById(id).value=''); 
                app.state.page = 1; app.render(); 
            },

            // Modals
            showResearcherDetail: (r) => {
                document.getElementById('researcherModal').classList.add('active');
                const rPubs = app.data.pubs.filter(p => p._memberAuthors.some(a => a.id === r.id)).sort((a,b)=>b.publication_year-a.publication_year).slice(0,10);
                document.getElementById('researcherContent').innerHTML = `
                    <div class="sticky top-0 bg-white z-10 p-6 border-b border-slate-100">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-2xl shadow-lg" style="background: ${r.color}">${r.display_name.substring(0,2)}</div>
                                <div><h2 class="text-xl font-bold text-slate-800">${esc(r.display_name)}</h2><p class="text-sm text-slate-500 font-medium">${esc(r.inst)}</p></div>
                            </div>
                            <button onclick="document.getElementById('researcherModal').classList.remove('active')" class="text-slate-400 hover:text-slate-700"><i class="fas fa-times text-lg"></i></button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 text-center"><span class="block font-bold text-2xl text-slate-700">${r.net_works}</span><span class="text-[10px] font-bold uppercase text-slate-400">Publications</span></div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 text-center"><span class="block font-bold text-2xl text-slate-700">${r.net_cited}</span><span class="text-[10px] font-bold uppercase text-slate-400">Total Citations</span></div>
                        </div>
                    </div>
                    <div class="p-6">
                        <h4 class="font-bold text-xs uppercase text-slate-400 mb-4 tracking-wider">Latest Contributions</h4>
                        <div class="space-y-3">
                            ${rPubs.map(p => `<div class="p-3 rounded-lg border border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors" onclick="document.getElementById('researcherModal').classList.remove('active');app.showWorkDetail('${p.id}')"><div class="font-semibold text-sm text-slate-700 mb-1">${esc(p.title)}</div><div class="text-xs text-slate-400 flex justify-between"><span>${p.publication_year}</span><span>${p.cited_by_count} citations</span></div></div>`).join('')}
                        </div>
                    </div>`;
            },

            showWorkDetail: async (id) => {
                const p = app.data.pubs.find(x => x.id === id); if (!p) return;
                document.getElementById('detailModal').classList.add('active');
                const render = (abs) => document.getElementById('detailContent').innerHTML = `
                    <div class="flex justify-between items-start mb-6 pb-4 border-b border-slate-100">
                        <h2 class="text-2xl font-bold text-slate-800 pr-12 leading-tight">${esc(p.title)}</h2>
                        <button onclick="document.getElementById('detailModal').classList.remove('active')" class="text-slate-400 hover:text-slate-700 text-xl"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="flex flex-wrap gap-4 text-sm text-slate-500 mb-8 font-medium">
                        <span class="flex items-center gap-2"><i class="fas fa-calendar"></i> ${p.publication_year}</span>
                        <span class="flex items-center gap-2"><i class="fas fa-quote-right"></i> ${p.cited_by_count} Citations</span>
                        ${p.source ? `<span class="flex items-center gap-2"><i class="fas fa-book"></i> ${esc(p.source)}</span>` : ''}
                        ${p.doi ? `<a href="${p.doi}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-2"><i class="fas fa-external-link-alt"></i> View Source</a>` : ''}
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <h4 class="font-bold text-sm text-slate-800 uppercase tracking-wide mb-3">Abstract</h4>
                            <div class="text-slate-600 text-sm leading-relaxed bg-slate-50 p-6 rounded-xl border border-slate-100 text-justify">${esc(abs)}</div>
                        </div>
                        <div>
                            <h4 class="font-bold text-sm text-slate-800 uppercase tracking-wide mb-3">Authors</h4>
                            <div class="flex flex-col gap-2">
                                ${p._allAuthors.map(a => `<div class="flex items-center gap-2 text-sm p-2 rounded-lg border ${a.isMember?'border-green-200 bg-green-50 cursor-pointer hover:bg-green-100':'border-transparent text-slate-500'}" ${a.isMember?`onclick="document.getElementById('detailModal').classList.remove('active');app.showResearcherDetail(app.data.researchers.find(r=>r.id==='${a.id}'))"`:''}>
                                    ${a.isMember?'<span class="w-2 h-2 rounded-full bg-green-500"></span>':''}
                                    <span class="${a.isMember?'font-semibold text-green-800':''}">${esc(a.name)}</span>
                                </div>`).join('')}
                            </div>
                            <div class="mt-8">
                                <h4 class="font-bold text-sm text-slate-800 uppercase tracking-wide mb-3">Topics</h4>
                                <div class="flex flex-wrap gap-1.5">${p._topics.map(t => `<span class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded border border-slate-200">${esc(t)}</span>`).join('')}</div>
                            </div>
                        </div>
                    </div>`;
                
                render("Loading abstract...");
                try {
                    const d = await fetchJSON(`${API}/works/${suffix(id)}?select=abstract_inverted_index`);
                    render(d?.abstract_inverted_index ? Object.keys(d.abstract_inverted_index).reduce((a, k) => (d.abstract_inverted_index[k].forEach(i => a[i] = k), a), []).join(' ') : "No abstract available.");
                } catch { render("Abstract information not available."); }
            },

            cite: (id) => {
                const p = app.data.pubs.find(x => x.id === id), aa = p._allAuthors.map(a => a.name);
                document.getElementById('citeAPA').textContent = `${aa.slice(0,6).join(', ')}${aa.length>6?', ...':''} (${p.publication_year}). ${p.title}. ${p.source||'Journal'}.`;
                document.getElementById('citeBib').textContent = `@article{${aa[0].split(' ').pop().toLowerCase()}${p.publication_year}, author={${aa.join(' and ')}}, title={${p.title}}, year={${p.publication_year}}, journal={${p.source||'Journal'}}}`;
                document.getElementById('citationModal').classList.add('active');
            },

            copy: (id) => {
                navigator.clipboard.writeText(document.getElementById(id).textContent);
                const btn = event.currentTarget; const og = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check text-green-600"></i>';
                setTimeout(()=>btn.innerHTML=og, 1500);
            },

            exportData: () => {
                const csv = [['Title','Year','Citations','Authors','DOI'], ...app.data.pubs.map(p => [`"${p.title.replace(/"/g,'""')}"`, p.publication_year, p.cited_by_count, `"${p._allAuthors.map(a=>a.name).join('; ')}"`, p.doi||''])];
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv.map(r=>r.join(',')).join('\n')], {type:'text/csv'})); a.download = 'agripv_data.csv'; a.click();
            },

            // D3 Controls
            zoomGraph: (k) => app.d3.svg.transition().duration(750).call(app.d3.zoom.scaleBy, k),
            resetGraph: () => {
                const con = document.getElementById('graphContainer');
                app.d3.svg.transition().duration(750).call(app.d3.zoom.transform, d3.zoomIdentity);
                app.d3.sim.force('center', d3.forceCenter(con.clientWidth/2, con.clientHeight/2)).alpha(0.3).restart();
            },

            setupUI: () => {
                const el = (id) => document.getElementById(id);
                
                // Search & Filter Debounce
                let tm;
                el('globalSearch').oninput = e => { clearTimeout(tm); tm = setTimeout(() => { app.state.filters.q = e.target.value; app.state.page = 1; app.render(); }, 300); };
                el('sortSelect').onchange = e => { app.state.sort = e.target.value; app.state.page = 1; app.render(); };
                ['yearFrom','yearTo'].forEach(id => el(id).onchange = e => { app.state.filters[id==='yearFrom'?'yFrom':'yTo'] = e.target.value ? parseInt(e.target.value) : null; app.render(); });

                // D3 Sliders
                el('linkDistance').oninput = e => { el('valLink').textContent = e.target.value; app.d3.sim.force('link').distance(+e.target.value).alpha(0.3).restart(); };
                el('chargeStrength').oninput = e => { el('valCharge').textContent = e.target.value; app.d3.sim.force('charge').strength(-e.target.value).alpha(0.3).restart(); };

                // Split Pane Logic
                let drag = false;
                const updateViews = () => { setTimeout(() => { app.resizeGraph(); }, 50); };
                
                document.querySelectorAll('.view-btn').forEach(btn => btn.onclick = () => {
                    const v = btn.dataset.view, both = v === 'both';
                    el('publicationsPanel').style.display = (both || v === 'publications') ? 'flex' : 'none';
                    el('publicationsPanel').style.width = both ? '50%' : (v === 'publications' ? '100%' : '0%');
                    el('networkPanel').style.display = (both || v === 'network') ? 'flex' : 'none';
                    el('networkPanel').style.width = both ? '50%' : (v === 'network' ? '100%' : '0%');
                    el('splitHandle').style.display = both ? 'block' : 'none';
                    document.querySelectorAll('.view-btn').forEach(b => {
                        b.className = `view-btn px-3 py-1.5 text-xs font-semibold rounded-md transition-all ${b===btn ? 'bg-white shadow-sm text-slate-800 ring-1 ring-slate-200' : 'text-slate-500 hover:text-slate-700'}`;
                    });
                    updateViews();
                });

                el('splitHandle').onmousedown = () => { drag = true; document.body.style.cursor = 'col-resize'; };
                document.onmouseup = () => { drag = false; document.body.style.cursor = 'default'; if(drag) updateViews(); };
                document.onmousemove = e => { 
                    if(drag) { 
                        const pct = (e.clientX - 340) / (document.body.clientWidth - 340) * 100; // Account for sidebar
                        if(pct > 15 && pct < 85) {
                            el('publicationsPanel').style.width = `${pct}%`; 
                            el('networkPanel').style.width = `${100-pct}%`; 
                            app.resizeGraph();
                        }
                    }
                };
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);
        window.app = app;
    </script>
</body>
</html>