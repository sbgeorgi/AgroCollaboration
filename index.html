<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agrovoltaicos sin Fronteras â€¢ Seminar Platform</title>
  <meta name="description" content="A seminar series to share advances in agrivoltaics in the Americas (EN/ES)." />
  <!-- Fonts: Headings (Poppins), Body (Lato), Handwritten accents (Caveat) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600&family=Lato:wght@400;700&family=Poppins:wght@700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* --- CORE LAYOUT: Full viewport on DESKTOP ONLY (Adapted from archive.html) --- */
    @media (min-width: 961px) {

      html,
      body {
        height: 100vh;
        max-height: 100vh;
        overflow: hidden;
      }
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    main.container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    main.container>.card {
      margin: 0;
    }

    #hero,
    #auth {
      flex-shrink: 0;
    }

    .hero {
      padding: var(--space-3) var(--space-4) !important;
    }

    #schedule,
    #eventDetail {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #eventsList,
    #calendar {
      flex-grow: 1;
      min-height: 0;
    }

    #eventsList {
      overflow-y: auto;
    }

    /* --- HEADER & NAVIGATION (from archive.html) --- */
    .mobile-menu-btn {
      display: none;
    }

    /* Mobile Nav Overlay */
    .mobile-nav-overlay {
      display: none;
      /* Hidden by default, shown with JS */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: var(--space-4);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100dvh;
      background: rgba(0, 33, 71, 0.92);
      /* Academic Navy overlay */
      backdrop-filter: blur(10px);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    .mobile-nav-overlay.is-open {
      display: flex;
      opacity: 1;
    }

    /* --- LOADER STYLES --- */
    .loader-container {
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--brand);
      /* Muted teal accent */
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }


    /* ========== MODIFICATION START: Replaced Event Card styling with archive.html version ========== */
    #eventsList {
      display: none;
      /* MODIFICATION: Hide by default to prevent jarring load */
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      grid-auto-rows: min-content;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-1);
      overflow-y: auto;
    }

    @supports (scrollbar-gutter: stable) {
      #eventsList {
        scrollbar-gutter: stable;
        padding-right: var(--space-2);
      }
    }

    .event-card {
      position: relative;
      display: flex;
      flex-direction: column;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      /* Using variable from styles.css */
      box-shadow: var(--shadow);
      /* Using variable from styles.css */
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      min-height: 320px;
      padding: var(--space-3);
    }

    .event-card:hover {
      transform: translateY(-4px);
      border-color: var(--brand);
      box-shadow: var(--shadow-lg);
    }

    .event-card .when {
      font-size: 0.95rem;
      color: var(--muted);
      margin-bottom: var(--space-1);
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--space-2);
    }

    .event-title {
      font-size: 1.35rem;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: var(--space-1);
      color: var(--brand-2);
    }

    .event-speaker {
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
    }

    .event-desc {
      flex-grow: 1;
      margin: var(--space-2) 0;
      max-height: 150px;
      overflow-y: auto;
      padding-right: var(--space-1);
      line-height: 1.6;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .event-desc::-webkit-scrollbar {
      width: 6px;
    }

    .event-desc::-webkit-scrollbar-track {
      background: transparent;
    }

    .event-desc::-webkit-scrollbar-thumb {
      background-color: var(--border);
      border-radius: 10px;
    }

    .event-card .tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      align-items: center;
      margin-top: auto;
      padding-top: var(--space-2);
      border-top: 1px solid var(--border);
    }

    .tag-topic {
      background: var(--card-2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .2rem .7rem;
      font-size: .8rem;
      font-weight: 600;
      color: var(--brand-2);
    }

    /* ========== MODIFICATION END ========== */

    #calendar {
      display: none;
      flex-direction: column;
    }

    #calendarGrid {
      flex-grow: 1;
      overflow-y: auto;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
    }

    .hero-main {
      flex: 1 1 60%;
      min-width: 350px;
    }

    .hero-main>h1 {
      margin-top: 0;
      margin-bottom: var(--space-2);
    }

    .hero-main>p {
      margin: 0;
    }

    .hero .meta {
      flex: 0 1 auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: var(--space-1);
    }

    /* --- CALENDAR & SCHEDULE HEADER REWORK --- */
    #schedule .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
    }

    .section-header .calendar-header {
      display: none;
      align-items: center;
      gap: var(--space-2);
      flex-grow: 1;
      justify-content: center;
    }

    #schedule.calendar-view .section-header .calendar-header {
      display: flex;
    }

    #schedule .calendar-header-standalone {
      display: none;
    }

    /* Calendar event display styles */
    .cal-event {
      display: block;
      width: 100%;
      padding: var(--space-2);
      margin-top: var(--space-1);
      font-size: 0.8rem;
      line-height: 1.35;
      text-align: left;
      border: none;
      border-radius: var(--radius-1);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      overflow: hidden;
    }

    .cal-event-title {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: var(--space-1);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--brand-2);
    }

    .cal-event-desc {
      font-size: 0.78rem;
      line-height: 1.3;
      opacity: 0.85;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
      color: var(--text);
    }

    .cal-event.status-scheduled {
      background-color: var(--color-primary-muted);
      color: var(--color-primary);
    }

    .cal-event.status-completed {
      background-color: var(--color-success-muted);
      color: var(--color-success);
    }

    .cal-event.status-canceled {
      background-color: var(--color-danger-muted);
      color: var(--color-danger);
    }

    .cal-event:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .cal-cell {
      min-height: 100px;
      padding: var(--space-2);
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-1);
    }

    .cal-day {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: var(--space-1);
      color: var(--muted);
      align-self: flex-end;
    }

    .section-title-group {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    #schedule .section-header h2 {
      margin: 0;
    }

    /* NEW: Compact, Horizontal Auth Section */
    #auth .auth-centered {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-2) var(--space-3);
      min-height: auto;
    }

    #auth .auth-centered h2 {
      margin: 0;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .auth-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-3);
      flex-grow: 1;
      justify-content: flex-end;
    }

    #emailForm.auth-form-secondary {
      display: flex;
      gap: var(--space-2);
    }

    @media (max-width: 800px) {
      #auth .auth-centered {
        flex-direction: column;
        align-items: center;
        gap: var(--space-3);
      }

      .auth-controls {
        justify-content: center;
      }
    }

    /* ========== Event Detail Layout ========== */
    #eventDetail.card {
      padding: 0;
      border: none;
      background: none;
      box-shadow: none;
    }

    .tab-panel {
      flex-grow: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    #discussion-layout {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: var(--space-4);
      flex-grow: 1;
      min-height: 0;
    }

    .sidebar-container,
    #discussion-main {
      background-color: var(--color-surface);
      border-radius: var(--radius-3);
      padding: var(--space-3);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .sidebar-container {
      overflow-y: auto;
    }

    .sidebar-container #compactEventHeaderContainer {
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
      margin-bottom: var(--space-3);
      flex-shrink: 0;
    }

    .sidebar-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .sidebar-title-row h2 {
      margin: 0;
      font-size: 1.4rem;
      line-height: 1.25;
      font-weight: 700;
      flex: 1;
      color: var(--brand-2);
    }

    .btn-pill {
      border-radius: 999px;
      border: 1px solid var(--color-border);
      padding: .2rem .6rem;
      font-size: .85rem;
      background: var(--color-surface-strong);
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .btn-pill:hover {
      background-color: var(--color-surface-hover);
      transform: translateY(-1px);
    }

    .event-speakers {
      margin-top: var(--space-2);
    }

    .speaker-list {
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
      margin: .5rem 0 0;
      padding: 0;
      list-style: none;
    }

    .speaker-pill {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .25rem .7rem;
      border-radius: 999px;
      border: 1px solid var(--spk-color, var(--color-primary));
      background: color-mix(in oklab, var(--spk-color, var(--color-primary)) 12%, transparent);
      font-size: .9rem;
      line-height: 1.1;
      color: var(--color-text);
    }

    .speaker-affiliation {
      color: var(--color-text-muted);
      font-size: .85rem;
    }

    .sidebar-meta {
      margin-top: var(--space-2);
      color: var(--color-text-muted);
      display: flex;
      flex-direction: column;
      gap: .35rem;
      font-size: .95rem;
    }

    .sidebar-tags {
      display: flex;
      flex-wrap: wrap;
      gap: .35rem;
      margin-top: var(--space-2);
    }

    .zoom-inline {
      margin-top: var(--space-3);
      display: flex;
      gap: .5rem;
      align-items: center;
    }

    .event-actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      align-items: center;
      margin-top: var(--space-3);
    }

    .chip {
      border-radius: 999px;
      padding: .35rem .8rem;
      border: 1px solid var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      cursor: pointer;
      font-weight: 700;
      font-size: .85rem;
      white-space: nowrap;
      transition: all 0.2s ease;
      color: var(--brand-2);
      background: var(--color-surface);
    }

    .chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chip.active {
      font-weight: 800;
      border-color: var(--brand);
      box-shadow: inset 0 0 0 1px var(--brand);
      color: var(--brand);
    }

    .chip[data-rsvp="going"].active {
      background: var(--color-success-muted);
      color: var(--color-success);
      border-color: var(--color-success);
    }

    .chip[data-rsvp="interested"].active {
      background: color-mix(in oklab, orange 15%, transparent);
      color: #d06900;
      border-color: orange;
    }

    .chip[data-rsvp="not_going"].active {
      background: var(--color-danger-muted);
      color: var(--color-danger);
      border-color: var(--color-danger);
    }

    .chip#btnFollowCompact.active {
      background: var(--color-primary-muted);
      color: var(--color-primary);
      border-color: var(--color-primary);
    }

    .inline-form {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-bottom: var(--space-3);
    }

    .inline-form input[type="text"] {
      flex: 1;
    }

    #threadsList {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .thread-list-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: var(--space-2);
      padding: var(--space-2);
      border-radius: var(--radius-2);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      align-items: center;
    }

    .thread-list-item:hover {
      background-color: var(--color-surface-hover);
      transform: translateY(-1px);
    }

    .thread-list-item.active {
      background-color: var(--color-primary-muted);
    }

    .thread-list-item .title {
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--brand-2);
    }

    .thread-list-item .meta {
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }

    .avatar-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--color-surface-strong);
      display: grid;
      place-content: center;
      font-weight: 700;
      font-size: 1rem;
      flex-shrink: 0;
      color: var(--brand-2);
      border: 1px solid var(--color-border);
    }

    .tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
    }

    .tab {
      background: none;
      border: none;
      color: var(--color-text-muted);
      padding: .7rem .3rem;
      cursor: pointer;
      font-weight: 700;
      font-size: .95rem;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s, background-color 0.2s;
      border-radius: 6px 6px 0 0;
    }

    .tab:hover {
      color: var(--brand-2);
      background-color: var(--color-surface-hover);
    }

    .tab.active {
      color: var(--brand);
      border-color: var(--brand);
    }

    .prose {
      line-height: 1.7;
      color: var(--color-text);
      font-size: 1rem;
      overflow-y: auto;
      padding-right: var(--space-2);
    }

    .prose a {
      color: var(--brand);
      text-decoration: none;
      border-bottom: 1px solid color-mix(in oklab, var(--brand) 35%, transparent);
    }

    .prose a:hover {
      border-bottom-color: var(--brand);
    }

    #thread-welcome {
      flex-grow: 1;
      display: grid;
      place-content: center;
      color: var(--color-text-muted);
      text-align: center;
      padding: var(--space-4);
    }

    /* --- CORRECTED CHAT STYLES (from old version) --- */
    #threadDetailView {
      flex-grow: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      padding: 0;
    }

    #commentsList {
      flex-grow: 1;
      overflow-y: auto;
      padding: var(--space-2);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .comment-node {
      display: block;
      position: relative;
    }

    .comment-author {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 0.9rem;
      color: var(--color-text-muted);
    }

    .avatar-circle.comment-avatar {
      width: 26px;
      height: 26px;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--color-text);
    }

    .comment-author strong {
      font-weight: 700;
      cursor: pointer;
      color: var(--brand-2);
    }

    .comment-author .timestamp {
      color: var(--color-text-muted);
    }

    .comment-body-wrapper {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-top: var(--space-1);
    }

    .comment-bubble {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: calc(var(--space-2) - 2px) var(--space-3);
      background: var(--color-surface-strong);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-2);
      max-width: 100%;
    }

    .comment-text {
      margin: 0;
      line-height: 1.6;
      font-size: 0.98rem;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .comment-actions {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .comment-actions .btn-ghost {
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--color-text-muted);
      padding: var(--space-1) 0;
    }

    .comment-replies {
      margin-top: var(--space-2);
      margin-left: 28px;
      padding-left: 16px;
      border-left: 2px solid var(--color-surface-strong);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      position: relative;
    }

    .comment-replies:empty {
      border-left: none;
      padding-left: 0;
      margin-left: 0;
    }

    .comment-main {
      position: relative;
    }

    .thread-dot {
      position: absolute;
      left: -25px;
      top: 12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-surface);
      border: 2px solid var(--accent, var(--color-primary));
      box-shadow: 0 0 0 3px var(--color-surface);
      pointer-events: none;
    }

    .comment-node.depth-0>.comment-main .thread-dot {
      display: none;
    }

    .inline-reply-form {
      margin-top: var(--space-2);
    }

    #replyToThreadForm {
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border);
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    #replyToThreadForm textarea {
      flex-grow: 1;
      resize: none;
    }

    /* --- RESPONSIVE ADJUSTMENTS (from archive.html) --- */
    @media (max-width: 960px) {

      /* HEADER & NAV */
      .mobile-menu-btn {
        display: block;
        background: none;
        border: none;
        color: var(--brand-2);
        font-size: 2rem;
        cursor: pointer;
        z-index: 1001;
        padding: 0;
        line-height: 0;
      }

      .header-grid>.nav {
        display: none;
      }

      .mobile-nav-overlay .nav {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-4);
      }

      .mobile-nav-overlay .link {
        font-size: 1.8rem;
        font-weight: 700;
        color: #fff;
      }

      .mobile-nav-overlay .divider {
        display: none;
      }

      .mobile-nav-overlay .auth-area {
        margin-top: var(--space-2);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-3);
      }

      .mobile-nav-close-btn {
        position: absolute;
        top: var(--space-3);
        right: var(--space-3);
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        line-height: 1;
        padding: 0;
      }

      body.menu-open {
        overflow: hidden;
      }

      /* INDEX.HTML CONTENT */
      .hero {
        text-align: center;
        flex-direction: column;
      }

      .hero-main {
        min-width: 0;
      }

      .hero .meta {
        text-align: center;
        align-items: center;
      }

      #schedule .section-header {
        flex-direction: column;
        align-items: stretch;
      }

      #schedule .search-bar {
        width: 100%;
      }

      #schedule .search-bar input {
        width: 100%;
        box-sizing: border-box;
      }

      /* EVENT DETAIL VIEW */
      #discussion-layout {
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }

      .sidebar-container,
      #discussion-main {
        overflow-y: visible;
      }
    }
  </style>

</head>

<body>
  <header class="site-header">
    <div class="container header-grid">
      <div class="brand">
        <a href="index.html" style="display: contents; text-decoration: none;">

          <!-- MODIFICATION: Replaced the old logo div with your new image -->
          <img src="static/icon.png" alt="Agrovoltaicos sin Fronteras logo" class="logo-image">

          <div class="brand-text">
            <div class="title">Agrovoltaicos sin Fronteras</div>
            <div class="subtitle" data-i18n="tagline">
              A seminar series to share advances in agrivoltaics in the Americas
            </div>
          </div>
        </a>
      </div>

      <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <!-- Desktop Nav -->
      <nav class="nav">
        <a href="index.html" class="link" data-i18n="nav.schedule">Schedule</a>
        <a href="archive.html" class="link" data-i18n="nav.archive">Archive</a>
        <a href="about.html" class="link" data-i18n="nav.about">About</a>
        <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
        <div class="divider"></div>
        <div id="langSwitchDesktop" class="lang-switch-slider" data-lang="en">
          <span>EN</span>
          <span>ES</span>
        </div>
        <div class="auth-area">
          <!-- PRESERVED: This is the user profile button, which is handled by your JS -->
          <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile">
            <span id="userInitial"></span>
            <img id="userAvatar" style="display: none; width: 100%; height: 100%; object-fit: cover;" />
          </button>
          <span id="userName"></span>
          <!-- MODIFIED: Button is now a link to the signin page -->
          <a href="signin.html" id="btnSignIn" class="btn-primary" data-i18n="auth.signin"
            style="text-decoration: none; display: inline-block;">Sign in</a>
          <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
            Sign out
          </button>
        </div>
      </nav>
    </div>
  </header>

  <div id="mobileNavOverlay" class="mobile-nav-overlay">
    <!-- Content will be injected by JS -->
  </div>

  <div id="flash" class="flash" role="status" aria-live="polite"></div>

  <main class="container">
    <!-- Hero -->
    <section id="hero" class="card hero">
      <div class="hero-main">
        <h1 style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap;">
          <span>Agrovoltaicos sin Fronteras</span>
          <div id="siteBanner"
            style="display: none; background: linear-gradient(135deg, var(--color-primary), var(--brand-2)); color: white; padding: 4px 12px; border-radius: 999px; font-size: 0.9rem; font-weight: 700; box-shadow: 0 2px 8px rgba(0, 33, 71, 0.2); animation: pulse 2s ease-in-out infinite; white-space: nowrap; font-family: 'Caveat', cursive;">
            <span>ðŸ“¢</span>
            <span id="bannerText"></span>
          </div>
        </h1>
        <!-- MODIFIED: Text is now full width due to CSS change -->
        <p data-i18n="intro">
          Agrivoltaics (agrivoltaics) is an emerging field that integrates solar energy with
          crop/livestock production. This bilingual seminar focuses on Latin America. Hosted by
          UNAM and University of Arizona.
        </p>
      </div>
      <div class="meta">
        <!-- MODIFIED: Text changed to Bi-monthly -->
        <span class="meta-item" data-i18n="format">Online â€¢ Bi-monthly â€¢ 1 hour</span>
        <span class="meta-item" data-i18n="hosted">Hosted by UNAM & University of Arizona</span>
      </div>
    </section>

    <!-- Schedule -->
    <section id="schedule" class="card" aria-labelledby="scheduleTitle">
      <div class="section-header">
        <div class="section-title-group">
          <h2 id="scheduleTitle" data-i18n="schedule.title">Upcoming Talks</h2>
          <div class="view-switch">
            <button id="viewList" class="chip chip-toggle active" data-i18n="schedule.list">List</button>
            <button id="viewCalendar" class="chip chip-toggle" data-i18n="schedule.calendar">Calendar</button>
          </div>
        </div>
        <div class="calendar-header">
          <button id="calPrev" class="btn-ghost" aria-label="Previous month">â—€</button>
          <div id="calLabel" class="cal-label">Month</div>
          <button id="calNext" class="btn-ghost" aria-label="Next month">â–¶</button>
        </div>
        <!-- MODIFIED: Wrapper for controls -->
        <div class="search-controls">
          <div class="calendar-legend">
            <span class="legend scheduled" data-i18n="legend.scheduled">Scheduled</span>
            <span class="legend completed" data-i18n="legend.completed">Completed</span>
            <span class="legend canceled" data-i18n="legend.canceled">Canceled</span>
          </div>
          <div class="search-bar">
            <input id="search" type="search" placeholder="Search..." data-i18n-placeholder="search.placeholder" />
          </div>
        </div>
      </div>

      <!-- MODIFICATION: Added loader -->
      <div id="eventsLoader" class="loader-container">
        <div class="spinner"></div>
      </div>

      <div id="eventsList" class="events-grid"></div>

      <div id="calendar" class="calendar">
        <div class="calendar-grid" id="calendarGrid"></div>
        <!-- MODIFIED: Legend moved to section-header -->
      </div>

      <div id="emptyEvents" class="empty" style="display: none" data-i18n="schedule.empty">
        No events yet. Check back soon.
      </div>
    </section>

    <!-- MODIFIED: Auth section removed, functionality moved to signin.html -->

    <!-- Event Detail -->
    <section id="eventDetail" class="card" style="display: none">
      <div id="discussion-layout">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar-container">
          <div id="compactEventHeaderContainer">
            <!-- JS Renders Event Details Here -->
          </div>

          <form id="newThreadForm" class="inline-form">
            <input id="threadTitle" type="text" placeholder="Start a new topic..." required
              data-i18n-placeholder="thread.placeholder" />
            <button class="btn-primary" type="submit" data-i18n="thread.create">Create</button>
          </form>
          <div id="threadsList">
            <!-- JS Renders Threads Here -->
          </div>
        </div>

        <!-- RIGHT MAIN AREA -->
        <div id="discussion-main">
          <div class="tabs">
            <button class="tab active" data-tab="description" data-i18n="tabs.description">Description</button>
            <button class="tab" data-tab="discussion" data-i18n="tabs.discussion">Discussion</button>
            <button class="tab" data-tab="files" data-i18n="tabs.files">Files</button>
          </div>

          <!-- Description Panel -->
          <div id="tab_description" class="tab-panel">
            <div id="descriptionContent" class="prose"></div>
          </div>

          <!-- Discussion Panel -->
          <div id="tab_discussion" class="tab-panel" style="display: none;">
            <div id="thread-welcome">
              <div>
                <h3 data-i18n="discussion.welcome_title">Welcome to the discussion!</h3>
                <p data-i18n="discussion.welcome_body">Select a topic from the left to view the
                  conversation, or start a new one.</p>
              </div>
            </div>
            <div id="threadDetailView" style="display: none;">
              <div id="commentsList"></div>
              <form id="replyToThreadForm">
                <textarea placeholder="Write a comment..." required
                  data-i18n-placeholder="comment.placeholder"></textarea>
                <button class="btn-primary" type="submit" data-i18n="comment.send">Send</button>
              </form>
            </div>
          </div>

          <!-- Files Panel -->
          <div id="tab_files" class="tab-panel" style="display: none">
            <form id="uploadForm" class="inline-form">
              <input id="fileInput" type="file" />
              <button class="btn-primary" type="submit" data-i18n="files.upload">Upload</button>
            </form>
            <div id="filesList" class="files"></div>
            <div id="emptyFiles" class="empty" style="display: none" data-i18n="files.empty">
              No files yet.
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center;">
          Â© <span id="year"></span> Agrovoltaicos sin Fronteras â€¢
          <span data-i18n="footer.note">Bilingual, community-driven seminar on agrivoltaics in Latin America.</span>
        </div>
        <div style="display: flex; align-items: center;">
          <a href="https://biosphere2.org/research/research-initiatives/agrivoltaics" target="_blank"
            rel="noopener noreferrer" style="margin-left: 8px;">
            <img src="static/b2ua.jpg" alt="Biosphere 2 Agrivoltaics"
              style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
          <a href="https://www.ier.unam.mx/ParcelaAgrovoltaica.html" target="_blank" rel="noopener noreferrer"
            style="margin-left: 8px;">
            <img src="static/unam.png" alt="UNAM"
              style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
        </div>
      </small>
    </div>
  </footer>

  <script type="module">
    import {
      supabase,
      authState,
      initAuth,
      fetchProfile, // <-- CORRECTED: Import fetchProfile
      signInWithGoogle,
      signInWithEmail,
      signOut
    } from "./auth.js";
    import { initEventLogic } from "./static/js/event.js";

    let eventLogic;

    const state = {
      language: localStorage.getItem("lang") || "en",
      events: [],
      selectedEvent: null,
      threads: [],
      selectedThreadId: null,
      comments: [],
      files: [],
      rsvpStatus: null,
      isFollowing: false,
      counts: { followers: 0, going: 0, interested: 0 },
      calendarMonth: new Date(),
    };

    const t = {
      en: {
        tagline: "A seminar series to share advances in agrivoltaics in the Americas",
        intro: "Agrovoltaicos sin Fronteras is a participatory seminar series presenting the latest advances in agrivoltaics research and development across the Americas and beyond. We welcome researchers, practitioners, students and anyone interested in agrivoltaics to join us for bi-weekly seminars and discussions. Seminars are bilingual (English and/or Spanish) and take place on zoom. Register to join the seminars or continue the discussion in the members forum!",
        format: "Online â€¢ Bi-monthly â€¢ 1 hour", // MODIFIED
        hosted: "Hosted by UNAM & University of Arizona",
        nav: { schedule: "Schedule", archive: "Archive", about: "About", admin: "Admin" },
        auth: {
          title: "Sign in to participate", signin: "Sign in", signout: "Sign out",
          email: "Email", magic: "Send magic link", magic_hint: "We'll email you a sign-in link. Check your inbox.", or: "or",
          required: "Please sign in to view event details.",
        },
        profile: { incomplete: "Please complete your profile to access all features" },
        schedule: { title: "Upcomming Talks", empty: "No events yet. Check back soon.", list: "List", calendar: "Calendar" },
        search: { placeholder: "Search..." },
        back: { schedule: "Back to schedule" },
        tabs: { description: "Description", discussion: "Discussion", files: "Files" },
        discussion: { welcome_title: "Welcome to the discussion!", welcome_body: "Select a topic from the left to view the conversation, or start a new one." },
        thread: { placeholder: "Start a new topic...", create: "Create", empty: "No topics yet. Start the discussion!" },
        comment: { placeholder: "Write a comment...", send: "Send" },
        files: { upload: "Upload", empty: "No files yet.", download: "Download" },
        footer: { note: "Bilingual, community-driven seminar on agrivoltaics in Latin America." },
        rsvp: { going: "Going", interested: "Interested", notgoing: "Not going", saved: "RSVP updated" },
        follow: "Follow",
        reply: "Reply",
        legend: { scheduled: "Scheduled", completed: "Completed", canceled: "Canceled" },
        save: "Save", cancel: "Cancel",
        errors: { upload: "Upload failed" },
        labels: { followers: "followers", going: "going", interested: "interested" },
        open: "Open", join_zoom: "Join Zoom", copy_link: "Copy Zoom link", copied: "Copied!",
        tags: "Tags",
        speakers: "Speaker(s)"
      },
      es: {
        tagline: "Una serie de seminarios para compartir avances en agrovoltaicos en las AmÃ©ricas",
        intro: "Agrovoltaicos sin Fronteras es una serie de seminarios participativos que presenta los Ãºltimos avances en investigaciÃ³n y desarrollo de agrovoltaicos en AmÃ©rica y el resto del mundo. Invitamos a investigadores, profesionales, estudiantes y a cualquier persona interesada en los agrovoltaicos a unirse a nuestros seminarios y debates quincenales. Los seminarios son bilingÃ¼es (inglÃ©s y/o espaÃ±ol) y se realizan por Zoom. Â¡RegÃ­strese para unirse a los seminarios o continÃºe la discusiÃ³n en el foro de miembros!",
        format: "En lÃ­nea â€¢ Bimestral â€¢ 1 hora", // MODIFIED
        hosted: "Organizado por UNAM y University of Arizona",
        nav: { schedule: "Calendario", archive: "Archivo", about: "Acerca de", admin: "Admin" },
        auth: {
          title: "Inicia sesiÃ³n para participar", signin: "Iniciar sesiÃ³n", signout: "Cerrar sesiÃ³n",
          email: "Correo", magic: "Enviar enlace mÃ¡gico", magic_hint: "Te enviaremos un enlace de acceso. Revisa tu bandeja.", or: "o",
          required: "Por favor, inicia sesiÃ³n para ver los detalles del evento.",
        },
        profile: { incomplete: "Por favor completa tu perfil para acceder a todas las funciones" },
        schedule: { title: "Charlas", empty: "AÃºn no hay eventos. Vuelve pronto.", list: "Lista", calendar: "Calendario" },
        search: { placeholder: "Buscar..." },
        back: { schedule: "Volver al calendario" },
        tabs: { description: "DescripciÃ³n", discussion: "DiscusiÃ³n", files: "Archivos" },
        discussion: { welcome_title: "Â¡Bienvenido/a a la discusiÃ³n!", welcome_body: "Selecciona un tema de la izquierda o crea uno nuevo." },
        thread: { placeholder: "Iniciar un nuevo tema...", create: "Crear", empty: "AÃºn no hay temas. Â¡Comienza la discusiÃ³n!" },
        comment: { placeholder: "Escribe un comentario...", send: "Enviar" },
        files: { upload: "Subir", empty: "No hay archivos.", download: "Descargar" },
        footer: { note: "Seminario bilingÃ¼e y comunitario sobre agrofotovoltaica en AmÃ©rica Latina." },
        rsvp: { going: "AsistirÃ©", interested: "Interesado/a", notgoing: "No asistirÃ©", saved: "Asistencia actualizada" },
        follow: "Seguir",
        reply: "Responder",
        legend: { scheduled: "Programado", completed: "Completado", cancelado: "Cancelado" },
        save: "Guardar", cancel: "Cancelar",
        errors: { upload: "Fallo al subir" },
        labels: { followers: "seguidores", going: "asisten", interested: "interesados" },
        open: "Abrir", join_zoom: "Unirse a Zoom", copy_link: "Copiar enlace de Zoom", copied: "Â¡Copiado!",
        tags: "Etiquetas",
        speakers: "Ponente(s)"
      },
    };

    // --- UTILITIES & I18N ---
    function tr(key, fallback = "") { const lang = state.language; const parts = key.split("."); let obj = t[lang]; for (const p of parts) obj = obj?.[p]; return obj ?? fallback; }
    const $ = (sel) => document.querySelector(sel);
    function setFlash(msg, timeout = 3000) {
      const el = $("#flash"); if (!el) return; el.textContent = msg; el.style.display = "block";
      clearTimeout(setFlash._t); if (timeout > 0) { setFlash._t = setTimeout(() => (el.style.display = "none"), timeout); }
    }
    function fmtDateTime(iso) { try { return new Intl.DateTimeFormat(undefined, { dateStyle: "medium", timeStyle: "short" }).format(new Date(iso)); } catch (_) { return iso; } }
    function bytesToSize(bytes = 0) {
      if (bytes === 0) return "0 B"; const k = 1024, sizes = ["B", "KB", "MB", "GB", "TB"], i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }
    function escapeHtml(s = "") { return String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])); }
    function linkify(text = "") {
      let safe = escapeHtml(text); const urlRegex = /\b(https?:\/\/[^\s<]+)\b/g;
      safe = safe.replace(urlRegex, (m) => `<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);
      safe = safe.replace(/\n/g, "<br/>"); return safe;
    }
    function applyI18n() {
      document.querySelectorAll("[data-i18n]").forEach((el) => { el.textContent = tr(el.dataset.i18n, el.textContent); });
      document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => { el.placeholder = tr(el.dataset.i18nPlaceholder, el.placeholder); });
      document.querySelectorAll(".lang-switch-slider").forEach(el => { if (el) el.dataset.lang = state.language; });
    }

    // --- HEADER & MENU ---
    function setupMobileMenu() {
      const mobileNavOverlay = $("#mobileNavOverlay");
      const desktopNav = document.querySelector('.header-grid .nav');
      if (!mobileNavOverlay || !desktopNav) return;
      mobileNavOverlay.innerHTML = '';
      const closeBtn = document.createElement('button');
      closeBtn.className = 'mobile-nav-close-btn';
      closeBtn.setAttribute('aria-label', 'Close menu');
      closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
      const content = desktopNav.cloneNode(true);
      content.id = '';
      const langSwitchMobile = content.querySelector('#langSwitchDesktop');
      if (langSwitchMobile) langSwitchMobile.id = 'langSwitchMobile';
      mobileNavOverlay.appendChild(closeBtn);
      mobileNavOverlay.appendChild(content);
      closeBtn.addEventListener('click', closeMenu);
      mobileNavOverlay.addEventListener('click', (e) => { if (e.target === mobileNavOverlay) closeMenu(); });
      langSwitchMobile?.addEventListener('click', handleLangSwitch);
      // MODIFIED: The sign in button is now a link, so no click listener needed here.
      content.querySelector("#btnSignOut")?.addEventListener("click", () => signOut());
      content.querySelector("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');
    }
    function openMenu() {
      const mobileMenuBtn = $("#mobileMenuBtn"), mobileNavOverlay = $("#mobileNavOverlay");
      mobileNavOverlay.classList.add("is-open"); document.body.classList.add("menu-open");
      mobileMenuBtn.setAttribute("aria-expanded", "true");
      mobileMenuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    }
    function closeMenu() {
      const mobileMenuBtn = $("#mobileMenuBtn"), mobileNavOverlay = $("#mobileNavOverlay");
      mobileNavOverlay.classList.remove("is-open"); document.body.classList.remove("menu-open");
      mobileMenuBtn.setAttribute("aria-expanded", "false");
      mobileMenuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
    }
    function renderHeader() {
      const btnSignIn = $("#btnSignIn"), btnSignOut = $("#btnSignOut"), btnAdmin = $("#btnAdmin"), userName = $("#userName"), btnProfile = $("#btnProfile");
      const isOrganizer = ["organizer", "admin"].includes(authState.profile?.role);
      if (authState.session) {
        btnSignIn.style.display = "none"; btnSignOut.style.display = "inline-block";
        btnProfile.style.display = "grid"; userName.style.display = "inline";
        userName.textContent = authState.profile?.full_name || authState.profile?.username || "";
        $("#userInitial").textContent = (authState.profile?.full_name || "U").charAt(0).toUpperCase();
        if (btnAdmin) btnAdmin.style.display = isOrganizer ? "inline-block" : "none";
      } else {
        btnSignIn.style.display = "inline-block"; btnSignOut.style.display = "none";
        btnProfile.style.display = "none"; userName.style.display = "none";
        if (btnAdmin) btnAdmin.style.display = "none";
      }
      setupMobileMenu();
    }
    function handleLangSwitch() {
      state.language = state.language === 'en' ? 'es' : 'en';
      localStorage.setItem("lang", state.language);
      applyI18n();

      // Update banner text when language changes
      loadSiteBanner();

      renderEventsList();
      if (state.selectedEvent && eventLogic) {
        eventLogic.renderEventHeader();
        eventLogic.renderThreads();
        eventLogic.renderDescriptionTab();
        if (state.selectedThreadId) eventLogic.renderComments();
        eventLogic.renderFiles();
      }
      renderScheduleCalendar();
    }

    // And update your loadSiteBanner function to be accessible:
    async function loadSiteBanner() {
      const { data } = await supabase.from('banners').select('*').eq('is_active', true).single();
      const bannerEl = document.getElementById('siteBanner');
      const textEl = document.getElementById('bannerText');

      if (data && bannerEl && textEl) {
        const text = state.language === 'es' && data.text_es ? data.text_es : data.text_en;
        textEl.textContent = text;
        bannerEl.style.display = 'inline-flex';
      } else if (bannerEl) {
        bannerEl.style.display = 'none';
      }
    }

    // --- PAGE-SPECIFIC LOGIC (SCHEDULE) ---
    function showView(which) {
      $("#schedule").style.display = "none";
      $("#eventDetail").style.display = "none";
      $("#hero").style.display = "none";

      if (which === "schedule") {
        $("#hero").style.display = "flex";
        $("#schedule").style.display = "flex";
      } else if (which === "event") {
        $("#eventDetail").style.display = "flex";
      }
    }

    async function loadEvents() {
      const { data } = await supabase.from("events").select("*, event_speakers(*)").order("start_time", { ascending: true });
      state.events = data || [];
      renderEventsList();
      renderScheduleCalendar();

      // MODIFICATION: Hide loader and show the list view by default
      const loader = $("#eventsLoader");
      const list = $("#eventsList");
      if (loader) loader.style.display = 'none';
      if (list) list.style.display = 'grid';

      const urlParams = new URLSearchParams(window.location.search);
      const eid = urlParams.get("event") || urlParams.get("e");

      if (eid && eventLogic) {
        if (authState.session) {
          await eventLogic.openEvent(eid);
        } else {
          authState.pendingDeepLinkEventId = eid;
          setFlash(tr('auth.required'));
          // MODIFIED: No longer scroll to auth section, user must click sign in link.
          showView("schedule");
        }
      } else {
        showView("schedule");
      }
    }

    function nowUtcComparable(d) {
      return new Date(d).getTime();
    }

    // ========== MODIFICATION START: Updated renderEventsList function ==========
    function renderEventsList() {
      const list = $("#eventsList"), empty = $("#emptyEvents");
      if (!list || !empty) return;
      const term = ($("#search")?.value || "").toLowerCase().trim();
      const now = Date.now();

      const futureEvents = state.events.filter(e => nowUtcComparable(e.start_time) >= now);

      const filtered = futureEvents.filter((e) => {
        if (!term) return true;
        const speakerMatch = (e.event_speakers || []).some(s =>
          (s.name || "").toLowerCase().includes(term) ||
          (s.affiliation || "").toLowerCase().includes(term)
        );
        const tagsMatch = (e.topic_tags || []).some(tag => (tag || "").toLowerCase().includes(term));
        const eventMatch = [e.title_en, e.title_es, e.description_en, e.description_es, e.host_org]
          .filter(Boolean)
          .some((v) => v.toLowerCase().includes(term));
        return speakerMatch || tagsMatch || eventMatch;
      });

      empty.style.display = filtered.length ? "none" : "block";
      list.innerHTML = filtered.map(ev => {
        const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
        const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;

        let speakerLine = '';
        if (ev.event_speakers && ev.event_speakers.length > 0) {
          const primarySpeaker = ev.event_speakers.find(s => s.primary_speaker) || ev.event_speakers[0];
          speakerLine = `<div class="event-speaker">ðŸ‘¤ ${escapeHtml(primarySpeaker.name)}${primarySpeaker.affiliation ? ` (${escapeHtml(primarySpeaker.affiliation)})` : ''}</div>`;
        }

        const tagTopics = (ev.topic_tags || []).map(tag => `<span class="tag-topic">#${escapeHtml(tag)}</span>`).join("");

        return `
        <div class="event-card">
            <div class="event-header">
              <div class="event-info">
                <div class="when">${fmtDateTime(ev.start_time)}</div>
                <h3 class="event-title">${escapeHtml(title)}</h3>
                ${speakerLine}
              </div>
              <div class="actions">
                  <button class="btn-primary" data-open="${String(ev.id)}">${tr('open')}</button>
              </div>
            </div>
            ${desc ? `<div class="event-desc">${linkify(desc)}</div>` : '<div style="flex-grow: 1;"></div>'}
            <div class="tags">
              ${tagTopics}
              <span class="tag">${(ev.language || "bi").toUpperCase()}</span>
              ${ev.host_org ? `<span class="tag">${escapeHtml(ev.host_org)}</span>` : ""}
            </div>
        </div>`;
      }).join('');
    }
    // ========== MODIFICATION END ==========

    function renderScheduleCalendar() {
      const grid = $("#calendarGrid"), label = $("#calLabel"); if (!grid || !label) return;
      const m = state.calendarMonth; label.textContent = m.toLocaleString(state.language, { month: "long", year: "numeric" });
      const start = new Date(m.getFullYear(), m.getMonth(), 1), end = new Date(m.getFullYear(), m.getMonth() + 1, 0);
      const firstDayIndex = (start.getDay() + 6) % 7, daysInMonth = end.getDate(); grid.innerHTML = ``;

      for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement("div"));
      const byDay = state.events.reduce((acc, ev) => {
        const d = new Date(ev.start_time); if (d.getMonth() !== m.getMonth() || d.getFullYear() !== m.getFullYear()) return acc;
        const day = d.getDate(); if (!acc.has(day)) acc.set(day, []); acc.get(day).push(ev); return acc;
      }, new Map());

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div"); cell.className = "cal-cell"; cell.innerHTML = `<div class="cal-day">${day}</div>`;
        (byDay.get(day) || []).forEach((ev) => {
          const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
          const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;

          let speakerName = '';
          if (ev.event_speakers && ev.event_speakers.length > 0) {
            const primarySpeaker = ev.event_speakers.find(s => s.primary_speaker) || ev.event_speakers[0];
            speakerName = `<div class="cal-event-speaker">ðŸ‘¤ ${escapeHtml(primarySpeaker.name)}</div>`;
          }

          const eventDiv = document.createElement("button");
          eventDiv.className = `cal-event status-${ev.status}`;
          eventDiv.innerHTML = `
                <div class="cal-event-title">${escapeHtml(title)}</div>
                ${desc ? `<div class="cal-event-desc">${escapeHtml(desc).substring(0, 60)}...</div>` : ''}
                ${speakerName}
            `;
          eventDiv.addEventListener("click", () => { if (eventLogic) eventLogic.openEvent(ev.id) });

          cell.appendChild(eventDiv);
        });
        grid.appendChild(cell);
      }
    }

    // --- WIRING & INITIALIZATION ---
    function wireUI() {
      $("#btnSignOut")?.addEventListener("click", () => signOut());
      // MODIFIED: Auth form listeners removed
      $("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');

      $("#eventsList").addEventListener("click", e => {
        const openBtn = e.target.closest('[data-open]');
        if (openBtn && eventLogic) { eventLogic.openEvent(openBtn.dataset.open); return; }
      });

      $("#search")?.addEventListener("input", renderEventsList);
      $("#viewList")?.addEventListener("click", () => { $("#schedule").classList.remove("calendar-view"); $("#viewList").classList.add("active"); $("#viewCalendar").classList.remove("active"); $("#eventsList").style.display = "grid"; $("#calendar").style.display = "none"; });
      $("#viewCalendar")?.addEventListener("click", () => { $("#schedule").classList.add("calendar-view"); $("#viewCalendar").classList.add("active"); $("#viewList").classList.remove("active"); $("#eventsList").style.display = "none"; $("#calendar").style.display = "flex"; });
      $("#calPrev")?.addEventListener("click", () => { state.calendarMonth.setMonth(state.calendarMonth.getMonth() - 1); renderScheduleCalendar(); });
      $("#calNext")?.addEventListener("click", () => { state.calendarMonth.setMonth(state.calendarMonth.getMonth() + 1); renderScheduleCalendar(); });

      $("#langSwitchDesktop")?.addEventListener('click', handleLangSwitch);
      $("#mobileMenuBtn")?.addEventListener("click", () => {
        const overlay = $("#mobileNavOverlay");
        if (overlay && !overlay.classList.contains('is-open')) {
          openMenu();
        } else {
          closeMenu();
        }
      });

      $("#year").textContent = new Date().getFullYear();
    }

    (async function main() {

      (async function loadBanner() {
        const { data } = await supabase.from('banners').select('*').eq('is_active', true).single();
        if (data) {
          const bannerEl = document.getElementById('siteBanner');
          const textEl = document.getElementById('bannerText');
          if (bannerEl && textEl) {
            const text = state.language === 'es' && data.text_es ? data.text_es : data.text_en;
            textEl.textContent = text;
            bannerEl.style.display = 'inline-flex';
          }
        }

        // Subscribe to banner changes
        supabase.channel('public:banners')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'banners' }, async () => {
            const { data } = await supabase.from('banners').select('*').eq('is_active', true).single();
            const bannerEl = document.getElementById('siteBanner');
            const textEl = document.getElementById('bannerText');
            if (data && bannerEl && textEl) {
              const text = state.language === 'es' && data.text_es ? data.text_es : data.text_en;
              textEl.textContent = text;
              bannerEl.style.display = 'inline-flex';
            } else if (bannerEl) {
              bannerEl.style.display = 'none';
            }
          })
          .subscribe();
      })();

      applyI18n();
      wireUI();

      await initAuth({
        onAuthReady: (authState) => {
          renderHeader();
        },
        onAuthChange: (authState) => {
          renderHeader();
          if (state.selectedEvent && eventLogic) {
            eventLogic.loadRSVPFollow(state.selectedEvent.id);
          }
        }
      });

      eventLogic = initEventLogic({
        supabase, authState, fetchProfile, // <-- CORRECTED: Pass fetchProfile
        tr, state, $, setFlash,
        fmtDateTime, escapeHtml, linkify, bytesToSize, showView,
        listViewName: 'schedule'
      });

      // --- MODIFICATION: Auto-select first thread on discussion tab ---
      const originalOpenEvent = eventLogic.openEvent;
      eventLogic.openEvent = async (...args) => {
        await originalOpenEvent.apply(eventLogic, args);

        const discussionTab = document.querySelector('.tab[data-tab="discussion"]');

        if (discussionTab && !discussionTab.dataset.listenerAttached) {
          discussionTab.dataset.listenerAttached = 'true';
          discussionTab.addEventListener('click', () => {
            setTimeout(() => {
              if (state.threads && state.threads.length > 0 && !state.selectedThreadId) {
                const firstThreadEl = document.querySelector('#threadsList .thread-list-item');
                if (firstThreadEl) {
                  firstThreadEl.click();
                }
              }
            }, 0);
          });
        }
      };

      // --- MODIFICATION START: Add Download button to files ---
      const originalRenderFiles = eventLogic.renderFiles;
      eventLogic.renderFiles = async (...args) => {
        // 1. Run the original function to fetch and render the files.
        // This will populate state.files and update the DOM.
        await originalRenderFiles.apply(eventLogic, args);

        // 2. The DOM is now updated and state.files is populated.
        const filesListContainer = $('#filesList');
        if (!filesListContainer || !state.files || state.files.length === 0) {
          return; // Nothing to do
        }

        // 3. Iterate over the files in the state and add a download button for each.
        state.files.forEach(file => {
          // Assumption: Each file element in the DOM has a `data-file-id` attribute.
          const fileElement = filesListContainer.querySelector(`[data-file-id='${file.id}']`);
          if (!fileElement) return;

          // Assumption: The action buttons are inside a container with class `.file-actions`.
          const actionsContainer = fileElement.querySelector('.file-actions');
          if (!actionsContainer) return;

          // Check if a download button already exists to prevent duplication.
          if (actionsContainer.querySelector('.btn-download')) return;

          // 4. Get the public URL for the file from Supabase storage.
          // Assumption: The storage bucket is named 'event_files' and the path is stored in file.path.
          const { data: urlData } = supabase.storage.from('event_files').getPublicUrl(file.path);

          if (!urlData || !urlData.publicUrl) {
            console.error(`Could not get public URL for file: ${file.path}`);
            return;
          }

          // 5. Create the download button.
          const downloadLink = document.createElement('a');
          downloadLink.href = urlData.publicUrl;
          downloadLink.setAttribute('download', file.name || ''); // Suggests a filename to the browser
          downloadLink.className = 'chip btn-download'; // Use 'chip' style and add a specific class
          downloadLink.textContent = tr('files.download', 'Download');
          downloadLink.style.textDecoration = 'none';

          // Append the new button to the actions container.
          actionsContainer.appendChild(downloadLink);
        });
      };
      // --- MODIFICATION END ---

      await loadEvents();

      supabase.channel('public:events').on('postgres_changes', { event: '*', schema: 'public', table: 'events' }, () => loadEvents()).subscribe();
    })();
  </script>
</body>

</html>