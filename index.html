<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agrovoltaicos sin Fronteras â€¢ Seminar Platform</title>
  <meta name="description" content="A seminar series to share advances in agrivoltaics in the Americas (EN/ES)." />
  <!-- Fonts: Headings (Poppins), Body (Lato), Handwritten accents (Caveat) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600&family=Lato:wght@400;700&family=Poppins:wght@700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* --- Page-Specific Layout --- */
    #hero,
    #auth {
      flex-shrink: 0;
    }

    .hero {
      padding: var(--space-3) var(--space-4) !important;
    }

    #schedule.card {
      padding-top: var(--space-1);
      padding-bottom: var(--space-1);
    }

    #schedule,
    #eventDetail {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #eventsList,
    #calendar {
      flex-grow: 1;
      min-height: 0;
    }

    #eventsList {
      overflow-y: auto;
    }

    #eventsList {
      display: none; /* Hide by default to prevent jarring load */
    }

    #calendar {
      display: none; /* Hide by default */
      flex-direction: column;
    }

    #calendarGrid {
      flex-grow: 1;
      overflow-y: auto;
    }

    /* --- Hero Layout --- */
    .hero {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
    }

    .hero-main {
      flex: 1 1 60%;
      min-width: 350px;
    }

    .hero-main>h1 {
      margin-top: 0;
      margin-bottom: var(--space-2);
    }

    .hero-main>p {
      margin: 0;
    }

    .hero .meta {
      flex: 0 1 auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: var(--space-1);
    }

    /* --- Calendar & Schedule Header Rework --- */
    #schedule .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
      margin-bottom: 0;
      /* Removed bottom margin to reduce space */
    }

    .section-header .calendar-header {
      display: none;
      align-items: center;
      gap: var(--space-2);
      flex-grow: 1;
      justify-content: center;
    }

    #schedule.calendar-view .section-header .calendar-header {
      display: flex;
    }

    #schedule .calendar-header-standalone {
      display: none;
    }
    
    .section-title-group {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    #schedule .section-header h2 {
      margin: 0;
    }
    
    /* --- Responsive Adjustments for This Page --- */
    @media (max-width: 960px) {
      .hero {
        text-align: center;
        flex-direction: column;
      }

      .hero-main {
        min-width: 0;
      }

      .hero .meta {
        text-align: center;
        align-items: center;
      }

      #schedule .section-header {
        flex-direction: column;
        align-items: stretch;
      }

      #schedule .search-bar {
        width: 100%;
      }

      #schedule .search-bar input {
        width: 100%;
        box-sizing: border-box;
      }
    }
  </style>

</head>

<body>
  <header class="site-header">
    <div class="container header-grid">
      <div class="brand">
        <a href="index.html" style="display: contents; text-decoration: none;">
          <img src="static/icon.png" alt="Agrovoltaicos sin Fronteras logo" class="logo-image">
          <div class="brand-text">
            <div class="title">Agrovoltaicos sin Fronteras</div>
            <div class="subtitle" data-i18n="tagline">
              A seminar series to share advances in agrivoltaics in the Americas
            </div>
          </div>
        </a>
      </div>

      <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <!-- Desktop Nav -->
      <nav class="nav">
        <a href="index.html" class="link" data-i18n="nav.schedule">Schedule</a>
        <a href="archive.html" class="link" data-i18n="nav.archive">Archive</a>
        <a href="about.html" class="link" data-i18n="nav.about">About</a>
        <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
        <div class="divider"></div>
        <div id="langSwitchDesktop" class="lang-switch-slider" data-lang="en">
          <span>EN</span>
          <span>ES</span>
        </div>
        <div class="auth-area">
          <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile">
            <span id="userInitial"></span>
            <img id="userAvatar" style="display: none; width: 100%; height: 100%; object-fit: cover;" />
          </button>
          <span id="userName"></span>
          <a href="signin.html" id="btnSignIn" class="btn-primary" data-i18n="auth.signin"
            style="text-decoration: none; display: inline-block;">Sign in</a>
          <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
            Sign out
          </button>
        </div>
      </nav>
    </div>
  </header>

  <div id="mobileNavOverlay" class="mobile-nav-overlay">
    <!-- Content will be injected by JS -->
  </div>

  <div id="flash" class="flash" role="status" aria-live="polite"></div>

  <main class="container">
    <!-- Hero -->
    <section id="hero" class="card hero">
      <div class="hero-main">
        <h1 style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap;">
          <span>Agrovoltaicos sin Fronteras</span>
          <div id="siteBanner"
            style="display: none; background: linear-gradient(135deg, var(--color-primary), var(--brand-2)); color: white; padding: 4px 12px; border-radius: 999px; font-size: 0.9rem; font-weight: 700; box-shadow: 0 2px 8px rgba(0, 33, 71, 0.2); animation: pulse 2s ease-in-out infinite; white-space: nowrap; font-family: 'Caveat', cursive;">
            <span>ðŸ“¢</span>
            <span id="bannerText"></span>
          </div>
        </h1>
        <p data-i18n="intro">
          Agrivoltaics (agrivoltaics) is an emerging field that integrates solar energy with
          crop/livestock production. This bilingual seminar focuses on Latin America. Hosted by
          UNAM and University of Arizona.
        </p>
      </div>
      <div class="meta">
        <span class="meta-item" data-i18n="format">Online â€¢ Bi-monthly â€¢ 1 hour</span>
        <span class="meta-item" data-i18n="hosted">Hosted by UNAM & University of Arizona</span>
      </div>
    </section>

    <!-- Schedule -->
    <section id="schedule" class="card" aria-labelledby="scheduleTitle">
      <div class="section-header">
        <div class="section-title-group">
          <h2 id="scheduleTitle" data-i18n="schedule.title">Upcoming Talks</h2>
          <div class="view-switch">
            <button id="viewList" class="chip chip-toggle active" data-i18n="schedule.list">List</button>
            <button id="viewCalendar" class="chip chip-toggle" data-i18n="schedule.calendar">Calendar</button>
          </div>
        </div>
        <div class="calendar-header">
          <button id="calPrev" class="btn-ghost" aria-label="Previous month">â—€</button>
          <div id="calLabel" class="cal-label">Month</div>
          <button id="calNext" class="btn-ghost" aria-label="Next month">â–¶</button>
        </div>
        <div class="search-controls">
          <div class="calendar-legend">
            <span class="legend scheduled" data-i18n="legend.scheduled">Scheduled</span>
            <span class="legend completed" data-i18n="legend.completed">Completed</span>
            <span class="legend canceled" data-i18n="legend.canceled">Canceled</span>
          </div>
          <div class="search-bar">
            <input id="search" type="search" placeholder="Search..." data-i18n-placeholder="search.placeholder" />
          </div>
        </div>
      </div>

      <div id="eventsLoader" class="loader-container">
        <div class="spinner"></div>
      </div>

      <!-- This grid is now fixed by the change in styles.css -->
      <div id="eventsList" class="events-grid"></div>

      <div id="calendar" class="calendar">
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>

      <div id="emptyEvents" class="empty" style="display: none" data-i18n="schedule.empty">
        No events yet. Check back soon.
      </div>
    </section>

    <!-- Event Detail -->
    <section id="eventDetail" class="card" style="display: none">
      <div id="discussion-layout">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar-container">
          <div id="compactEventHeaderContainer">
            <!-- JS Renders Event Details Here -->
          </div>

          <form id="newThreadForm" class="inline-form">
            <input id="threadTitle" type="text" placeholder="Start a new topic..." required
              data-i18n-placeholder="thread.placeholder" />
            <button class="btn-primary" type="submit" data-i18n="thread.create">Create</button>
          </form>
          <div id="threadsList">
            <!-- JS Renders Threads Here -->
          </div>
        </div>

        <!-- RIGHT MAIN AREA -->
        <div id="discussion-main">
          <div class="tabs">
            <button class="tab active" data-tab="description" data-i18n="tabs.description">Description</button>
            <button class="tab" data-tab="discussion" data-i18n="tabs.discussion">Discussion</button>
            <button class="tab" data-tab="files" data-i18n="tabs.files">Files</button>
          </div>

          <!-- Description Panel -->
          <div id="tab_description" class="tab-panel">
            <div id="descriptionContent" class="prose"></div>
          </div>

          <!-- Discussion Panel -->
          <div id="tab_discussion" class="tab-panel" style="display: none;">
            <div id="thread-welcome">
              <div>
                <h3 data-i18n="discussion.welcome_title">Welcome to the discussion!</h3>
                <p data-i18n="discussion.welcome_body">Select a topic from the left to view the
                  conversation, or start a new one.</p>
              </div>
            </div>
            <div id="threadDetailView" style="display: none;">
              <div id="commentsList"></div>
              <form id="replyToThreadForm">
                <textarea placeholder="Write a comment..." required
                  data-i18n-placeholder="comment.placeholder"></textarea>
                <button class="btn-primary" type="submit" data-i18n="comment.send">Send</button>
              </form>
            </div>
          </div>

          <!-- Files Panel -->
          <div id="tab_files" class="tab-panel" style="display: none">
            <form id="uploadForm" class="inline-form">
              <input id="fileInput" type="file" />
              <button class="btn-primary" type="submit" data-i18n="files.upload">Upload</button>
            </form>
            <div id="filesList" class="files"></div>
            <div id="emptyFiles" class="empty" style="display: none" data-i18n="files.empty">
              No files yet.
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center;">
          Â© <span id="year"></span> Agrovoltaicos sin Fronteras â€¢
          <span data-i18n="footer.note">Bilingual, community-driven seminar on agrivoltaics in Latin America.</span>
        </div>
        <div style="display: flex; align-items: center;">
          <a href="https://biosphere2.org/research/research-initiatives/agrivoltaics" target="_blank"
            rel="noopener noreferrer" style="margin-left: 8px;">
            <img src="static/b2ua.jpg" alt="Biosphere 2 Agrivoltaics"
              style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
          <a href="https://www.ier.unam.mx/ParcelaAgrovoltaica.html" target="_blank" rel="noopener noreferrer"
            style="margin-left: 8px;">
            <img src="static/unam.png" alt="UNAM"
              style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
        </div>
      </small>
    </div>
  </footer>

  <script type="module">
    import {
      supabase,
      authState,
      initAuth,
      fetchProfile, // <-- CORRECTED: Import fetchProfile
      signInWithGoogle,
      signInWithEmail,
      signOut
    } from "./auth.js";
    import { initEventLogic } from "./static/js/event.js";

    let eventLogic;

    const state = {
      language: localStorage.getItem("lang") || "en",
      events: [],
      selectedEvent: null,
      threads: [],
      selectedThreadId: null,
      comments: [],
      files: [],
      rsvpStatus: null,
      isFollowing: false,
      counts: { followers: 0, going: 0, interested: 0 },
      calendarMonth: new Date(),
    };

    const t = {
      en: {
        tagline: "A seminar series to share advances in agrivoltaics in the Americas",
        intro: "Agrovoltaicos sin Fronteras is a participatory seminar series presenting the latest advances in agrivoltaics research and development across the Americas and beyond. We welcome researchers, practitioners, students and anyone interested in agrivoltaics to join us for bi-weekly seminars and discussions. Seminars are bilingual (English and/or Spanish) and take place on zoom. Register to join the seminars or continue the discussion in the members forum!",
        format: "Online â€¢ Bi-monthly â€¢ 1 hour", // MODIFIED
        hosted: "Hosted by UNAM & University of Arizona",
        nav: { schedule: "Schedule", archive: "Archive", about: "About", admin: "Admin" },
        auth: {
          title: "Sign in to participate", signin: "Sign in", signout: "Sign out",
          email: "Email", magic: "Send magic link", magic_hint: "We'll email you a sign-in link. Check your inbox.", or: "or",
          required: "Please sign in to view event details.",
        },
        profile: { incomplete: "Please complete your profile to access all features" },
        schedule: { title: "Upcoming Talks", empty: "No events yet. Check back soon.", list: "List", calendar: "Calendar" },
        search: { placeholder: "Search..." },
        back: { schedule: "Back to schedule" },
        tabs: { description: "Description", discussion: "Discussion", files: "Files" },
        discussion: { welcome_title: "Welcome to the discussion!", welcome_body: "Select a topic from the left to view the conversation, or start a new one." },
        thread: { placeholder: "Start a new topic...", create: "Create", empty: "No topics yet. Start the discussion!" },
        comment: { placeholder: "Write a comment...", send: "Send" },
        files: { upload: "Upload", empty: "No files yet.", download: "Download" },
        footer: { note: "Bilingual, community-driven seminar on agrivoltaics in Latin America." },
        rsvp: { going: "Going", interested: "Interested", notgoing: "Not going", saved: "RSVP updated" },
        follow: "Follow",
        reply: "Reply",
        legend: { scheduled: "Scheduled", completed: "Completed", canceled: "Canceled" },
        save: "Save", cancel: "Cancel",
        errors: { upload: "Upload failed" },
        labels: { followers: "followers", going: "going", interested: "interested" },
        open: "Open", join_zoom: "Join Zoom", copy_link: "Copy Zoom link", copied: "Copied!",
        tags: "Tags",
        speakers: "Speaker(s)"
      },
      es: {
        tagline: "Una serie de seminarios para compartir avances en agrovoltaicos en las AmÃ©ricas",
        intro: "Agrovoltaicos sin Fronteras es una serie de seminarios participativos que presenta los Ãºltimos avances en investigaciÃ³n y desarrollo de agrovoltaicos en AmÃ©rica y el resto del mundo. Invitamos a investigadores, profesionales, estudiantes y a cualquier persona interesada en los agrovoltaicos a unirse a nuestros seminarios y debates quincenales. Los seminarios son bilingÃ¼es (inglÃ©s y/o espaÃ±ol) y se realizan por Zoom. Â¡RegÃ­strese para unirse a los seminarios o continÃºe la discusiÃ³n en el foro de miembros!",
        format: "En lÃ­nea â€¢ Bimestral â€¢ 1 hora", // MODIFIED
        hosted: "Organizado por UNAM y University of Arizona",
        nav: { schedule: "Calendario", archive: "Archivo", about: "Acerca de", admin: "Admin" },
        auth: {
          title: "Inicia sesiÃ³n para participar", signin: "Iniciar sesiÃ³n", signout: "Cerrar sesiÃ³n",
          email: "Correo", magic: "Enviar enlace mÃ¡gico", magic_hint: "Te enviaremos un enlace de acceso. Revisa tu bandeja.", or: "o",
          required: "Por favor, inicia sesiÃ³n para ver los detalles del evento.",
        },
        profile: { incomplete: "Por favor completa tu perfil para acceder a todas las funciones" },
        schedule: { title: "Charlas", empty: "AÃºn no hay eventos. Vuelve pronto.", list: "Lista", calendar: "Calendario" },
        search: { placeholder: "Buscar..." },
        back: { schedule: "Volver al calendario" },
        tabs: { description: "DescripciÃ³n", discussion: "DiscusiÃ³n", files: "Archivos" },
        discussion: { welcome_title: "Â¡Bienvenido/a a la discusiÃ³n!", welcome_body: "Selecciona un tema de la izquierda o crea uno nuevo." },
        thread: { placeholder: "Iniciar un nuevo tema...", create: "Crear", empty: "AÃºn no hay temas. Â¡Comienza la discusiÃ³n!" },
        comment: { placeholder: "Escribe un comentario...", send: "Enviar" },
        files: { upload: "Subir", empty: "No hay archivos.", download: "Descargar" },
        footer: { note: "Seminario bilingÃ¼e y comunitario sobre agrofotovoltaica en AmÃ©rica Latina." },
        rsvp: { going: "AsistirÃ©", interested: "Interesado/a", notgoing: "No asistirÃ©", saved: "Asistencia actualizada" },
        follow: "Seguir",
        reply: "Responder",
        legend: { scheduled: "Programado", completed: "Completado", cancelado: "Cancelado" },
        save: "Guardar", cancel: "Cancelar",
        errors: { upload: "Fallo al subir" },
        labels: { followers: "seguidores", going: "asisten", interested: "interesados" },
        open: "Abrir", join_zoom: "Unirse a Zoom", copy_link: "Copiar enlace de Zoom", copied: "Â¡Copiado!",
        tags: "Etiquetas",
        speakers: "Ponente(s)"
      },
    };

    // --- UTILITIES & I18N ---
    function tr(key, fallback = "") { const lang = state.language; const parts = key.split("."); let obj = t[lang]; for (const p of parts) obj = obj?.[p]; return obj ?? fallback; }
    const $ = (sel) => document.querySelector(sel);
    function setFlash(msg, timeout = 3000) {
      const el = $("#flash"); if (!el) return; el.textContent = msg; el.style.display = "block";
      clearTimeout(setFlash._t); if (timeout > 0) { setFlash._t = setTimeout(() => (el.style.display = "none"), timeout); }
    }
    function fmtDateTime(iso) { try { return new Intl.DateTimeFormat(undefined, { dateStyle: "medium", timeStyle: "short" }).format(new Date(iso)); } catch (_) { return iso; } }
    function bytesToSize(bytes = 0) {
      if (bytes === 0) return "0 B"; const k = 1024, sizes = ["B", "KB", "MB", "GB", "TB"], i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }
    function escapeHtml(s = "") { return String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])); }
    function linkify(text = "") {
      let safe = escapeHtml(text); const urlRegex = /\b(https?:\/\/[^\s<]+)\b/g;
      safe = safe.replace(urlRegex, (m) => `<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);
      safe = safe.replace(/\n/g, "<br/>"); return safe;
    }
    function applyI18n() {
      document.querySelectorAll("[data-i18n]").forEach((el) => { el.textContent = tr(el.dataset.i18n, el.textContent); });
      document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => { el.placeholder = tr(el.dataset.i18nPlaceholder, el.placeholder); });
      document.querySelectorAll(".lang-switch-slider").forEach(el => { if (el) el.dataset.lang = state.language; });
    }

    // --- HEADER & MENU ---
    function setupMobileMenu() {
      const mobileNavOverlay = $("#mobileNavOverlay");
      const desktopNav = document.querySelector('.header-grid .nav');
      if (!mobileNavOverlay || !desktopNav) return;
      mobileNavOverlay.innerHTML = '';
      const closeBtn = document.createElement('button');
      closeBtn.className = 'mobile-nav-close-btn';
      closeBtn.setAttribute('aria-label', 'Close menu');
      
      // ========= FIX STARTS HERE =========
      // This line was causing the SVG parsing error. It has been replaced with a clean version.
      closeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
      // ========= FIX ENDS HERE =========

      const content = desktopNav.cloneNode(true);
      content.id = '';
      const langSwitchMobile = content.querySelector('#langSwitchDesktop');
      if (langSwitchMobile) langSwitchMobile.id = 'langSwitchMobile';
      mobileNavOverlay.appendChild(closeBtn);
      mobileNavOverlay.appendChild(content);
      closeBtn.addEventListener('click', closeMenu);
      mobileNavOverlay.addEventListener('click', (e) => { if (e.target === mobileNavOverlay) closeMenu(); });
      langSwitchMobile?.addEventListener('click', handleLangSwitch);
      content.querySelector("#btnSignOut")?.addEventListener("click", () => signOut());
      content.querySelector("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');
    }
    function openMenu() {
      const mobileMenuBtn = $("#mobileMenuBtn"), mobileNavOverlay = $("#mobileNavOverlay");
      mobileNavOverlay.classList.add("is-open"); document.body.classList.add("menu-open");
      mobileMenuBtn.setAttribute("aria-expanded", "true");
      mobileMenuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    }
    function closeMenu() {
      const mobileMenuBtn = $("#mobileMenuBtn"), mobileNavOverlay = $("#mobileNavOverlay");
      mobileNavOverlay.classList.remove("is-open"); document.body.classList.remove("menu-open");
      mobileMenuBtn.setAttribute("aria-expanded", "false");
      mobileMenuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
    }
    function renderHeader() {
      const btnSignIn = $("#btnSignIn"), btnSignOut = $("#btnSignOut"), btnAdmin = $("#btnAdmin"), userName = $("#userName"), btnProfile = $("#btnProfile");
      const isOrganizer = ["organizer", "admin"].includes(authState.profile?.role);
      if (authState.session) {
        btnSignIn.style.display = "none"; btnSignOut.style.display = "inline-block";
        btnProfile.style.display = "grid"; userName.style.display = "inline";
        userName.textContent = authState.profile?.full_name || authState.profile?.username || "";
        $("#userInitial").textContent = (authState.profile?.full_name || "U").charAt(0).toUpperCase();
        if (btnAdmin) btnAdmin.style.display = isOrganizer ? "inline-block" : "none";
      } else {
        btnSignIn.style.display = "inline-block"; btnSignOut.style.display = "none";
        btnProfile.style.display = "none"; userName.style.display = "none";
        if (btnAdmin) btnAdmin.style.display = "none";
      }
      setupMobileMenu();
    }
    function handleLangSwitch() {
      state.language = state.language === 'en' ? 'es' : 'en';
      localStorage.setItem("lang", state.language);
      applyI18n();
      loadSiteBanner();
      renderEventsList();
      if (state.selectedEvent && eventLogic) {
        eventLogic.renderEventHeader();
        eventLogic.renderThreads();
        eventLogic.renderDescriptionTab();
        if (state.selectedThreadId) eventLogic.renderComments();
        eventLogic.renderFiles();
      }
      renderScheduleCalendar();
    }
    async function loadSiteBanner() {
      const { data } = await supabase.from('banners').select('*').eq('is_active', true).single();
      const bannerEl = document.getElementById('siteBanner');
      const textEl = document.getElementById('bannerText');

      if (data && bannerEl && textEl) {
        const text = state.language === 'es' && data.text_es ? data.text_es : data.text_en;
        textEl.textContent = text;
        bannerEl.style.display = 'inline-flex';
      } else if (bannerEl) {
        bannerEl.style.display = 'none';
      }
    }

    // --- PAGE-SPECIFIC LOGIC (SCHEDULE) ---
    function showView(which) {
      $("#schedule").style.display = "none";
      $("#eventDetail").style.display = "none";
      $("#hero").style.display = "none";

      if (which === "schedule") {
        $("#hero").style.display = "flex";
        $("#schedule").style.display = "flex";
      } else if (which === "event") {
        $("#eventDetail").style.display = "flex";
      }
    }

    async function loadEvents() {
      const { data } = await supabase.from("events").select("*, event_speakers(*)").order("start_time", { ascending: true });
      state.events = data || [];
      renderEventsList();
      renderScheduleCalendar();

      const loader = $("#eventsLoader");
      const list = $("#eventsList");
      if (loader) loader.style.display = 'none';
      if (list) list.style.display = 'grid';

      const urlParams = new URLSearchParams(window.location.search);
      const eid = urlParams.get("event") || urlParams.get("e");

      if (eid && eventLogic) {
        if (authState.session) {
          await eventLogic.openEvent(eid);
        } else {
          authState.pendingDeepLinkEventId = eid;
          setFlash(tr('auth.required'));
          showView("schedule");
        }
      } else {
        showView("schedule");
      }
    }

    function nowUtcComparable(d) {
      return new Date(d).getTime();
    }

    function renderEventsList() {
      const list = $("#eventsList"), empty = $("#emptyEvents");
      if (!list || !empty) return;
      const term = ($("#search")?.value || "").toLowerCase().trim();
      const now = Date.now();

      const futureEvents = state.events.filter(e => nowUtcComparable(e.start_time) >= now);

      const filtered = futureEvents.filter((e) => {
        if (!term) return true;
        const speakerMatch = (e.event_speakers || []).some(s =>
          (s.name || "").toLowerCase().includes(term) ||
          (s.affiliation || "").toLowerCase().includes(term)
        );
        const tagsMatch = (e.topic_tags || []).some(tag => (tag || "").toLowerCase().includes(term));
        const eventMatch = [e.title_en, e.title_es, e.description_en, e.description_es, e.host_org]
          .filter(Boolean)
          .some((v) => v.toLowerCase().includes(term));
        return speakerMatch || tagsMatch || eventMatch;
      });

      empty.style.display = filtered.length ? "none" : "block";
      list.innerHTML = filtered.map(ev => {
        const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
        const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;

        let speakerLine = '';
        if (ev.event_speakers && ev.event_speakers.length > 0) {
          const primarySpeaker = ev.event_speakers.find(s => s.primary_speaker) || ev.event_speakers[0];
          speakerLine = `<div class="event-speaker">ðŸ‘¤ ${escapeHtml(primarySpeaker.name)}${primarySpeaker.affiliation ? ` (${escapeHtml(primarySpeaker.affiliation)})` : ''}</div>`;
        }

        const tagTopics = (ev.topic_tags || []).map(tag => `<span class="tag-topic">#${escapeHtml(tag)}</span>`).join("");

        return `
        <div class="event-card">
            <div class="event-header">
              <div class="event-info">
                <div class="when">${fmtDateTime(ev.start_time)}</div>
                <h3 class="event-title">${escapeHtml(title)}</h3>
                ${speakerLine}
              </div>
              <div class="actions">
                  <button class="btn-primary" data-open="${String(ev.id)}">${tr('open')}</button>
              </div>
            </div>
            ${desc ? `<div class="event-desc">${linkify(desc)}</div>` : '<div style="flex-grow: 1;"></div>'}
            <div class="tags">
              ${tagTopics}
              <span class="tag">${(ev.language || "bi").toUpperCase()}</span>
              ${ev.host_org ? `<span class="tag">${escapeHtml(ev.host_org)}</span>` : ""}
            </div>
        </div>`;
      }).join('');
    }

    function renderScheduleCalendar() {
      const grid = $("#calendarGrid"), label = $("#calLabel"); if (!grid || !label) return;
      const m = state.calendarMonth; label.textContent = m.toLocaleString(state.language, { month: "long", year: "numeric" });
      const start = new Date(m.getFullYear(), m.getMonth(), 1), end = new Date(m.getFullYear(), m.getMonth() + 1, 0);
      const firstDayIndex = (start.getDay() + 6) % 7, daysInMonth = end.getDate(); grid.innerHTML = ``;

      for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement("div"));
      const byDay = state.events.reduce((acc, ev) => {
        const d = new Date(ev.start_time); if (d.getMonth() !== m.getMonth() || d.getFullYear() !== m.getFullYear()) return acc;
        const day = d.getDate(); if (!acc.has(day)) acc.set(day, []); acc.get(day).push(ev); return acc;
      }, new Map());

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div"); cell.className = "cal-cell"; cell.innerHTML = `<div class="cal-day">${day}</div>`;
        (byDay.get(day) || []).forEach((ev) => {
          const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
          const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;

          let speakerName = '';
          if (ev.event_speakers && ev.event_speakers.length > 0) {
            const primarySpeaker = ev.event_speakers.find(s => s.primary_speaker) || ev.event_speakers[0];
            speakerName = `<div class="cal-event-speaker">ðŸ‘¤ ${escapeHtml(primarySpeaker.name)}</div>`;
          }

          const eventDiv = document.createElement("button");
          eventDiv.className = `cal-event status-${ev.status}`;
          eventDiv.innerHTML = `
                <div class="cal-event-title">${escapeHtml(title)}</div>
                ${desc ? `<div class="cal-event-desc">${escapeHtml(desc).substring(0, 60)}...</div>` : ''}
                ${speakerName}
            `;
          eventDiv.addEventListener("click", () => { if (eventLogic) eventLogic.openEvent(ev.id) });

          cell.appendChild(eventDiv);
        });
        grid.appendChild(cell);
      }
    }

    // --- WIRING & INITIALIZATION ---
    function wireUI() {
      $("#btnSignOut")?.addEventListener("click", () => signOut());
      $("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');

      $("#eventsList").addEventListener("click", e => {
        const openBtn = e.target.closest('[data-open]');
        if (openBtn && eventLogic) { eventLogic.openEvent(openBtn.dataset.open); return; }
      });

      $("#search")?.addEventListener("input", renderEventsList);
      $("#viewList")?.addEventListener("click", () => { $("#schedule").classList.remove("calendar-view"); $("#viewList").classList.add("active"); $("#viewCalendar").classList.remove("active"); $("#eventsList").style.display = "grid"; $("#calendar").style.display = "none"; });
      $("#viewCalendar")?.addEventListener("click", () => { $("#schedule").classList.add("calendar-view"); $("#viewCalendar").classList.add("active"); $("#viewList").classList.remove("active"); $("#eventsList").style.display = "none"; $("#calendar").style.display = "flex"; });
      $("#calPrev")?.addEventListener("click", () => { state.calendarMonth.setMonth(state.calendarMonth.getMonth() - 1); renderScheduleCalendar(); });
      $("#calNext")?.addEventListener("click", () => { state.calendarMonth.setMonth(state.calendarMonth.getMonth() + 1); renderScheduleCalendar(); });

      $("#langSwitchDesktop")?.addEventListener('click', handleLangSwitch);
      $("#mobileMenuBtn")?.addEventListener("click", () => {
        const overlay = $("#mobileNavOverlay");
        if (overlay && !overlay.classList.contains('is-open')) {
          openMenu();
        } else {
          closeMenu();
        }
      });

      $("#year").textContent = new Date().getFullYear();
    }

    (async function main() {

      (async function loadBanner() {
        const { data } = await supabase.from('banners').select('*').eq('is_active', true).single();
        if (data) {
          const bannerEl = document.getElementById('siteBanner');
          const textEl = document.getElementById('bannerText');
          if (bannerEl && textEl) {
            const text = state.language === 'es' && data.text_es ? data.text_es : data.text_en;
            textEl.textContent = text;
            bannerEl.style.display = 'inline-flex';
          }
        }
        supabase.channel('public:banners')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'banners' }, async () => {
            const { data } = await supabase.from('banners').select('*').eq('is_active', true).single();
            const bannerEl = document.getElementById('siteBanner');
            const textEl = document.getElementById('bannerText');
            if (data && bannerEl && textEl) {
              const text = state.language === 'es' && data.text_es ? data.text_es : data.text_en;
              textEl.textContent = text;
              bannerEl.style.display = 'inline-flex';
            } else if (bannerEl) {
              bannerEl.style.display = 'none';
            }
          })
          .subscribe();
      })();

      applyI18n();
      wireUI();

      await initAuth({
        onAuthReady: (authState) => {
          renderHeader();
        },
        onAuthChange: (authState) => {
          renderHeader();
          if (state.selectedEvent && eventLogic) {
            eventLogic.loadRSVPFollow(state.selectedEvent.id);
          }
        }
      });

      eventLogic = initEventLogic({
        supabase, authState, fetchProfile,
        tr, state, $, setFlash,
        fmtDateTime, escapeHtml, linkify, bytesToSize, showView,
        listViewName: 'schedule'
      });

      const originalOpenEvent = eventLogic.openEvent;
      eventLogic.openEvent = async (...args) => {
        await originalOpenEvent.apply(eventLogic, args);
        const discussionTab = document.querySelector('.tab[data-tab="discussion"]');
        if (discussionTab && !discussionTab.dataset.listenerAttached) {
          discussionTab.dataset.listenerAttached = 'true';
          discussionTab.addEventListener('click', () => {
            setTimeout(() => {
              if (state.threads && state.threads.length > 0 && !state.selectedThreadId) {
                const firstThreadEl = document.querySelector('#threadsList .thread-list-item');
                if (firstThreadEl) {
                  firstThreadEl.click();
                }
              }
            }, 0);
          });
        }
      };

      const originalRenderFiles = eventLogic.renderFiles;
      eventLogic.renderFiles = async (...args) => {
        await originalRenderFiles.apply(eventLogic, args);
        const filesListContainer = $('#filesList');
        if (!filesListContainer || !state.files || state.files.length === 0) {
          return;
        }
        state.files.forEach(file => {
          const fileElement = filesListContainer.querySelector(`[data-file-id='${file.id}']`);
          if (!fileElement) return;
          const actionsContainer = fileElement.querySelector('.file-actions');
          if (!actionsContainer) return;
          if (actionsContainer.querySelector('.btn-download')) return;
          const { data: urlData } = supabase.storage.from('event_files').getPublicUrl(file.path);
          if (!urlData || !urlData.publicUrl) {
            console.error(`Could not get public URL for file: ${file.path}`);
            return;
          }
          const downloadLink = document.createElement('a');
          downloadLink.href = urlData.publicUrl;
          downloadLink.setAttribute('download', file.name || '');
          downloadLink.className = 'chip btn-download';
          downloadLink.textContent = tr('files.download', 'Download');
          downloadLink.style.textDecoration = 'none';
          actionsContainer.appendChild(downloadLink);
        });
      };
      
      await loadEvents();
      supabase.channel('public:events').on('postgres_changes', { event: '*', schema: 'public', table: 'events' }, () => loadEvents()).subscribe();
    })();
  </script>
</body>

</html>