<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Almuerzo Agrivoltaico ‚Ä¢ Seminar Platform</title>
  <meta name="description" content="An informal seminar series to share advances in agrivoltaics in Latin America (EN/ES)." />
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* --- CORE LAYOUT: Full viewport on DESKTOP ONLY (Adapted from archive.html) --- */
    @media (min-width: 961px) {
      html, body {
        height: 100vh;
        max-height: 100vh;
        overflow: hidden;
      }
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    main.container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    main.container > .card { margin: 0; }
    #hero, #auth { flex-shrink: 0; }
    .hero { padding: var(--space-3) var(--space-4) !important; }

    #schedule,
    #eventDetail {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    #eventsList, #calendar { flex-grow: 1; min-height: 0; }
    #eventsList { overflow-y: auto; }

    /* --- HEADER & NAVIGATION (from archive.html) --- */
    .mobile-menu-btn { display: none; }
    
    /* Mobile Nav Overlay */
    .mobile-nav-overlay {
      display: none; /* Hidden by default, shown with JS */
      flex-direction: column; justify-content: center; align-items: center;
      gap: var(--space-4); position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
      background: rgba(18, 19, 23, 0.9); backdrop-filter: blur(10px);
      z-index: 1000; opacity: 0; transition: opacity 0.3s ease-in-out;
    }
    .mobile-nav-overlay.is-open { display: flex; opacity: 1; }

    /* Modernized Event Card in List View */
    .event-card {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: var(--space-2) var(--space-4);
      align-items: center;
    }

    .event-card .when {
      grid-column: 1 / -1;
      color: var(--color-primary);
      font-weight: 500;
    }

    .event-card .event-title {
      grid-column: 1;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .event-card .event-desc {
      grid-column: 1 / -1;
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    .event-card .tags {
      grid-column: 1 / -1;
      margin-top: var(--space-3);
      display: flex;
      flex-wrap: wrap;
      gap: .35rem;
    }

    .tag-topic {
      background: var(--color-surface-strong);
      border: 1px solid var(--color-border);
      border-radius: 999px;
      padding: .15rem .5rem;
      font-size: .8rem;
    }

    .event-card .actions {
      grid-column: 2;
      grid-row: 2;
    }

    #calendar {
      display: none;
      flex-direction: column;
    }

    #calendarGrid {
      flex-grow: 1;
      overflow-y: auto;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
    }

    .hero-main {
      flex: 1 1 60%;
      min-width: 350px;
    }

    .hero-main>h1 {
      margin-top: 0;
      margin-bottom: var(--space-2);
    }

    .hero-main>p {
      margin: 0;
    }

    .hero .meta {
      flex: 0 1 auto;
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    /* --- CALENDAR & SCHEDULE HEADER REWORK --- */
    #schedule .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
    }

    .section-header .calendar-header {
      display: none;
      align-items: center;
      gap: var(--space-2);
      flex-grow: 1;
      justify-content: center;
    }

    #schedule.calendar-view .section-header .calendar-header {
      display: flex;
    }

    #schedule .calendar-header-standalone {
      display: none;
    }

    /* Calendar event display styles */
    .cal-event {
      display: block;
      width: 100%;
      padding: var(--space-2);
      margin-top: var(--space-1);
      font-size: 0.75rem;
      line-height: 1.3;
      text-align: left;
      border: none;
      border-radius: var(--radius-1);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      overflow: hidden;
    }

    .cal-event-title {
      font-weight: 600;
      font-size: 0.8rem;
      margin-bottom: var(--space-1);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .cal-event-desc {
      font-size: 0.7rem;
      line-height: 1.3;
      opacity: 0.85;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .cal-event.status-scheduled {
      background-color: var(--color-primary-muted);
      color: var(--color-primary);
    }

    .cal-event.status-completed {
      background-color: var(--color-success-muted);
      color: var(--color-success);
    }

    .cal-event.status-canceled {
      background-color: var(--color-danger-muted);
      color: var(--color-danger);
    }

    .cal-event:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .cal-cell {
      min-height: 100px;
      padding: var(--space-2);
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .cal-day {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: var(--space-1);
    }

    .section-title-group {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    #schedule .section-header h2 {
      margin: 0;
    }

    /* NEW: Compact, Horizontal Auth Section */
    #auth .auth-centered {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-2) var(--space-3);
      min-height: auto;
    }

    #auth .auth-centered h2 {
      margin: 0;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .auth-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-3);
      flex-grow: 1;
      justify-content: flex-end;
    }

    #emailForm.auth-form-secondary {
      display: flex;
      gap: var(--space-2);
    }

    @media (max-width: 800px) {
      #auth .auth-centered {
        flex-direction: column;
        align-items: center;
        gap: var(--space-3);
      }

      .auth-controls {
        justify-content: center;
      }
    }

    /* ========== Event Detail Layout ========== */
    #eventDetail.card {
      padding: 0;
      border: none;
      background: none;
      box-shadow: none;
    }

    .tab-panel {
      flex-grow: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    #discussion-layout {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: var(--space-4);
      flex-grow: 1;
      min-height: 0;
    }

    .sidebar-container,
    #discussion-main {
      background-color: var(--color-surface);
      border-radius: var(--radius-3);
      padding: var(--space-3);
      border: 1px solid var(--color-border);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .sidebar-container {
      overflow-y: auto;
    }

    .sidebar-container #compactEventHeaderContainer {
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
      margin-bottom: var(--space-3);
      flex-shrink: 0;
    }

    .sidebar-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .sidebar-title-row h2 {
      margin: 0;
      font-size: 1.4rem;
      line-height: 1.25;
      font-weight: 700;
      flex: 1;
    }

    .btn-pill {
      border-radius: 999px;
      border: 1px solid var(--color-border);
      padding: .2rem .6rem;
      font-size: .8rem;
      background: var(--color-surface-strong);
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 0.2s ease;
    }
    .btn-pill:hover {
      background-color: var(--color-surface-hover);
    }

    .event-speakers { margin-top: var(--space-2); }
    .speaker-list { display: flex; flex-wrap: wrap; gap: .4rem; margin: .5rem 0 0; padding: 0; list-style: none; }
    .speaker-pill {
      display: inline-flex; align-items: center; gap: .4rem; padding: .2rem .6rem; border-radius: 999px;
      border: 1px solid var(--spk-color, var(--color-primary));
      background: color-mix(in oklab, var(--spk-color, var(--color-primary)) 10%, transparent);
      font-size: .85rem; line-height: 1.1; color: var(--color-text);
    }
    .speaker-affiliation { color: var(--color-text-muted); font-size: .8rem; }
    .sidebar-meta { margin-top: var(--space-2); color: var(--color-text-muted); display: flex; flex-direction: column; gap: .3rem; font-size: .9rem; }
    .sidebar-tags { display: flex; flex-wrap: wrap; gap: .35rem; margin-top: var(--space-2); }
    .zoom-inline { margin-top: var(--space-3); display: flex; gap: .5rem; align-items: center; }
    .event-actions-row { display: flex; flex-wrap: wrap; gap: .5rem; align-items: center; margin-top: var(--space-3); }
    .chip {
      border-radius: 999px; padding: .3rem .7rem; border: 1px solid var(--color-border);
      display: inline-flex; align-items: center; gap: .35rem; cursor: pointer; font-weight: 600;
      font-size: .8rem; white-space: nowrap; transition: all 0.2s ease;
    }
    .chip:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .chip.active { font-weight: 700; }
    .chip[data-rsvp="going"].active { background: var(--color-success-muted); color: var(--color-success); border-color: var(--color-success); }
    .chip[data-rsvp="interested"].active { background: color-mix(in oklab, orange 15%, transparent); color: #d06900; border-color: orange; }
    .chip[data-rsvp="not_going"].active { background: var(--color-danger-muted); color: var(--color-danger); border-color: var(--color-danger); }
    .chip#btnFollowCompact.active { background: var(--color-primary-muted); color: var(--color-primary); border-color: var(--color-primary); }

    .inline-form { display: flex; gap: .5rem; align-items: center; margin-bottom: var(--space-3); }
    .inline-form input[type="text"] { flex: 1; }

    #threadsList { flex-grow: 1; display: flex; flex-direction: column; gap: var(--space-1); }
    .thread-list-item {
      display: grid; grid-template-columns: auto 1fr; gap: var(--space-2); padding: var(--space-2);
      border-radius: var(--radius-2); cursor: pointer; transition: background-color 0.2s ease; align-items: center;
    }
    .thread-list-item:hover { background-color: var(--color-surface-hover); }
    .thread-list-item.active { background-color: var(--color-primary-muted); }
    .thread-list-item .title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .thread-list-item .meta { font-size: 0.8rem; color: var(--color-text-muted); }
    .avatar-circle {
      width: 32px; height: 32px; border-radius: 50%; background-color: var(--color-surface-strong);
      display: grid; place-content: center; font-weight: 600; font-size: 1rem; flex-shrink: 0;
    }

    .tabs {
      display: flex; gap: var(--space-2); margin-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border); flex-shrink: 0;
    }
    .tab {
      background: none; border: none; color: var(--color-text-muted); padding: .5rem .2rem;
      cursor: pointer; font-weight: 600; font-size: .95rem; border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s;
    }
    .tab:hover { color: var(--color-text); }
    .tab.active { color: var(--color-primary); border-color: var(--color-primary); }

    .prose { line-height: 1.6; color: var(--color-text); font-size: 1rem; overflow-y: auto; padding-right: var(--space-2); }
    .prose a { color: var(--color-primary); text-decoration: none; border-bottom: 1px solid var(--color-primary-muted); }
    .prose a:hover { border-bottom-color: var(--color-primary); }
    
    #thread-welcome {
      flex-grow: 1; display: grid; place-content: center; color: var(--color-text-muted);
      text-align: center; padding: var(--space-4);
    }

    /* --- CORRECTED CHAT STYLES (from old version) --- */
    #threadDetailView {
      flex-grow: 1; min-height: 0; display: flex; flex-direction: column; padding: 0;
    }
    #commentsList {
      flex-grow: 1; overflow-y: auto; padding: var(--space-2);
      display: flex; flex-direction: column; gap: var(--space-2);
    }
    .comment-node { display: block; position: relative; }
    .comment-author { display: flex; align-items: center; gap: var(--space-2); font-size: 0.85rem; }
    .avatar-circle.comment-avatar {
      width: 26px; height: 26px; font-size: 0.8rem; cursor: pointer; color: var(--color-text);
    }
    .comment-author strong { font-weight: 600; cursor: pointer; }
    .comment-author .timestamp { color: var(--color-text-muted); }
    .comment-body-wrapper {
      display: flex; align-items: center; gap: var(--space-3); margin-top: var(--space-1);
    }
    .comment-bubble {
      display: inline-flex; align-items: center; gap: var(--space-2);
      padding: calc(var(--space-2) - 2px) var(--space-3);
      background: var(--color-surface-strong);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-2); max-width: 100%;
    }
    .comment-text {
      margin: 0; line-height: 1.5; font-size: 0.95rem; word-wrap: break-word; white-space: pre-wrap;
    }
    .comment-actions { display: flex; align-items: center; gap: var(--space-3); }
    .comment-actions .btn-ghost {
      font-size: 0.75rem; font-weight: 600; color: var(--color-text-muted); padding: var(--space-1) 0;
    }
    .comment-replies {
      margin-top: var(--space-2); margin-left: 28px; padding-left: 16px;
      border-left: 2px solid var(--color-surface-strong);
      display: flex; flex-direction: column; gap: var(--space-2); position: relative;
    }
    .comment-replies:empty { border-left: none; padding-left: 0; margin-left: 0; }
    .comment-main { position: relative; }
    .thread-dot {
      position: absolute; left: -25px; top: 12px;
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--color-surface);
      border: 2px solid var(--accent, var(--color-primary));
      box-shadow: 0 0 0 3px var(--color-surface); pointer-events: none;
    }
    .comment-node.depth-0 > .comment-main .thread-dot { display: none; }
    .inline-reply-form { margin-top: var(--space-2); }
    #replyToThreadForm {
      padding-top: var(--space-3); border-top: 1px solid var(--color-border);
      display: flex; gap: var(--space-2); align-items: center;
    }
    #replyToThreadForm textarea { flex-grow: 1; resize: none; }
    
    /* --- RESPONSIVE ADJUSTMENTS (from archive.html) --- */
    @media (max-width: 960px) {
      /* HEADER & NAV */
      .mobile-menu-btn {
        display: block; background: none; border: none; color: var(--text);
        font-size: 2rem; cursor: pointer; z-index: 1001; padding: 0; line-height: 0;
      }
      .header-grid > .nav { display: none; }
      
      .mobile-nav-overlay .nav {
        display: flex; flex-direction: column; align-items: center; gap: var(--space-4);
      }
      .mobile-nav-overlay .link { font-size: 1.8rem; font-weight: 500; }
      .mobile-nav-overlay .divider { display: none; }
      .mobile-nav-overlay .auth-area {
        margin-top: var(--space-2); display: flex; flex-direction: column; align-items: center; gap: var(--space-3);
      }
      
      .mobile-nav-close-btn {
        position: absolute; top: var(--space-3); right: var(--space-3);
        background: none; border: none; color: var(--text); cursor: pointer; line-height: 1; padding: 0;
      }
      body.menu-open { overflow: hidden; }

      /* INDEX.HTML CONTENT */
      .hero { text-align: center; flex-direction: column; }
      .hero-main { min-width: 0; }
      .hero .meta { text-align: center; }
      
      #schedule .section-header { flex-direction: column; align-items: stretch; }
      #schedule .search-bar { width: 100%; }
      #schedule .search-bar input { width: 100%; box-sizing: border-box; }

      /* EVENT DETAIL VIEW */
      #discussion-layout {
          grid-template-columns: 1fr;
          gap: var(--space-3);
      }
      .sidebar-container, #discussion-main {
          overflow-y: visible; 
      }
    }
  </style>

</head>

<body>
  <header class="site-header">
    <div class="container header-grid">
      <div class="brand">
        <a href="index.html" style="display: contents; text-decoration: none;">
          <div class="logo-circle">A</div>
          <div class="brand-text">
            <div class="title">Almuerzo Agrivoltaico</div>
            <div class="subtitle" data-i18n="tagline">
              An informal seminar series to share advances in agrivoltaics in Latin America
            </div>
          </div>
        </a>
      </div>
      
      <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>

      <!-- Desktop Nav -->
      <nav class="nav">
        <a href="index.html" class="link active" data-i18n="nav.schedule">Schedule</a>
        <a href="archive.html" class="link" data-i18n="nav.archive">Archive</a>
        <a href="about.html" class="link" data-i18n="nav.about">About</a>
        <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
        <div class="divider"></div>
        <div id="langSwitchDesktop" class="lang-switch-slider" data-lang="en">
          <span>EN</span>
          <span>ES</span>
        </div>
        <div class="auth-area">
          <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile">
            <span id="userInitial"></span>
          </button>
          <span id="userName"></span>
          <button id="btnSignIn" class="btn-primary" data-i18n="auth.signin">Sign in</button>
          <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
            Sign out
          </button>
        </div>
      </nav>
    </div>
  </header>

  <div id="mobileNavOverlay" class="mobile-nav-overlay">
    <!-- Content will be injected by JS -->
  </div>

  <div id="flash" class="flash" role="status" aria-live="polite"></div>

  <main class="container">
    <!-- Hero -->
    <section id="hero" class="card hero">
      <div class="hero-main">
        <h1>Almuerzo Agrivoltaico</h1>
        <p data-i18n="intro">
          Agrivoltaics (agrivoltaics) is an emerging field that integrates solar energy with
          crop/livestock production. This bilingual seminar focuses on Latin America. Hosted by
          UNAM and University of Arizona.
        </p>
      </div>
      <div class="meta">
        <span class="meta-item" data-i18n="format">Online ‚Ä¢ Monthly ‚Ä¢ 1 hour (30 min talk + 30 min
          discussion)</span>
        <span class="meta-item" data-i18n="hosted">Hosted by UNAM & University of Arizona</span>
      </div>
    </section>

    <!-- Schedule -->
    <section id="schedule" class="card" aria-labelledby="scheduleTitle">
      <div class="section-header">
        <div class="section-title-group">
          <h2 id="scheduleTitle" data-i18n="schedule.title">Talks</h2>
          <div class="view-switch">
            <button id="viewList" class="chip chip-toggle active" data-i18n="schedule.list">List</button>
            <button id="viewCalendar" class="chip chip-toggle" data-i18n="schedule.calendar">Calendar</button>
          </div>
        </div>
        <div class="calendar-header">
          <button id="calPrev" class="btn-ghost" aria-label="Previous month">‚óÄ</button>
          <div id="calLabel" class="cal-label">Month</div>
          <button id="calNext" class="btn-ghost" aria-label="Next month">‚ñ∂</button>
        </div>
        <div class="search-bar">
          <input id="search" type="search" placeholder="Search..." data-i18n-placeholder="search.placeholder" />
        </div>
      </div>

      <div id="eventsList" class="events-grid"></div>

      <div id="calendar" class="calendar">
        <div class="calendar-grid" id="calendarGrid"></div>
        <div class="calendar-legend">
          <span class="legend scheduled" data-i18n="legend.scheduled">Scheduled</span>
          <span class="legend completed" data-i18n="legend.completed">Completed</span>
          <span class="legend canceled" data-i18n="legend.canceled">Canceled</span>
        </div>
      </div>

      <div id="emptyEvents" class="empty" style="display: none" data-i18n="schedule.empty">
        No events yet. Check back soon.
      </div>
    </section>

    <!-- Auth (shown when signed out, now compact and after schedule) -->
    <section id="auth" class="card" aria-labelledby="authTitle">
      <div class="auth-centered">
        <h2 id="authTitle" data-i18n="auth.title">Sign in to participate</h2>
        <div class="auth-controls">
          <button id="btnGoogle" class="btn-social btn-google">
            <svg viewBox="0 0 24 24" aria-hidden="true" width="24" height="24">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"></path>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"></path>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"></path>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"></path>
              <path d="M1 1h22v22H1z" fill="none"></path>
            </svg>
            <span>Sign in with Google</span>
          </button>
          <form id="emailForm" class="auth-form-secondary">
            <label for="email" class="sr-only" data-i18n="auth.email">Email</label>
            <input id="email" type="email" placeholder="you@example.com" required data-i18n-placeholder="auth.email" />
            <button class="btn-secondary" type="submit" data-i18n="auth.magic">Send magic link</button>
          </form>
        </div>
      </div>
    </section>

    <!-- Event Detail -->
    <section id="eventDetail" class="card" style="display: none">
      <div id="discussion-layout">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar-container">
          <div id="compactEventHeaderContainer">
            <!-- JS Renders Event Details Here -->
          </div>

          <form id="newThreadForm" class="inline-form">
            <input id="threadTitle" type="text" placeholder="Start a new topic..." required data-i18n-placeholder="thread.placeholder" />
            <button class="btn-primary" type="submit" data-i18n="thread.create">Create</button>
          </form>
          <div id="threadsList">
            <!-- JS Renders Threads Here -->
          </div>
        </div>

        <!-- RIGHT MAIN AREA -->
        <div id="discussion-main">
          <div class="tabs">
            <button class="tab active" data-tab="description" data-i18n="tabs.description">Description</button>
            <button class="tab" data-tab="discussion" data-i18n="tabs.discussion">Discussion</button>
            <button class="tab" data-tab="files" data-i18n="tabs.files">Files</button>
          </div>

          <!-- Description Panel -->
          <div id="tab_description" class="tab-panel">
            <div id="descriptionContent" class="prose"></div>
          </div>

          <!-- Discussion Panel -->
          <div id="tab_discussion" class="tab-panel" style="display: none;">
            <div id="thread-welcome">
              <div>
                <h3 data-i18n="discussion.welcome_title">Welcome to the discussion!</h3>
                <p data-i18n="discussion.welcome_body">Select a topic from the left to view the
                  conversation, or start a new one.</p>
              </div>
            </div>
            <div id="threadDetailView" style="display: none;">
              <div id="commentsList"></div>
              <form id="replyToThreadForm">
                <textarea placeholder="Write a comment..." required data-i18n-placeholder="comment.placeholder"></textarea>
                <button class="btn-primary" type="submit" data-i18n="comment.send">Send</button>
              </form>
            </div>
          </div>

          <!-- Files Panel -->
          <div id="tab_files" class="tab-panel" style="display: none">
            <form id="uploadForm" class="inline-form">
              <input id="fileInput" type="file" />
              <button class="btn-primary" type="submit" data-i18n="files.upload">Upload</button>
            </form>
            <div id="filesList" class="files"></div>
            <div id="emptyFiles" class="empty" style="display: none" data-i18n="files.empty">
              No files yet.
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>
        ¬© <span id="year"></span> Almuerzo Agrivoltaico ‚Ä¢
        <span data-i18n="footer.note">Bilingual, community-driven seminar on agrivoltaics in Latin
          America.</span>
      </small>
    </div>
  </footer>

  <!-- JS Logic embedded in HTML -->
  <script type="module">
    import { 
      supabase, 
      authState, 
      initAuth, 
      fetchProfile,
      signInWithGoogle,
      signInWithEmail,
      signOut
    } from "./auth.js";

    let eventRealtimeChannel = null;

    const state = {
      language: localStorage.getItem("lang") || "en",
      events: [],
      selectedEvent: null,
      threads: [],
      selectedThreadId: null,
      comments: [],
      files: [],
      rsvpStatus: null,
      isFollowing: false,
      counts: { followers: 0, going: 0, interested: 0 },
      calendarMonth: new Date(),
    };

    // Basic i18n
    const t = {
      en: {
        tagline: "An informal seminar series to share advances in agrivoltaics in Latin America",
        intro: "Agrivoltaics (agrivoltaics) is an emerging field that integrates solar energy with crop/livestock production. This bilingual seminar focuses on Latin America. Hosted by UNAM and University of Arizona.",
        format: "Online ‚Ä¢ Monthly ‚Ä¢ 1 hour (30 min talk + 30 min discussion)",
        hosted: "Hosted by UNAM & University of Arizona",
        nav: { schedule: "Schedule", archive: "Archive", about: "About", admin: "Admin" },
        auth: {
          title: "Sign in to participate", signin: "Sign in", signout: "Sign out",
          email: "Email", magic: "Send magic link", magic_hint: "We'll email you a sign-in link. Check your inbox.", or: "or",
          required: "Please sign in to view event details.",
        },
        profile: { incomplete: "Please complete your profile to access all features" },
        schedule: { title: "Talks", empty: "No events yet. Check back soon.", list: "List", calendar: "Calendar" },
        search: { placeholder: "Search..." },
        back: { schedule: "Back to schedule" },
        tabs: { description: "Description", discussion: "Discussion", files: "Files" },
        discussion: { welcome_title: "Welcome to the discussion!", welcome_body: "Select a topic from the left to view the conversation, or start a new one." },
        thread: { placeholder: "Start a new topic...", create: "Create", empty: "No topics yet. Start the discussion!" },
        comment: { placeholder: "Write a comment...", send: "Send" },
        files: { upload: "Upload", empty: "No files yet." },
        footer: { note: "Bilingual, community-driven seminar on agrivoltaics in Latin America." },
        rsvp: { going: "Going", interested: "Interested", notgoing: "Not going", saved: "RSVP updated" },
        follow: "Follow",
        reply: "Reply",
        legend: { scheduled: "Scheduled", completed: "Completed", canceled: "Canceled" },
        save: "Save", cancel: "Cancel",
        errors: { upload: "Upload failed" },
        labels: { followers: "followers", going: "going", interested: "interested" },
        open: "Open", join_zoom: "Join Zoom", copy_link: "Copy Zoom link", copied: "Copied!",
        tags: "Tags",
        speakers: "Speaker(s)"
      },
      es: {
        tagline: "Serie de seminarios informales para compartir avances en agrofotovoltaica en Am√©rica Latina",
        intro: "La agrofotovoltaica integra energ√≠a solar con producci√≥n agr√≠cola/ganadera. Este seminario biling√ºe se enfoca en Am√©rica Latina. Organizado por UNAM y University of Arizona.",
        format: "En l√≠nea ‚Ä¢ Mensual ‚Ä¢ 1 hora (30 min charla + 30 min discusi√≥n)",
        hosted: "Organizado por UNAM y University of Arizona",
        nav: { schedule: "Calendario", archive: "Archivo", about: "Acerca de", admin: "Admin" },
        auth: {
          title: "Inicia sesi√≥n para participar", signin: "Iniciar sesi√≥n", signout: "Cerrar sesi√≥n",
          email: "Correo", magic: "Enviar enlace m√°gico", magic_hint: "Te enviaremos un enlace de acceso. Revisa tu bandeja.", or: "o",
          required: "Por favor, inicia sesi√≥n para ver los detalles del evento.",
        },
        profile: { incomplete: "Por favor completa tu perfil para acceder a todas las funciones" },
        schedule: { title: "Charlas", empty: "A√∫n no hay eventos. Vuelve pronto.", list: "Lista", calendar: "Calendario" },
        search: { placeholder: "Buscar..." },
        back: { schedule: "Volver al calendario" },
        tabs: { description: "Descripci√≥n", discussion: "Discusi√≥n", files: "Archivos" },
        discussion: { welcome_title: "¬°Bienvenido/a a la discusi√≥n!", welcome_body: "Selecciona un tema de la izquierda o crea uno nuevo." },
        thread: { placeholder: "Iniciar un nuevo tema...", create: "Crear", empty: "A√∫n no hay temas. ¬°Comienza la discusi√≥n!" },
        comment: { placeholder: "Escribe un comentario...", send: "Enviar" },
        files: { upload: "Subir", empty: "No hay archivos." },
        footer: { note: "Seminario biling√ºe y comunitario sobre agrofotovoltaica en Am√©rica Latina." },
        rsvp: { going: "Asistir√©", interested: "Interesado/a", notgoing: "No asistir√©", saved: "Asistencia actualizada" },
        follow: "Seguir",
        reply: "Responder",
        legend: { scheduled: "Programado", completed: "Completado", cancelado: "Cancelado" },
        save: "Guardar", cancel: "Cancelar",
        errors: { upload: "Fallo al subir" },
        labels: { followers: "seguidores", going: "asisten", interested: "interesados" },
        open: "Abrir", join_zoom: "Unirse a Zoom", copy_link: "Copiar enlace de Zoom", copied: "¬°Copiado!",
        tags: "Etiquetas",
        speakers: "Ponente(s)"
      },
    };

    function tr(key, fallback = "") {
      const lang = state.language;
      const parts = key.split(".");
      let obj = t[lang];
      for (const p of parts) obj = obj?.[p];
      return obj ?? fallback;
    }

    const $ = (sel) => document.querySelector(sel);

    function setFlash(msg, timeout = 3000) {
      const el = $("#flash");
      if (!el) return;
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(setFlash._t);
      if (timeout > 0) {
        setFlash._t = setTimeout(() => (el.style.display = "none"), timeout);
      }
    }

    function fmtDateTime(iso) {
      try { return new Intl.DateTimeFormat(undefined, { dateStyle: "medium", timeStyle: "short" }).format(new Date(iso)); } catch (_) { return iso; }
    }

    function bytesToSize(bytes = 0) {
      if (bytes === 0) return "0 B";
      const k = 1024, sizes = ["B", "KB", "MB", "GB", "TB"], i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function escapeHtml(s = "") {
      return String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
    }

    function linkify(text = "") {
      let safe = escapeHtml(text);
      const urlRegex = /\b(https?:\/\/[^\s<]+)\b/g;
      safe = safe.replace(urlRegex, (m) => `<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);
      safe = safe.replace(/\n/g, "<br/>");
      return safe;
    }

    function applyI18n() {
      document.querySelectorAll("[data-i18n]").forEach((el) => { el.textContent = tr(el.dataset.i18n, el.textContent); });
      document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => { el.placeholder = tr(el.dataset.i18nPlaceholder, el.placeholder); });
      document.querySelectorAll(".lang-switch-slider").forEach(el => { if (el) el.dataset.lang = state.language; });
    }

    function showView(which) {
      $("#schedule").style.display = "none";
      $("#eventDetail").style.display = "none";
      $("#hero").style.display = "none";
      $("#auth").style.display = "none";

      if (which === "schedule") {
        $("#hero").style.display = "flex";
        $("#schedule").style.display = "flex";
        if (!authState.session) $("#auth").style.display = "block";
      } else if (which === "event") {
        $("#eventDetail").style.display = "flex";
      }
    }

    /* ============= Mobile Menu Logic (from archive.html) ============= */
    function setupMobileMenu() {
        const mobileNavOverlay = $("#mobileNavOverlay");
        const desktopNav = document.querySelector('.header-grid .nav');
        if (!mobileNavOverlay || !desktopNav) return;

        mobileNavOverlay.innerHTML = ''; // Clear previous content
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'mobile-nav-close-btn';
        closeBtn.setAttribute('aria-label', 'Close menu');
        closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        
        const content = desktopNav.cloneNode(true);
        content.id = ''; // Avoid duplicate IDs
        const langSwitchMobile = content.querySelector('#langSwitchDesktop');
        if (langSwitchMobile) langSwitchMobile.id = 'langSwitchMobile';
        
        mobileNavOverlay.appendChild(closeBtn);
        mobileNavOverlay.appendChild(content);

        closeBtn.addEventListener('click', closeMenu);
        mobileNavOverlay.addEventListener('click', (e) => { if (e.target === mobileNavOverlay) closeMenu(); });
        
        // Wire up listeners for the cloned elements
        langSwitchMobile?.addEventListener('click', handleLangSwitch);
        content.querySelector("#btnSignIn")?.addEventListener("click", () => signInWithGoogle()); // Or show auth section
        content.querySelector("#btnSignOut")?.addEventListener("click", () => signOut());
        content.querySelector("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');
    }

    function openMenu() {
        const mobileMenuBtn = $("#mobileMenuBtn"), mobileNavOverlay = $("#mobileNavOverlay");
        mobileNavOverlay.classList.add("is-open");
        document.body.classList.add("menu-open");
        mobileMenuBtn.setAttribute("aria-expanded", "true");
        mobileMenuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    }

    function closeMenu() {
        const mobileMenuBtn = $("#mobileMenuBtn"), mobileNavOverlay = $("#mobileNavOverlay");
        mobileNavOverlay.classList.remove("is-open");
        document.body.classList.remove("menu-open");
        mobileMenuBtn.setAttribute("aria-expanded", "false");
        mobileMenuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
    }

    /* ============= Header, Auth & Language ============= */
    function renderHeader() {
      const btnSignIn = $("#btnSignIn"), btnSignOut = $("#btnSignOut"), btnAdmin = $("#btnAdmin"), userName = $("#userName"), btnProfile = $("#btnProfile");
      const isOrganizer = ["organizer", "admin"].includes(authState.profile?.role);
      
      if (authState.session) {
        btnSignIn.style.display = "none"; btnSignOut.style.display = "inline-block";
        btnProfile.style.display = "grid"; userName.style.display = "inline";
        userName.textContent = authState.profile?.full_name || authState.profile?.username || "";
        $("#userInitial").textContent = (authState.profile?.full_name || "U").charAt(0).toUpperCase();
        if (btnAdmin) btnAdmin.style.display = isOrganizer ? "inline-block" : "none";
      } else {
        btnSignIn.style.display = "inline-block"; btnSignOut.style.display = "none";
        btnProfile.style.display = "none"; userName.style.display = "none";
        if (btnAdmin) btnAdmin.style.display = "none";
      }
      // Re-build the mobile menu every time the header is rendered to reflect auth state
      setupMobileMenu();
    }

    function handleLangSwitch() {
        state.language = state.language === 'en' ? 'es' : 'en';
        localStorage.setItem("lang", state.language);
        applyI18n(); 
        renderEventsList();
        if (state.selectedEvent) { 
            renderEventHeader(); 
            renderThreads(); 
            renderDescriptionTab(); 
            if (state.selectedThreadId) renderComments(); 
        }
        renderFiles(); 
        renderScheduleCalendar();
    }


    /* ============= Data: Events & Schedule ============= */
    async function loadEvents() {
      const { data } = await supabase.from("events").select("*, event_speakers(*)").order("start_time", { ascending: true });
      state.events = data || [];
      renderEventsList();
      renderScheduleCalendar();

      const urlParams = new URLSearchParams(window.location.search);
      const eid = urlParams.get("event") || urlParams.get("e");

      // DECIDE INITIAL VIEW
      if (eid) {
        if (authState.session) {
          await openEvent(eid);
        } else {
          // If not logged in, remember the event, show a message, and display the default schedule view
          authState.pendingDeepLinkEventId = eid;
          setFlash(tr('auth.required'));
          $("#auth")?.scrollIntoView({ behavior: 'smooth' });
          showView("schedule");
        }
      } else {
        // If no event is specified in the URL, show the default schedule view
        showView("schedule");
      }
    }

    function nowUtcComparable(d) {
      return new Date(d).getTime();
    }

    function renderEventsList() {
      const list = $("#eventsList"), empty = $("#emptyEvents");
      if (!list || !empty) return;
      const term = ($("#search")?.value || "").toLowerCase().trim();
      const now = Date.now();

      const futureEvents = state.events.filter(e => nowUtcComparable(e.start_time) >= now);

      const filtered = futureEvents.filter((e) => {
        if (!term) return true;
        const speakerMatch = (e.event_speakers || []).some(s =>
          (s.name || "").toLowerCase().includes(term) ||
          (s.affiliation || "").toLowerCase().includes(term)
        );
        const tagsMatch = (e.topic_tags || []).some(tag => (tag || "").toLowerCase().includes(term));
        const eventMatch = [e.title_en, e.title_es, e.description_en, e.description_es, e.host_org]
          .filter(Boolean)
          .some((v) => v.toLowerCase().includes(term));
        return speakerMatch || tagsMatch || eventMatch;
      });

      empty.style.display = filtered.length ? "none" : "block";
      list.innerHTML = filtered.map(ev => {
        const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
        const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;

        let speakerLine = '';
        if (ev.event_speakers && ev.event_speakers.length > 0) {
          const primarySpeaker = ev.event_speakers.find(s => s.primary_speaker) || ev.event_speakers[0];
          speakerLine = `<div class="event-speaker">üë§ ${escapeHtml(primarySpeaker.name)}${primarySpeaker.affiliation ? ` (${escapeHtml(primarySpeaker.affiliation)})` : ''}</div>`;
        }

        const tagTopics = (ev.topic_tags || []).map(tag => `<span class="tag-topic">#${escapeHtml(tag)}</span>`).join("");

        return `
        <div class="event-card">
          <div class="when">${fmtDateTime(ev.start_time)}</div>
          <div class="event-title">${escapeHtml(title)}</div>
          ${speakerLine}
          <div class="actions">
            <button class="btn-secondary" data-open="${String(ev.id)}">${tr("open", "Open")}</button>
          </div>
          ${desc ? `<div class="event-desc">${escapeHtml(desc).substring(0, 140)}‚Ä¶</div>` : ""}
          <div class="tags">
            ${tagTopics}
            <span class="tag">${(ev.language || "bi").toUpperCase()}</span>
            ${ev.host_org ? `<span class="tag">${escapeHtml(ev.host_org)}</span>` : ""}
          </div>
        </div>`;
      }).join('');
    }

    async function openEvent(eventId) {
      if (!authState.session) {
        setFlash(tr('auth.required'));
        $("#auth").scrollIntoView({ behavior: 'smooth' });
        return;
      }

      const { data: ev, error } = await supabase
        .from('events')
        .select('*, event_speakers(*)')
        .eq('id', eventId)
        .single();

      if (error || !ev) {
        console.error("Failed to fetch event details", error);
        setFlash("Could not load event.", true);
        return;
      }

      state.selectedEvent = ev;
      state.selectedThreadId = null;
      showDiscussionView('welcome');
      subscribeToEventChanges(ev.id);
      await Promise.all([loadThreads(ev.id), loadFiles(ev.id), loadRSVPFollow(ev.id)]);
      renderEventHeader();
      renderDescriptionTab();
      setActiveTab('description');
      showView("event");

      const url = new URL(window.location.href);
      url.searchParams.set("event", ev.id);
      history.replaceState(null, "", url.toString());
    }

    function colorFromString(str = "") {
      let hash = 0;
      for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue} 70% 45%)`;
    }

    function renderEventHeader() {
      const ev = state.selectedEvent; if (!ev) return;
      const container = $("#compactEventHeaderContainer");
      if (!container) return;

      const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;

      let speakersHtml = "";
      if (ev.event_speakers && ev.event_speakers.length > 0) {
        const speakersSorted = [...ev.event_speakers].sort((a, b) => (b.primary_speaker === true) - (a.primary_speaker === true));
        const speakerPills = speakersSorted.map(s => {
          const col = colorFromString(s.name || "");
          return `
            <li class="speaker-pill" style="--spk-color:${col}">
              <span class="speaker-name">${escapeHtml(s.name)} ${s.primary_speaker ? '‚≠ê' : ''}</span>
              ${s.affiliation ? `<span class="speaker-affiliation">${escapeHtml(s.affiliation)}</span>` : ''}
            </li>
          `;
        }).join("");

        speakersHtml = `
          <div class="event-speakers">
            <div style="font-weight:600; font-size: .9rem; color: var(--color-text-muted); margin-bottom: .2rem;">${tr('speakers')}</div>
            <ul class="speaker-list">${speakerPills}</ul>
          </div>
        `;
      }

      const metaHtml = `
        <div class="sidebar-meta">
          <div>üóìÔ∏è ${fmtDateTime(ev.start_time)}</div>
          ${ev.host_org ? `<div>üè¢ ${escapeHtml(ev.host_org)}</div>` : ""}
          <div>üåê ${(ev.language || "bi").toUpperCase()}</div>
        </div>
      `;

      const tagsHtml = `
        <div class="sidebar-tags">
          ${(ev.topic_tags || []).map(tag => `<span class="tag-topic">#${escapeHtml(tag)}</span>`).join("")}
        </div>
      `;

      const zoomHtml = (authState.session && ev.zoom_url) ? `
        <div class="zoom-inline">
          <a href="${ev.zoom_url}" target="_blank" rel="noopener" class="btn-primary">üîó ${tr('join_zoom')}</a>
          <button class="btn-ghost" data-copy-link="${ev.zoom_url}" aria-label="${tr('copy_link')}">üìã</button>
        </div>
      ` : "";

      const actionsHtml = `
        <div class="event-actions-row">
          <button class="chip ${state.rsvpStatus === 'going' ? 'active' : ''}" data-rsvp="going">${tr('rsvp.going')}</button>
          <button class="chip ${state.rsvpStatus === 'interested' ? 'active' : ''}" data-rsvp="interested">${tr('rsvp.interested')}</button>
          <button class="chip ${state.rsvpStatus === 'not_going' ? 'active' : ''}" data-rsvp="not_going">${tr('rsvp.notgoing')}</button>
          <button id="btnFollowCompact" class="chip ${state.isFollowing ? 'active' : ''}" style="display: ${authState.session ? 'inline-flex' : 'none'}">${tr('follow')}</button>
          <span class="event-counts" style="margin-left:auto; font-size:.8rem; color:var(--color-text-muted); display:flex; gap:.5rem;">
            <span class="count">${state.counts.followers} ${tr("labels.followers")}</span>
            <span class="count">${state.counts.going} ${tr("labels.going")}</span>
            <span class="count">${state.counts.interested} ${tr("labels.interested")}</span>
          </span>
        </div>
      `;

      container.innerHTML = `
        <div class="sidebar-title-row">
          <h2 class="event-title">${escapeHtml(title)}</h2>
          <button class="btn-pill" id="backToScheduleCompact">‚Üê ${tr('back.schedule')}</button>
        </div>
        ${metaHtml}
        ${speakersHtml}
        ${tagsHtml}
        ${zoomHtml}
        ${actionsHtml}
      `;
    }

    function renderDescriptionTab() {
      const ev = state.selectedEvent;
      const el = $("#descriptionContent");
      if (!el) return;
      const desc = state.language === "es" && ev?.description_es ? ev.description_es : ev?.description_en || "";
      const extraLinks = [];
      if (ev?.registration_url) extraLinks.push(`<a href="${escapeHtml(ev.registration_url)}" target="_blank" rel="noopener">üìù Registration</a>`);
      if (ev?.livestream_url) extraLinks.push(`<a href="${escapeHtml(ev.livestream_url)}" target="_blank" rel="noopener">üì∫ Livestream</a>`);
      if (ev?.recording_url) extraLinks.push(`<a href="${escapeHtml(ev.recording_url)}" target="_blank" rel="noopener">üé• Recording</a>`);
      el.innerHTML = `
        ${desc ? `<div>${linkify(desc)}</div>` : `<div class="text-muted">No description provided.</div>`}
        ${extraLinks.length ? `<div style="margin-top:.8rem; display:flex; gap:.6rem; flex-wrap:wrap;">${extraLinks.join("")}</div>` : ""}
      `;
    }

    function setActiveTab(name) {
      document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach((p) => (p.style.display = "none"));
      const tabBtn = document.querySelector(`.tab[data-tab="${name}"]`);
      const panel = document.querySelector(`#tab_${name}`);
      if (tabBtn) tabBtn.classList.add("active");
      if (panel) panel.style.display = "flex";
    }

    function renderScheduleCalendar() {
      const grid = $("#calendarGrid"), label = $("#calLabel"); if (!grid || !label) return;
      const m = state.calendarMonth; label.textContent = m.toLocaleString(state.language, { month: "long", year: "numeric" });
      const start = new Date(m.getFullYear(), m.getMonth(), 1), end = new Date(m.getFullYear(), m.getMonth() + 1, 0);
      const firstDayIndex = (start.getDay() + 6) % 7, daysInMonth = end.getDate(); grid.innerHTML = ``;

      for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement("div"));
      const byDay = state.events.reduce((acc, ev) => {
        const d = new Date(ev.start_time); if (d.getMonth() !== m.getMonth() || d.getFullYear() !== m.getFullYear()) return acc;
        const day = d.getDate(); if (!acc.has(day)) acc.set(day, []); acc.get(day).push(ev); return acc;
      }, new Map());

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div"); cell.className = "cal-cell"; cell.innerHTML = `<div class="cal-day">${day}</div>`;
        (byDay.get(day) || []).forEach((ev) => {
          const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
          const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;

          let speakerName = '';
          if (ev.event_speakers && ev.event_speakers.length > 0) {
            const primarySpeaker = ev.event_speakers.find(s => s.primary_speaker) || ev.event_speakers[0];
            speakerName = `<div class="cal-event-speaker">üë§ ${escapeHtml(primarySpeaker.name)}</div>`;
          }

          const eventDiv = document.createElement("button");
          eventDiv.className = `cal-event status-${ev.status}`;
          eventDiv.innerHTML = `
                <div class="cal-event-title">${escapeHtml(title)}</div>
                ${desc ? `<div class="cal-event-desc">${escapeHtml(desc).substring(0, 60)}...</div>` : ''}
                ${speakerName}
            `;
          eventDiv.addEventListener("click", () => openEvent(ev.id));

          cell.appendChild(eventDiv);
        });
        grid.appendChild(cell);
      }
    }

    /* ====== Discussion Forum Logic (Corrected from old version) ====== */
    function showDiscussionView(view) {
      if (view === 'detail') {
        $("#thread-welcome").style.display = 'none';
        $("#threadDetailView").style.display = 'flex';
      } else { // 'welcome'
        $("#thread-welcome").style.display = 'grid';
        $("#threadDetailView").style.display = 'none';
      }
    }

    async function openThread(threadId) {
      state.selectedThreadId = threadId;
      showDiscussionView('detail');
      renderThreads();
      await loadComments(threadId);
      setActiveTab('discussion');
    }

    async function loadThreads(eventId) {
      const { data } = await supabase.from("threads").select("*, comments(count), profiles(id, full_name, username)").eq("event_id", eventId).order("created_at", { ascending: false });
      state.threads = data || [];
      for (const th of state.threads) {
        if (th.profiles) {
          authState.profileCache.set(th.created_by, th.profiles);
        } else {
          await fetchProfile(th.created_by);
        }
      }
      renderThreads();
    }

    function renderThreads() {
      const list = $("#threadsList");
      if (!list) return;
      list.innerHTML = "";

      if (!state.threads.length) {
        list.innerHTML = `<div class="empty" data-i18n="thread.empty">${tr('thread.empty')}</div>`;
      }

      for (const th of state.threads) {
        const author = authState.profileCache.get(th.created_by);
        const authorName = author?.full_name || author?.username || '...';
        const initial = authorName.charAt(0).toUpperCase();

        const item = document.createElement("div");
        item.className = "thread-list-item";
        if (th.id === state.selectedThreadId) item.classList.add('active');

        item.innerHTML = `
          <div class="avatar-circle">${initial}</div>
          <div>
            <div class="title">${th.pinned ? "üìå " : ""}${escapeHtml(th.title)}</div>
            <div class="meta">${th.comments[0].count} replies ‚Ä¢ by ${escapeHtml(authorName)}</div>
          </div>
        `;
        item.addEventListener('click', () => openThread(th.id));
        list.appendChild(item);
      }
    }

    async function loadComments(threadId) {
        if (!threadId) return;
        const { data } = await supabase.from("comments").select("*").eq("thread_id", threadId).order("created_at", { ascending: true });
        state.comments = data || [];
        // Pre-fetch all profiles needed for the comments
        const userIds = [...new Set(state.comments.map(c => c.created_by))];
        await Promise.all(userIds.map(id => fetchProfile(id)));
        renderComments();
    }

    function accentFromId(id = "") {
        let hash = 0;
        for (let i = 0; i < id.length; i++) hash = (hash << 5) - hash + id.charCodeAt(i);
        const hue = Math.abs(hash) % 360;
        return `hsl(${hue} 70% 50%)`;
    }

    function createCommentNode(comment, commentsByParentId, depth = 0) {
        const profile = authState.profileCache.get(comment.created_by);
        const authorName = profile?.full_name || profile?.username || '...';
        const initial = authorName.charAt(0).toUpperCase();
        const children = commentsByParentId.get(comment.id) || [];
        const accent = accentFromId(comment.created_by);

        const node = document.createElement('div');
        node.className = `comment-node depth-${depth}`;
        node.style.setProperty('--accent', accent);

        node.innerHTML = `
            <div class="comment-main">
                ${depth > 0 ? `<span class="thread-dot" aria-hidden="true"></span>` : ''}
                <div class="comment-author">
                    <div class="avatar-circle comment-avatar" data-user-id="${comment.created_by}" title="Open profile">${initial}</div>
                    <strong class="author-name" data-open-profile-id="${comment.created_by}" title="Open profile">${escapeHtml(authorName)}</strong>
                    <span class="timestamp">‚Ä¢ ${fmtDateTime(comment.created_at)}</span>
                </div>
                <div class="comment-body-wrapper">
                    <div class="comment-bubble">
                        <div class="comment-text">${comment.is_deleted ? "<em>(deleted)</em>" : linkify(comment.content)}</div>
                    </div>
                    <div class="comment-actions">
                        <button class="btn-ghost" data-reply-id="${comment.id}">üí¨ ${tr('reply', 'Reply')}</button>
                    </div>
                </div>
                <div class="comment-replies"></div>
            </div>
        `;

        const avatar = node.querySelector('.comment-avatar');
        if (avatar) {
            avatar.style.background = `color-mix(in oklab, ${accent} 22%, var(--color-surface-strong))`;
        }

        const repliesContainer = node.querySelector('.comment-replies');
        for (const child of children) {
            repliesContainer.appendChild(createCommentNode(child, commentsByParentId, depth + 1));
        }

        node.querySelector(`[data-reply-id]`).addEventListener('click', (e) => {
            const parentId = e.target.closest('[data-reply-id]').dataset.replyId;
            const existingForm = node.querySelector('.inline-reply-form');
            if (existingForm) {
                existingForm.remove();
                return;
            }

            const formContainer = document.createElement('div');
            formContainer.className = 'inline-reply-form';
            formContainer.innerHTML = `
              <form class="inline-form">
                  <input type="text" placeholder="Replying to ${escapeHtml(authorName)}..." required />
                  <button type="submit" class="btn-primary">${tr('reply', 'Reply')}</button>
              </form>
            `;

            formContainer.querySelector('form').addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const input = ev.target.querySelector('input');
                const content = input.value.trim();
                if (content) {
                    await createComment(state.selectedThreadId, parentId, content);
                    await loadComments(state.selectedThreadId);
                }
            });
            node.querySelector('.comment-body-wrapper').insertAdjacentElement('afterend', formContainer);
            formContainer.querySelector('input').focus();
        });

        return node;
    }

    function renderComments() {
        const container = $(`#commentsList`);
        if (!container) return;
        container.innerHTML = "";

        const commentsByParentId = new Map();
        for (const comment of state.comments) {
            const parentId = comment.parent_id || 'root';
            if (!commentsByParentId.has(parentId)) {
                commentsByParentId.set(parentId, []);
            }
            commentsByParentId.get(parentId).push(comment);
        }

        const rootComments = commentsByParentId.get('root') || [];
        for (const comment of rootComments) {
            container.appendChild(createCommentNode(comment, commentsByParentId, 0));
        }
    }

    async function createThread(title) {
      if (!title || !state.selectedEvent) return;
      const { data } = await supabase.from("threads").insert({ event_id: state.selectedEvent.id, title, created_by: authState.session.user.id }).select().single();
      await loadThreads(state.selectedEvent.id);
      if (data) openThread(data.id);
    }
    async function createComment(thread_id, parent_id, content) {
      await supabase.from("comments").insert({ event_id: state.selectedEvent.id, thread_id, parent_id, content, created_by: authState.session.user.id });
    }

    /* ====== Files / RSVP / Follow ====== */
    async function loadFiles(eventId) { const { data } = await supabase.from("attachments").select("*").eq("event_id", eventId).order("created_at", { ascending: false }); state.files = data || []; renderFiles(); }
    async function uploadFile(file) { if (!file || !state.selectedEvent) return; const eventId = state.selectedEvent.id; const object_path = `events/${eventId}/${Date.now()}-${file.name}`; await supabase.storage.from("attachments").upload(object_path, file); await supabase.from("attachments").insert({ event_id: eventId, bucket_id: "attachments", object_path, file_name: file.name, file_type: file.type, file_size: file.size, created_by: authState.session.user.id }); }
    async function getSignedUrl(path) { const { data } = await supabase.storage.from("attachments").createSignedUrl(path, 3600); return data?.signedUrl; }
    async function renderFiles() {
      const grid = $("#filesList"), empty = $("#emptyFiles"); if (!grid || !empty) return; grid.innerHTML = ""; empty.style.display = state.files.length ? "none" : "block";
      for (const f of state.files) {
        const div = document.createElement("div"); div.className = "file";
        const url = await getSignedUrl(f.object_path);
        div.innerHTML = `<div class="meta"><div class="name">${escapeHtml(f.file_name)}</div><div class="size">${bytesToSize(f.file_size)}</div></div><div class="actions"><a class="btn-secondary" href="${url}" target="_blank" rel="noopener">${tr('open')}</a>${authState.profile?.role === 'admin' ? `<button class="btn-danger" data-del-file-id="${f.id}" data-del-file-path="${f.object_path}">Delete</button>` : ""}</div>`;
        grid.appendChild(div);
      }
    }
    async function deleteFile(id, path) { if (!confirm('Delete file permanently?')) return; await supabase.storage.from("attachments").remove([path]); await supabase.from("attachments").delete().eq("id", id); }
    async function loadRSVPFollow(eventId) {
      state.rsvpStatus = null; state.isFollowing = false; state.counts = { followers: 0, going: 0, interested: 0 };
      const { data: countsData } = await supabase.rpc('get_event_counts', { event_id_param: eventId });
      if (countsData) { state.counts.followers = countsData.followers_count; state.counts.going = countsData.going_count; state.counts.interested = countsData.interested_count; }
      if (authState.session) {
        const uid = authState.session.user.id; const [{ data: myFollow }, { data: myRsvp }] = await Promise.all([
          supabase.from("event_follows").select("id").eq("event_id", eventId).eq("profile_id", uid).maybeSingle(),
          supabase.from("event_rsvps").select("status").eq("event_id", eventId).eq("profile_id", uid).maybeSingle()
        ]);
        state.isFollowing = !!myFollow; state.rsvpStatus = myRsvp?.status || null;
      }
      renderEventHeader();
    }
    async function toggleFollow() { if (!authState.session || !state.selectedEvent) return; const uid = authState.session.user.id; const eventId = state.selectedEvent.id; if (state.isFollowing) await supabase.from("event_follows").delete().eq("event_id", eventId).eq("profile_id", uid); else await supabase.from("event_follows").insert({ event_id: eventId, profile_id: uid }); }

    async function setRSVP(status) {
      if (!authState.session || !state.selectedEvent) return;
      const uid = authState.session.user.id; const eventId = state.selectedEvent.id;
      await supabase.from("event_rsvps").upsert({ event_id: eventId, profile_id: uid, status }, { onConflict: "event_id,profile_id" });
      setFlash(tr('rsvp.saved'));
    }

    /* ============= Realtime Subscriptions ============= */
    function cleanupSubscriptions() {
      if (eventRealtimeChannel) { supabase.removeChannel(eventRealtimeChannel); eventRealtimeChannel = null; }
    }
    function subscribeToEventChanges(eventId) {
      cleanupSubscriptions();
      eventRealtimeChannel = supabase.channel(`event-${eventId}`)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'attachments', filter: `event_id=eq.${eventId}` }, () => loadFiles(eventId))
        .on('postgres_changes', { event: '*', schema: 'public', table: 'event_follows', filter: `event_id=eq.${eventId}` }, () => loadRSVPFollow(eventId))
        .on('postgres_changes', { event: '*', schema: 'public', table: 'event_rsvps', filter: `event_id=eq.${eventId}` }, () => loadRSVPFollow(eventId))
        .subscribe();
    }

    /* ============= Wire-up ============= */
    function wireUI() {
      $("#btnSignOut")?.addEventListener("click", () => signOut());
      $("#emailForm")?.addEventListener("submit", async (e) => { 
        e.preventDefault(); 
        const email = $("#email")?.value.trim(); 
        if (email) { 
          const msg = await signInWithEmail(email, tr);
          setFlash(msg); 
        } 
      });
      $("#btnGoogle")?.addEventListener("click", () => signInWithGoogle());

      $("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');

      $("#eventsList").addEventListener("click", e => {
        const openBtn = e.target.closest('[data-open]');
        if (openBtn) { openEvent(openBtn.dataset.open); return; }
      });

      $("#search")?.addEventListener("input", renderEventsList);
      $("#viewList")?.addEventListener("click", () => { $("#schedule").classList.remove("calendar-view"); $("#viewList").classList.add("active"); $("#viewCalendar").classList.remove("active"); $("#eventsList").style.display = "grid"; $("#calendar").style.display = "none"; });
      $("#viewCalendar")?.addEventListener("click", () => { $("#schedule").classList.add("calendar-view"); $("#viewCalendar").classList.add("active"); $("#viewList").classList.remove("active"); $("#eventsList").style.display = "none"; $("#calendar").style.display = "flex"; });
      $("#calPrev")?.addEventListener("click", () => { state.calendarMonth.setMonth(state.calendarMonth.getMonth() - 1); renderScheduleCalendar(); });
      $("#calNext")?.addEventListener("click", () => { state.calendarMonth.setMonth(state.calendarMonth.getMonth() + 1); renderScheduleCalendar(); });

      $("#eventDetail").addEventListener('click', (e) => {
        const backBtn = e.target.closest('#backToScheduleCompact'); if (backBtn) {
          cleanupSubscriptions(); showView('schedule');
          const url = new URL(window.location.href);
          url.searchParams.delete("event");
          history.replaceState(null, "", url.toString());
          return;
        }
        const followBtn = e.target.closest('#btnFollowCompact'); if (followBtn) { toggleFollow(); return; }
        const rsvpBtn = e.target.closest('[data-rsvp]'); if (rsvpBtn) { setRSVP(rsvpBtn.dataset.rsvp); return; }
        const delFileBtn = e.target.closest('[data-del-file-id]'); if (delFileBtn) { deleteFile(delFileBtn.dataset.delFileId, delFileBtn.dataset.delFilePath); return; }
        const copyBtn = e.target.closest('[data-copy-link]'); if (copyBtn) { navigator.clipboard.writeText(copyBtn.dataset.copyLink); setFlash(tr('copied')); return; }

        const profileEl = e.target.closest('[data-open-profile-id], .comment-avatar[data-user-id]');
        if (profileEl) {
          const userId = profileEl.dataset.openProfileId || profileEl.dataset.userId;
          if (userId) window.location.href = `profile.html?user=${userId}`;
        }
      });

      document.querySelectorAll(".tab").forEach((tab) => tab.addEventListener("click", () => {
        setActiveTab(tab.dataset.tab);
      }));

      $("#newThreadForm")?.addEventListener("submit", async (e) => { e.preventDefault(); const title = $("#threadTitle")?.value.trim(); if (title) { await createThread(title); $("#threadTitle").value = ""; } });
      $("#replyToThreadForm")?.addEventListener("submit", async (e) => {
        e.preventDefault(); const textarea = e.target.querySelector("textarea"); const content = textarea.value.trim();
        if (content && state.selectedThreadId) { await createComment(state.selectedThreadId, null, content); textarea.value = ""; await loadComments(state.selectedThreadId); }
      });
      $("#uploadForm")?.addEventListener("submit", async (e) => { e.preventDefault(); const f = $("#fileInput")?.files[0]; if (f) { await uploadFile(f); $("#fileInput").value = ""; } });
      
      // Wire up language switch and mobile menu
      $("#langSwitchDesktop")?.addEventListener('click', handleLangSwitch);
      $("#mobileMenuBtn")?.addEventListener("click", () => {
        const overlay = $("#mobileNavOverlay");
        if (overlay && !overlay.classList.contains('is-open')) {
          openMenu();
        } else {
          closeMenu();
        }
      });

      $("#year").textContent = new Date().getFullYear();
    }

    (async function main() {
      applyI18n();
      wireUI();
      
      // Initialize auth with callbacks
      await initAuth({
        onAuthReady: (authState, viewUserId) => {
          if (!viewUserId) {
            renderHeader();
          }
        },
        onAuthChange: (authState, viewUserId) => {
          if (!viewUserId) {
            renderHeader();
          }
        }
      });
      
      await loadEvents();
      // NOTE: The showView() call has been moved inside loadEvents()
      // to handle deep linking correctly.

      supabase.channel('public:events').on('postgres_changes', { event: '*', schema: 'public', table: 'events' }, () => loadEvents()).subscribe();
    })();
  </script>
</body>

</html>