<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Almuerzo Agrivoltaico • Seminar Platform</title>
    <meta name="description"
        content="An informal seminar series to share advances in agrivoltaics in Latin America (EN/ES)." />
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* --- Vertical Fit & Layout Fixes for index.html --- */
        html,
        body {
            height: 100%;
            overflow: hidden;
            /* Prevent body from scrolling */
        }

        body {
            display: flex;
            flex-direction: column;
        }

        main.container {
            flex-grow: 1;
            /* Allow main to fill space between header and footer */
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* Critical for flex children to shrink/grow properly */
            padding-top: var(--space-3);
            padding-bottom: var(--space-3);
            gap: var(--space-3);
            /* Replaces margins for spacing between cards */
        }

        /* Override default card margins for this flex layout */
        main.container>.card {
            margin: 0;
        }

        /* Make static sections shrinkable, but not growable */
        #hero,
        #auth,
        #profile {
            flex-shrink: 0;
        }

        .hero {
            padding: var(--space-3) var(--space-4) !important;
        }

        #schedule,
        #eventDetail {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #eventsList,
        #calendar {
            flex-grow: 1;
            min-height: 0;
        }

        #eventsList {
            overflow-y: auto;
        }

        /* Modernized Event Card in List View */
        .event-card {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--space-2) var(--space-4);
            align-items: center;
        }

        .event-card .when {
            grid-column: 1 / -1;
            color: var(--color-primary);
            font-weight: 500;
        }

        .event-card .event-title {
            grid-column: 1;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .event-card .event-desc {
            grid-column: 1 / -1;
            color: var(--color-text-muted);
            margin-top: var(--space-1);
        }

        .event-card .tags {
            grid-column: 1 / -1;
            margin-top: var(--space-3);
        }

        .event-card .actions {
            grid-column: 2;
            grid-row: 2;
        }

        .event-card .zoom-info {
            grid-column: 1 / -1;
            display: flex;
            gap: var(--space-2);
            align-items: center;
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--color-surface-strong);
        }

        #calendar {
            display: none;
            /* Initially hidden */
            flex-direction: column;
        }

        #calendarGrid {
            flex-grow: 1;
            overflow-y: auto;
        }

        .hero {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-4);
        }

        .hero-main {
            flex: 1 1 60%;
            min-width: 350px;
        }

        .hero-main>h1 {
            margin-top: 0;
            margin-bottom: var(--space-2);
        }

        .hero-main>p {
            margin: 0;
        }

        .hero .meta {
            flex: 0 1 auto;
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        /* --- CALENDAR & SCHEDULE HEADER REWORK --- */
        #schedule .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .section-header .calendar-header {
            display: none;
            align-items: center;
            gap: var(--space-2);
            flex-grow: 1;
            justify-content: center;
        }

        #schedule.calendar-view .section-header .calendar-header {
            display: flex;
        }

        #schedule .calendar-header-standalone {
            display: none;
        }

        /* NEW Calendar Tooltip */
        .cal-badge-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .cal-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-surface-strong);
            color: var(--color-text);
            padding: var(--space-3);
            border-radius: var(--radius-2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            width: 280px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 10;
            pointer-events: none;
            text-align: left;
        }

        .cal-badge-wrapper:hover .cal-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .cal-tooltip-title {
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .cal-tooltip-desc {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--color-text-muted);
            margin: 0;
        }


        .section-title-group {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        #schedule .section-header h2 {
            margin: 0;
        }

        /* NEW: Compact, Horizontal Auth Section */
        #auth .auth-centered {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-2) var(--space-3);
            min-height: auto;
        }

        #auth .auth-centered h2 {
            margin: 0;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .auth-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-3);
            flex-grow: 1;
            justify-content: flex-end;
        }

        #emailForm.auth-form-secondary {
            display: flex;
            gap: var(--space-2);
        }

        /* Make auth stack nicely on mobile */
        @media (max-width: 800px) {
            #auth .auth-centered {
                flex-direction: column;
                align-items: center;
                gap: var(--space-3);
            }

            .auth-controls {
                justify-content: center;
            }
        }

        /* Stack header rows vertically to fit in the narrow sidebar */
        .event-header-row1,
        .event-header-row2 {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: var(--space-3);
        }

        .title-and-attrs {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: var(--space-1);
            flex-wrap: wrap;
        }

        .event-header-row1 .event-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
            line-height: 1.3;
            flex-shrink: 0;
        }

        #compactEventHeaderContainer .event-attrs {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .event-header-row1 .btn-ghost {
            flex-shrink: 0;
        }

        .event-header-row2 .event-actions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-2);
        }

        .event-header-row2 .rsvp-group {
            display: flex;
            gap: var(--space-2);
        }

        /* MODIFICATION: Make chips smaller in this specific context */
        .sidebar-container .event-header-row2 .chip {
            padding: var(--space-1) var(--space-2);
            font-size: 0.8rem;
        }

        /* MODIFICATION: Make counts smaller and closer together */
        .event-header-row2 .event-counts {
            display: flex;
            gap: var(--space-2);
            /* Was var(--space-3) */
            font-size: 0.75rem;
            /* Was 0.8rem */
            color: var(--color-text-muted);
            flex-shrink: 0;
        }


        #compactEventHeaderContainer .event-description {
            color: var(--color-text-muted);
            line-height: 1.5;
            margin: var(--space-3) 0 0 0;
            font-size: 0.9rem;
        }


        /* --- REDESIGNED REDDIT-STYLE DISCUSSION UI --- */
        /* The #eventDetail card is now a transparent container for the two-column layout */
        #eventDetail.card {
            padding: 0;
            border: none;
            background: none;
            box-shadow: none;
        }

        .tab-panel {
            flex-grow: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        /* This is now the main layout for the entire Event Detail view */
        #discussion-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: var(--space-4);
            flex-grow: 1;
            min-height: 0;
        }

        /* The left sidebar container */
        .sidebar-container {
            background-color: var(--color-surface);
            border-radius: var(--radius-3);
            padding: var(--space-3);
            border: 1px solid var(--color-border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            min-height: 0;
        }

        /* Add a separator below the header inside the sidebar */
        .sidebar-container #compactEventHeaderContainer {
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--space-3);
            flex-shrink: 0;
            /* Prevent header from collapsing */
        }

        #threadsList {
            background: var(--color-surface);
            border: 1px solid var(--color-surface-strong);
            border-radius: var(--radius-2);
            padding: var(--space-2);
            margin-top: var(--space-3);
        }

        .thread-list-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-2);
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--color-surface-strong);
        }

        .thread-list-item:last-child {
            border-bottom: none;
        }

        .thread-list-item:hover {
            background-color: var(--color-surface-hover);
        }

        .thread-list-item.active {
            background-color: var(--color-primary-muted);
        }

        .thread-list-item .title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thread-list-item .meta {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .avatar-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--color-surface-strong);
            display: grid;
            place-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        /* The right-side main content area */
        #discussion-main {
            display: flex;
            flex-direction: column;
            min-height: 0;
            background-color: var(--color-surface);
            border-radius: var(--radius-3);
            padding: var(--space-3);
            border: 1px solid var(--color-border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
        }

        #thread-welcome {
            flex-grow: 1;
            display: grid;
            place-content: center;
            color: var(--color-text-muted);
            text-align: center;
            padding: var(--space-4);
        }

        #threadDetailView {
            flex-grow: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            padding: 0;
            /* Parent #discussion-main has padding now */
        }

        /* Compact Comment styles start */
        #commentsList {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--space-2);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            /* spacing between root comments */
        }

        .comment-node {
            display: flex;
            gap: var(--space-2);
            /* Tighter gap */
        }

        .comment-threadline {
            width: 2px;
            flex-shrink: 0;
            background-color: var(--color-border);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .comment-threadline:hover {
            background-color: var(--color-primary);
        }

        .comment-main {
            flex-grow: 1;
            min-width: 0;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.8rem;
        }

        .avatar-circle.comment-avatar {
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
        }

        .comment-author strong {
            font-weight: 500;
        }

        .comment-author .timestamp {
            color: var(--color-text-muted);
        }

        .comment-text {
            margin: var(--space-1) 0 0 0;
            /* No bottom margin */
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .comment-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-top: 0;
            /* No top margin */
        }

        .comment-actions .btn-ghost {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-muted);
            padding: var(--space-1) 0;
        }

        .comment-replies {
            margin-top: var(--space-2);
            /* Tighter */
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            /* Tighter */
        }

        .inline-reply-form {
            margin-top: var(--space-2);
        }

        #replyToThreadForm {
            padding-top: var(--space-3);
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        #replyToThreadForm textarea {
            flex-grow: 1;
            resize: none;
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="container header-grid">
            <div class="brand">
                <a href="index.html" style="display: contents; text-decoration: none;">
                    <div class="logo-circle">A</div>
                    <div class="brand-text">
                        <div class="title">Almuerzo Agrivoltaico</div>
                        <div class="subtitle" data-i18n="tagline">
                            An informal seminar series to share advances in agrivoltaics in Latin America
                        </div>
                    </div>
                </a>
            </div>
            <nav class="nav">
                <a href="index.html" class="link" data-i18n="nav.schedule">Schedule</a>
                <a href="about.html" class="link" data-i18n="nav.about">About</a>
                <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
                <div class="divider"></div>
                <div id="langSwitch" class="lang-switch-slider" data-lang="en">
                    <span>EN</span>
                    <span>ES</span>
                </div>
                <div class="auth-area">
                    <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile">
                        <span id="userInitial"></span>
                    </button>
                    <span id="userName"></span>
                    <button id="btnSignIn" class="btn-primary" data-i18n="auth.signin">Sign in</button>
                    <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
                        Sign out
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <div id="flash" class="flash" role="status" aria-live="polite"></div>

    <main class="container">
        <!-- Hero -->
        <section id="hero" class="card hero">
            <div class="hero-main">
                <h1>Almuerzo Agrivoltaico</h1>
                <p data-i18n="intro">
                    Agrivoltaics (agrivoltaics) is an emerging field that integrates solar energy with
                    crop/livestock production. This bilingual seminar focuses on Latin America. Hosted by
                    UNAM and University of Arizona.
                </p>
            </div>
            <div class="meta">
                <span class="meta-item" data-i18n="format">Online • Monthly • 1 hour (30 min talk + 30 min
                    discussion)</span>
                <span class="meta-item" data-i18n="hosted">Hosted by UNAM & University of Arizona</span>
            </div>
        </section>

        <!-- Profile (shown as a separate view) -->
        <section id="profile" class="card" aria-labelledby="profileTitle" style="display: none">
            <button class="btn-ghost" id="backFromProfile">
                ← <span data-i18n="back.schedule">Back to schedule</span>
            </button>
            <h2 id="profileTitle" data-i18n="profile.title">Your profile</h2>
            <form id="profileForm" class="grid-form">
                <div>
                    <label for="fullName" data-i18n="profile.full_name">Full name</label>
                    <input id="fullName" />
                </div>
                <div>
                    <label for="username" data-i18n="profile.username">Username</label>
                    <input id="username" />
                </div>
                <div class="col-span-2">
                    <label for="affiliation" data-i18n="profile.affiliation">Affiliation</label>
                    <input id="affiliation" />
                </div>
                <div class="col-span-2">
                    <button class="btn-secondary" type="submit" data-i18n="profile.save">
                        Save profile
                    </button>
                </div>
            </form>
        </section>

        <!-- Schedule -->
        <section id="schedule" class="card" aria-labelledby="scheduleTitle">
            <div class="section-header">
                <div class="section-title-group">
                    <h2 id="scheduleTitle" data-i18n="schedule.title">Upcoming Talks</h2>
                    <div class="view-switch">
                        <button id="viewList" class="chip chip-toggle active" data-i18n="schedule.list">List</button>
                        <button id="viewCalendar" class="chip chip-toggle"
                            data-i18n="schedule.calendar">Calendar</button>
                    </div>
                </div>
                <div class="calendar-header">
                    <button id="calPrev" class="btn-ghost" aria-label="Previous month">◀</button>
                    <div id="calLabel" class="cal-label">Month</div>
                    <button id="calNext" class="btn-ghost" aria-label="Next month">▶</button>
                </div>
                <div class="search-bar">
                    <input id="search" type="search" placeholder="Search..."
                        data-i18n-placeholder="search.placeholder" />
                </div>
            </div>

            <div id="eventsList" class="events-grid"></div>

            <div id="calendar" class="calendar">
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-legend">
                    <span class="legend scheduled" data-i18n="legend.scheduled">Scheduled</span>
                    <span class="legend completed" data-i18n="legend.completed">Completed</span>
                    <span class="legend canceled" data-i18n="legend.canceled">Canceled</span>
                </div>
            </div>

            <div id="emptyEvents" class="empty" style="display: none" data-i18n="schedule.empty">
                No events yet. Check back soon.
            </div>
        </section>

        <!-- Auth (shown when signed out, now compact and after schedule) -->
        <section id="auth" class="card" aria-labelledby="authTitle">
            <div class="auth-centered">
                <h2 id="authTitle" data-i18n="auth.title">Sign in to participate</h2>
                <div class="auth-controls">
                    <button id="btnGoogle" class="btn-social btn-google">
                        <svg viewBox="0 0 24 24" aria-hidden="true" width="24" height="24">
                            <path
                                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                fill="#4285F4"></path>
                            <path
                                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                                fill="#34A853"></path>
                            <path
                                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                                fill="#FBBC05"></path>
                            <path
                                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                                fill="#EA4335"></path>
                            <path d="M1 1h22v22H1z" fill="none"></path>
                        </svg>
                        <span>Sign in with Google</span>
                    </button>
                    <form id="emailForm" class="auth-form-secondary">
                        <label for="email" class="sr-only" data-i18n="auth.email">Email</label>
                        <input id="email" type="email" placeholder="you@example.com" required
                            data-i18n-placeholder="auth.email" />
                        <button class="btn-secondary" type="submit" data-i18n="auth.magic">Send magic link</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Event Detail -->
        <section id="eventDetail" class="card" style="display: none">
            <!-- RESTRUCTURED: The grid layout is now the top-level element -->
            <div id="discussion-layout">

                <!-- LEFT SIDEBAR -->
                <div class="sidebar-container">
                    <!-- Header content moved here -->
                    <div id="compactEventHeaderContainer"></div>

                    <!-- Original sidebar content -->
                    <form id="newThreadForm" class="inline-form">
                        <input id="threadTitle" type="text" placeholder="Start a new topic..." required
                            data-i18n-placeholder="thread.placeholder" />
                        <button class="btn-primary" type="submit" data-i18n="thread.create">Create</button>
                    </form>
                    <div id="threadsList"></div>
                </div>

                <!-- RIGHT MAIN AREA -->
                <div id="discussion-main">
                    <!-- Tabs moved here -->
                    <div class="tabs">
                        <button class="tab active" data-tab="discussion" data-i18n="tabs.discussion">
                            Discussion
                        </button>
                        <button class="tab" data-tab="files" data-i18n="tabs.files">Files</button>
                    </div>

                    <!-- Discussion Panel Content -->
                    <div id="tab_discussion" class="tab-panel">
                        <div id="thread-welcome">
                            <div>
                                <h3 data-i18n="discussion.welcome_title">Welcome to the discussion!</h3>
                                <p data-i18n="discussion.welcome_body">Select a topic from the left to view the
                                    conversation, or start a new one.</p>
                            </div>
                        </div>
                        <div id="threadDetailView" style="display: none;">
                            <div id="commentsList"></div>
                            <form id="replyToThreadForm">
                                <textarea placeholder="Write a comment..." required
                                    data-i18n-placeholder="comment.placeholder"></textarea>
                                <button class="btn-primary" type="submit" data-i18n="comment.send">Send</button>
                            </form>
                        </div>
                    </div>

                    <!-- Files Panel Content -->
                    <div id="tab_files" class="tab-panel" style="display: none">
                        <form id="uploadForm" class="inline-form">
                            <input id="fileInput" type="file" />
                            <button class="btn-primary" type="submit" data-i18n="files.upload">Upload</button>
                        </form>
                        <div id="filesList" class="files"></div>
                        <div id="emptyFiles" class="empty" style="display: none" data-i18n="files.empty">
                            No files yet.
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <small>
                © <span id="year"></span> Almuerzo Agrivoltaico •
                <span data-i18n="footer.note">Bilingual, community-driven seminar on agrivoltaics in Latin
                    America.</span>
            </small>
        </div>
    </footer>

    <!-- JS Logic embedded in HTML -->
    <script type="module">
        import {
            createClient
        } from "https://esm.sh/@supabase/supabase-js@2";

        /* ================== CONFIG ================== */
        const SUPABASE_URL = "https://iuzgfldgvueuehybgntm.supabase.co";
        const SUPABASE_ANON_KEY =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1emdmbGRndnVldWVoeWJnbnRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4Mjc0MjUsImV4cCI6MjA3MjQwMzQyNX0.do919Hvw2AK-Ql-2V5guoRRH2yx4Rmset4eeVXi__o8";

        const REDIRECT_TO = window.location.origin + window.location.pathname;
        /* ============================================ */

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true,
            },
        });

        let eventRealtimeChannel = null;

        const state = {
            session: null,
            profile: null,
            language: localStorage.getItem("lang") || "en",
            events: [],
            selectedEvent: null,
            threads: [],
            selectedThreadId: null, // Track the active thread view
            comments: [],
            profileCache: new Map(),
            files: [],
            rsvpStatus: null,
            isFollowing: false,
            counts: { followers: 0, going: 0, interested: 0 },
            calendarMonth: new Date(),
        };

        // Basic i18n
        const t = {
            en: {
                tagline: "An informal seminar series to share advances in agrivoltaics in Latin America",
                intro: "Agrivoltaics (agrivoltaics) is an emerging field that integrates solar energy with crop/livestock production. This bilingual seminar focuses on Latin America. Hosted by UNAM and University of Arizona.",
                format: "Online • Monthly • 1 hour (30 min talk + 30 min discussion)",
                hosted: "Hosted by UNAM & University of Arizona",
                nav: { schedule: "Schedule", about: "About", admin: "Admin" },
                auth: {
                    title: "Sign in to participate", signin: "Sign in", signout: "Sign out",
                    email: "Email", magic: "Send magic link", magic_hint: "We'll email you a sign-in link. Check your inbox.", or: "or",
                    required: "Please sign in to view event details.",
                },
                profile: { title: "Your profile", full_name: "Full name", username: "Username", affiliation: "Affiliation", save: "Save profile", saved: "Profile updated" },
                schedule: { title: "Upcoming Talks", empty: "No events yet. Check back soon.", list: "List", calendar: "Calendar" },
                search: { placeholder: "Search..." },
                back: { schedule: "Back to schedule" },
                tabs: { discussion: "Discussion", files: "Files" },
                discussion: { welcome_title: "Welcome to the discussion!", welcome_body: "Select a topic from the left to view the conversation, or start a new one." },
                thread: { placeholder: "Start a new topic...", create: "Create", empty: "No topics yet. Start the discussion!" },
                comment: { placeholder: "Write a comment...", send: "Send" },
                files: { upload: "Upload", empty: "No files yet." },
                footer: { note: "Bilingual, community-driven seminar on agrivoltaics in Latin America." },
                rsvp: { going: "Going", interested: "Interested", notgoing: "Not going", saved: "RSVP updated" },
                follow: "Follow",
                reply: "Reply",
                legend: { scheduled: "Scheduled", completed: "Completed", canceled: "Canceled" },
                save: "Save", cancel: "Cancel",
                errors: { upload: "Upload failed" },
                labels: { followers: "followers", going: "going", interested: "interested" },
                open: "Open", join_zoom: "Join Zoom", copy_link: "Copy Zoom link", copied: "Copied!",
            },
            es: {
                tagline: "Serie de seminarios informales para compartir avances en agrofotovoltaica en América Latina",
                intro: "La agrofotovoltaica integra energía solar con producción agrícola/ganadera. Este seminario bilingüe se enfoca en América Latina. Organizado por UNAM y University of Arizona.",
                format: "En línea • Mensual • 1 hora (30 min charla + 30 min discusión)",
                hosted: "Organizado por UNAM y University of Arizona",
                nav: { schedule: "Calendario", about: "Acerca de", admin: "Admin" },
                auth: {
                    title: "Inicia sesión para participar", signin: "Iniciar sesión", signout: "Cerrar sesión",
                    email: "Correo", magic: "Enviar enlace mágico", magic_hint: "Te enviaremos un enlace de acceso. Revisa tu bandeja.", or: "o",
                    required: "Por favor, inicia sesión para ver los detalles del evento.",
                },
                profile: { title: "Tu perfil", full_name: "Nombre completo", username: "Usuario", affiliation: "Afiliación", save: "Guardar perfil", saved: "Perfil actualizado" },
                schedule: { title: "Próximas charlas", empty: "Aún no hay eventos. Vuelve pronto.", list: "Lista", calendar: "Calendario" },
                search: { placeholder: "Buscar..." },
                back: { schedule: "Volver al calendario" },
                tabs: { discussion: "Discusión", files: "Archivos" },
                discussion: { welcome_title: "¡Bienvenido/a a la discusión!", welcome_body: "Selecciona un tema de la izquierda o crea uno nuevo." },
                thread: { placeholder: "Iniciar un nuevo tema...", create: "Crear", empty: "Aún no hay temas. ¡Comienza la discusión!" },
                comment: { placeholder: "Escribe un comentario...", send: "Enviar" },
                files: { upload: "Subir", empty: "No hay archivos." },
                footer: { note: "Seminario bilingüe y comunitario sobre agrofotovoltaica en América Latina." },
                rsvp: { going: "Asistiré", interested: "Interesado/a", notgoing: "No asistiré", saved: "Asistencia actualizada" },
                follow: "Seguir",
                reply: "Responder",
                legend: { scheduled: "Programado", completed: "Completado", canceled: "Cancelado" },
                save: "Guardar", cancel: "Cancelar",
                errors: { upload: "Fallo al subir" },
                labels: { followers: "seguidores", going: "asisten", interested: "interesados" },
                open: "Abrir", join_zoom: "Unirse a Zoom", copy_link: "Copiar enlace de Zoom", copied: "¡Copiado!",
            },
        };

        function tr(key, fallback = "") {
            const lang = state.language;
            const parts = key.split(".");
            let obj = t[lang];
            for (const p of parts) obj = obj?.[p];
            return obj ?? fallback;
        }

        /* ============== UI helpers ============== */
        const $ = (sel) => document.querySelector(sel);

        function setFlash(msg, timeout = 3000) {
            const el = $("#flash");
            if (!el) return;
            el.textContent = msg;
            el.style.display = "block";
            clearTimeout(setFlash._t);
            if (timeout > 0) {
                setFlash._t = setTimeout(() => (el.style.display = "none"), timeout);
            }
        }

        function fmtDateTime(iso) {
            try { return new Intl.DateTimeFormat(undefined, { dateStyle: "medium", timeStyle: "short" }).format(new Date(iso)); } catch (_) { return iso; }
        }

        function bytesToSize(bytes = 0) {
            if (bytes === 0) return "0 B";
            const k = 1024, sizes = ["B", "KB", "MB", "GB", "TB"], i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
        }

        function escapeHtml(s = "") {
            return String(s).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
        }

        function applyI18n() {
            document.querySelectorAll("[data-i18n]").forEach((el) => { el.textContent = tr(el.dataset.i18n, el.textContent); });
            document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => { el.placeholder = tr(el.dataset.i18nPlaceholder, el.placeholder); });
            const langSwitch = $("#langSwitch");
            if (langSwitch) langSwitch.dataset.lang = state.language;
        }

        /* ============= Views ============= */
        function showView(which) {
            $("#schedule").style.display = "none";
            $("#eventDetail").style.display = "none";
            $("#hero").style.display = "none";
            $("#auth").style.display = "none";
            $("#profile").style.display = "none";

            if (which === "schedule") {
                $("#hero").style.display = "flex";
                $("#schedule").style.display = "flex";
                if (!state.session) $("#auth").style.display = "block";
            } else if (which === "event") {
                $("#eventDetail").style.display = "flex";
            } else if (which === "profile") {
                $("#profile").style.display = "block";
            }
        }

        /* ============= Auth ============= */
        async function initAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                state.session = session;
                if (session) await ensureProfile();
            } catch (err) {
                console.error("Session check error:", err);
            } finally { renderAuthUI(); renderHeader(); }

            supabase.auth.onAuthStateChange(async (event, session) => {
                state.session = session;
                if (session) {
                    await ensureProfile();
                    if (event === "SIGNED_IN") setFlash(tr("auth.magic_hint"));
                } else {
                    state.profile = null;
                }
                renderAuthUI(); renderHeader(); await loadEvents();
            });
        }

        function renderAuthUI() {
            const showAuthCard = !state.session && $("#schedule").style.display !== 'none';
            $("#auth").style.display = showAuthCard ? "block" : "none";
            if (state.session) {
                $("#fullName").value = state.profile?.full_name || "";
                $("#username").value = state.profile?.username || "";
                $("#affiliation").value = state.profile?.affiliation || "";
            }
        }

        async function fetchProfile(uid) {
            if (!uid) return null;
            if (state.profileCache.has(uid)) return state.profileCache.get(uid);
            const { data } = await supabase.from("profiles").select("*").eq("id", uid).single();
            if (data) state.profileCache.set(uid, data);
            return data;
        }

        async function ensureProfile() {
            const uid = state.session?.user?.id;
            if (!uid || state.profile) return;
            state.profile = await fetchProfile(uid);
        }

        function renderHeader() {
            const btnSignIn = $("#btnSignIn"), btnSignOut = $("#btnSignOut"), btnAdmin = $("#btnAdmin"), userName = $("#userName"), btnProfile = $("#btnProfile");
            if (state.session) {
                btnSignIn.style.display = "none"; btnSignOut.style.display = "inline-block";
                btnProfile.style.display = "grid"; userName.style.display = "inline";
                userName.textContent = state.profile?.full_name || state.profile?.username || "";
                $("#userInitial").textContent = (state.profile?.full_name || "U").charAt(0).toUpperCase();
                if (btnAdmin) btnAdmin.style.display = state.profile?.role === "admin" ? "inline-block" : "none";
            } else {
                btnSignIn.style.display = "inline-block"; btnSignOut.style.display = "none";
                btnProfile.style.display = "none"; userName.style.display = "none";
                if (btnAdmin) btnAdmin.style.display = "none";
            }
        }

        /* ============= Data: Events & Schedule ============= */
        async function loadEvents() {
            const { data } = await supabase.from("events").select("*").order("start_time", { ascending: true });
            state.events = data || [];
            renderEventsList();
            renderScheduleCalendar();
        }

        function renderEventsList() {
            const list = $("#eventsList"), empty = $("#emptyEvents");
            if (!list || !empty) return;
            const term = ($("#search")?.value || "").toLowerCase().trim();
            const filtered = state.events.filter((e) => !term || [e.title_en, e.title_es, e.description_en, e.description_es, e.host_org].filter(Boolean).some((v) => v.toLowerCase().includes(term)));

            empty.style.display = filtered.length ? "none" : "block";
            list.innerHTML = filtered.map(ev => {
                const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
                const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;
                return `
                <div class="event-card">
                    <div class="when">${fmtDateTime(ev.start_time)}</div>
                    <div class="event-title">${escapeHtml(title)}</div>
                    <div class="actions">
<button class="btn-secondary" data-open="${String(ev.id)}">${tr("open", "Open")}</button>
                    </div>
                    ${desc ? `<div class="event-desc">${escapeHtml(desc).substring(0, 140)}…</div>` : ""}
                    <div class="tags">
                        <span class="tag">${(ev.language || "bi").toUpperCase()}</span>
                        <span class="tag status-${ev.status || "scheduled"}">${ev.status || "scheduled"}</span>
                        ${ev.host_org ? `<span class="tag">${escapeHtml(ev.host_org)}</span>` : ""}
                    </div>
                    ${state.session && ev.zoom_url ? `
                    <div class="zoom-info">
                        <a href="${ev.zoom_url}" target="_blank" rel="noopener" class="btn-primary">🔗 ${tr('join_zoom')}</a>
                        <button class="btn-ghost" data-copy-link="${ev.zoom_url}" aria-label="${tr('copy_link')}">📋</button>
                    </div>
                    ` : ''}
                </div>`;
            }).join('');
        }

        async function openEvent(eventId) {
            if (!state.session) {
                setFlash(tr('auth.required'));
                $("#auth").scrollIntoView({ behavior: 'smooth' });
                return;
            }

            const ev = state.events.find((e) => String(e.id) === String(eventId));
            if (!ev) return;

            state.selectedEvent = ev;
            state.selectedThreadId = null;
            showDiscussionView('welcome');
            subscribeToEventChanges(ev.id);
            await Promise.all([loadThreads(ev.id), loadFiles(ev.id), loadRSVPFollow(ev.id)]);
            renderEventHeader();
            showView("event");
        }

        function renderEventHeader() {
            const ev = state.selectedEvent; if (!ev) return;
            const container = $("#compactEventHeaderContainer");
            if (!container) return;

            const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
            const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;

            container.innerHTML = `
                <div class="event-header-row1">
                     <div class="title-and-attrs">
                        <h2 class="event-title">${escapeHtml(title)}</h2>
                        <div class="event-attrs">
                            <span>${fmtDateTime(ev.start_time)}</span>
                            ${ev.host_org ? `<span>• ${escapeHtml(ev.host_org)}</span>` : ""}
                            <span>• ${(ev.language || "bi").toUpperCase()}</span>
                        </div>
                    </div>
                    <button class="btn-ghost" id="backToScheduleCompact">
                        ← <span>${tr('back.schedule')}</span>
                    </button>
                </div>

                <div class="event-header-row2">
                    <div class="event-actions">
                        <div class="rsvp-group" style="display: ${state.session ? 'flex' : 'none'}">
                            <button class="chip ${state.rsvpStatus === 'going' ? 'active' : ''}" data-rsvp="going">
                                <span>${tr('rsvp.going')}</span>
                            </button>
                            <button class="chip ${state.rsvpStatus === 'interested' ? 'active' : ''}" data-rsvp="interested">
                                <span>${tr('rsvp.interested')}</span>
                            </button>
                            <button class="chip ${state.rsvpStatus === 'not_going' ? 'active' : ''}" data-rsvp="not_going">
                                <span>${tr('rsvp.notgoing')}</span>
                            </button>
                        </div>
                        <button id="btnFollowCompact" class="chip ${state.isFollowing ? 'active' : ''}" style="display: ${state.session ? 'inline-flex' : 'none'}">
                            <span>${tr('follow')}</span>
                        </button>
                    </div>
                     <div class="event-counts">
                        <span class="count">${state.counts.followers} ${tr("labels.followers")}</span>
                        <span class="count">${state.counts.going} ${tr("labels.going")}</span>
                        <span class="count">${state.counts.interested} ${tr("labels.interested")}</span>
                    </div>
                </div>
                ${desc ? `<p class="event-description">${escapeHtml(desc).replace(/\n/g, "<br/>")}</p>` : ""}
            `;
        }

        function renderScheduleCalendar() {
            const grid = $("#calendarGrid"), label = $("#calLabel"); if (!grid || !label) return;
            const m = state.calendarMonth; label.textContent = m.toLocaleString(state.language, { month: "long", year: "numeric" });
            const start = new Date(m.getFullYear(), m.getMonth(), 1), end = new Date(m.getFullYear(), m.getMonth() + 1, 0);
            const firstDayIndex = (start.getDay() + 6) % 7, daysInMonth = end.getDate(); grid.innerHTML = ``;
            for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement("div"));
            const byDay = state.events.reduce((acc, ev) => {
                const d = new Date(ev.start_time); if (d.getMonth() !== m.getMonth() || d.getFullYear() !== m.getFullYear()) return acc;
                const day = d.getDate(); if (!acc.has(day)) acc.set(day, []); acc.get(day).push(ev); return acc;
            }, new Map());
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement("div"); cell.className = "cal-cell"; cell.innerHTML = `<div class="cal-day">${day}</div>`;
                (byDay.get(day) || []).forEach((ev) => {
                    const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
                    const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;

                    const badgeWrapper = document.createElement('div');
                    badgeWrapper.className = 'cal-badge-wrapper';

                    const badge = document.createElement("button");
                    badge.className = `cal-badge status-${ev.status}`;
                    badge.textContent = (ev.language || "bi").toUpperCase();
                    badge.addEventListener("click", () => openEvent(ev.id));

                    const tooltip = document.createElement('div');
                    tooltip.className = 'cal-tooltip';
                    tooltip.innerHTML = `
                        <div class="cal-tooltip-title">${escapeHtml(title)}</div>
                        ${desc ? `<p class="cal-tooltip-desc">${escapeHtml(desc).substring(0, 120)}…</p>` : ''}
                    `;

                    badgeWrapper.appendChild(badge);
                    badgeWrapper.appendChild(tooltip);
                    cell.appendChild(badgeWrapper);
                });
                grid.appendChild(cell);
            }
        }

        /* ====== MODERN FORUM LOGIC (from v1) ====== */
        function showDiscussionView(view) {
            if (view === 'detail') {
                $("#thread-welcome").style.display = 'none';
                $("#threadDetailView").style.display = 'flex';
            } else { // 'welcome'
                $("#thread-welcome").style.display = 'grid';
                $("#threadDetailView").style.display = 'none';
            }
        }

        async function openThread(threadId) {
            state.selectedThreadId = threadId;
            showDiscussionView('detail');
            renderThreads();
            await loadComments(threadId);
        }

        async function loadThreads(eventId) {
            const { data } = await supabase.from("threads").select("*, comments(count), profiles(id, full_name)").eq("event_id", eventId).order("created_at", { ascending: false });
            state.threads = data || [];
            for (const th of state.threads) {
                if (th.profiles) {
                    state.profileCache.set(th.created_by, th.profiles);
                } else {
                    await fetchProfile(th.created_by);
                }
            }
            renderThreads();
        }

        function renderThreads() {
            const list = $("#threadsList");
            if (!list) return;
            list.innerHTML = "";

            for (const th of state.threads) {
                const author = state.profileCache.get(th.created_by);
                const authorName = author?.full_name || '...';
                const initial = authorName.charAt(0).toUpperCase();

                const item = document.createElement("div");
                item.className = "thread-list-item";
                if (th.id === state.selectedThreadId) item.classList.add('active');

                item.innerHTML = `
                    <div class="avatar-circle">${initial}</div>
                    <div>
                        <div class="title">${th.pinned ? "📌 " : ""}${escapeHtml(th.title)}</div>
                        <div class="meta">${th.comments[0].count} replies • by ${escapeHtml(authorName)}</div>
                    </div>
                `;
                item.addEventListener('click', () => openThread(th.id));
                list.appendChild(item);
            }
        }

        async function loadComments(threadId) {
            if (!threadId) return; // Prevent loading with null ID
            const { data } = await supabase.from("comments").select("*").eq("thread_id", threadId).order("created_at", { ascending: true });
            state.comments = data || [];
            for (const c of state.comments) {
                await fetchProfile(c.created_by);
            }
            renderComments();
        }

        function renderComments() {
            const container = $(`#commentsList`);
            if (!container) return;
            container.innerHTML = "";

            const commentsByParentId = new Map();
            for (const comment of state.comments) {
                const parentId = comment.parent_id || 'root';
                if (!commentsByParentId.has(parentId)) {
                    commentsByParentId.set(parentId, []);
                }
                commentsByParentId.get(parentId).push(comment);
            }

            const rootComments = commentsByParentId.get('root') || [];
            for (const comment of rootComments) {
                container.appendChild(createCommentNode(comment, commentsByParentId));
            }

            container.scrollTop = container.scrollHeight;
        }

        function createCommentNode(comment, commentsByParentId) {
            const profile = state.profileCache.get(comment.created_by);
            const authorName = profile?.full_name || '...';
            const initial = authorName.charAt(0).toUpperCase();

            const node = document.createElement('div');
            node.className = 'comment-node';

            node.innerHTML = `
                <div class="comment-threadline"></div>
                <div class="comment-main">
                    <div class="comment-author">
                        <div class="avatar-circle comment-avatar">${initial}</div>
                        <strong>${escapeHtml(authorName)}</strong>
                        <span class="timestamp">• ${fmtDateTime(comment.created_at)}</span>
                    </div>
                    <div class="comment-text">${comment.is_deleted ? "<em>(deleted)</em>" : escapeHtml(comment.content)}</div>
                    <div class="comment-actions">
                        <button class="btn-ghost" data-reply-id="${comment.id}">💬 ${tr('reply', 'Reply')}</button>
                    </div>
                    <div class="comment-replies"></div>
                </div>
            `;

            const repliesContainer = node.querySelector('.comment-replies');
            const children = commentsByParentId.get(comment.id) || [];
            if (children.length === 0) {
                node.querySelector('.comment-threadline').style.height = '20px'; // Shorten line if no replies
            }
            for (const child of children) {
                repliesContainer.appendChild(createCommentNode(child, commentsByParentId));
            }

            node.querySelector(`[data-reply-id]`).addEventListener('click', (e) => {
                const parentId = e.target.dataset.replyId;
                const existingForm = node.querySelector('.inline-reply-form');
                if (existingForm) {
                    existingForm.remove();
                    return;
                }

                const formContainer = document.createElement('div');
                formContainer.className = 'inline-reply-form';
                formContainer.innerHTML = `
                    <form class="inline-form">
                        <input type="text" placeholder="Replying to ${authorName}..." required />
                        <button type="submit" class="btn-primary">Reply</button>
                    </form>
                `;

                formContainer.querySelector('form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const input = ev.target.querySelector('input');
                    const content = input.value.trim();
                    if (content) {
                        await createComment(state.selectedThreadId, parentId, content);
                        await loadComments(state.selectedThreadId);
                    }
                });
                node.querySelector('.comment-actions').insertAdjacentElement('afterend', formContainer);
                formContainer.querySelector('input').focus();
            });

            return node;
        }

        async function createThread(title) {
            if (!title || !state.selectedEvent) return;
            const { data } = await supabase.from("threads").insert({ event_id: state.selectedEvent.id, title, created_by: state.session.user.id }).select().single();
            await loadThreads(state.selectedEvent.id);
            if (data) openThread(data.id);
        }
        async function createComment(thread_id, parent_id, content) {
            await supabase.from("comments").insert({ event_id: state.selectedEvent.id, thread_id, parent_id, content, created_by: state.session.user.id });
        }

        /* ====== End forum logic ====== */

        async function loadFiles(eventId) { const { data } = await supabase.from("attachments").select("*").eq("event_id", eventId).order("created_at", { ascending: false }); state.files = data || []; renderFiles(); }
        async function uploadFile(file) { if (!file || !state.selectedEvent) return; const eventId = state.selectedEvent.id; const object_path = `events/${eventId}/${Date.now()}-${file.name}`; await supabase.storage.from("attachments").upload(object_path, file); await supabase.from("attachments").insert({ event_id: eventId, bucket_id: "attachments", object_path, file_name: file.name, file_type: file.type, file_size: file.size, created_by: state.session.user.id }); }
        async function getSignedUrl(path) { const { data } = await supabase.storage.from("attachments").createSignedUrl(path, 3600); return data?.signedUrl; }
        async function renderFiles() {
            const grid = $("#filesList"), empty = $("#emptyFiles"); if (!grid || !empty) return; grid.innerHTML = ""; empty.style.display = state.files.length ? "none" : "block";
            for (const f of state.files) { const div = document.createElement("div"); div.className = "file"; const url = await getSignedUrl(f.object_path); div.innerHTML = `<div class="meta"><div class="name">${escapeHtml(f.file_name)}</div><div class="size">${bytesToSize(f.file_size)}</div></div><div class="actions"><a class="btn-secondary" href="${url}" target="_blank" rel="noopener">Open</a>${state.profile?.role === 'admin' ? `<button class="btn-danger" data-del-file-id="${f.id}" data-del-file-path="${f.object_path}">Delete</button>` : ""}</div>`; grid.appendChild(div); }
        }
        async function deleteFile(id, path) { if (!confirm('Delete file permanently?')) return; await supabase.storage.from("attachments").remove([path]); await supabase.from("attachments").delete().eq("id", id); }
        async function loadRSVPFollow(eventId) {
            state.rsvpStatus = null; state.isFollowing = false; state.counts = { followers: 0, going: 0, interested: 0 };
            const { data: countsData } = await supabase.rpc('get_event_counts', { event_id_param: eventId });
            if (countsData) { state.counts.followers = countsData.followers_count; state.counts.going = countsData.going_count; state.counts.interested = countsData.interested_count; }
            if (state.session) { const uid = state.session.user.id; const [{ data: myFollow }, { data: myRsvp }] = await Promise.all([supabase.from("event_follows").select("id").eq("event_id", eventId).eq("profile_id", uid).maybeSingle(), supabase.from("event_rsvps").select("status").eq("event_id", eventId).eq("profile_id", uid).maybeSingle()]); state.isFollowing = !!myFollow; state.rsvpStatus = myRsvp?.status || null; }
            renderEventHeader();
        }
        async function toggleFollow() { if (!state.session || !state.selectedEvent) return; const uid = state.session.user.id; const eventId = state.selectedEvent.id; if (state.isFollowing) await supabase.from("event_follows").delete().eq("event_id", eventId).eq("profile_id", uid); else await supabase.from("event_follows").insert({ event_id: eventId, profile_id: uid }); }
        async function setRSVP(status) { if (!state.session || !state.selectedEvent) return; const uid = state.session.user.id; const eventId = state.selectedEvent.id; await supabase.from("event_rsvps").upsert({ event_id: eventId, profile_id: uid, status }, { onConflict: "event_id,profile_id" }); }

        /* ============= Realtime Subscriptions ============= */
        function cleanupSubscriptions() {
            if (eventRealtimeChannel) { supabase.removeChannel(eventRealtimeChannel); eventRealtimeChannel = null; }
        }
        function subscribeToEventChanges(eventId) {
            cleanupSubscriptions();
            eventRealtimeChannel = supabase.channel(`event-${eventId}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'attachments', filter: `event_id=eq.${eventId}` }, () => loadFiles(eventId))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'event_follows', filter: `event_id=eq.${eventId}` }, () => loadRSVPFollow(eventId))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'event_rsvps', filter: `event_id=eq.${eventId}` }, () => loadRSVPFollow(eventId))
                .subscribe();
        }

        /* ============= Wire-up ============= */
        function wireUI() {
            // --- Auth ---
            $("#btnSignOut")?.addEventListener("click", () => supabase.auth.signOut());
            $("#emailForm")?.addEventListener("submit", async (e) => { e.preventDefault(); const email = $("#email")?.value.trim(); if (email) { await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: REDIRECT_TO } }); setFlash(tr("auth.magic_hint")); } });
            $("#btnGoogle")?.addEventListener("click", () => supabase.auth.signInWithOAuth({ provider: "google", options: { redirectTo: REDIRECT_TO } }));

            // --- Navigation ---
            $("#btnProfile")?.addEventListener("click", () => showView("profile"));
            $("#backFromProfile")?.addEventListener("click", () => showView("schedule"));

            // --- Main Schedule View (using event delegation) ---
            $("#eventsList").addEventListener("click", e => {
                const openBtn = e.target.closest('[data-open]');
                if (openBtn) {
                    openEvent(openBtn.dataset.open);
                    return;
                }
                const copyBtn = e.target.closest('[data-copy-link]');
                if (copyBtn) {
                    navigator.clipboard.writeText(copyBtn.dataset.copyLink);
                    setFlash(tr('copied'));
                }
            });

            $("#search")?.addEventListener("input", renderEventsList);
            $("#viewList")?.addEventListener("click", () => { $("#schedule").classList.remove("calendar-view"); $("#viewList").classList.add("active"); $("#viewCalendar").classList.remove("active"); $("#eventsList").style.display = "grid"; $("#calendar").style.display = "none"; });
            $("#viewCalendar")?.addEventListener("click", () => { $("#schedule").classList.add("calendar-view"); $("#viewCalendar").classList.add("active"); $("#viewList").classList.remove("active"); $("#eventsList").style.display = "none"; $("#calendar").style.display = "flex"; });
            $("#calPrev")?.addEventListener("click", () => { state.calendarMonth.setMonth(state.calendarMonth.getMonth() - 1); renderScheduleCalendar(); });
            $("#calNext")?.addEventListener("click", () => { state.calendarMonth.setMonth(state.calendarMonth.getMonth() + 1); renderScheduleCalendar(); });

            // --- Profile View ---
            $("#profileForm")?.addEventListener("submit", async (e) => { e.preventDefault(); if (!state.session) return; const p = { full_name: $("#fullName").value.trim(), username: $("#username").value.trim(), affiliation: $("#affiliation").value.trim() }; await supabase.from("profiles").update(p).eq("id", state.session.user.id); state.profile = null; await ensureProfile(); setFlash(tr("profile.saved")); renderHeader(); });

            // --- Event Detail View (using a single delegated listener for robustness) ---
            $("#eventDetail").addEventListener('click', (e) => {
                const backBtn = e.target.closest('#backToScheduleCompact');
                if (backBtn) {
                    cleanupSubscriptions();
                    showView('schedule');
                    return;
                }
                const followBtn = e.target.closest('#btnFollowCompact');
                if (followBtn) {
                    toggleFollow();
                    return;
                }
                const rsvpBtn = e.target.closest('[data-rsvp]');
                if (rsvpBtn) {
                    setRSVP(rsvpBtn.dataset.rsvp);
                    return;
                }
                const delFileBtn = e.target.closest('[data-del-file-id]');
                if (delFileBtn) {
                    deleteFile(delFileBtn.dataset.delFileId, delFileBtn.dataset.delFilePath);
                }
            });

            document.querySelectorAll(".tab").forEach((tab) => tab.addEventListener("click", () => {
                document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active")); tab.classList.add("active");
                document.querySelectorAll(".tab-panel").forEach((p) => (p.style.display = "none"));
                $(`#tab_${tab.dataset.tab}`).style.display = "flex";
            }));

            // --- Forms within Event Detail ---
            $("#newThreadForm")?.addEventListener("submit", async (e) => { e.preventDefault(); const title = $("#threadTitle")?.value.trim(); if (title) { await createThread(title); $("#threadTitle").value = ""; } });
            $("#replyToThreadForm")?.addEventListener("submit", async (e) => {
                e.preventDefault();
                const textarea = e.target.querySelector("textarea");
                const content = textarea.value.trim();
                if (content && state.selectedThreadId) {
                    await createComment(state.selectedThreadId, null, content);
                    textarea.value = "";
                    await loadComments(state.selectedThreadId);
                }
            });
            $("#uploadForm")?.addEventListener("submit", async (e) => { e.preventDefault(); const f = $("#fileInput")?.files[0]; if (f) { await uploadFile(f); $("#fileInput").value = ""; } });

            // --- General ---
            $("#langSwitch")?.addEventListener('click', () => { state.language = state.language === 'en' ? 'es' : 'en'; localStorage.setItem("lang", state.language); applyI18n(); renderEventsList(); if (state.selectedEvent) { renderEventHeader(); renderThreads(); if (state.selectedThreadId) renderComments(); } renderFiles(); renderScheduleCalendar(); });
            $("#year").textContent = new Date().getFullYear();
        }

        /* ============= Bootstrap ============= */
        (async function main() {
            applyI18n();
            wireUI();
            await initAuth();
            await loadEvents();
            showView("schedule");

            // Subscribe to global event changes
            supabase.channel('public:events')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'events' }, () => {
                    loadEvents();
                })
                .subscribe();
        })();
    </script>
</body>

</html>