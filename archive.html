<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archive • Agrovoltaicos sin Fronteras</title>
  <meta name="description" content="Archive of previous agrivoltaics talks (EN/ES)." />
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600&family=Lato:wght@400;700&family=Poppins:wght@700;800&display=swap"
    rel="stylesheet">
  <style>
    /* --- Page-Specific Layout --- */
    main.container {
      padding: var(--space-3);
      box-sizing: border-box;
    }

    #archive.card {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      margin: 0;
      padding: var(--space-3);
      overflow: hidden;
    }

    /* --- Filter Bar --- */
    #archive .section-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2) var(--space-3);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      margin-bottom: 0;
    }

    #archive .section-header h2 {
      margin: 0;
    }

    .tags-filter-group {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      flex-wrap: wrap;
      flex-grow: 1;
      min-width: 200px;
    }

    .filter-tags {
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
    }

    .filters {
      display: flex;
      gap: var(--space-2);
      align-items: center;
      flex-wrap: wrap;
    }

    .filters input[type="search"],
    .filters select {
      background-color: var(--card-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      padding: var(--space-1) var(--space-2);
      height: 40px;
    }

    .filters input[type="search"] {
      min-width: 200px;
    }

    .filters select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    .chip-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      user-select: none;
      padding: var(--space-1) var(--space-2);
      background-color: var(--card-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      height: 40px;
      box-sizing: border-box;
    }
    .chip-toggle input[type="checkbox"] {
      width: 1em;
      height: 1em;
    }

    /* --- Event List --- */
    #archiveList {
      display: none; /* Hide by default to prevent jarring load */
      flex-grow: 1;
      overflow-y: auto;
      padding: var(--space-3) var(--space-1);
    }
    
    #emptyArchive {
      text-align: center;
      padding: var(--space-4);
      color: var(--muted);
    }
    
    #eventDetail.card {
      flex-grow: 1;
      display: none;
      flex-direction: column;
      min-height: 0;
      margin: 0;
    }
    
    /* --- Responsive Adjustments for This Page --- */
    @media (max-width: 960px) {
      /* Mobile Filter Bar */
      #archive .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-3);
      }

      .tags-filter-group {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
        text-align: left;
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        gap: var(--space-2);
      }

      .filters input[type="search"],
      .filters select,
      .filters .chip-toggle {
        width: 100%;
        box-sizing: border-box;
      }

      /* Mobile Grid & Padding */
      #archiveList {
        grid-template-columns: 1fr;
      }

      main.container,
      #archive.card {
        padding: var(--space-2);
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="container header-grid">
      <div class="brand">
        <a href="index.html" style="display: contents; text-decoration: none;">

          <!-- MODIFICATION: Replaced the old logo div with your new image -->
          <img src="static/icon.png" alt="Agrovoltaicos sin Fronteras logo" class="logo-image">

          <div class="brand-text">
            <div class="title">Agrovoltaicos sin Fronteras</div>
            <div class="subtitle" data-i18n="tagline">
              A seminar series to share advances in agrivoltaics in the Americas
            </div>
          </div>
        </a>
      </div>

      <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <!-- Desktop Nav -->
      <nav class="nav">
        <a href="index.html" class="link" data-i18n="nav.schedule">Schedule</a>
        <a href="archive.html" class="link" data-i18n="nav.archive">Archive</a>
        <a href="about.html" class="link" data-i18n="nav.about">About</a>
        <a href="admin.html" id="btnAdmin" class="link" data-i18n="nav.admin" style="display: none;">Admin</a>
        <div class="divider"></div>
        <div id="langSwitchDesktop" class="lang-switch-slider" data-lang="en">
          <span>EN</span>
          <span>ES</span>
        </div>
        <div class="auth-area">
          <!-- PRESERVED: This is the user profile button, which is handled by your JS -->
          <button id="btnProfile" class="profile-button" style="display: none" aria-label="Open profile">
            <span id="userInitial"></span>
            <img id="userAvatar" style="display: none; width: 100%; height: 100%; object-fit: cover;" />
          </button>
          <span id="userName"></span>
          <!-- MODIFIED: Button is now a link to the signin page -->
          <a href="signin.html" id="btnSignIn" class="btn-primary" data-i18n="auth.signin"
            style="text-decoration: none; display: inline-block;">Sign in</a>
          <button id="btnSignOut" class="btn-ghost" data-i18n="auth.signout" style="display: none">
            Sign out
          </button>
        </div>
      </nav>
    </div>
  </header>

  <div id="mobileNavOverlay" class="mobile-nav-overlay">
    <!-- Content will be injected by JS -->
  </div>

  <div id="flash" class="flash" role="status" aria-live="polite"></div>

  <main class="container">
    <section id="archive" class="card">
      <div class="section-header">
        <h2>Archive</h2>
        <div class="tags-filter-group">
          <div style="font-weight:500; opacity: 0.8;" data-i18n="archive.filter_by_tags">Filter by Tags:</div>
          <div id="tagsFilter" class="filter-tags"></div>
        </div>
        <div class="filters">
          <input id="search" type="search" placeholder="Search..." data-i18n-placeholder="search.placeholder" />
          <select id="yearFilter"></select>
          <label class="chip-toggle">
            <input type="checkbox" id="hasRecording" />
            <span data-i18n="archive.recordings_only">Recordings only</span>
          </label>
          <button id="clearFilters" class="btn-ghost" data-i18n="archive.clear">Clear</button>
        </div>
      </div>

      <!-- MODIFICATION: Added loader -->
      <div id="archiveLoader" class="loader-container">
        <div class="spinner"></div>
      </div>

      <div id="archiveList"></div>

      <div id="emptyArchive" class="empty" style="display:none;" data-i18n="archive.empty">
        No past events found.
      </div>
    </section>

    <!-- Event Detail (same as index.html) -->
    <section id="eventDetail" class="card">
      <div id="discussion-layout">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar-container">
          <div id="compactEventHeaderContainer">
            <!-- JS Renders Event Details Here -->
          </div>

          <form id="newThreadForm" class="inline-form">
            <input id="threadTitle" type="text" placeholder="Start a new topic..." required
              data-i18n-placeholder="thread.placeholder" />
            <button class="btn-primary" type="submit" data-i18n="thread.create">Create</button>
          </form>
          <div id="threadsList">
            <!-- JS Renders Threads Here -->
          </div>
        </div>

        <!-- RIGHT MAIN AREA -->
        <div id="discussion-main">
          <div class="tabs">
            <button class="tab active" data-tab="description" data-i18n="tabs.description">Description</button>
            <button class="tab" data-tab="discussion" data-i18n="tabs.discussion">Discussion</button>
            <button class="tab" data-tab="files" data-i18n="tabs.files">Files</button>
          </div>

          <!-- Description Panel -->
          <div id="tab_description" class="tab-panel">
            <div id="descriptionContent" class="prose"></div>
          </div>

          <!-- Discussion Panel -->
          <div id="tab_discussion" class="tab-panel" style="display: none;">
            <div id="thread-welcome">
              <div>
                <h3 data-i18n="discussion.welcome_title">Welcome to the discussion!</h3>
                <p data-i18n="discussion.welcome_body">Select a topic from the left to view the
                  conversation, or start a new one.</p>
              </div>
            </div>
            <div id="threadDetailView" style="display: none;">
              <div id="commentsList"></div>
              <form id="replyToThreadForm">
                <textarea placeholder="Write a comment..." required
                  data-i18n-placeholder="comment.placeholder"></textarea>
                <button class="btn-primary" type="submit" data-i18n="comment.send">Send</button>
              </form>
            </div>
          </div>

          <!-- Files Panel -->
          <div id="tab_files" class="tab-panel" style="display: none">
            <form id="uploadForm" class="inline-form">
              <input id="fileInput" type="file" />
              <button class="btn-primary" type="submit" data-i18n="files.upload">Upload</button>
            </form>
            <div id="filesList" class="files"></div>
            <div id="emptyFiles" class="empty" style="display: none" data-i18n="files.empty">
              No files yet.
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center;">
          © <span id="year"></span> Agrovoltaicos sin Fronteras •
          <span data-i18n="footer.note">Bilingual, community-driven seminar on agrivoltaics in Latin America.</span>
        </div>
        <div style="display: flex; align-items: center;">
          <a href="https://biosphere2.org/research/research-initiatives/agrivoltaics" target="_blank"
            rel="noopener noreferrer" style="margin-left: 8px;">
            <img src="static/b2ua.jpg" alt="Biosphere 2 Agrivoltaics"
              style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
          <a href="https://www.ier.unam.mx/ParcelaAgrovoltaica.html" target="_blank" rel="noopener noreferrer"
            style="margin-left: 8px;">
            <img src="static/unam.png" alt="UNAM"
              style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
        </div>
      </small>
    </div>
  </footer>

  <script type="module">
    import {
      supabase,
      authState,
      initAuth,
      fetchProfile,
      signInWithGoogle,
      signInWithEmail,
      signOut
    } from "./auth.js";
    import { initEventLogic } from "./static/js/event.js";  // ADD THIS LINE

    let eventLogic;

    const state = {
      language: localStorage.getItem("lang") || "en",
      events: [],
      selectedEvent: null,
      threads: [],
      selectedThreadId: null,
      comments: [],
      files: [],
      rsvpStatus: null,
      isFollowing: false,
      counts: { followers: 0, going: 0, interested: 0 },
      filters: { search: "", year: "all", tags: new Set(), onlyRecording: false }
    };

    const t = {
      en: {
        tagline: "A seminar series to share advances in agrivoltaics in the Americas",
        nav: { schedule: "Schedule", archive: "Archive", about: "About", admin: "Admin" },
        auth: { signin: "Sign in", signout: "Sign out", required: "Please sign in to view event details." },
        search: { placeholder: "Search title, speaker, description..." },
        archive: { title: "Archive", recordings_only: "Recordings only", clear: "Clear", empty: "No past events match your filters.", filter_by_tags: "Filter by Tags" },
        back: { archive: "Back to archive" },
        tabs: { description: "Description", discussion: "Discussion", files: "Files" },
        discussion: { welcome_title: "Welcome to the discussion!", welcome_body: "Select a topic from the left to view the conversation, or start a new one." },
        thread: { placeholder: "Start a new topic...", create: "Create", empty: "No topics yet. Start the discussion!" },
        comment: { placeholder: "Write a comment...", send: "Send" },
        files: { upload: "Upload", empty: "No files yet." },
        footer: { note: "Bilingual, community-driven seminar on agrivoltaics in Latin America." },
        rsvp: { going: "Going", interested: "Interested", notgoing: "Not going", saved: "RSVP updated" },
        follow: "Follow",
        reply: "Reply",
        errors: { upload: "Upload failed" },
        labels: { followers: "followers", going: "going", interested: "interested" },
        open: "Open",
        recording: "Recording",
        all_years: "All years",
        join_zoom: "Join Zoom",
        copy_link: "Copy Zoom link",
        copied: "Copied!",
        speakers: "Speaker(s)"
      },
      es: {
        tagline: "Una serie de seminarios para compartir avances en agrovoltaicos en las Américas",
        nav: { schedule: "Calendario", archive: "Archivo", about: "Acerca de", admin: "Admin" },
        auth: { signin: "Iniciar sesión", signout: "Cerrar sesión", required: "Por favor, inicia sesión para ver los detalles del evento." },
        search: { placeholder: "Buscar título, ponente, descripción..." },
        archive: { title: "Archivo", recordings_only: "Solo con grabaciones", clear: "Limpiar", empty: "Ningún evento pasado coincide con sus filtros.", filter_by_tags: "Filtrar por Etiquetas" },
        back: { archive: "Volver al archivo" },
        tabs: { description: "Descripción", discussion: "Discusión", files: "Archivos" },
        discussion: { welcome_title: "¡Bienvenido/a a la discusión!", welcome_body: "Selecciona un tema de la izquierda o crea uno nuevo." },
        thread: { placeholder: "Iniciar un nuevo tema...", create: "Crear", empty: "Aún no hay temas. ¡Comienza la discusión!" },
        comment: { placeholder: "Escribe un comentario...", send: "Enviar" },
        files: { upload: "Subir", empty: "No hay archivos." },
        footer: { note: "Seminario bilingüe y comunitario sobre agrofotovoltaica en América Latina." },
        rsvp: { going: "Asistiré", interested: "Interesado/a", notgoing: "No asistiré", saved: "Asistencia actualizada" },
        follow: "Seguir",
        reply: "Responder",
        errors: { upload: "Fallo al subir" },
        labels: { followers: "seguidores", going: "asisten", interested: "interesados" },
        open: "Abrir",
        recording: "Grabación",
        all_years: "Todos los años",
        join_zoom: "Unirse a Zoom",
        copy_link: "Copiar enlace de Zoom",
        copied: "¡Copiado!",
        speakers: "Ponente(s)"
      }
    };

    // --- UTILITIES & I18N ---
    function tr(key, fallback = "") { const lang = state.language; const parts = key.split("."); let obj = t[lang]; for (const p of parts) obj = obj?.[p]; return obj ?? fallback; }
    const $ = (sel) => document.querySelector(sel);
    function escapeHtml(s = "") { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
    function fmtDateTime(iso) { try { return new Intl.DateTimeFormat(state.language === 'es' ? 'es-MX' : 'en-US', { dateStyle: "medium", timeStyle: "short" }).format(new Date(iso)); } catch { return iso; } }
    function linkify(text = "") {
      if (!text) return '';
      let safeText = escapeHtml(text);
      const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      safeText = safeText.replace(urlPattern, `<a href="$&" target="_blank" rel="noopener noreferrer" class="link">$&</a>`);
      safeText = safeText.replace(/\n/g, "<br/>");
      return safeText;
    }
    function bytesToSize(bytes = 0) {
      if (bytes === 0) return "0 B";
      const k = 1024, sizes = ["B", "KB", "MB", "GB", "TB"], i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }
    function setFlash(msg, timeout = 3000) {
      const el = $("#flash");
      if (!el) return;
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(setFlash._t);
      if (timeout > 0) {
        setFlash._t = setTimeout(() => (el.style.display = "none"), timeout);
      }
    }

    function applyI18n() {
      document.querySelectorAll("[data-i18n]").forEach((el) => { el.textContent = tr(el.dataset.i18n, el.textContent); });
      document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => { el.placeholder = tr(el.dataset.i18nPlaceholder, el.placeholder); });
      document.querySelectorAll(".lang-switch-slider").forEach(el => { if (el) el.dataset.lang = state.language; });
      const yearSel = $("#yearFilter");
      if (yearSel && yearSel.options.length > 0) { yearSel.options[0].textContent = tr('all_years'); }
    }

    // --- HEADER & MENU ---
    function setupMobileMenu() {
      const mobileNavOverlay = $("#mobileNavOverlay");
      const desktopNav = document.querySelector('.header-grid .nav');
      if (!mobileNavOverlay || !desktopNav) return;

      mobileNavOverlay.innerHTML = '';

      const closeBtn = document.createElement('button');
      closeBtn.className = 'mobile-nav-close-btn';
      closeBtn.setAttribute('aria-label', 'Close menu');
      closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

      const content = desktopNav.cloneNode(true);
      content.id = '';
      const langSwitchMobile = content.querySelector('#langSwitchDesktop');
      if (langSwitchMobile) langSwitchMobile.id = 'langSwitchMobile';

      mobileNavOverlay.appendChild(closeBtn);
      mobileNavOverlay.appendChild(content);

      closeBtn.addEventListener('click', closeMenu);
      mobileNavOverlay.addEventListener('click', (e) => { if (e.target === mobileNavOverlay) closeMenu(); });

      langSwitchMobile?.addEventListener('click', handleLangSwitch);
      content.querySelector("#btnSignIn")?.addEventListener("click", () => window.location.href = 'index.html');
      content.querySelector("#btnSignOut")?.addEventListener("click", () => signOut());
      content.querySelector("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');
    }

    function renderHeader() {
      const btnSignIn = $("#btnSignIn"), btnSignOut = $("#btnSignOut"), btnAdmin = $("#btnAdmin"),
        userName = $("#userName"), btnProfile = $("#btnProfile");
      const isOrganizer = ["organizer", "admin"].includes(authState.profile?.role);

      if (authState.session) {
        btnSignIn.style.display = "none"; btnSignOut.style.display = "inline-block";
        btnProfile.style.display = "grid"; userName.style.display = "inline";
        userName.textContent = authState.profile?.full_name || authState.profile?.username || "";
        $("#userInitial").textContent = (authState.profile?.full_name || "U").charAt(0).toUpperCase();

        const userAvatar = $("#userAvatar");
        if (authState.profile?.avatar_url && userAvatar) {
          userAvatar.src = authState.profile.avatar_url;
          userAvatar.style.display = "block";
          $("#userInitial").style.display = "none";
        } else {
          if (userAvatar) userAvatar.style.display = "none";
          $("#userInitial").style.display = "block";
        }

        if (btnAdmin) btnAdmin.style.display = isOrganizer ? "inline-block" : "none";
      } else {
        btnSignIn.style.display = "inline-block"; btnSignOut.style.display = "none";
        btnProfile.style.display = "none"; userName.style.display = "none";
        if (btnAdmin) btnAdmin.style.display = "none";
      }
      setupMobileMenu();
    }

    function openMenu() {
      const mobileMenuBtn = $("#mobileMenuBtn"), mobileNavOverlay = $("#mobileNavOverlay");
      mobileNavOverlay.classList.add("is-open");
      document.body.classList.add("menu-open");
      mobileMenuBtn.setAttribute("aria-expanded", "true");
      mobileMenuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    }

    function closeMenu() {
      const mobileMenuBtn = $("#mobileMenuBtn"), mobileNavOverlay = $("#mobileNavOverlay");
      mobileNavOverlay.classList.remove("is-open");
      document.body.classList.remove("menu-open");
      mobileMenuBtn.setAttribute("aria-expanded", "false");
      mobileMenuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="18" y2="18"></line></svg>`;
    }

    function handleLangSwitch() {
      state.language = state.language === "en" ? "es" : "en";
      localStorage.setItem("lang", state.language);
      applyI18n();
      renderArchiveList();
      if (state.selectedEvent && eventLogic) {
        eventLogic.renderEventHeader();
        eventLogic.renderThreads();
        eventLogic.renderDescriptionTab();
        if (state.selectedThreadId) eventLogic.renderComments();
        eventLogic.renderFiles();
      }
    }

    // --- PAGE-SPECIFIC LOGIC (ARCHIVE) ---
    function showView(which) {
      $("#archive").style.display = which === "archive" ? "flex" : "none";
      $("#eventDetail").style.display = which === "event" ? "flex" : "none";
    }

    async function loadEvents() {
      const { data } = await supabase.from("events").select("*, event_speakers(*, profiles(full_name, affiliation))").order("start_time", { ascending: false });
      state.events = data || [];
      buildFilters();
      renderArchiveList();

      // MODIFICATION: Hide loader and show the list now that content is ready
      const loader = $("#archiveLoader");
      const list = $("#archiveList");
      if (loader) loader.style.display = 'none';
      if (list) list.style.display = 'grid'; // Use 'grid' as defined in CSS

      const urlParams = new URLSearchParams(window.location.search);
      const eid = urlParams.get("event") || urlParams.get("e");
      if (eid) {
        if (authState.session) {
          await eventLogic.openEvent(eid);
        } else {
          setFlash(tr('auth.required'));
          showView("archive");
        }
      } else {
        showView("archive");
      }
    }

    function buildFilters() {
      const years = Array.from(new Set(state.events.map(e => new Date(e.start_time).getFullYear()))).sort((a, b) => b - a);
      const yearSel = $("#yearFilter");
      yearSel.innerHTML = `<option value="all">${tr('all_years')}</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");
      const tags = new Set();
      for (const e of state.events) (e.topic_tags || []).forEach(t => tags.add(t));
      const tagsContainer = $("#tagsFilter");
      tagsContainer.innerHTML = "";
      Array.from(tags).sort((a, b) => a.localeCompare(b)).forEach(tag => {
        const btn = document.createElement("button");
        btn.className = "chip"; btn.type = "button"; btn.textContent = `#${tag}`; btn.dataset.tag = tag;
        btn.addEventListener("click", () => {
          if (state.filters.tags.has(tag)) state.filters.tags.delete(tag); else state.filters.tags.add(tag);
          btn.classList.toggle("active"); renderArchiveList();
        });
        tagsContainer.appendChild(btn);
      });
    }

    function isPast(e) { return new Date(e.start_time).getTime() < Date.now(); }

    function renderArchiveList() {
      const wrap = $("#archiveList"), empty = $("#emptyArchive"); if (!wrap || !empty) return;
      const term = state.filters.search.toLowerCase(); const year = state.filters.year;
      const onlyRec = state.filters.onlyRecording; const tagsSel = state.filters.tags;
      const pastEvents = state.events.filter(isPast);
      const candidates = pastEvents.filter(ev => {
        if (onlyRec && !ev.recording_url) return false;
        if (year !== "all" && String(new Date(ev.start_time).getFullYear()) !== String(year)) return false;
        if (tagsSel.size > 0) { const evTags = new Set(ev.topic_tags || []); for (const t of tagsSel) if (!evTags.has(t)) return false; }
        if (!term) return true;
        const speakerMatch = (ev.event_speakers || []).some(s => (s.name || "").toLowerCase().includes(term) || (s.affiliation || "").toLowerCase().includes(term));
        const tagsMatch = (ev.topic_tags || []).some(tg => (tg || "").toLowerCase().includes(term));
        const eventMatch = [ev.title_en, ev.title_es, ev.description_en, ev.description_es, ev.host_org].filter(Boolean).some(v => v.toLowerCase().includes(term));
        return speakerMatch || tagsMatch || eventMatch;
      });
      empty.style.display = candidates.length ? "none" : "block";
      wrap.innerHTML = candidates.map(ev => {
        const title = state.language === "es" && ev.title_es ? ev.title_es : ev.title_en;
        const desc = state.language === "es" && ev.description_es ? ev.description_es : ev.description_en;
        let speakerLine = '';
        if (ev.event_speakers && ev.event_speakers.length > 0) {
          const primarySpeaker = ev.event_speakers.find(s => s.primary_speaker) || ev.event_speakers[0];
          speakerLine = `<div class="event-speaker">👤 ${escapeHtml(primarySpeaker.name)}${primarySpeaker.affiliation ? ` (${escapeHtml(primarySpeaker.affiliation)})` : ''}</div>`;
        }
        const tagsHtml = (ev.topic_tags || []).map(tag => `<span class="tag-topic">#${escapeHtml(tag)}</span>`).join("");
        return `
          <div class="event-card">
              <div class="event-header">
                <div class="event-info">
                  <div class="when">${fmtDateTime(ev.start_time)}</div>
                  <h3 class="event-title">${escapeHtml(title)}</h3>
                  ${speakerLine}
                </div>
                <div class="actions">
                    <button class="btn-primary" data-open="${ev.id}">${tr('open')}</button>
                </div>
              </div>
              ${desc ? `<div class="event-desc">${linkify(desc)}</div>` : '<div style="flex-grow: 1;"></div>'}
              <div class="tags">
                ${tagsHtml}
                <span class="tag">${(ev.language || "bi").toUpperCase()}</span>
                ${ev.host_org ? `<span class="tag">${escapeHtml(ev.host_org)}</span>` : ""}
                ${ev.recording_url ? `<a href="${escapeHtml(ev.recording_url)}" class="tag tag-success" target="_blank" rel="noopener">▶️ ${tr('recording')}</a>` : ""}
              </div>
          </div>`;
      }).join("");
    }

    // --- WIRING & INITIALIZATION ---
    function wireUI() {
      // Wire desktop-only buttons
      $("#btnSignOut")?.addEventListener("click", () => signOut());
      $("#btnSignIn")?.addEventListener("click", () => window.location.href = 'index.html');
      $("#btnProfile")?.addEventListener("click", () => window.location.href = 'profile.html');
      $("#langSwitchDesktop")?.addEventListener("click", handleLangSwitch);

      const searchInput = $("#search"); let searchTimeout;
      searchInput?.addEventListener("input", () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { state.filters.search = searchInput.value; renderArchiveList(); }, 300); });
      $("#yearFilter")?.addEventListener("change", (e) => { state.filters.year = e.target.value; renderArchiveList(); });
      $("#hasRecording")?.addEventListener("change", (e) => { state.filters.onlyRecording = e.target.checked; renderArchiveList(); });
      $("#clearFilters")?.addEventListener("click", () => {
        searchInput.value = ""; $("#yearFilter").value = "all"; $("#hasRecording").checked = false;
        state.filters.search = ""; state.filters.year = "all"; state.filters.onlyRecording = false; state.filters.tags.clear();
        document.querySelectorAll("#tagsFilter .chip.active").forEach(el => el.classList.remove("active"));
        renderArchiveList();
      });

      $("#archiveList").addEventListener("click", e => {
        const openBtn = e.target.closest('[data-open]');
        if (openBtn && eventLogic) { eventLogic.openEvent(openBtn.dataset.open); return; }
      });

      $("#year").textContent = new Date().getFullYear();

      $("#mobileMenuBtn")?.addEventListener("click", () => {
        const overlay = $("#mobileNavOverlay");
        if (overlay && !overlay.classList.contains('is-open')) {
          openMenu();
        } else {
          closeMenu();
        }
      });
    }

    (async function main() {
      applyI18n();
      wireUI();

      await initAuth({
        onAuthReady: (authState) => {
          renderHeader();
        },
        onAuthChange: (authState) => {
          renderHeader();
          if (state.selectedEvent && eventLogic) {
            eventLogic.loadRSVPFollow(state.selectedEvent.id);
          }
        }
      });

      eventLogic = initEventLogic({
        supabase, authState, fetchProfile, // <-- CORRECTED: Pass fetchProfile
        tr, state, $, setFlash,
        fmtDateTime, escapeHtml, linkify, bytesToSize, showView,
        listViewName: 'archive'
      });

      await loadEvents();
    })();
  </script>
</body>

</html>